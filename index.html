<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Traveling Birder v7.5 - Route-Based Birding Planner</title>
    <!-- BUILD: 2025-12-21-v7.5-MULTI-LIST-AUTO-UPDATE -->
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Plan birding trips with eBird data. Find target species, hotspots, and optimize your birding routes.">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Traveling Birder">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- Google Consent Mode v2 - Default to denied for EEA users -->
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        
        // Set default consent state (denied until user accepts)
        gtag('consent', 'default', {
            'ad_storage': 'denied',
            'ad_user_data': 'denied',
            'ad_personalization': 'denied',
            'analytics_storage': 'denied',
            'functionality_storage': 'granted',
            'personalization_storage': 'denied',
            'security_storage': 'granted',
            'wait_for_update': 500,
            'region': ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 
                       'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 
                       'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE', 'GB', 'IS', 'LI', 'NO', 'CH']
        });
        
        // Grant consent by default for non-EEA regions
        gtag('consent', 'default', {
            'ad_storage': 'granted',
            'ad_user_data': 'granted',
            'ad_personalization': 'granted',
            'analytics_storage': 'granted'
        });
    </script>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J8NPHZHBTE"></script>
    <script>
        gtag('js', new Date());
        gtag('config', 'G-J8NPHZHBTE');
        
        // Function to update consent when user accepts cookies
        window.grantAnalyticsConsent = function() {
            gtag('consent', 'update', {
                'ad_storage': 'granted',
                'ad_user_data': 'granted',
                'ad_personalization': 'granted',
                'analytics_storage': 'granted'
            });
            localStorage.setItem('travelingBirder_cookieConsent', 'granted');
            console.log('‚úÖ Analytics consent granted');
        };
        
        // Function to deny consent
        window.denyAnalyticsConsent = function() {
            gtag('consent', 'update', {
                'ad_storage': 'denied',
                'ad_user_data': 'denied',
                'ad_personalization': 'denied',
                'analytics_storage': 'denied'
            });
            localStorage.setItem('travelingBirder_cookieConsent', 'denied');
            console.log('‚ùå Analytics consent denied');
        };
        
        // Check if user has previously consented
        const savedConsent = localStorage.getItem('travelingBirder_cookieConsent');
        if (savedConsent === 'granted') {
            window.grantAnalyticsConsent();
        }
    </script>
    
    <!-- Global Error Logging -->
    <script>
        // Error logging system
        window.TravelingBirderErrors = [];
        
        window.onerror = function(message, source, lineno, colno, error) {
            const errorInfo = {
                type: 'javascript',
                message: message,
                source: source,
                line: lineno,
                column: colno,
                stack: error ? error.stack : null,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            // Store locally
            window.TravelingBirderErrors.push(errorInfo);
            
            // Log to console
            console.error('üö® Error logged:', errorInfo);
            
            // Send to Google Analytics as event
            if (typeof gtag === 'function') {
                gtag('event', 'exception', {
                    description: message,
                    fatal: false,
                    error_source: source,
                    error_line: lineno
                });
            }
            
            // Store in localStorage for persistence (keep last 50 errors)
            try {
                let storedErrors = JSON.parse(localStorage.getItem('travelingBirder_errorLog') || '[]');
                storedErrors.push(errorInfo);
                if (storedErrors.length > 50) storedErrors = storedErrors.slice(-50);
                localStorage.setItem('travelingBirder_errorLog', JSON.stringify(storedErrors));
            } catch (e) {
                // localStorage might be full or unavailable
            }
            
            return false; // Don't suppress the error
        };
        
        // Catch unhandled promise rejections
        window.onunhandledrejection = function(event) {
            const errorInfo = {
                type: 'promise_rejection',
                message: event.reason ? (event.reason.message || String(event.reason)) : 'Unknown rejection',
                stack: event.reason ? event.reason.stack : null,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            window.TravelingBirderErrors.push(errorInfo);
            console.error('üö® Unhandled Promise Rejection:', errorInfo);
            
            if (typeof gtag === 'function') {
                gtag('event', 'exception', {
                    description: 'Promise: ' + errorInfo.message,
                    fatal: false
                });
            }
            
            try {
                let storedErrors = JSON.parse(localStorage.getItem('travelingBirder_errorLog') || '[]');
                storedErrors.push(errorInfo);
                if (storedErrors.length > 50) storedErrors = storedErrors.slice(-50);
                localStorage.setItem('travelingBirder_errorLog', JSON.stringify(storedErrors));
            } catch (e) {}
        };
        
        // Helper function to log custom errors/events
        window.logBirderError = function(category, message, details = {}) {
            const errorInfo = {
                type: 'custom',
                category: category,
                message: message,
                details: details,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            window.TravelingBirderErrors.push(errorInfo);
            console.warn('‚ö†Ô∏è Custom error logged:', errorInfo);
            
            if (typeof gtag === 'function') {
                gtag('event', 'error', {
                    event_category: category,
                    event_label: message,
                    value: details.code || 0
                });
            }
            
            try {
                let storedErrors = JSON.parse(localStorage.getItem('travelingBirder_errorLog') || '[]');
                storedErrors.push(errorInfo);
                if (storedErrors.length > 50) storedErrors = storedErrors.slice(-50);
                localStorage.setItem('travelingBirder_errorLog', JSON.stringify(storedErrors));
            } catch (e) {}
        };
        
        // Function to view error log (for debugging)
        window.viewErrorLog = function() {
            const errors = JSON.parse(localStorage.getItem('travelingBirder_errorLog') || '[]');
            console.table(errors);
            return errors;
        };
        
        // Function to clear error log
        window.clearErrorLog = function() {
            localStorage.removeItem('travelingBirder_errorLog');
            window.TravelingBirderErrors = [];
            console.log('‚úÖ Error log cleared');
        };
    </script>
    
    <!-- Google Maps Script with Callback -->
    <script>
        var mapInitPending = false;
        window.initMap = function() {
            console.log('üó∫Ô∏è Google Maps callback triggered');
            mapInitPending = true;
            if (document.readyState === 'complete') {
                if (typeof realInitMap === 'function') {
                    console.log('‚úÖ Calling realInitMap immediately');
                    realInitMap();
                }
            }
        };
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvpU9tANBmnbKqMM2UWvELa9nRcrhneY0&libraries=places,geometry&callback=initMap"></script>
    
    <!-- CSV Parser for Life List Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Dark Mode Variables */
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: white;
            --text-primary: #374151;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
        }

        [data-theme="dark"] {
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --bg-success: #064e3b;
            --bg-warning: #78350f;
            --bg-info: #1e3a5f;
            --bg-purple: #2e1065;
            --bg-red: #450a0a;
        }
        
        /* Dark mode overrides for inline styled elements */
        [data-theme="dark"] #belowMap {
            background: var(--bg-secondary) !important;
        }
        
        [data-theme="dark"] .panel {
            background: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .panel-summary {
            background: var(--bg-primary) !important;
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .panel-content {
            background: var(--bg-secondary) !important;
        }
        
        /* Dashboard area statistics boxes */
        [data-theme="dark"] #statsDisplay > div[style*="background: #f0fdf4"],
        [data-theme="dark"] #statsDisplay > div[style*="background: #f9fafb"],
        [data-theme="dark"] #statsDisplay div[style*="background: #f0fdf4"],
        [data-theme="dark"] #statsDisplay div[style*="background: #f9fafb"] {
            background: var(--bg-primary) !important;
        }
        
        [data-theme="dark"] #statsDisplay div[style*="background: #ede9fe"] {
            background: var(--bg-purple) !important;
        }
        
        [data-theme="dark"] #statsDisplay div[style*="background: #fef3c7"] {
            background: var(--bg-warning) !important;
            color: #fef3c7 !important;
        }
        
        [data-theme="dark"] #statsDisplay div[style*="background: #fef2f2"] {
            background: var(--bg-red) !important;
        }
        
        [data-theme="dark"] #statsDisplay div[style*="background: #f3e8ff"] {
            background: var(--bg-purple) !important;
        }
        
        /* Target list and sightings list items */
        [data-theme="dark"] #targetList > div,
        [data-theme="dark"] #sightingsList > div {
            background: var(--bg-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] #targetList div[style*="background: #f0fdf4"],
        [data-theme="dark"] #targetList div[style*="background: var(--bg-primary)"],
        [data-theme="dark"] #sightingsList div[style*="background: #f0fdf4"] {
            background: var(--bg-primary) !important;
        }
        
        /* Your Bird Lists panel */
        [data-theme="dark"] #listsStatsDisplay div[style*="background: var(--bg-primary)"],
        [data-theme="dark"] #listsStatsDisplay div[style*="background: linear-gradient"] {
            border-color: var(--border-color) !important;
        }
        
        /* Top eBirders panel */
        [data-theme="dark"] #topEBirdersDisplay div[style*="background: #f0fdf4"] {
            background: var(--bg-success) !important;
            border-color: #10b981 !important;
        }
        
        /* Hotspots and checklists panels */
        [data-theme="dark"] #hotspotsList > div,
        [data-theme="dark"] #checklistsList > div {
            background: var(--bg-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Info boxes within panels */
        [data-theme="dark"] div[style*="background: #f0fdf4"] {
            background: var(--bg-success) !important;
            border-color: #10b981 !important;
        }
        
        [data-theme="dark"] div[style*="background: #fef3c7"] {
            background: var(--bg-warning) !important;
        }
        
        [data-theme="dark"] div[style*="background: #f5f3ff"] {
            background: var(--bg-purple) !important;
        }
        
        [data-theme="dark"] div[style*="background: #e0e7ff"] {
            background: var(--bg-info) !important;
        }
        
        /* Text color fixes for dark mode */
        [data-theme="dark"] span[style*="color: #065f46"],
        [data-theme="dark"] div[style*="color: #065f46"],
        [data-theme="dark"] p[style*="color: #065f46"] {
            color: #6ee7b7 !important;
        }
        
        [data-theme="dark"] span[style*="color: #92400e"],
        [data-theme="dark"] div[style*="color: #92400e"],
        [data-theme="dark"] p[style*="color: #92400e"] {
            color: #fcd34d !important;
        }
        
        [data-theme="dark"] span[style*="color: #5b21b6"],
        [data-theme="dark"] div[style*="color: #5b21b6"] {
            color: #c4b5fd !important;
        }
        
        [data-theme="dark"] span[style*="color: #1e40af"],
        [data-theme="dark"] div[style*="color: #1e40af"] {
            color: #93c5fd !important;
        }
        
        [data-theme="dark"] span[style*="color: #991b1b"],
        [data-theme="dark"] div[style*="color: #991b1b"] {
            color: #fca5a5 !important;
        }
        
        [data-theme="dark"] span[style*="color: #6b21a8"],
        [data-theme="dark"] div[style*="color: #6b21a8"] {
            color: #d8b4fe !important;
        }

        /* Fix dark mode full page height */
        html, body {
            min-height: 100vh;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        /* ============================================
           FOOTER INFO SECTION STYLES (Dark Mode Compatible)
           ============================================ */
        .info-footer {
            background: var(--bg-secondary);
            border-top: 2px solid var(--border-color);
            padding: 40px 20px;
            margin-top: 40px;
        }

        .info-card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .info-box-section {
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .info-box-section.warning-section {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
        }

        .info-box-section.tips-section {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
        }

        :root[data-theme="dark"] .info-box-section.warning-section {
            border-color: #10b981;
        }

        :root[data-theme="dark"] .info-box-section.tips-section {
            border-color: #3b82f6;
        }

        /* ============================================
           HEADER STYLES
           ============================================ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: var(--bg-secondary);
            border-bottom: 3px solid #10b981;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-left h1 {
            margin: 0;
            font-size: 1.6em;
            color: var(--text-primary);
        }

        .header-left p {
            margin: 3px 0 0 0;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .help-btn {
            background: #fbbf24;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.4em;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(251, 191, 36, 0.3);
            transition: all 0.3s;
        }

        .help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }

        .ebird-login {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ebird-login input {
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9em;
            width: 220px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .ebird-login input::placeholder {
            color: var(--text-secondary);
        }

        .ebird-login button {
            padding: 10px 20px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.3s;
        }

        .ebird-login button:hover {
            background: #059669;
        }

        .ebird-connected {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-primary);
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .ebird-connected-text {
            font-size: 0.9em;
            color: var(--text-primary);
            font-weight: 600;
        }

        .disconnect-btn {
            padding: 6px 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
        }

        /* ============================================
           QUICK START MODAL
           ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 35px;
            max-width: 650px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.8em;
        }

        .modal-close {
            background: none;
            color: #9ca3af;
            border: none;
            width: 32px;
            height: 32px;
            font-size: 1.8em;
            cursor: pointer;
            font-weight: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding: 0;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #6b7280;
        }

        .modal-content ol {
            padding-left: 25px;
            line-height: 2;
            color: var(--text-primary);
        }

        .modal-content strong {
            color: var(--text-primary);
        }

        .modal-content p {
            color: var(--text-primary);
        }
            color: #065f46;
        }

        .modal-tips {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
            border: 1px solid #10b981;
        }

        .modal-tips strong {
            display: block;
            margin-bottom: 12px;
            color: #065f46;
            font-size: 1.1em;
        }

        .modal-tips ul {
            margin: 0;
            padding-left: 25px;
            font-size: 0.95em;
            color: #047857;
        }

        /* ============================================
           MAIN LAYOUT
           ============================================ */
        .main-layout {
            display: grid;
            grid-template-columns: 420px 1fr;
            height: calc(100vh - 80px);
            gap: 0;
        }

        .sidebar {
            background: var(--bg-secondary);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
        }

        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #10b981;
            border-radius: 4px;
        }

        .map-container {
            position: relative;
            height: 100%;
            min-height: 600px;
        }

        #map {
            width: 100%;
            height: 100%;
            min-height: 600px;
        }

        /* ============================================
           SIDEBAR SECTIONS
           ============================================ */
        .section {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 18px;
            margin-bottom: 18px;
        }

        .section h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.15em;
            padding-bottom: 10px;
            border-bottom: 2px solid #10b981;
        }

        .section label {
            color: var(--text-primary);
        }

        .section select, .section input {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        }

        .input-group {
            margin-bottom: 14px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9em;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 11px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9em;
            transition: all 0.3s;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .input-group input::placeholder {
            color: var(--text-secondary);
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Checkbox styling for dark mode */
        input[type="checkbox"] {
            accent-color: #10b981;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        /* Better checkbox visibility in dark mode */
        [data-theme="dark"] input[type="checkbox"] {
            filter: brightness(1.2);
        }

        button.primary-btn {
            width: 100%;
            padding: 12px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        button.primary-btn:hover {
            background: #059669;
        }

        button.secondary-btn {
            width: 100%;
            padding: 10px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 8px;
        }

        button.secondary-btn:hover {
            background: #4b5563;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-size: 0.9em;
            color: var(--text-primary);
        }

        /* ============================================
           FLOATING MAP LEGEND
           ============================================ */
        .map-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(0, 0, 0, 0.1);
            max-width: 200px;
            z-index: 100;
            border: 2px solid #10b981;
            font-size: 0.85em;
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .legend-header h4 {
            margin: 0;
            color: var(--text-primary);
            font-size: 0.95em;
            font-weight: 600;
        }

        .legend-toggle {
            font-size: 1em;
            color: var(--text-secondary);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .legend-content {
            color: var(--text-primary);
        }

        /* Legend Toggle Buttons - Tab Style */
        .legend-toggle-group {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
            margin-bottom: 12px;
        }

        .legend-style-btn {
            flex: 1;
            padding: 10px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .legend-style-btn .btn-icon {
            font-size: 1.2em;
        }

        .legend-style-btn .btn-label {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .legend-style-btn.active {
            background: white;
            color: #065f46;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .legend-style-btn:hover:not(.active) {
            background: rgba(255,255,255,0.5);
            color: var(--text-primary);
        }

        :root[data-theme="dark"] .legend-style-btn.active {
            background: #374151;
            color: #10b981;
        }

        :root[data-theme="dark"] .legend-style-btn:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }

        .legend-divider {
            height: 1px;
            background: var(--border-color);
            margin: 10px 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            gap: 8px;
            color: var(--text-primary);
            font-size: 0.9em;
        }

        .legend-item span {
            color: var(--text-primary);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .legend-numbered {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            color: white;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .legend-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        .legend-marker.target { background: #ef4444; }
        .legend-marker.rare { background: #f59e0b; }
        .legend-marker.common { background: #10b981; }
        .legend-marker.hotspot { background: #3b82f6; }

        /* ABA Filter Checkboxes */
        .aba-filter-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            padding: 3px 0;
            font-size: 0.85em;
            color: var(--text-primary);
            transition: opacity 0.2s;
        }

        .aba-filter-item:hover {
            opacity: 0.8;
        }

        .aba-filter-item input[type="checkbox"] {
            width: 14px;
            height: 14px;
            margin: 0;
            cursor: pointer;
            accent-color: #10b981;
        }

        .aba-filter-item input[type="checkbox"]:not(:checked) + .legend-dot {
            opacity: 0.3;
        }

        .aba-filter-item input[type="checkbox"]:not(:checked) ~ span {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .aba-quick-btn {
            flex: 1;
            padding: 4px 8px;
            font-size: 0.7em;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .aba-quick-btn:hover {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        /* ============================================
           BELOW MAP PANELS
           ============================================ */
        .below-map {
            background: white;
            border-top: 2px solid var(--border-color);
        }

        .panels-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: #e5e7eb;
        }

        .panel {
            background: white;
            padding: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .panel:hover {
            background: #f9fafb;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .panel-header h3 {
            margin: 0;
            color: #065f46;
            font-size: 1.1em;
        }

        .panel-toggle {
            font-size: 1.5em;
            color: #10b981;
            font-weight: bold;
        }

        .panel-summary {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .panel-content {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .panel-content.expanded {
            display: block;
        }

        /* ============================================
           ROUTE CONTROLS
           ============================================ */
        .route-duration {
            background: #dbeafe;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            margin: 12px 0;
            font-weight: 600;
            color: #1e40af;
        }

        .waypoint-list {
            margin-top: 12px;
        }

        .waypoint-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f3f4f6;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 0.85em;
        }

        .waypoint-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 3px 8px;
            font-size: 0.8em;
            cursor: pointer;
        }

        /* ============================================
           RESPONSIVE DESIGN
           ============================================ */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 360px 1fr;
            }
        }

        @media (max-width: 968px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .main-layout {
                grid-template-columns: 1fr;
                height: auto;
            }

            .sidebar {
                height: auto;
                max-height: 60vh;
            }

            .map-container {
                height: 500px;
            }

            .panels-container {
                grid-template-columns: 1fr;
            }

            .ebird-login input {
                width: 180px;
            }
        }

        @media (max-width: 640px) {
            .header-left h1 {
                font-size: 1.3em;
            }

            .ebird-login {
                flex-direction: column;
                width: 100%;
            }

            .ebird-login input,
            .ebird-login button {
                width: 100%;
            }

            .help-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2em;
            }
        }

        /* ============================================
           PRINT STYLES
           ============================================ */
        @media print {
            .header,
            .sidebar,
            .below-map,
            .map-legend {
                display: none !important;
            }

            .map-container {
                height: 100vh !important;
            }

            #map {
                height: 100vh !important;
            }
        }

        /* ============================================
           MODAL STYLES
           ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal h2 {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 1.5em;
        }

        .modal h3 {
            margin: 20px 0 10px 0;
            color: var(--text-primary);
            font-size: 1.2em;
        }

        .modal h4 {
            margin: 15px 0 8px 0;
            color: var(--text-primary);
            font-size: 1em;
        }

        .modal p, .modal li {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .modal-close {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .info-box {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid;
        }

        .info-box.warning {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .info-box.success {
            background: #d1fae5;
            border-color: #10b981;
        }

        .info-box.info {
            background: #e0e7ff;
            border-color: #6366f1;
        }

        [data-theme="dark"] .info-box.warning {
            background: #78350f;
        }

        [data-theme="dark"] .info-box.success {
            background: #064e3b;
        }

        [data-theme="dark"] .info-box.info {
            background: #312e81;
        }

        /* Account Menu Dropdown */
        .account-dropdown {
            position: relative;
        }

        .account-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 220px;
            margin-top: 8px;
            z-index: 1000;
        }

        .account-menu.active {
            display: block;
        }

        .account-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
            color: var(--text-primary);
            font-size: 0.95em;
        }

        .account-menu-item:hover {
            background: var(--bg-primary);
        }

        .account-menu-item:last-child {
            border-bottom: none;
        }

        .menu-toggle-btn {
            background: #6b7280;
            border: none;
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
            font-weight: 500;
        }

        .menu-toggle-btn:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        [data-theme="dark"] .menu-toggle-btn {
            background: #374151;
        }

        [data-theme="dark"] .menu-toggle-btn:hover {
            background: #4b5563;
        }

        /* ============================================
           UTILITY CLASSES
           ============================================ */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        /* ============================================
           GOOGLE PLACES AUTOCOMPLETE STYLING
           ============================================ */
        .pac-container {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-top: 4px;
            z-index: 10000 !important;
        }

        .pac-item {
            padding: 10px;
            cursor: pointer;
            border-top: 1px solid var(--border-color);
        }

        .pac-item:first-child {
            border-top: none;
        }

        .pac-item:hover {
            background: #f0fdf4;
        }

        .pac-item-query {
            color: #065f46;
            font-weight: 600;
        }

        .pac-icon {
            margin-top: 2px;
        }
        
        @keyframes fly {
            0%, 100% { transform: translateY(0px) rotate(-5deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }

        /* ============================================
           WELCOME OVERLAY STYLES
           ============================================ */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 50%, #a7f3d0 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .welcome-overlay.hidden {
            display: none;
        }

        .welcome-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            max-width: 700px;
            width: 100%;
            padding: 40px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .welcome-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .welcome-logo {
            font-size: 4em;
            margin-bottom: 10px;
            animation: fly 3s ease-in-out infinite;
        }

        .welcome-header h1 {
            color: #065f46;
            font-size: 1.8em;
            margin: 0 0 10px 0;
        }

        .welcome-header p {
            color: #6b7280;
            font-size: 1em;
            margin: 0;
        }

        .welcome-description {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: left;
        }

        .welcome-description > p:first-child {
            color: #0369a1;
            font-size: 1em;
            margin: 0 0 8px 0;
        }

        .welcome-description > p:nth-child(2) {
            color: #475569;
            font-size: 0.95em;
            line-height: 1.5;
            margin: 0 0 15px 0;
        }

        .feature-highlights {
            display: grid;
            gap: 10px;
        }

        .feature-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.9em;
            color: #334155;
            line-height: 1.4;
        }

        .feature-icon {
            font-size: 1.1em;
            flex-shrink: 0;
        }

        .feature-item strong {
            color: #0369a1;
        }

        .creator-note {
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px dashed #93c5fd;
        }

        .creator-note p {
            margin: 0;
            font-size: 0.85em;
            color: #64748b;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .welcome-description {
                padding: 15px;
            }

            .feature-item {
                font-size: 0.85em;
            }

            .creator-note p {
                font-size: 0.8em;
            }
        }

        .welcome-steps h2 {
            color: #374151;
            font-size: 1.1em;
            margin: 0 0 20px 0;
            text-align: center;
        }

        .welcome-step {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .welcome-step.active {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .welcome-step.completed {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .welcome-step.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .step-number {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: white;
            color: #9ca3af;
            border: 3px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2em;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .welcome-step.active .step-number {
            background: white;
            color: #10b981;
            border-color: #10b981;
        }

        .welcome-step.completed .step-number {
            background: #10b981;
            color: white;
            border-color: #10b981;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }

        /* Existing data indicator */
        .existing-data-box {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
        }

        .existing-data-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .existing-data-header .check-badge {
            background: #10b981;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
        }

        .existing-data-header span {
            font-weight: 600;
            color: #065f46;
        }

        .existing-data-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85em;
            color: #047857;
        }

        .existing-data-details .data-item {
            display: flex;
            justify-content: space-between;
        }

        .existing-data-details .data-value {
            font-weight: 600;
        }

        .update-prompt {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #a7f3d0;
            font-size: 0.85em;
            color: #065f46;
        }

        .update-btn {
            background: white;
            color: #10b981;
            border: 2px solid #10b981;
            padding: 6px 14px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85em;
            margin-left: 10px;
            transition: all 0.2s;
        }

        .update-btn:hover {
            background: #10b981;
            color: white;
        }

        .step-content {
            flex: 1;
        }

        .step-content h3 {
            color: #374151;
            font-size: 1.1em;
            margin: 0 0 5px 0;
        }

        .step-content > p {
            color: #6b7280;
            font-size: 0.9em;
            margin: 0 0 15px 0;
        }

        .step-instructions {
            margin-bottom: 15px;
        }

        .instruction-item {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #4b5563;
            line-height: 1.4;
        }

        .instruction-item.highlight {
            background: #fef3c7;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid #f59e0b;
        }

        .instruction-num {
            color: #10b981;
            font-weight: 600;
            flex-shrink: 0;
        }

        .highlight-text {
            background: #fef3c7;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            color: #92400e;
        }

        .step-input-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .welcome-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .welcome-input:focus {
            outline: none;
            border-color: #10b981;
        }

        .welcome-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .welcome-btn.primary {
            background: #10b981;
            color: white;
        }

        .welcome-btn.primary:hover {
            background: #059669;
        }

        .welcome-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px dashed #d1d5db;
        }

        .welcome-btn.secondary:hover:not(:disabled) {
            background: #e5e7eb;
            border-color: #9ca3af;
        }

        .welcome-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .welcome-btn.large {
            padding: 15px 40px;
            font-size: 1.1em;
        }

        .step-status {
            margin-top: 10px;
            font-size: 0.9em;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .step-status.success {
            background: #d1fae5;
            color: #065f46;
        }

        .step-status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .step-status.loading {
            background: #dbeafe;
            color: #1e40af;
        }

        .visual-hint {
            margin: 15px 0;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #bae6fd;
        }

        .hint-mockup {
            background: white;
            border-radius: 6px;
            padding: 10px;
            border: 1px solid #e5e7eb;
        }

        .hint-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .hint-tab {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            background: #f3f4f6;
            color: #6b7280;
        }

        .hint-tab.active {
            background: #10b981;
            color: white;
            font-weight: 600;
        }

        .hint-arrow {
            color: #10b981;
            font-weight: 600;
            font-size: 0.9em;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .welcome-footer {
            text-align: center;
            margin-top: 25px;
            padding: 25px;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            animation: celebratePulse 2s ease-in-out infinite;
        }

        @keyframes celebratePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 0 20px 5px rgba(16, 185, 129, 0.2); }
        }

        .success-message {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
            font-size: 1.2em;
            color: #065f46;
            font-weight: 700;
        }

        .success-icon {
            font-size: 2em;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .welcome-skip {
            text-align: center;
            margin-top: 20px;
        }

        .skip-btn {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 0.85em;
            cursor: pointer;
            text-decoration: underline;
        }

        .skip-btn:hover {
            color: #6b7280;
        }

        /* Mobile file upload fixes */
        .mobile-upload-label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .mobile-upload-label.disabled {
            opacity: 0.5;
            pointer-events: none;
            cursor: not-allowed;
        }

        .mobile-file-input {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Ensure touch targets are large enough on mobile */
        @media (max-width: 768px) {
            .mobile-upload-label {
                min-height: 48px;
                padding: 12px 20px;
            }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .welcome-content {
                padding: 25px 20px;
                border-radius: 15px;
            }

            .welcome-header h1 {
                font-size: 1.4em;
            }

            .welcome-logo {
                font-size: 3em;
            }

            .welcome-step {
                flex-direction: column;
                padding: 15px;
            }

            .step-number {
                width: 35px;
                height: 35px;
                font-size: 1em;
            }

            .step-input-row {
                flex-direction: column;
            }

            .welcome-btn {
                width: 100%;
            }

            .instruction-item {
                font-size: 0.85em;
            }

            .hint-mockup {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <!-- ============================================
         HEADER
         ============================================ -->
    <div class="header">
        <div class="header-left">
            <h1>ü¶© Traveling Birder</h1>
            <p>Plan your birding trip with target species along your route</p>
        </div>
        <div class="header-right">
            <button class="help-btn" onclick="toggleQuickStart()" title="Quick Start Guide" style="display: flex; align-items: center; gap: 8px; padding: 0 15px; border-radius: 20px; width: auto;">
                <span style="font-size: 1.3em;">üí°</span>
                <span style="font-size: 0.9em; font-weight: 600;">Quick Start</span>
            </button>
            
            <!-- Account/Settings Menu -->
            <div class="account-dropdown">
                <button class="menu-toggle-btn" onclick="toggleAccountMenu()" title="Settings & Features">
                    ‚öôÔ∏è Menu
                </button>
                <div id="accountMenu" class="account-menu">
                    <div class="account-menu-item" onclick="openCSVImportModal()">
                        üì• Import Life List CSV
                    </div>
                    <div class="account-menu-item" onclick="exportCurrentSearchCSV()">
                        üì§ Export Search Results
                    </div>
                    <div class="account-menu-item" onclick="exportLifeListCSV()">
                        üíæ Export My Life List
                    </div>
                    <div class="account-menu-item" onclick="toggleDarkMode()">
                        üåì Toggle Dark Mode
                    </div>
                    <div class="account-menu-item" onclick="showTermsModal()">
                        üìã Terms & Privacy
                    </div>
                </div>
            </div>
            
            <div id="ebirdHeader">
                <!-- Simple status display in header -->
                <div id="headerStatus">
                    <div id="notConnectedStatus" style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: #f59e0b; font-weight: 600; font-size: 0.9em;">‚ö†Ô∏è Setup Required</span>
                        <button onclick="showWelcomeOverlay()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.85em;">
                            Get Started
                        </button>
                    </div>
                    <div id="connectedStatus" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         WELCOME/SETUP OVERLAY (covers map until setup complete)
         ============================================ -->
    <div id="welcomeOverlay" class="welcome-overlay">
        <div class="welcome-content">
            <div class="welcome-header">
                <div class="welcome-logo">ü¶©</div>
                <h1>Welcome to Traveling Birder!</h1>
                <p style="font-size: 1.05em; margin-bottom: 15px;">Your personal birding trip planner</p>
            </div>
            
            <!-- Site Description -->
            <div class="welcome-description">
                <p><strong>What is Traveling Birder?</strong></p>
                <p>A free tool that helps you find birds you haven't seen yet along any route or in any area. Perfect for road trips, vacations, or exploring new birding spots!</p>
                
                <div class="feature-highlights">
                    <div class="feature-item">
                        <span class="feature-icon">üó∫Ô∏è</span>
                        <span><strong>Route Planning</strong> ‚Äî See target species along your driving route</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">üéØ</span>
                        <span><strong>Target Species</strong> ‚Äî Find birds not on your life, year, or regional list</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">üìç</span>
                        <span><strong>Top Hotspots</strong> ‚Äî Best birding locations ranked by species count</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">üìã</span>
                        <span><strong>Top Checklists</strong> ‚Äî Recent checklists with the most species</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">üîÑ</span>
                        <span><strong>Auto-Update</strong> ‚Äî Life list syncs with your recent eBird sightings</span>
                    </div>
                </div>
                
                <div class="creator-note">
                    <p>üí° <em>I built this tool after spending time traveling and realizing eBird didn't have a good way to plan trips around bird sightings. So I took it on as a fun side project ‚Äî hope you find it useful!</em></p>
                </div>
            </div>
            
            <div class="welcome-steps">
                <h2>Complete these 2 steps to get started:</h2>
                
                <!-- STEP 1 -->
                <div class="welcome-step" id="welcomeStep1">
                    <div class="step-number" id="welcomeStep1Num">1</div>
                    <div class="step-content">
                        <h3>Get Your Free eBird API Key</h3>
                        <p>This connects you to eBird's bird sighting database</p>
                        
                        <div class="step-instructions">
                            <div class="instruction-item">
                                <span class="instruction-num">a.</span>
                                <span>Visit <a href="https://ebird.org/api/keygen" target="_blank">ebird.org/api/keygen</a> (opens in new tab)</span>
                            </div>
                            <div class="instruction-item">
                                <span class="instruction-num">b.</span>
                                <span>Sign in to your eBird account (or create one free)</span>
                            </div>
                            <div class="instruction-item">
                                <span class="instruction-num">c.</span>
                                <span>Copy your API key and paste it below</span>
                            </div>
                        </div>
                        
                        <div class="step-input-row">
                            <input type="password" id="welcomeApiKey" placeholder="Paste your API key here" class="welcome-input">
                            <button onclick="connectFromWelcome()" class="welcome-btn primary">Connect</button>
                        </div>
                        <div id="step1Status" class="step-status"></div>
                    </div>
                </div>
                
                <!-- STEP 2 -->
                <div class="welcome-step disabled" id="welcomeStep2">
                    <div class="step-number" id="welcomeStep2Num">2</div>
                    <div class="step-content">
                        <h3>Upload Your eBird Life List</h3>
                        <p>This tells us which birds you've already seen</p>
                        
                        <!-- Existing data indicator (hidden by default, shown by JS) -->
                        <div id="existingDataBox" class="existing-data-box" style="display: none;">
                            <div class="existing-data-header">
                                <div class="check-badge">‚úì</div>
                                <span>Life List Already Loaded!</span>
                            </div>
                            <div class="existing-data-details">
                                <div class="data-item">
                                    <span>Life list:</span>
                                    <span class="data-value" id="existingLifeCount">‚Äî</span>
                                </div>
                                <div class="data-item">
                                    <span>Year list:</span>
                                    <span class="data-value" id="existingYearCount">‚Äî</span>
                                </div>
                                <div class="data-item" style="grid-column: span 2;">
                                    <span>Last updated:</span>
                                    <span class="data-value" id="existingLastUpdate">‚Äî</span>
                                </div>
                            </div>
                            <div class="update-prompt">
                                üê¶ Seen new birds since then?
                                <button class="update-btn" onclick="showUploadInstructions()">Upload New List</button>
                            </div>
                        </div>
                        
                        <!-- Upload instructions (hidden when data exists) -->
                        <div id="uploadInstructions">
                            <!-- Upload Method Tabs -->
                            <div style="display: flex; gap: 0; margin-bottom: 15px; border-radius: 8px; overflow: hidden; border: 2px solid #10b981;">
                                <button id="tabZipBtn" onclick="showUploadTab('zip')" style="flex: 1; padding: 12px; border: none; background: #10b981; color: white; font-weight: 600; cursor: pointer; font-size: 0.9em;">
                                    ‚≠ê Full Data (ZIP) - Best
                                </button>
                                <button id="tabCsvBtn" onclick="showUploadTab('csv')" style="flex: 1; padding: 12px; border: none; background: #e5e7eb; color: #374151; font-weight: 600; cursor: pointer; font-size: 0.9em;">
                                    üìÑ Quick (CSV)
                                </button>
                            </div>
                            
                            <!-- ZIP Upload Tab (Recommended) -->
                            <div id="zipUploadTab">
                                <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #10b981;">
                                    <div style="font-weight: 600; color: #065f46; margin-bottom: 6px;">‚ú® Why ZIP is better:</div>
                                    <ul style="margin: 0; padding-left: 18px; font-size: 0.85em; color: #047857;">
                                        <li><strong>Date filtering</strong> - Filter your list by year, month, or custom dates</li>
                                        <li><strong>Auto-creates regional lists</strong> - State/country lists generated automatically</li>
                                        <li><strong>Complete data</strong> - All your observations in one file</li>
                                    </ul>
                                </div>
                                
                                <div class="step-instructions">
                                    <div class="instruction-item">
                                        <span class="instruction-num">1.</span>
                                        <span>Visit <a href="https://ebird.org/downloadMyData" target="_blank" style="color: #2563eb; font-weight: 600;">ebird.org/downloadMyData</a></span>
                                    </div>
                                    <div class="instruction-item">
                                        <span class="instruction-num">2.</span>
                                        <span>Click <strong>"Request my observations"</strong></span>
                                    </div>
                                    <div class="instruction-item highlight">
                                        <span class="instruction-num">3.</span>
                                        <span>Wait for email (usually <strong>2-10 minutes</strong>)</span>
                                    </div>
                                    <div class="instruction-item">
                                        <span class="instruction-num">4.</span>
                                        <span>Download the <strong>ZIP file</strong> from the email link</span>
                                    </div>
                                    <div class="instruction-item">
                                        <span class="instruction-num">5.</span>
                                        <span>Upload it below</span>
                                    </div>
                                </div>
                                
                                <div style="background: #fef3c7; padding: 10px; border-radius: 6px; margin: 12px 0; font-size: 0.85em; color: #92400e;">
                                    ‚è±Ô∏è <strong>Note:</strong> eBird needs to prepare your data file. You'll receive an email when it's ready (typically within 10 minutes).
                                </div>
                                
                                <div class="step-input-row">
                                    <input type="file" id="welcomeZipInput" accept=".zip" onchange="uploadZipFromWelcome(this)" class="mobile-file-input">
                                    <label for="welcomeZipInput" class="welcome-btn secondary mobile-upload-label" id="welcomeZipBtn" style="background: #10b981; color: white; border-color: #10b981;">
                                        üì¶ Choose ZIP File
                                    </label>
                                </div>
                                <div id="welcomeZipStatus" style="margin-top: 10px; font-size: 0.85em;"></div>
                            </div>
                            
                            <!-- CSV Upload Tab (Quick) -->
                            <div id="csvUploadTab" style="display: none;">
                                <div style="background: #fef3c7; padding: 10px; border-radius: 6px; margin-bottom: 12px; font-size: 0.85em; color: #92400e;">
                                    ‚ö° <strong>Quick option:</strong> Faster to set up, but has limitations. You can always upload the ZIP later for full features.
                                </div>
                                
                                <div style="background: #fee2e2; padding: 10px; border-radius: 6px; margin-bottom: 12px; font-size: 0.8em; color: #991b1b; border: 1px solid #fecaca;">
                                    <strong>‚ö†Ô∏è CSV Limitation:</strong> Only includes your <strong>most recent sighting date</strong> for each species‚Äînot your full history. Year lists, trip reports, and date filtering won't be accurate.
                                </div>
                                
                                <div class="step-instructions">
                                    <div class="instruction-item">
                                        <span class="instruction-num">a.</span>
                                        <span>Visit <a href="https://ebird.org/lifelist" target="_blank">ebird.org/lifelist</a> (opens in new tab)</span>
                                    </div>
                                    <div class="instruction-item highlight">
                                        <span class="instruction-num">b.</span>
                                        <span><strong>IMPORTANT:</strong> Click the <span class="highlight-text">"Last seen"</span> tab (not "First seen")</span>
                                    </div>
                                    <div class="instruction-item">
                                        <span class="instruction-num">c.</span>
                                        <span>Click <span class="highlight-text">"Download (csv)"</span> button in top right</span>
                                    </div>
                                    <div class="instruction-item">
                                        <span class="instruction-num">d.</span>
                                        <span>Upload the downloaded file below</span>
                                    </div>
                                </div>
                                
                                <!-- Visual hint image placeholder -->
                                <div class="visual-hint">
                                    <div class="hint-mockup">
                                        <div class="hint-tabs">
                                            <span class="hint-tab">First seen</span>
                                            <span class="hint-tab active">Last seen ‚úì</span>
                                        </div>
                                        <div class="hint-arrow">‚Üê Click this tab first!</div>
                                    </div>
                                </div>
                                
                                <div class="step-input-row">
                                    <input type="file" id="welcomeCsvInput" accept=".csv,text/csv,application/csv,text/plain" onchange="uploadFromWelcome(this)" class="mobile-file-input">
                                    <label for="welcomeCsvInput" class="welcome-btn secondary mobile-upload-label" id="welcomeUploadBtn">
                                        üìÑ Choose CSV File
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div id="step2Status" class="step-status"></div>
                    </div>
                </div>
            </div>
            
            <!-- Completion -->
            <div class="welcome-footer" id="welcomeFooter" style="display: none;">
                <div class="success-message">
                    <span class="success-icon">‚úÖ</span>
                    <span>You're all set! Start planning your birding trip.</span>
                </div>
                <button onclick="closeWelcomeOverlay()" class="welcome-btn primary large">
                    ü¶© Start Birding!
                </button>
            </div>
            
            <div class="welcome-skip">
                <button onclick="skipWelcome()" class="skip-btn">Skip for now (limited features)</button>
            </div>
        </div>
    </div>

    <!-- ============================================
         QUICK START MODAL
         ============================================ -->
    <div id="quickStartModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí° Quick Start Guide</h2>
                <button class="modal-close" onclick="toggleQuickStart()">√ó</button>
            </div>
            
            <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <div style="font-weight: 700; color: #92400e; margin-bottom: 10px; font-size: 1.1em;">
                    ‚ö†Ô∏è REQUIRED: Complete These 2 Steps First
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #10b981;">
                    <strong style="color: #065f46;">Step 1:</strong> Get your free API key from 
                    <a href="https://ebird.org/api/keygen" target="_blank" style="color: #10b981; font-weight: 600;">ebird.org/api/keygen</a>, 
                    then paste it and click "Connect"
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #10b981;">
                    <strong style="color: #065f46;">Step 2:</strong> Go to 
                    <a href="https://ebird.org/downloadMyData" target="_blank" style="color: #10b981; font-weight: 600;">ebird.org/downloadMyData</a>, 
                    download your <strong>World Life List</strong> CSV, then upload via Menu ‚Üí Bird Lists Manager
                </div>
            </div>
            
            <h3 style="margin: 15px 0 10px 0; color: #065f46;">üîç Search Options</h3>
            <ol>
                <li><strong>Route Search:</strong> Enter origin & destination to find birds along your driving route</li>
                <li><strong>Area Search:</strong> Search a specific location, county, state, or country</li>
                <li><strong>Species Search:</strong> Find where a specific bird has been seen recently</li>
            </ol>
            
            <h3 style="margin: 15px 0 10px 0; color: #065f46;">üó∫Ô∏è Region-Based Searching</h3>
            <ul style="margin-bottom: 15px;">
                <li>Select <strong>County/State/Country</strong> from Location Type dropdown</li>
                <li>Check <strong>"Region boundaries only"</strong> to stay within political boundaries</li>
                <li>Hotspots and checklists will only show locations within your selected region</li>
            </ul>
            
            <h3 style="margin: 15px 0 10px 0; color: #065f46;">üìã Multi-List Management (New!)</h3>
            <ul style="margin-bottom: 15px;">
                <li><strong>World Life List:</strong> Upload first - your complete birding history</li>
                <li><strong>Regional Lists:</strong> Upload state/county lists for accurate regional targets</li>
                <li><strong>Auto-Update:</strong> Your life list updates automatically when you connect (last 30 days)</li>
                <li><strong>Date Filter:</strong> Filter by date range (e.g., only count birds seen 2020-2024)</li>
            </ul>
            
            <div class="modal-tips">
                <strong>üí° Pro Tips:</strong>
                <ul>
                    <li><strong>Top 10 Hotspots</strong> show locations with most species in last 30 days</li>
                    <li><strong>Top 10 Checklists</strong> show best recent checklists in the region (total species)</li>
                    <li><strong>Target Species</strong> = birds not on your selected list (life/year/month/regional)</li>
                    <li><strong>Notable/Rare</strong> = unusual sightings flagged by eBird reviewers</li>
                    <li>Your data is saved locally - you won't need to re-upload each visit</li>
                    <li>Click any marker to add it as a waypoint to your route</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ============================================
         MAIN LAYOUT
         ============================================ -->
    <div class="main-layout">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <!-- Search Location Section -->
            <div class="section" style="padding-bottom: 15px;">
                <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                    <span style="font-size: 1.2em;">üìç</span> Search Location
                </h3>
                
                <!-- Hidden searchMode for compatibility -->
                <select id="searchMode" style="display: none;">
                    <option value="route" selected>Route</option>
                    <option value="area">Area</option>
                </select>
                
                <div class="input-group" style="margin-bottom: 12px;">
                    <div style="display: flex; gap: 8px;">
                        <button id="searchModeRoute" onclick="setSearchMode('route')" style="flex: 1; padding: 10px; border: 2px solid #10b981; background: #f0fdf4; color: #065f46; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85em;">
                            üöó Route
                        </button>
                        <button id="searchModeArea" onclick="setSearchMode('area')" style="flex: 1; padding: 10px; border: 2px solid #e5e7eb; background: white; color: #6b7280; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85em;">
                            üìç Area
                        </button>
                    </div>
                </div>
                
                <!-- Route Mode Fields -->
                <div id="routeModeFields">
                    <div class="input-group">
                        <label>Origin</label>
                        <input type="text" id="originInput" placeholder="e.g., Boston, MA">
                    </div>
                    <div class="input-group">
                        <label>Destination</label>
                        <input type="text" id="destinationInput" placeholder="e.g., Portland, ME">
                    </div>
                </div>
                
                <!-- Area Mode Fields -->
                <div id="areaModeFields" style="display: none;">
                    <div class="input-group">
                        <label>Location Type</label>
                        <select id="areaType" onchange="updateRegionSelectors()">
                            <option value="custom">Custom Location (use map)</option>
                            <option value="country">Country</option>
                            <option value="state">State/Province</option>
                            <option value="county">County</option>
                        </select>
                    </div>
                    
                    <!-- Custom Location Input (default) -->
                    <div id="customLocationInput" class="input-group">
                        <label>Location</label>
                        <input type="text" id="areaInput" placeholder="e.g., Boston, MA or Central Park">
                    </div>
                    
                    <!-- Country Selector -->
                    <div id="countrySelector" class="input-group" style="display: none;">
                        <label>Select Country</label>
                        <select id="countrySelect" onchange="onCountrySelected()">
                            <option value="">-- Select a Country --</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="MX">Mexico</option>
                            <option value="GB">United Kingdom</option>
                            <option value="AU">Australia</option>
                            <option value="CR">Costa Rica</option>
                            <option value="PA">Panama</option>
                            <option value="CO">Colombia</option>
                            <option value="EC">Ecuador</option>
                            <option value="PE">Peru</option>
                            <option value="BR">Brazil</option>
                            <option value="AR">Argentina</option>
                            <option value="CL">Chile</option>
                            <option value="ZA">South Africa</option>
                            <option value="KE">Kenya</option>
                            <option value="TZ">Tanzania</option>
                            <option value="IN">India</option>
                            <option value="TH">Thailand</option>
                            <option value="JP">Japan</option>
                            <option value="NZ">New Zealand</option>
                        </select>
                        <input type="hidden" id="selectedRegionCode" value="">
                    </div>
                    
                    <!-- State/Province Selector -->
                    <div id="stateSelector" class="input-group" style="display: none;">
                        <label>Select State/Province</label>
                        <select id="stateCountrySelect" onchange="loadStatesForCountry()">
                            <option value="">-- First, select a country --</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="MX">Mexico</option>
                            <option value="AU">Australia</option>
                        </select>
                        <select id="stateSelect" style="margin-top: 8px;" onchange="onStateSelected()">
                            <option value="">-- Select a State/Province --</option>
                        </select>
                    </div>
                    
                    <!-- County Selector -->
                    <div id="countySelector" class="input-group" style="display: none;">
                        <label>Select County</label>
                        <select id="countyStateSelect" onchange="loadCountiesForState()">
                            <option value="">-- First, select a state --</option>
                        </select>
                        <select id="countySelect" style="margin-top: 8px; display: none;" onchange="onCountySelected()">
                            <option value="">-- Select a County --</option>
                        </select>
                        <div id="countyLoading" style="display: none; margin-top: 8px; font-size: 0.85em; color: var(--text-secondary);">
                            ‚è≥ Loading counties...
                        </div>
                    </div>
                    
                    <!-- Selected Region Display -->
                    <div id="selectedRegionDisplay" style="display: none; margin-top: 10px; padding: 12px; background: #f0fdf4; border: 1px solid #10b981; border-radius: 8px;">
                        <div style="font-size: 0.85em; color: #065f46; font-weight: 600;">‚úÖ Selected Region:</div>
                        <div id="selectedRegionName" style="font-size: 1em; color: #047857; margin-top: 4px;"></div>
                        <div id="selectedRegionCodeDisplay" style="font-size: 0.75em; color: #6b7280; margin-top: 2px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Search Settings Section (Collapsible) -->
            <div class="section" style="padding: 15px; background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); border: 1px solid #c4b5fd;">
                <div onclick="toggleSettingsPanel()" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 8px; color: #5b21b6;">
                        <span>‚öôÔ∏è</span> Search Settings
                    </h3>
                    <span id="settingsToggle" style="font-size: 1.2em; color: #7c3aed; font-weight: bold;">‚àí</span>
                </div>
                
                <div id="settingsContent" style="margin-top: 15px;">
                    <!-- Quick Settings Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                        <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <label style="font-size: 0.8em; color: #6b7280; display: block; margin-bottom: 6px;">üìç Radius (miles)</label>
                            <input type="number" id="searchRadius" value="15" min="1" max="100" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1em;">
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <label style="font-size: 0.8em; color: #6b7280; display: block; margin-bottom: 6px;">üìÖ Time Range</label>
                            <select id="timeRange" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                                <option value="1">1 day</option>
                                <option value="3">3 days</option>
                                <option value="7" selected>7 days</option>
                                <option value="14">14 days</option>
                                <option value="30">30 days</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Target Filter -->
                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 15px;">
                        <label style="font-size: 0.8em; color: #6b7280; display: block; margin-bottom: 6px;">üéØ Target Filter</label>
                        <select id="targetListType" onchange="handleTargetFilterChange()" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                            <option value="all">Show All Species</option>
                            <option value="life">Life List Targets</option>
                            <option value="year" selected>Year List Targets</option>
                            <option value="month">Month List Targets</option>
                            <option value="regional">Regional Lists</option>
                            <option value="notable">Notable/Rare</option>
                        </select>
                        
                        <!-- Regional Multi-Select -->
                        <div id="regionalMultiSelect" style="display: none; margin-top: 10px; background: #f0fdf4; padding: 12px; border-radius: 8px; border: 1px solid #10b981;">
                            <div style="font-weight: 600; color: #065f46; margin-bottom: 8px; font-size: 0.85em;">üìã Select Regional Lists:</div>
                            <div id="regionalCheckboxes" style="max-height: 150px; overflow-y: auto;"></div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #10b981;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.8em; color: #065f46;">
                                    <input type="checkbox" id="includeWorldList" onchange="applyTargetFilter()" style="width: 14px; height: 14px;">
                                    <span>üåç Also exclude World Life List</span>
                                </label>
                            </div>
                            <button onclick="applyTargetFilter()" style="margin-top: 8px; width: 100%; background: #10b981; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em;">
                                Apply Filter
                            </button>
                        </div>
                    </div>
                    
                    <!-- Advanced Options (collapsed by default) -->
                    <div style="border-top: 1px dashed #c4b5fd; padding-top: 12px;">
                        <div onclick="toggleAdvancedSettings()" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <span style="font-size: 0.85em; color: #5b21b6; font-weight: 600;">üîß Advanced Options</span>
                            <span id="advancedToggle" style="color: #7c3aed;">+</span>
                        </div>
                        <div id="advancedSettings" style="display: none; margin-top: 10px;">
                            <!-- Region Only Mode -->
                            <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb; margin-bottom: 10px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="regionOnlyMode" onchange="toggleRegionOnlyMode()" style="width: 16px; height: 16px;">
                                    <span style="font-size: 0.85em; color: #374151;">Region boundaries only</span>
                                </label>
                                <div style="font-size: 0.75em; color: #6b7280; margin-top: 4px; margin-left: 24px;">
                                    Stays within state/county boundaries
                                </div>
                            </div>
                            
                            <!-- Map Layers -->
                            <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb; margin-bottom: 10px;">
                                <div style="font-size: 0.85em; color: #374151; font-weight: 600; margin-bottom: 8px;">üó∫Ô∏è Map Layers</div>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 6px;">
                                    <input type="checkbox" id="showHotspots" onchange="toggleHotspots()" checked style="width: 14px; height: 14px;">
                                    <span style="font-size: 0.8em;">Show Top 10 Hotspots</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="showChecklists" onchange="toggleChecklists()" checked style="width: 14px; height: 14px;">
                                    <span style="font-size: 0.8em;">Show Top 10 Checklists</span>
                                </label>
                            </div>
                            
                            <!-- Date Filter for Life List -->
                            <div style="background: #fefce8; padding: 10px; border-radius: 6px; border: 1px solid #fcd34d;">
                                <div onclick="toggleDateFilter()" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                                    <span style="font-size: 0.85em; color: #854d0e; font-weight: 600;">üìÖ Life List Date Filter</span>
                                    <span id="dateFilterToggle" style="color: #f59e0b; font-size: 0.85em;">+ Add</span>
                                </div>
                                <div id="dateFilterInputs" style="display: none; margin-top: 10px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                        <div>
                                            <label style="font-size: 0.7em; display: block; margin-bottom: 2px; color: #854d0e;">Start</label>
                                            <input type="date" id="dateRangeStart" style="width: 100%; padding: 6px; border: 1px solid #fcd34d; border-radius: 4px; font-size: 0.8em;">
                                        </div>
                                        <div>
                                            <label style="font-size: 0.7em; display: block; margin-bottom: 2px; color: #854d0e;">End</label>
                                            <input type="date" id="dateRangeEnd" style="width: 100%; padding: 6px; border: 1px solid #fcd34d; border-radius: 4px; font-size: 0.8em;">
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="applyDateRangeFilter()" style="flex: 1; background: #f59e0b; color: white; border: none; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: 600;">
                                            Apply
                                        </button>
                                        <button onclick="clearDateRangeFilter()" style="flex: 1; background: #6b7280; color: white; border: none; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                                            Clear
                                        </button>
                                    </div>
                                </div>
                                <div id="dateFilterStatus" style="display: none; margin-top: 8px; font-size: 0.8em; color: #854d0e;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Search Button -->
            <div class="section" style="padding: 15px;">
                <button class="primary-btn" onclick="performSearch()" style="width: 100%; padding: 14px; font-size: 1.1em;">
                    üîç Find Birds
                </button>
                
                <!-- Loading Indicator -->
                <div id="loadingIndicator" style="display: none; margin-top: 15px; text-align: center; padding: 15px; background: #f0fdf4; border-radius: 8px; border: 2px solid #10b981;">
                    <div style="font-size: 2em; animation: fly 2s ease-in-out infinite;">ü¶©</div>
                    <div style="margin-top: 8px; font-weight: 600; color: #065f46;">Finding birds...</div>
                    <div style="margin-top: 4px; font-size: 0.85em; color: #047857;" id="loadingStatus">Searching...</div>
                </div>
                
                <div id="routeDuration" class="route-duration hidden">
                    Duration: <span id="durationText">--</span>
                </div>
                
                <!-- Hidden legacy elements -->
                <div id="layersSection" style="display: none;"></div>
                <select id="hotspotTimeRange" style="display: none;">
                    <option value="30" selected>Last 30 days</option>
                </select>
                
                <button class="secondary-btn hidden" id="printBtn" onclick="printDirections()">üñ®Ô∏è Print Directions</button>
                <button class="secondary-btn hidden" id="navBtn" onclick="showNavigationModal()" style="background: #4285f4; border-color: #4285f4; margin-top: 8px;">üì± Send to Phone / Navigate</button>
                
                <div id="waypointList" class="waypoint-list"></div>
            </div>

            <!-- Target Species Search -->
            <div class="section" id="speciesSearchSection">
                <h3>üîç Search Specific Species</h3>
                <div class="input-group">
                    <label>Species Name or Code <span style="font-size: 0.75em; color: var(--text-secondary);">(type to see suggestions)</span></label>
                    <input type="text" id="speciesSearch" list="speciesList" placeholder="e.g., Scarlet Tanager or SCTA" oninput="filterSpecies(this.value)">
                    <datalist id="speciesList"></datalist>
                </div>
                <div class="input-group">
                    <label>Location (optional)</label>
                    <input type="text" id="speciesLocation" placeholder="City, County, or State">
                </div>
                <div class="input-group">
                    <label>Search Radius (miles)</label>
                    <input type="number" id="speciesSearchRadius" value="25" min="1" max="100" placeholder="Enter miles">
                    <div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 4px;">
                        How far from the location to search (max 31 miles)
                    </div>
                </div>
                <div class="input-group">
                    <label>Time Range</label>
                    <select id="speciesTimeRange">
                        <option value="7">Last 7 days</option>
                        <option value="14">Last 14 days</option>
                        <option value="30" selected>Last 30 days (API max)</option>
                    </select>
                    <div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 4px;">
                        eBird API limit: max 30 days
                    </div>
                </div>
                <button class="primary-btn" onclick="searchSpecies()">üîç Search Species</button>
            </div>

            <!-- Reset Button -->
            <div class="section" id="resetSection" style="display: none;">
                <button class="secondary-btn" onclick="resetAll()">üîÑ Reset All</button>
            </div>
        </div>

        <!-- MAP CONTAINER -->
        <div class="map-container">
            <div id="map">
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f9fafb;">
                    <div style="text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 3em; margin-bottom: 10px;">üó∫Ô∏è</div>
                        <div style="font-size: 1.2em; font-weight: 600;">Loading Map...</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">Please wait a moment</div>
                    </div>
                </div>
            </div>
            
            <!-- Floating Legend -->
            <div class="map-legend">
                <div class="legend-header" onclick="toggleLegend()">
                    <h4>Map Legend</h4>
                    <span class="legend-toggle" id="legendToggle">‚àí</span>
                </div>
                <div class="legend-content" id="legendContent">
                    <!-- Marker Style Toggle - Tab Style -->
                    <div class="legend-toggle-group">
                        <button id="btnTargetStyle" onclick="setMarkerStyle('default')" class="legend-style-btn active">
                            <span class="btn-icon">üéØ</span>
                            <span class="btn-label">Target Status</span>
                        </button>
                        <button id="btnABAStyle" onclick="setMarkerStyle('aba')" class="legend-style-btn">
                            <span class="btn-icon">üìä</span>
                            <span class="btn-label">ABA Rarity</span>
                        </button>
                    </div>
                    
                    <!-- Default Target Type Legend -->
                    <div id="defaultLegend">
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #ef4444;"></div>
                            <span>Target Species</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #a855f7;"></div>
                            <span>Notable/Rare</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #10b981;"></div>
                            <span>Already Seen</span>
                        </div>
                    </div>
                    
                    <!-- ABA Rarity Legend with filters (hidden by default) -->
                    <div id="abaLegend" style="display: none;">
                        <div style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 8px;">Filter by rarity code:</div>
                        <label class="aba-filter-item">
                            <input type="checkbox" id="abaFilter1" checked onchange="applyABAFilter()">
                            <div class="legend-dot" style="background: #22c55e;"></div>
                            <span>Code 1 - Common</span>
                        </label>
                        <label class="aba-filter-item">
                            <input type="checkbox" id="abaFilter2" checked onchange="applyABAFilter()">
                            <div class="legend-dot" style="background: #eab308;"></div>
                            <span>Code 2 - Uncommon</span>
                        </label>
                        <label class="aba-filter-item">
                            <input type="checkbox" id="abaFilter3" checked onchange="applyABAFilter()">
                            <div class="legend-dot" style="background: #f97316;"></div>
                            <span>Code 3 - Rare</span>
                        </label>
                        <label class="aba-filter-item">
                            <input type="checkbox" id="abaFilter4" checked onchange="applyABAFilter()">
                            <div class="legend-dot" style="background: #ef4444;"></div>
                            <span>Code 4 - Very Rare</span>
                        </label>
                        <label class="aba-filter-item">
                            <input type="checkbox" id="abaFilter5" checked onchange="applyABAFilter()">
                            <div class="legend-dot" style="background: #8b5cf6;"></div>
                            <span>Code 5 - Mega Rare</span>
                        </label>
                        <label class="aba-filter-item">
                            <input type="checkbox" id="abaFilter6" checked onchange="applyABAFilter()">
                            <div class="legend-dot" style="background: #1f2937;"></div>
                            <span>Code 6 - Extirpated</span>
                        </label>
                        <div style="margin-top: 8px; display: flex; gap: 4px;">
                            <button onclick="selectAllABA(true)" class="aba-quick-btn">All</button>
                            <button onclick="selectAllABA(false)" class="aba-quick-btn">None</button>
                            <button onclick="selectRareABA()" class="aba-quick-btn">Rare+</button>
                        </div>
                    </div>
                    
                    <!-- Locations -->
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                        <div class="legend-item">
                            <div class="legend-numbered" style="background: #3b82f6;">1</div>
                            <span>Top 10 Hotspots</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-numbered" style="background: #8b5cf6;">1</div>
                            <span>Top 10 Checklists</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         BELOW MAP PANELS
         ============================================ -->
    <div class="below-map" id="belowMap">
        <!-- Dashboard Tiles Row - only shows after search -->
        <div id="dashboardTiles" style="display: none; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; padding: 0 10px;">
            <!-- Tiles will be populated by JS -->
        </div>
        
        <!-- Report Buttons - only shows after search -->
        <div id="reportButtonsRow" style="display: none; padding: 0 10px 15px 10px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <button onclick="openPrintableReport('route')" class="report-btn" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    üñ®Ô∏è <span>Print Route Checklist</span>
                </button>
                <button onclick="openPrintableReport('species')" class="report-btn" style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    üìä <span>View Species Report</span>
                </button>
                <button onclick="exportSearchResults()" class="report-btn" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    üì• <span>Export CSV</span>
                </button>
            </div>
        </div>
        
        <div class="panels-container">
            <!-- Target Species Panel - only shows after search -->
            <div class="panel" id="targetPanelWrapper" style="display: none;">
                <div class="panel-header" onclick="togglePanel('targetPanel')">
                    <h3>üéØ Target Species</h3>
                    <span class="panel-toggle" id="targetPanelToggle">+</span>
                </div>
                <div class="panel-summary">
                    <span id="targetCount">0</span> species you haven't seen
                    <div id="targetDateRange" style="font-size: 0.75em; color: var(--text-secondary); margin-top: 2px;"></div>
                </div>
                <div class="panel-content" id="targetPanelContent">
                    <div id="targetList"></div>
                </div>
            </div>

            <!-- Sightings Panel - only shows after search -->
            <div class="panel" id="sightingsPanelWrapper" style="display: none;">
                <div class="panel-header" onclick="togglePanel('sightingsPanel')">
                    <h3>üìç Recent Sightings</h3>
                    <span class="panel-toggle" id="sightingsPanelToggle">+</span>
                </div>
                <div class="panel-summary">
                    <span id="sightingsCount">0</span> species reported
                    <div id="sightingsDateRange" style="font-size: 0.75em; color: var(--text-secondary); margin-top: 2px;"></div>
                </div>
                <div class="panel-content" id="sightingsPanelContent">
                    <div id="sightingsList"></div>
                </div>
            </div>

            <!-- Stats Panel - only shows after search -->
            <div class="panel" id="statsPanelWrapper" style="display: none;">
                <div class="panel-header" onclick="togglePanel('statsPanel')">
                    <h3>üìä Area Statistics</h3>
                    <span class="panel-toggle" id="statsPanelToggle">+</span>
                </div>
                <div class="panel-summary">
                    Your stats vs area overall
                    <div id="statsDateRange" style="font-size: 0.75em; color: var(--text-secondary); margin-top: 2px;"></div>
                </div>
                <div class="panel-content" id="statsPanelContent">
                    <div id="statsDisplay"></div>
                </div>
            </div>
            
            <!-- Your Lists Panel - ALWAYS VISIBLE -->
            <div class="panel">
                <div class="panel-header" onclick="togglePanel('listsPanel')">
                    <h3>üìã Your Bird Lists</h3>
                    <span class="panel-toggle" id="listsPanelToggle">+</span>
                </div>
                <div class="panel-summary">
                    <span id="listsActiveCount">0</span> lists uploaded
                </div>
                <div class="panel-content" id="listsPanelContent">
                    <div id="listsStatsDisplay"></div>
                </div>
            </div>

            <!-- Top eBirders Panel -->
            <div class="panel">
                <div class="panel-header" onclick="togglePanel('topEBirdersPanel')">
                    <h3>üèÜ Top Regional eBirders</h3>
                    <span class="panel-toggle" id="topEBirdersPanelToggle">+</span>
                </div>
                <div class="panel-summary">
                    <span id="topEBirdersSummary">View rankings on eBird</span>
                </div>
                <div class="panel-content" id="topEBirdersPanelContent" style="padding: 15px;">
                    <div id="topEBirdersDisplay">
                        <div style="text-align: center; color: var(--text-secondary); padding: 10px;">
                            Search a region to see Top 100 link
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         JAVASCRIPT
         ============================================ -->
    <script>
        console.log('üöÄ Traveling Birder v7.5 Starting');

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let map;
        let directionsService;
        let directionsRenderer;
        let originAutocomplete;
        let destinationAutocomplete;
        let areaAutocomplete;
        let speciesLocationAutocomplete;
        
        let ebirdAuthenticated = false;
        let userApiKey = '';
        let userName = '';
        let userList = new Set();
        
        // V7.0 FEATURES - GLOBAL STATE
        let userLifeListSource = 'api'; // 'api', 'csv', or 'manual'
        let darkModeEnabled = false;

        // localStorage keys
        const STORAGE_KEYS = {
            LIFE_LIST: 'travelingBirder_lifeList',
            SETTINGS: 'travelingBirder_settings',
            API_KEY: 'travelingBirder_apiKey',
            TERMS: 'travelingBirder_termsAccepted'
        };
        
        let currentRoute = null;
        let tripWaypoints = [];
        let routeDuration = '';
        
        let allObservations = []; // NEW: Unfiltered raw observations for checklists/hotspots
        let allSightings = [];
        let allHotspots = [];
        let allChecklists = [];
        let targetSpecies = [];
        let expectedTargets = []; // Seasonal expected targets
        let notableTargets = []; // Rare/notable targets
        let targetFrequencies = new Map(); // Species -> frequency data
        
        let markersArray = [];
        let hotspotsArray = [];
        let checklistsArray = [];
        
        // Save/Share Routes
        let savedRoutes = [];
        let currentWaypoints = [];

        // ============================================
        // MAP INITIALIZATION
        // ============================================
        function realInitMap() {
            console.log('üó∫Ô∏è realInitMap() called');
            
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('‚ùå Map element not found');
                return;
            }

            // Clear loading message
            mapElement.innerHTML = '';

            try {
                map = new google.maps.Map(mapElement, {
                    center: { lat: 39.8283, lng: -98.5795 }, // Center of USA
                    zoom: 4,
                    mapTypeControl: true,
                    streetViewControl: false,
                    fullscreenControl: true
                });

                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: false,
                    polylineOptions: {
                        strokeColor: '#10b981',
                        strokeWeight: 4
                    }
                });

                // Initialize autocompletes
                initializeAutocompletes();
                
                // Initialize bird lists system
                initBirdLists();

                console.log('‚úÖ Map initialized successfully');
                console.log('‚úÖ Autocomplete fields ready');
            } catch (error) {
                console.error('‚ùå Error initializing map:', error);
                mapElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #fef2f2; color: #991b1b; padding: 20px; text-align: center;"><div><div style="font-size: 2em; margin-bottom: 10px;">‚ö†Ô∏è</div><div style="font-weight: 600;">Map Failed to Load</div><div style="font-size: 0.9em; margin-top: 5px;">Please refresh the page</div></div></div>';
            }
        }

        // Wait for page to load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üìÑ DOM Content Loaded');
                if (mapInitPending && typeof realInitMap === 'function') {
                    realInitMap();
                } else {
                    console.log('‚è≥ Waiting for Google Maps API...');
                    // Retry after a delay if API not ready
                    setTimeout(function() {
                        if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                            console.log('‚úÖ Google Maps API loaded, initializing map...');
                            realInitMap();
                        } else {
                            console.error('‚ùå Google Maps API failed to load');
                        }
                    }, 1000);
                }
            });
        } else {
            console.log('üìÑ DOM already loaded');
            if (mapInitPending && typeof realInitMap === 'function') {
                realInitMap();
            } else {
                // Retry initialization
                setTimeout(function() {
                    if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                        console.log('‚úÖ Google Maps API loaded (delayed), initializing map...');
                        realInitMap();
                    }
                }, 1000);
            }
        }

        // ============================================
        // AUTOCOMPLETE INITIALIZATION
        // ============================================
        function initializeAutocompletes() {
            const originInput = document.getElementById('originInput');
            const destinationInput = document.getElementById('destinationInput');
            const areaInput = document.getElementById('areaInput');
            const speciesLocationInput = document.getElementById('speciesLocation');

            if (originInput) {
                originAutocomplete = new google.maps.places.Autocomplete(originInput, {
                    types: ['geocode']
                });
            }

            if (destinationInput) {
                destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput, {
                    types: ['geocode']
                });
            }

            if (areaInput) {
                areaAutocomplete = new google.maps.places.Autocomplete(areaInput, {
                    types: ['geocode']
                });
            }

            if (speciesLocationInput) {
                speciesLocationAutocomplete = new google.maps.places.Autocomplete(speciesLocationInput, {
                    types: ['geocode']
                });
            }
            
            // Load eBird taxonomy for species autocomplete
            loadEBirdTaxonomy();
        }

        // ============================================
        // SEARCH MODE TOGGLE
        // ============================================
        function toggleSearchMode() {
            const mode = document.getElementById('searchMode')?.value || 'route';
            setSearchMode(mode);
        }
        
        function setSearchMode(mode) {
            const routeFields = document.getElementById('routeModeFields');
            const areaFields = document.getElementById('areaModeFields');
            const routeBtn = document.getElementById('searchModeRoute');
            const areaBtn = document.getElementById('searchModeArea');
            
            // Update hidden select for compatibility
            const searchModeSelect = document.getElementById('searchMode');
            if (searchModeSelect) searchModeSelect.value = mode;
            
            if (mode === 'route') {
                if (routeFields) routeFields.style.display = 'block';
                if (areaFields) areaFields.style.display = 'none';
                if (routeBtn) {
                    routeBtn.style.background = '#f0fdf4';
                    routeBtn.style.borderColor = '#10b981';
                    routeBtn.style.color = '#065f46';
                }
                if (areaBtn) {
                    areaBtn.style.background = 'white';
                    areaBtn.style.borderColor = '#e5e7eb';
                    areaBtn.style.color = '#6b7280';
                }
            } else {
                if (routeFields) routeFields.style.display = 'none';
                if (areaFields) areaFields.style.display = 'block';
                if (areaBtn) {
                    areaBtn.style.background = '#f0fdf4';
                    areaBtn.style.borderColor = '#10b981';
                    areaBtn.style.color = '#065f46';
                }
                if (routeBtn) {
                    routeBtn.style.background = 'white';
                    routeBtn.style.borderColor = '#e5e7eb';
                    routeBtn.style.color = '#6b7280';
                }
            }
        }
        
        // Make functions globally accessible
        window.toggleSearchMode = toggleSearchMode;
        window.setSearchMode = setSearchMode;
        
        // Toggle settings panel
        function toggleSettingsPanel() {
            const content = document.getElementById('settingsContent');
            const toggle = document.getElementById('settingsToggle');
            if (content && toggle) {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    toggle.textContent = '‚àí';
                } else {
                    content.style.display = 'none';
                    toggle.textContent = '+';
                }
            }
        }
        window.toggleSettingsPanel = toggleSettingsPanel;
        
        // Toggle advanced settings
        function toggleAdvancedSettings() {
            const content = document.getElementById('advancedSettings');
            const toggle = document.getElementById('advancedToggle');
            if (content && toggle) {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    toggle.textContent = '‚àí';
                } else {
                    content.style.display = 'none';
                    toggle.textContent = '+';
                }
            }
        }
        window.toggleAdvancedSettings = toggleAdvancedSettings;

        // ============================================
        // EBIRD TAXONOMY FOR SPECIES AUTOCOMPLETE
        // ============================================
        let ebirdTaxonomy = [];
        
        async function loadEBirdTaxonomy() {
            try {
                // Fetch eBird taxonomy (subset of common species with codes)
                console.log('üìö Loading eBird species taxonomy...');
                
                // Create a common species database with codes
                ebirdTaxonomy = [
                    { name: 'Snow Goose', code: 'SNGO' },
                    { name: 'Canada Goose', code: 'CANG' },
                    { name: 'Wood Duck', code: 'WODU' },
                    { name: 'Mallard', code: 'MALL' },
                    { name: 'Northern Pintail', code: 'NOPI' },
                    { name: 'Blue-winged Teal', code: 'BWTE' },
                    { name: 'Northern Shoveler', code: 'NSHO' },
                    { name: 'Green-winged Teal', code: 'GWTE' },
                    { name: 'Ring-necked Duck', code: 'RNDU' },
                    { name: 'Greater Scaup', code: 'GRSC' },
                    { name: 'Lesser Scaup', code: 'LESC' },
                    { name: 'Common Goldeneye', code: 'COGO' },
                    { name: 'Hooded Merganser', code: 'HOME' },
                    { name: 'Common Merganser', code: 'COME' },
                    { name: 'Red-breasted Merganser', code: 'RBME' },
                    { name: 'Wild Turkey', code: 'WITU' },
                    { name: 'Northern Bobwhite', code: 'NOBO' },
                    { name: 'Common Loon', code: 'COLO' },
                    { name: 'Pied-billed Grebe', code: 'PBGR' },
                    { name: 'Double-crested Cormorant', code: 'DCCO' },
                    { name: 'American White Pelican', code: 'AWPE' },
                    { name: 'Great Blue Heron', code: 'GBHE' },
                    { name: 'Great Egret', code: 'GREG' },
                    { name: 'Snowy Egret', code: 'SNEG' },
                    { name: 'Green Heron', code: 'GRHE' },
                    { name: 'Black-crowned Night-Heron', code: 'BCNH' },
                    { name: 'Turkey Vulture', code: 'TUVU' },
                    { name: 'Osprey', code: 'OSPR' },
                    { name: 'Bald Eagle', code: 'BAEA' },
                    { name: 'Northern Harrier', code: 'NOHA' },
                    { name: 'Sharp-shinned Hawk', code: 'SSHA' },
                    { name: 'Cooper\'s Hawk', code: 'COHA' },
                    { name: 'Red-shouldered Hawk', code: 'RSHA' },
                    { name: 'Red-tailed Hawk', code: 'RTHA' },
                    { name: 'American Kestrel', code: 'AMKE' },
                    { name: 'Merlin', code: 'MERL' },
                    { name: 'Peregrine Falcon', code: 'PEFA' },
                    { name: 'American Coot', code: 'AMCO' },
                    { name: 'Killdeer', code: 'KILL' },
                    { name: 'American Woodcock', code: 'AMWO' },
                    { name: 'Wilson\'s Snipe', code: 'WISN' },
                    { name: 'Spotted Sandpiper', code: 'SPSA' },
                    { name: 'Greater Yellowlegs', code: 'GRYE' },
                    { name: 'Lesser Yellowlegs', code: 'LEYE' },
                    { name: 'Ring-billed Gull', code: 'RBGU' },
                    { name: 'Herring Gull', code: 'HERG' },
                    { name: 'Rock Pigeon', code: 'ROPI' },
                    { name: 'Mourning Dove', code: 'MODO' },
                    { name: 'Yellow-billed Cuckoo', code: 'YBCU' },
                    { name: 'Black-billed Cuckoo', code: 'BBCU' },
                    { name: 'Eastern Screech-Owl', code: 'EASO' },
                    { name: 'Great Horned Owl', code: 'GHOW' },
                    { name: 'Barred Owl', code: 'BADO' },
                    { name: 'Common Nighthawk', code: 'CONI' },
                    { name: 'Chimney Swift', code: 'CHSW' },
                    { name: 'Ruby-throated Hummingbird', code: 'RTHU' },
                    { name: 'Belted Kingfisher', code: 'BEKI' },
                    { name: 'Red-headed Woodpecker', code: 'RHWO' },
                    { name: 'Red-bellied Woodpecker', code: 'RBWO' },
                    { name: 'Downy Woodpecker', code: 'DOWO' },
                    { name: 'Hairy Woodpecker', code: 'HAWO' },
                    { name: 'Northern Flicker', code: 'NOFL' },
                    { name: 'Pileated Woodpecker', code: 'PIWO' },
                    { name: 'Eastern Wood-Pewee', code: 'EAWP' },
                    { name: 'Least Flycatcher', code: 'LEFL' },
                    { name: 'Eastern Phoebe', code: 'EAPH' },
                    { name: 'Great Crested Flycatcher', code: 'GCFL' },
                    { name: 'Eastern Kingbird', code: 'EAKI' },
                    { name: 'White-eyed Vireo', code: 'WEVI' },
                    { name: 'Yellow-throated Vireo', code: 'YTVI' },
                    { name: 'Blue-headed Vireo', code: 'BHVI' },
                    { name: 'Warbling Vireo', code: 'WAVI' },
                    { name: 'Red-eyed Vireo', code: 'REVI' },
                    { name: 'Blue Jay', code: 'BLJA' },
                    { name: 'American Crow', code: 'AMCR' },
                    { name: 'Fish Crow', code: 'FICR' },
                    { name: 'Common Raven', code: 'CORA' },
                    { name: 'Tree Swallow', code: 'TRES' },
                    { name: 'Bank Swallow', code: 'BANS' },
                    { name: 'Barn Swallow', code: 'BARS' },
                    { name: 'Cliff Swallow', code: 'CLSW' },
                    { name: 'Carolina Chickadee', code: 'CACH' },
                    { name: 'Black-capped Chickadee', code: 'BCCH' },
                    { name: 'Tufted Titmouse', code: 'TUFT' },
                    { name: 'Red-breasted Nuthatch', code: 'RBNU' },
                    { name: 'White-breasted Nuthatch', code: 'WBNU' },
                    { name: 'Brown Creeper', code: 'BRCR' },
                    { name: 'House Wren', code: 'HOWR' },
                    { name: 'Winter Wren', code: 'WIWR' },
                    { name: 'Carolina Wren', code: 'CARW' },
                    { name: 'Blue-gray Gnatcatcher', code: 'BGGN' },
                    { name: 'Golden-crowned Kinglet', code: 'GCKI' },
                    { name: 'Ruby-crowned Kinglet', code: 'RCKI' },
                    { name: 'Eastern Bluebird', code: 'EABL' },
                    { name: 'Veery', code: 'VEER' },
                    { name: 'Gray-cheeked Thrush', code: 'GCTH' },
                    { name: 'Swainson\'s Thrush', code: 'SWTH' },
                    { name: 'Hermit Thrush', code: 'HETH' },
                    { name: 'Wood Thrush', code: 'WOTH' },
                    { name: 'American Robin', code: 'AMRO' },
                    { name: 'Gray Catbird', code: 'GRCA' },
                    { name: 'Brown Thrasher', code: 'BRTH' },
                    { name: 'Northern Mockingbird', code: 'NOMO' },
                    { name: 'European Starling', code: 'EUST' },
                    { name: 'Cedar Waxwing', code: 'CEDW' },
                    { name: 'House Sparrow', code: 'HOSP' },
                    { name: 'American Goldfinch', code: 'AMGO' },
                    { name: 'Purple Finch', code: 'PUFI' },
                    { name: 'House Finch', code: 'HOFI' },
                    { name: 'Pine Siskin', code: 'PISI' },
                    { name: 'Chipping Sparrow', code: 'CHSP' },
                    { name: 'Field Sparrow', code: 'FISP' },
                    { name: 'Dark-eyed Junco', code: 'DEJU' },
                    { name: 'White-crowned Sparrow', code: 'WCSP' },
                    { name: 'White-throated Sparrow', code: 'WTSP' },
                    { name: 'Song Sparrow', code: 'SOSP' },
                    { name: 'Swamp Sparrow', code: 'SWSP' },
                    { name: 'Eastern Towhee', code: 'EATO' },
                    { name: 'Scarlet Tanager', code: 'SCTA' },
                    { name: 'Northern Cardinal', code: 'NOCA' },
                    { name: 'Rose-breasted Grosbeak', code: 'RBGR' },
                    { name: 'Indigo Bunting', code: 'INBU' },
                    { name: 'Bobolink', code: 'BOBO' },
                    { name: 'Red-winged Blackbird', code: 'RWBL' },
                    { name: 'Eastern Meadowlark', code: 'EAME' },
                    { name: 'Common Grackle', code: 'COGR' },
                    { name: 'Brown-headed Cowbird', code: 'BHCO' },
                    { name: 'Orchard Oriole', code: 'OROR' },
                    { name: 'Baltimore Oriole', code: 'BAOR' },
                    { name: 'Ovenbird', code: 'OVEN' },
                    { name: 'Northern Waterthrush', code: 'NOWA' },
                    { name: 'Black-and-white Warbler', code: 'BAWW' },
                    { name: 'Prothonotary Warbler', code: 'PROW' },
                    { name: 'Tennessee Warbler', code: 'TEWA' },
                    { name: 'Nashville Warbler', code: 'NAWA' },
                    { name: 'Common Yellowthroat', code: 'COYE' },
                    { name: 'American Redstart', code: 'AMRE' },
                    { name: 'Cape May Warbler', code: 'CMWA' },
                    { name: 'Northern Parula', code: 'NOPA' },
                    { name: 'Magnolia Warbler', code: 'MAWA' },
                    { name: 'Bay-breasted Warbler', code: 'BBWA' },
                    { name: 'Blackburnian Warbler', code: 'BLBW' },
                    { name: 'Yellow Warbler', code: 'YEWA' },
                    { name: 'Chestnut-sided Warbler', code: 'CSWA' },
                    { name: 'Blackpoll Warbler', code: 'BLPW' },
                    { name: 'Black-throated Blue Warbler', code: 'BTBW' },
                    { name: 'Palm Warbler', code: 'PAWA' },
                    { name: 'Pine Warbler', code: 'PIWA' },
                    { name: 'Yellow-rumped Warbler', code: 'YRWA' },
                    { name: 'Black-throated Green Warbler', code: 'BTNW' },
                    { name: 'Canada Warbler', code: 'CAWA' },
                    { name: 'Wilson\'s Warbler', code: 'WIWA' }
                ];
                
                console.log(`‚úÖ Loaded ${ebirdTaxonomy.length} species with codes`);
                populateSpeciesDatalist();
            } catch (error) {
                console.error('‚ùå Error loading taxonomy:', error);
            }
        }

        function populateSpeciesDatalist() {
            const datalist = document.getElementById('speciesList');
            if (!datalist) return;
            
            datalist.innerHTML = '';
            ebirdTaxonomy.forEach(species => {
                const option = document.createElement('option');
                option.value = species.name;
                option.setAttribute('data-code', species.code);
                option.textContent = `${species.name} (${species.code})`;
                datalist.appendChild(option);
            });
        }

        function filterSpecies(value) {
            if (!value || value.length < 2) return;
            
            const datalist = document.getElementById('speciesList');
            if (!datalist) return;
            
            const searchTerm = value.toUpperCase();
            const filtered = ebirdTaxonomy.filter(species => 
                species.name.toUpperCase().includes(searchTerm) ||
                species.code.includes(searchTerm)
            );
            
            datalist.innerHTML = '';
            filtered.forEach(species => {
                const option = document.createElement('option');
                option.value = species.name;
                option.setAttribute('data-code', species.code);
                option.textContent = `${species.name} (${species.code})`;
                datalist.appendChild(option);
            });
        }

        // ============================================
        // V7.0 FEATURES - LOCALSTORAGE MANAGEMENT
        // ============================================
        
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                return false;
            }
        }

        function loadFromLocalStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return null;
            }
        }

        function saveLifeList(species, source = 'api') {
            const data = {
                species: Array.isArray(species) ? species : Array.from(species),
                source: source,
                updated: new Date().toISOString(),
                count: species.length || species.size || 0
            };
            saveToLocalStorage(STORAGE_KEYS.LIFE_LIST, data);
            userLifeListSource = source;
            console.log(`üíæ Saved ${data.count} species from ${source}`);
        }

        function loadLifeList() {
            const data = loadFromLocalStorage(STORAGE_KEYS.LIFE_LIST);
            if (data && data.species) {
                userList = new Set(data.species);
                userLifeListSource = data.source || 'api';
                console.log(`üì• Loaded ${data.count} species from ${data.source}`);
                return new Set(data.species);
            }
            return new Set();
        }

        function saveSettings(settings) {
            saveToLocalStorage(STORAGE_KEYS.SETTINGS, settings);
        }

        function loadSettings() {
            return loadFromLocalStorage(STORAGE_KEYS.SETTINGS) || {
                darkMode: false,
                defaultRadius: 15,
                defaultTimeRange: 30
            };
        }

        function toggleDarkMode() {
            darkModeEnabled = !darkModeEnabled;
            document.documentElement.setAttribute('data-theme', darkModeEnabled ? 'dark' : 'light');
            
            const settings = loadSettings();
            settings.darkMode = darkModeEnabled;
            saveSettings(settings);
            
            console.log(`üåì Dark mode: ${darkModeEnabled ? 'ON' : 'OFF'}`);
            closeAccountMenu();
        }

        // ============================================
        // V7.0 FEATURES - CSV IMPORT/EXPORT
        // ============================================
        
        function importeBirdCSV(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    reject(new Error('No file provided'));
                    return;
                }

                if (typeof Papa === 'undefined') {
                    reject(new Error('Papaparse library not loaded'));
                    return;
                }

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        try {
                            const species = new Set();
                            
                            results.data.forEach(row => {
                                const commonName = row['Common Name'] || row['Species'] || row['species'];
                                if (commonName && commonName.trim()) {
                                    species.add(commonName.trim());
                                }
                            });

                            if (species.size === 0) {
                                reject(new Error('No species found in CSV. Make sure it\'s an eBird export with a "Common Name" column.'));
                                return;
                            }

                            // Save to localStorage
                            saveLifeList(Array.from(species), 'csv');
                            userList = species;

                            console.log(`‚úÖ Imported ${species.size} species from CSV`);
                            resolve(species);
                        } catch (error) {
                            reject(error);
                        }
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }

        function exportSpeciesListCSV(species, filename = 'my-bird-list.csv') {
            const speciesArray = Array.isArray(species) ? species : Array.from(species);
            
            const csv = 'Common Name\n' + speciesArray.join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log(`üì• Exported ${speciesArray.length} species to ${filename}`);
            closeAccountMenu();
        }

        function exportCurrentSearchCSV() {
            if (!allSightings || allSightings.length === 0) {
                alert('No search results to export. Please perform a search first.');
                return;
            }

            // Get unique sightings with full details
            const sightingsMap = new Map();
            allSightings.forEach(obs => {
                const key = `${obs.comName}-${obs.locName}`;
                if (!sightingsMap.has(key)) {
                    sightingsMap.set(key, obs);
                }
            });
            
            const uniqueSightings = Array.from(sightingsMap.values());
            
            // Determine target status for each bird
            const targetList = getTargetList();
            
            // Build comprehensive CSV
            let csv = 'Common Name,Scientific Name,Location,Date Observed,Latitude,Longitude,Target Status,eBird Link\n';
            
            uniqueSightings.forEach(obs => {
                const isTarget = !targetList.has(obs.comName);
                const targetStatus = isTarget ? 'Target (not seen)' : 'Already seen';
                const ebirdLink = obs.locId ? `https://ebird.org/hotspot/${obs.locId}` : '';
                const sciName = obs.sciName || '';
                const date = obs.obsDt || '';
                
                // Escape fields that might contain commas
                const escapeCsv = (str) => {
                    if (!str) return '';
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                };
                
                csv += `${escapeCsv(obs.comName)},${escapeCsv(sciName)},${escapeCsv(obs.locName)},${date},${obs.lat},${obs.lng},${targetStatus},${ebirdLink}\n`;
            });
            
            // Add summary section
            const targetCount = uniqueSightings.filter(obs => !targetList.has(obs.comName)).length;
            const seenCount = uniqueSightings.length - targetCount;
            const uniqueLocations = new Set(uniqueSightings.map(s => s.locName)).size;
            
            csv += `\n\nSUMMARY\n`;
            csv += `Total Species,${new Set(uniqueSightings.map(s => s.comName)).size}\n`;
            csv += `Target Species,${targetCount}\n`;
            csv += `Already Seen,${seenCount}\n`;
            csv += `Unique Locations,${uniqueLocations}\n`;
            csv += `Export Date,${new Date().toLocaleDateString()}\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `traveling-birder-results-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log(`üì• Exported ${uniqueSightings.length} sightings with full details`);
            closeAccountMenu();
        }

        function exportLifeListCSV() {
            if (!userList || userList.size === 0) {
                alert('No life list to export. Please connect to eBird or import a CSV first.');
                return;
            }

            exportSpeciesListCSV(userList, 'my-life-list.csv');
        }

        // ============================================
        // GOOGLE MAPS NAVIGATION LINK
        // ============================================
        function generateGoogleMapsLink() {
            const origin = document.getElementById('originInput').value;
            const destination = document.getElementById('destinationInput').value;
            
            if (!origin || !destination) {
                alert('Please set an origin and destination first.');
                return null;
            }
            
            // Build Google Maps directions URL
            let mapsUrl = 'https://www.google.com/maps/dir/?api=1';
            mapsUrl += `&origin=${encodeURIComponent(origin)}`;
            mapsUrl += `&destination=${encodeURIComponent(destination)}`;
            mapsUrl += '&travelmode=driving';
            
            // Add waypoints if any (Google Maps supports up to 9 waypoints in URL)
            if (tripWaypoints.length > 0) {
                const waypointStops = tripWaypoints.slice(0, 9).map(wp => {
                    return `${wp.location.lat},${wp.location.lng}`;
                }).join('|');
                mapsUrl += `&waypoints=${encodeURIComponent(waypointStops)}`;
            }
            
            return mapsUrl;
        }

        function openInGoogleMaps() {
            const mapsUrl = generateGoogleMapsLink();
            if (mapsUrl) {
                window.open(mapsUrl, '_blank');
            }
        }

        function showNavigationModal() {
            const mapsUrl = generateGoogleMapsLink();
            if (!mapsUrl) return;
            
            const origin = document.getElementById('originInput').value;
            const destination = document.getElementById('destinationInput').value;
            
            // Check if waypoints exceed Google Maps limit
            const waypointWarning = tripWaypoints.length > 9 ? `
                <div style="background: #fef3c7; border: 1px solid #f59e0b; padding: 10px 12px; border-radius: 6px; margin: 10px 0; font-size: 0.85em;">
                    <strong>‚ö†Ô∏è Note:</strong> You have ${tripWaypoints.length} stops, but Google Maps navigation only supports up to 9 waypoints. 
                    The first 9 stops will be included in the navigation link. Use "Print Directions" for the complete route.
                </div>
            ` : '';
            
            const stopsText = tripWaypoints.length > 9 
                ? `üéØ ${tripWaypoints.length} birding stops (first 9 in nav)<br>`
                : tripWaypoints.length > 0 
                    ? `üéØ ${tripWaypoints.length} birding stop${tripWaypoints.length > 1 ? 's' : ''}<br>` 
                    : '';
            
            // Build email subject and body
            const emailSubject = encodeURIComponent(`Birding Trip: ${origin} to ${destination}`);
            const emailBody = encodeURIComponent(`Here's my birding trip route:\n\nFrom: ${origin}\nTo: ${destination}\n${tripWaypoints.length > 0 ? `Stops: ${tripWaypoints.length} birding locations\n` : ''}\nOpen in Google Maps:\n${mapsUrl}\n\nPlanned with Traveling Birder ü¶©`);
            const emailLink = `mailto:?subject=${emailSubject}&body=${emailBody}`;
            
            // Create modal content
            const modalHtml = `
                <div id="navigationModal" class="modal-overlay active">
                    <div class="modal" style="max-width: 500px;">
                        <span class="modal-close" onclick="closeModal('navigationModal')">&times;</span>
                        <h2>üì± Share Your Route</h2>
                        
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <p style="margin: 0 0 10px 0;"><strong>Route:</strong></p>
                            <p style="margin: 0; font-size: 0.9em; color: #065f46;">
                                üìç ${origin}<br>
                                ${stopsText}
                                üèÅ ${destination}
                            </p>
                        </div>
                        
                        ${waypointWarning}
                        
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button onclick="openInGoogleMaps(); closeModal('navigationModal');" 
                                        style="padding: 14px 16px; background: #4285f4; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.95em; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 1.2em;">üó∫Ô∏è</span> Open Maps
                                </button>
                                <button onclick="window.location.href='${emailLink}';" 
                                        style="padding: 14px 16px; background: #6366f1; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.95em; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 1.2em;">üìß</span> Email Route
                                </button>
                            </div>
                            
                            <div style="position: relative;">
                                <input type="text" id="mapsLinkInput" value="${mapsUrl}" readonly 
                                       style="width: 100%; padding: 12px; padding-right: 80px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85em; background: var(--bg-secondary); color: var(--text-primary);">
                                <button onclick="copyMapsLink()" 
                                        style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%); padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 4px; font-size: 0.85em; cursor: pointer;">
                                    üìã Copy
                                </button>
                            </div>
                            
                            <p style="font-size: 0.85em; color: var(--text-secondary); text-align: center; margin: 5px 0 0 0;">
                                Or scan the QR code with your phone
                            </p>
                            
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid var(--border-color);">
                                <div id="qrCodeContainer" style="display: inline-block;"></div>
                                <p style="font-size: 0.75em; color: #6b7280; margin: 10px 0 0 0;">Scan with your phone camera</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Generate QR code using a simple API
            const qrContainer = document.getElementById('qrCodeContainer');
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(mapsUrl)}`;
            qrContainer.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="width: 150px; height: 150px;">`;
        }

        function copyMapsLink() {
            const input = document.getElementById('mapsLinkInput');
            input.select();
            document.execCommand('copy');
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úì Copied!';
            btn.style.background = '#065f46';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '#10b981';
            }, 2000);
        }

        // ============================================
        // V7.0 FEATURES - MODAL & UI CONTROLS
        // ============================================
        
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function showTermsModal() {
            openModal('termsModal');
            closeAccountMenu();
        }

        function acceptTerms() {
            saveToLocalStorage(STORAGE_KEYS.TERMS, {
                accepted: true,
                date: new Date().toISOString()
            });
            closeModal('termsModal');
            console.log('‚úÖ Terms accepted');
        }

        // ============================================
        // MULTI-LIST MANAGEMENT SYSTEM
        // ============================================
        
        // Storage keys
        const BIRD_LISTS_KEY = 'travelingBirder_birdLists';
        const IDB_NAME = 'TravelingBirderDB';
        const IDB_VERSION = 1;
        const IDB_STORE = 'birdLists';
        
        // Store all uploaded lists
        let allBirdLists = {};
        let activeListDateFilter = null;
        let dbReady = false;
        let db = null;
        
        // ============================================
        // INDEXEDDB STORAGE (for large datasets)
        // ============================================
        
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) {
                    console.log('‚ö†Ô∏è IndexedDB not supported, using localStorage');
                    resolve(false);
                    return;
                }
                
                const request = indexedDB.open(IDB_NAME, IDB_VERSION);
                
                request.onerror = (event) => {
                    console.error('‚ùå IndexedDB error:', event.target.error);
                    resolve(false);
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    dbReady = true;
                    console.log('‚úÖ IndexedDB ready');
                    resolve(true);
                };
                
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    
                    // Create object store for bird lists
                    if (!database.objectStoreNames.contains(IDB_STORE)) {
                        const store = database.createObjectStore(IDB_STORE, { keyPath: 'key' });
                        store.createIndex('type', 'type', { unique: false });
                        console.log('üì¶ Created IndexedDB store');
                    }
                };
            });
        }
        
        // Save a single list to IndexedDB
        function saveListToIDB(key, listData) {
            return new Promise((resolve, reject) => {
                if (!dbReady || !db) {
                    resolve(false);
                    return;
                }
                
                try {
                    const transaction = db.transaction([IDB_STORE], 'readwrite');
                    const store = transaction.objectStore(IDB_STORE);
                    
                    const data = { key, ...listData };
                    const request = store.put(data);
                    
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => {
                        console.error('‚ùå Error saving to IndexedDB:', request.error);
                        resolve(false);
                    };
                } catch (e) {
                    console.error('‚ùå IndexedDB transaction error:', e);
                    resolve(false);
                }
            });
        }
        
        // Load all lists from IndexedDB
        function loadAllFromIDB() {
            return new Promise((resolve, reject) => {
                if (!dbReady || !db) {
                    resolve({});
                    return;
                }
                
                try {
                    const transaction = db.transaction([IDB_STORE], 'readonly');
                    const store = transaction.objectStore(IDB_STORE);
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        const lists = {};
                        request.result.forEach(item => {
                            const { key, ...data } = item;
                            lists[key] = data;
                        });
                        resolve(lists);
                    };
                    
                    request.onerror = () => {
                        console.error('‚ùå Error loading from IndexedDB:', request.error);
                        resolve({});
                    };
                } catch (e) {
                    console.error('‚ùå IndexedDB read error:', e);
                    resolve({});
                }
            });
        }
        
        // Delete a list from IndexedDB
        function deleteFromIDB(key) {
            return new Promise((resolve) => {
                if (!dbReady || !db) {
                    resolve(false);
                    return;
                }
                
                try {
                    const transaction = db.transaction([IDB_STORE], 'readwrite');
                    const store = transaction.objectStore(IDB_STORE);
                    const request = store.delete(key);
                    
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => resolve(false);
                } catch (e) {
                    resolve(false);
                }
            });
        }
        
        // Clear all from IndexedDB
        function clearAllFromIDB() {
            return new Promise((resolve) => {
                if (!dbReady || !db) {
                    resolve(false);
                    return;
                }
                
                try {
                    const transaction = db.transaction([IDB_STORE], 'readwrite');
                    const store = transaction.objectStore(IDB_STORE);
                    const request = store.clear();
                    
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => resolve(false);
                } catch (e) {
                    resolve(false);
                }
            });
        }
        
        // ============================================
        // UNIFIED STORAGE API (IndexedDB with localStorage fallback)
        // ============================================
        
        async function loadAllBirdLists() {
            // Try IndexedDB first
            if (dbReady) {
                const idbLists = await loadAllFromIDB();
                if (Object.keys(idbLists).length > 0) {
                    allBirdLists = idbLists;
                    const keys = Object.keys(allBirdLists);
                    console.log(`üìã Loaded ${keys.length} bird lists from IndexedDB`);
                    return allBirdLists;
                }
            }
            
            // Fallback to localStorage
            const stored = localStorage.getItem(BIRD_LISTS_KEY);
            if (stored) {
                try {
                    allBirdLists = JSON.parse(stored);
                    const keys = Object.keys(allBirdLists);
                    console.log(`üìã Loaded ${keys.length} bird lists from localStorage: ${keys.join(', ')}`);
                    
                    // Migrate to IndexedDB if available
                    if (dbReady && keys.length > 0) {
                        console.log('üîÑ Migrating lists to IndexedDB...');
                        for (const [key, list] of Object.entries(allBirdLists)) {
                            await saveListToIDB(key, list);
                        }
                        // Clear localStorage after migration
                        localStorage.removeItem(BIRD_LISTS_KEY);
                        console.log('‚úÖ Migration to IndexedDB complete');
                    }
                } catch (e) {
                    console.error('‚ùå Error loading bird lists:', e);
                    allBirdLists = {};
                }
            } else {
                console.log('üìã No bird lists in storage');
            }
            return allBirdLists;
        }
        
        async function saveAllBirdLists() {
            const listCount = Object.keys(allBirdLists).length;
            
            // Try IndexedDB first (preferred for large data)
            if (dbReady) {
                try {
                    for (const [key, list] of Object.entries(allBirdLists)) {
                        await saveListToIDB(key, list);
                    }
                    console.log(`üíæ Saved ${listCount} bird lists to IndexedDB`);
                    return;
                } catch (e) {
                    console.error('‚ùå IndexedDB save failed, falling back to localStorage:', e);
                }
            }
            
            // Fallback to localStorage
            try {
                const data = JSON.stringify(allBirdLists);
                const sizeKB = (data.length / 1024).toFixed(1);
                console.log(`üíæ Saving ${listCount} bird lists to localStorage (${sizeKB} KB)`);
                localStorage.setItem(BIRD_LISTS_KEY, data);
            } catch (e) {
                console.error('‚ùå Error saving bird lists:', e);
                // If quota exceeded, try saving without speciesWithDates for regional lists
                if (e.name === 'QuotaExceededError') {
                    console.log('‚ö†Ô∏è Storage quota exceeded, trying to save without date details for regional lists...');
                    const trimmedLists = {};
                    for (const [key, list] of Object.entries(allBirdLists)) {
                        if (key === 'world') {
                            trimmedLists[key] = list; // Keep world list intact
                        } else {
                            // Remove speciesWithDates from regional lists to save space
                            trimmedLists[key] = { ...list, speciesWithDates: {} };
                        }
                    }
                    try {
                        localStorage.setItem(BIRD_LISTS_KEY, JSON.stringify(trimmedLists));
                        console.log('‚úÖ Saved trimmed bird lists (without regional date details)');
                    } catch (e2) {
                        console.error('‚ùå Still cannot save:', e2);
                        alert('Unable to save your bird lists. Your browser storage may be full. Try clearing some browser data.');
                    }
                }
            }
        }
        
        // Delete a specific list
        async function deleteList(key) {
            delete allBirdLists[key];
            
            if (dbReady) {
                await deleteFromIDB(key);
            }
            
            await saveAllBirdLists();
        }
        
        function updateListTypeHelp() {
            const listType = document.getElementById('uploadListType').value;
            const helpDiv = document.getElementById('listTypeHelp');
            const regionSelector = document.getElementById('uploadRegionSelector');
            const countrySelect = document.getElementById('uploadCountrySelect');
            const stateSelect = document.getElementById('uploadStateSelect');
            const countySelect = document.getElementById('uploadCountySelect');
            const customInput = document.getElementById('uploadCustomRegion');
            
            // Hide all region selectors first
            regionSelector.style.display = 'none';
            countrySelect.style.display = 'none';
            stateSelect.style.display = 'none';
            countySelect.style.display = 'none';
            customInput.style.display = 'none';
            
            switch(listType) {
                case 'world':
                    helpDiv.innerHTML = 'üí° <strong>World Life List:</strong> Download from <a href="https://ebird.org/downloadMyData" target="_blank" style="color: #1e40af;">ebird.org/downloadMyData</a> ‚Üí Select "Life List" (no region filter)';
                    break;
                case 'country':
                    helpDiv.innerHTML = 'üí° <strong>Country List:</strong> Download from eBird with Region set to your target country';
                    regionSelector.style.display = 'block';
                    countrySelect.style.display = 'block';
                    break;
                case 'state':
                    helpDiv.innerHTML = 'üí° <strong>State List:</strong> Download from eBird with Region set to your target state/province';
                    regionSelector.style.display = 'block';
                    countrySelect.style.display = 'block';
                    stateSelect.style.display = 'block';
                    break;
                case 'county':
                    helpDiv.innerHTML = 'üí° <strong>County List:</strong> Download from eBird with Region set to your target county';
                    regionSelector.style.display = 'block';
                    countrySelect.style.display = 'block';
                    stateSelect.style.display = 'block';
                    countySelect.style.display = 'block';
                    break;
                case 'custom':
                    helpDiv.innerHTML = 'üí° <strong>Custom Region:</strong> Enter a name for this list (e.g., "Southeast Arizona" or "Big Year 2024")';
                    regionSelector.style.display = 'block';
                    customInput.style.display = 'block';
                    break;
            }
        }
        
        function loadUploadStates() {
            const country = document.getElementById('uploadCountrySelect').value;
            const stateSelect = document.getElementById('uploadStateSelect');
            
            stateSelect.innerHTML = '<option value="">-- Select State --</option>';
            
            if (country === 'other') {
                document.getElementById('uploadCustomRegion').style.display = 'block';
                return;
            }
            
            let states = [];
            switch(country) {
                case 'US': states = US_STATES; break;
                case 'CA': states = CA_PROVINCES; break;
                case 'MX': states = MX_STATES; break;
                case 'AU': states = AU_STATES; break;
            }
            
            states.forEach(state => {
                stateSelect.innerHTML += `<option value="${state.code}">${state.name}</option>`;
            });
        }
        
        async function loadUploadCounties() {
            const stateCode = document.getElementById('uploadStateSelect').value;
            const countySelect = document.getElementById('uploadCountySelect');
            
            if (!stateCode || !userApiKey) {
                countySelect.innerHTML = '<option value="">-- Select state first --</option>';
                return;
            }
            
            countySelect.innerHTML = '<option value="">Loading counties...</option>';
            
            try {
                const url = `https://api.ebird.org/v2/ref/region/list/subnational2/${stateCode}`;
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });
                
                if (response.ok) {
                    const counties = await response.json();
                    countySelect.innerHTML = '<option value="">-- Select County --</option>';
                    counties.forEach(county => {
                        countySelect.innerHTML += `<option value="${county.code}">${county.name}</option>`;
                    });
                }
            } catch (e) {
                countySelect.innerHTML = '<option value="">Error loading counties</option>';
            }
        }
        
        function getSelectedRegionInfo() {
            const listType = document.getElementById('uploadListType').value;
            
            switch(listType) {
                case 'world':
                    return { code: 'world', name: 'World Life List', type: 'world' };
                case 'country':
                    const countryEl = document.getElementById('uploadCountrySelect');
                    if (!countryEl.value) return null;
                    return { 
                        code: countryEl.value, 
                        name: countryEl.options[countryEl.selectedIndex].text,
                        type: 'country'
                    };
                case 'state':
                    const stateEl = document.getElementById('uploadStateSelect');
                    if (!stateEl.value) return null;
                    return { 
                        code: stateEl.value, 
                        name: stateEl.options[stateEl.selectedIndex].text,
                        type: 'state'
                    };
                case 'county':
                    const countyEl = document.getElementById('uploadCountySelect');
                    if (!countyEl.value) return null;
                    return { 
                        code: countyEl.value, 
                        name: countyEl.options[countyEl.selectedIndex].text,
                        type: 'county'
                    };
                case 'custom':
                    const customName = document.getElementById('uploadCustomRegion').value.trim();
                    if (!customName) return null;
                    return { 
                        code: 'custom_' + customName.toLowerCase().replace(/\s+/g, '_'), 
                        name: customName,
                        type: 'custom'
                    };
            }
            return null;
        }
        
        async function handleCSVUpload() {
            const fileInput = document.getElementById('csvFileInput');
            
            if (!fileInput) {
                console.error('File input element not found');
                alert('Error: Could not find file upload element. Please refresh the page.');
                return;
            }
            
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file first');
                return;
            }
            
            const regionInfo = getSelectedRegionInfo();
            if (!regionInfo) {
                alert('Please select a region for this list');
                return;
            }
            
            // Check if world list exists for non-world uploads
            if (regionInfo.type !== 'world' && !allBirdLists['world']) {
                alert('Please upload your World Life List first. This is required before uploading regional lists.');
                return;
            }
            
            showLoading('Importing CSV...');
            
            try {
                const result = await importeBirdCSVWithDates(file);
                
                // Store the list with metadata
                allBirdLists[regionInfo.code] = {
                    ...regionInfo,
                    species: result.species,
                    speciesWithDates: result.speciesWithDates,
                    count: result.species.length,
                    uploadDate: new Date().toISOString(),
                    fileName: file.name
                };
                
                saveAllBirdLists();
                
                // If this is world list, also save to legacy storage for compatibility
                if (regionInfo.type === 'world') {
                    saveLifeList(result.species, 'csv');
                    userList = new Set(result.species);
                }
                
                hideLoading();
                
                // Refresh the lists display
                displayUploadedLists();
                updateTargetListOptions();
                
                alert(`‚úÖ Successfully imported ${result.species.length} species to "${regionInfo.name}"!`);
                
                // Update header
                updateHeaderWithLifeList();
                
                // Reload any active search
                if (allSightings && allSightings.length > 0) {
                    displayBirds();
                }
                
            } catch (error) {
                hideLoading();
                alert('Error importing CSV: ' + error.message);
                console.error(error);
            }
        }
        
        function importeBirdCSVWithDates(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    reject(new Error('No file provided'));
                    return;
                }

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        try {
                            const speciesSet = new Set();
                            const speciesWithDates = {};
                            
                            // Log first row to debug column names
                            if (results.data.length > 0) {
                                console.log('üìã CSV columns found:', Object.keys(results.data[0]));
                            }
                            
                            results.data.forEach(row => {
                                const commonName = row['Common Name'] || row['Species'] || row['species'] || row['common name'] || row['CommonName'];
                                // eBird uses various date column names
                                const dateStr = row['Date'] || row['date'] || row['Observation Date'] || row['observation date'] || 
                                               row['ObservationDate'] || row['Submission ID'] ? null : null || // Skip if only submission ID
                                               row['First Seen'] || row['first seen'] || row['DateObserved'];
                                
                                if (commonName && commonName.trim()) {
                                    const name = commonName.trim();
                                    speciesSet.add(name);
                                    
                                    // Store date if available
                                    if (dateStr && dateStr.trim()) {
                                        const date = new Date(dateStr.trim());
                                        if (!isNaN(date.getTime())) {
                                            // Keep earliest date for each species (first time you saw it)
                                            if (!speciesWithDates[name] || date < new Date(speciesWithDates[name])) {
                                                speciesWithDates[name] = date.toISOString();
                                            }
                                        }
                                    }
                                }
                            });

                            if (speciesSet.size === 0) {
                                reject(new Error('No species found in CSV. Make sure it\'s an eBird export with a "Common Name" column.'));
                                return;
                            }

                            const dateCount = Object.keys(speciesWithDates).length;
                            console.log(`‚úÖ Imported ${speciesSet.size} species from CSV (${dateCount} with dates)`);
                            
                            resolve({
                                species: Array.from(speciesSet),
                                speciesWithDates: speciesWithDates
                            });
                        } catch (error) {
                            reject(error);
                        }
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }
        
        // ============================================
        // EBIRD ZIP FILE IMPORT
        // ============================================
        
        async function handleEBirdZipUpload() {
            const fileInput = document.getElementById('ebirdZipInput');
            const statusDiv = document.getElementById('zipUploadStatus');
            
            if (!fileInput || !fileInput.files[0]) {
                alert('Please select a ZIP file first');
                return;
            }
            
            const file = fileInput.files[0];
            if (!file.name.toLowerCase().endsWith('.zip')) {
                alert('Please select a ZIP file (.zip)');
                return;
            }
            
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div style="color: #2563eb;">üì¶ Reading ZIP file...</div>';
            
            try {
                const zip = await JSZip.loadAsync(file);
                
                // Find the main CSV file (usually named MyEBirdData.csv or similar)
                let mainCsvFile = null;
                let mainCsvName = null;
                
                // Look for common eBird export file patterns
                const csvPatterns = ['MyEBirdData', 'ebird_', 'observations', 'data'];
                
                for (const [filename, zipEntry] of Object.entries(zip.files)) {
                    if (filename.toLowerCase().endsWith('.csv') && !zipEntry.dir) {
                        // Prefer files matching common patterns
                        const lowerName = filename.toLowerCase();
                        if (csvPatterns.some(p => lowerName.includes(p.toLowerCase())) || !mainCsvFile) {
                            mainCsvFile = zipEntry;
                            mainCsvName = filename;
                        }
                    }
                }
                
                if (!mainCsvFile) {
                    statusDiv.innerHTML = '<div style="color: #dc2626;">‚ùå No CSV file found in ZIP</div>';
                    return;
                }
                
                statusDiv.innerHTML = `<div style="color: #2563eb;">üìÑ Found ${mainCsvName}, processing...</div>`;
                
                // Extract and parse the CSV
                const csvContent = await mainCsvFile.async('string');
                const result = await parseEBirdDataCSV(csvContent);
                
                statusDiv.innerHTML = `<div style="color: #2563eb;">üîÑ Processing ${result.totalObservations} observations...</div>`;
                
                // Store as World Life List
                allBirdLists['world'] = {
                    type: 'world',
                    code: 'world',
                    name: 'World Life List',
                    species: result.species,
                    speciesWithDates: result.speciesWithDates,
                    speciesFirstDate: result.speciesFirstDate,
                    speciesCategories: result.speciesCategories,
                    count: result.species.length,
                    countableCount: result.countableCount,
                    uploadDate: new Date().toISOString(),
                    fileName: file.name,
                    source: 'eBird ZIP export',
                    // Store regional breakdowns
                    byCountry: result.byCountry,
                    byState: result.byState,
                    byCounty: result.byCounty
                };
                
                saveAllBirdLists();
                
                // Also save to legacy storage
                saveLifeList(result.species, 'zip');
                userList = new Set(result.species);
                
                // Auto-generate regional lists
                let regionalListsCreated = 0;
                
                // Create country lists for countries with 10+ species
                for (const [countryCode, countryData] of Object.entries(result.byCountry)) {
                    if (countryData.species.length >= 10) {
                        const listKey = `country_${countryCode}`;
                        const countable = countryData.species.filter(sp => result.speciesCategories[sp] === 'species').length;
                        allBirdLists[listKey] = {
                            type: 'country',
                            code: listKey,
                            name: countryData.name || countryCode,
                            species: countryData.species,
                            speciesWithDates: countryData.speciesWithDates,
                            speciesFirstDate: countryData.speciesFirstDate,
                            count: countryData.species.length,
                            countableCount: countable,
                            uploadDate: new Date().toISOString(),
                            source: 'auto-generated from ZIP'
                        };
                        regionalListsCreated++;
                    }
                }
                
                // Create state lists for states with 10+ species (limit to top 10 states)
                const sortedStates = Object.entries(result.byState)
                    .sort((a, b) => b[1].species.length - a[1].species.length)
                    .slice(0, 10);
                    
                for (const [stateCode, stateData] of sortedStates) {
                    if (stateData.species.length >= 10) {
                        const listKey = stateCode.replace('-', '_');
                        const countable = stateData.species.filter(sp => result.speciesCategories[sp] === 'species').length;
                        allBirdLists[listKey] = {
                            type: 'state',
                            code: listKey,
                            name: stateData.name || stateCode,
                            species: stateData.species,
                            speciesWithDates: stateData.speciesWithDates,
                            speciesFirstDate: stateData.speciesFirstDate,
                            count: stateData.species.length,
                            countableCount: countable,
                            uploadDate: new Date().toISOString(),
                            source: 'auto-generated from ZIP'
                        };
                        regionalListsCreated++;
                    }
                }
                
                // Create special eBird regions (ABA, Lower 48, AOU)
                const usData = result.byCountry['US'];
                const caData = result.byCountry['CA'];
                const mxData = result.byCountry['MX'];
                
                // Helper to combine species from multiple regions
                function combineRegions(regions) {
                    const combined = {
                        speciesSet: new Set(),
                        speciesWithDates: {},
                        speciesFirstDate: {}
                    };
                    
                    regions.forEach(region => {
                        if (!region) return;
                        
                        region.species.forEach(species => {
                            combined.speciesSet.add(species);
                            
                            // Combine dates
                            if (region.speciesWithDates && region.speciesWithDates[species]) {
                                if (!combined.speciesWithDates[species]) {
                                    combined.speciesWithDates[species] = [];
                                }
                                const dates = region.speciesWithDates[species];
                                const dateArray = Array.isArray(dates) ? dates : [dates];
                                combined.speciesWithDates[species].push(...dateArray);
                            }
                            
                            // Track first date
                            if (region.speciesFirstDate && region.speciesFirstDate[species]) {
                                const date = new Date(region.speciesFirstDate[species]);
                                if (!combined.speciesFirstDate[species] || date < new Date(combined.speciesFirstDate[species])) {
                                    combined.speciesFirstDate[species] = region.speciesFirstDate[species];
                                }
                            }
                        });
                    });
                    
                    // Calculate countable species using global categories
                    const allSpecies = Array.from(combined.speciesSet);
                    const countable = allSpecies.filter(sp => result.speciesCategories[sp] === 'species').length;
                    
                    return {
                        species: allSpecies,
                        speciesWithDates: combined.speciesWithDates,
                        speciesFirstDate: combined.speciesFirstDate,
                        count: combined.speciesSet.size,
                        countableCount: countable
                    };
                }
                
                // USA Lower 48 (US excluding Alaska and Hawaii)
                const lower48States = Object.entries(result.byState)
                    .filter(([code]) => code.startsWith('US-') && code !== 'US-AK' && code !== 'US-HI')
                    .map(([_, data]) => data);
                
                if (lower48States.length > 0) {
                    const lower48Combined = combineRegions(lower48States);
                    
                    if (lower48Combined.count >= 10) {
                        allBirdLists['usa_lower48'] = {
                            type: 'region',
                            code: 'usa_lower48',
                            name: 'USA Lower 48',
                            species: lower48Combined.species,
                            speciesWithDates: lower48Combined.speciesWithDates,
                            speciesFirstDate: lower48Combined.speciesFirstDate,
                            count: lower48Combined.count,
                            countableCount: lower48Combined.countableCount,
                            uploadDate: new Date().toISOString(),
                            source: 'auto-generated from ZIP'
                        };
                        regionalListsCreated++;
                        console.log(`üá∫üá∏ USA Lower 48: ${lower48Combined.countableCount} countable (${lower48Combined.count} total)`);
                    }
                }
                
                // ABA Area (US + Canada, excluding Hawaii)
                const abaStates = Object.entries(result.byState)
                    .filter(([code]) => (code.startsWith('US-') && code !== 'US-HI') || code.startsWith('CA-'))
                    .map(([_, data]) => data);
                
                if (abaStates.length > 0) {
                    const abaCombined = combineRegions(abaStates);
                    
                    if (abaCombined.count >= 10) {
                        allBirdLists['aba_area'] = {
                            type: 'region',
                            code: 'aba_area',
                            name: 'ABA Area',
                            species: abaCombined.species,
                            speciesWithDates: abaCombined.speciesWithDates,
                            speciesFirstDate: abaCombined.speciesFirstDate,
                            count: abaCombined.count,
                            countableCount: abaCombined.countableCount,
                            uploadDate: new Date().toISOString(),
                            source: 'auto-generated from ZIP'
                        };
                        regionalListsCreated++;
                        console.log(`ü¶Ö ABA Area: ${abaCombined.countableCount} countable (${abaCombined.count} total)`);
                    }
                }
                
                // AOU Area (US + Canada + Mexico = North America)
                if (usData || caData || mxData) {
                    const aouCombined = combineRegions([usData, caData, mxData].filter(Boolean));
                    
                    if (aouCombined.count >= 10) {
                        allBirdLists['aou_area'] = {
                            type: 'region',
                            code: 'aou_area',
                            name: 'AOU Area (North America)',
                            species: aouCombined.species,
                            speciesWithDates: aouCombined.speciesWithDates,
                            speciesFirstDate: aouCombined.speciesFirstDate,
                            count: aouCombined.count,
                            countableCount: aouCombined.countableCount,
                            uploadDate: new Date().toISOString(),
                            source: 'auto-generated from ZIP'
                        };
                        regionalListsCreated++;
                        console.log(`üåé AOU Area: ${aouCombined.countableCount} countable (${aouCombined.count} total)`);
                    }
                }
                
                saveAllBirdLists();
                
                // Update UI
                displayUploadedLists();
                updateTargetListOptions();
                updateHeaderWithLifeList();
                updateListsStatsPanel();
                
                // Show success
                statusDiv.innerHTML = `
                    <div style="background: #d1fae5; padding: 12px; border-radius: 6px; border: 1px solid #10b981;">
                        <div style="color: #065f46; font-weight: 600; margin-bottom: 8px;">‚úÖ Import Successful!</div>
                        <div style="color: #047857; font-size: 0.9em;">
                            <div>üåç World Life List: <strong>${result.species.length}</strong> species</div>
                            <div>üìÖ With dates: <strong>${Object.keys(result.speciesWithDates).length}</strong> species</div>
                            <div>üó∫Ô∏è Auto-created: <strong>${regionalListsCreated}</strong> regional lists</div>
                            <div>üìä Total observations: <strong>${result.totalObservations.toLocaleString()}</strong></div>
                        </div>
                    </div>
                `;
                
                // Clear file input
                fileInput.value = '';
                
            } catch (error) {
                console.error('ZIP import error:', error);
                statusDiv.innerHTML = `<div style="color: #dc2626;">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function parseEBirdDataCSV(csvContent) {
            return new Promise((resolve, reject) => {
                Papa.parse(csvContent, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        try {
                            const columns = Object.keys(results.data[0] || {});
                            console.log('üìã ZIP CSV columns:', columns.join(', '));
                            
                            const speciesSet = new Set();
                            const speciesWithDates = {};  // species -> array of all dates
                            const speciesFirstDate = {};  // species -> earliest date (for display)
                            const speciesCategories = {}; // species -> category (species, spuh, slash, domestic, hybrid)
                            const byCountry = {};
                            const byState = {};
                            const byCounty = {};
                            
                            let totalObservations = 0;
                            let countriesFound = new Set();
                            let statesFound = new Set();
                            
                            // Country code to name mapping
                            const countryNames = {
                                'US': 'United States', 'CA': 'Canada', 'MX': 'Mexico',
                                'CR': 'Costa Rica', 'PA': 'Panama', 'CO': 'Colombia',
                                'EC': 'Ecuador', 'PE': 'Peru', 'BR': 'Brazil',
                                'GB': 'United Kingdom', 'AU': 'Australia', 'NZ': 'New Zealand',
                                'ZA': 'South Africa', 'KE': 'Kenya', 'TZ': 'Tanzania',
                                'JP': 'Japan', 'TW': 'Taiwan', 'HK': 'Hong Kong',
                                'SG': 'Singapore', 'TH': 'Thailand', 'MY': 'Malaysia',
                                'IN': 'India', 'ID': 'Indonesia', 'PH': 'Philippines',
                                'ES': 'Spain', 'PT': 'Portugal', 'FR': 'France',
                                'DE': 'Germany', 'IT': 'Italy', 'NL': 'Netherlands',
                                'BE': 'Belgium', 'IE': 'Ireland', 'IS': 'Iceland'
                            };
                            
                            // Function to check if a species is "countable" by eBird standards
                            // Non-countable: spuhs (sp.), slashes (/), domestics, hybrids
                            function isCountableSpecies(name) {
                                if (!name) return false;
                                const lowerName = name.toLowerCase();
                                
                                // Spuhs - unidentified to species level
                                if (lowerName.includes(' sp.') || lowerName.endsWith(' sp')) return false;
                                
                                // Slashes - one of two similar species (e.g., "Greater/Lesser Scaup")
                                if (name.includes('/')) return false;
                                
                                // Domestics and escapees
                                if (lowerName.includes('(domestic') || lowerName.includes('domestic type')) return false;
                                
                                // Hybrids
                                if (lowerName.includes(' x ') || lowerName.includes('hybrid')) return false;
                                
                                // Intergrade
                                if (lowerName.includes('intergrade')) return false;
                                
                                // Uncertain species (with ?)
                                if (name.includes('?')) return false;
                                
                                return true;
                            }
                            
                            // Function to get species category
                            function getSpeciesCategory(name) {
                                if (!name) return 'unknown';
                                const lowerName = name.toLowerCase();
                                
                                if (lowerName.includes(' sp.') || lowerName.endsWith(' sp')) return 'spuh';
                                if (name.includes('/')) return 'slash';
                                if (lowerName.includes('(domestic') || lowerName.includes('domestic type')) return 'domestic';
                                if (lowerName.includes(' x ') || lowerName.includes('hybrid')) return 'hybrid';
                                if (lowerName.includes('intergrade')) return 'intergrade';
                                if (name.includes('?')) return 'uncertain';
                                
                                return 'species'; // Countable species
                            }
                            
                            results.data.forEach(row => {
                                // eBird columns
                                const commonName = row['Common Name'] || row['common name'] || row['Species'];
                                const dateStr = row['Date'] || row['date'];
                                
                                // State/Province format is "US-FL" or "CA-ON" - country code is embedded
                                const stateProvince = row['State/Province'] || row['State'] || '';
                                const county = row['County'] || '';
                                
                                if (!commonName || !commonName.trim()) return;
                                
                                const name = commonName.trim();
                                const category = getSpeciesCategory(name);
                                const isCountable = category === 'species';
                                totalObservations++;
                                
                                // Add to main species list (all species)
                                speciesSet.add(name);
                                
                                // Track category for this species
                                if (!speciesCategories[name]) {
                                    speciesCategories[name] = category;
                                }
                                
                                // Store ALL dates for this species (for accurate date filtering)
                                if (dateStr && dateStr.trim()) {
                                    const date = new Date(dateStr.trim());
                                    if (!isNaN(date.getTime())) {
                                        const dateISO = dateStr.trim(); // Keep as string YYYY-MM-DD
                                        
                                        // Initialize array if needed
                                        if (!speciesWithDates[name]) {
                                            speciesWithDates[name] = new Set();
                                        }
                                        speciesWithDates[name].add(dateISO);
                                        
                                        // Track first/earliest date for display
                                        if (!speciesFirstDate[name] || date < new Date(speciesFirstDate[name])) {
                                            speciesFirstDate[name] = date.toISOString();
                                        }
                                    }
                                }
                                
                                // Parse State/Province to get country and state
                                // Format: "US-FL", "CA-ON", "MX-ROO", etc.
                                let countryCode = '';
                                let stateCode = '';
                                
                                if (stateProvince && stateProvince.includes('-')) {
                                    const parts = stateProvince.split('-');
                                    countryCode = parts[0];
                                    stateCode = parts.slice(1).join('-');
                                } else if (stateProvince) {
                                    countryCode = stateProvince;
                                }
                                
                                // Group by country
                                if (countryCode) {
                                    const countryName = countryNames[countryCode] || countryCode;
                                    countriesFound.add(countryCode);
                                    
                                    if (!byCountry[countryCode]) {
                                        byCountry[countryCode] = { 
                                            name: countryName, 
                                            speciesSet: new Set(), 
                                            speciesWithDates: {},
                                            speciesFirstDate: {}
                                        };
                                    }
                                    byCountry[countryCode].speciesSet.add(name);
                                    if (dateStr) {
                                        const date = new Date(dateStr);
                                        if (!isNaN(date.getTime())) {
                                            const dateISO = dateStr.trim();
                                            if (!byCountry[countryCode].speciesWithDates[name]) {
                                                byCountry[countryCode].speciesWithDates[name] = new Set();
                                            }
                                            byCountry[countryCode].speciesWithDates[name].add(dateISO);
                                            
                                            if (!byCountry[countryCode].speciesFirstDate[name] || 
                                                date < new Date(byCountry[countryCode].speciesFirstDate[name])) {
                                                byCountry[countryCode].speciesFirstDate[name] = date.toISOString();
                                            }
                                        }
                                    }
                                }
                                
                                // Group by state (use full State/Province code like "US-FL")
                                if (stateProvince) {
                                    statesFound.add(stateProvince);
                                    if (!byState[stateProvince]) {
                                        byState[stateProvince] = { 
                                            name: stateProvince, 
                                            speciesSet: new Set(), 
                                            speciesWithDates: {},
                                            speciesFirstDate: {}
                                        };
                                    }
                                    byState[stateProvince].speciesSet.add(name);
                                    if (dateStr) {
                                        const date = new Date(dateStr);
                                        if (!isNaN(date.getTime())) {
                                            const dateISO = dateStr.trim();
                                            if (!byState[stateProvince].speciesWithDates[name]) {
                                                byState[stateProvince].speciesWithDates[name] = new Set();
                                            }
                                            byState[stateProvince].speciesWithDates[name].add(dateISO);
                                            
                                            if (!byState[stateProvince].speciesFirstDate[name] || 
                                                date < new Date(byState[stateProvince].speciesFirstDate[name])) {
                                                byState[stateProvince].speciesFirstDate[name] = date.toISOString();
                                            }
                                        }
                                    }
                                }
                                
                                // Group by county
                                if (county && stateProvince) {
                                    const fullCountyKey = `${stateProvince}-${county}`;
                                    if (!byCounty[fullCountyKey]) {
                                        byCounty[fullCountyKey] = { 
                                            name: `${county}, ${stateProvince}`, 
                                            speciesSet: new Set(), 
                                            speciesWithDates: {},
                                            speciesFirstDate: {}
                                        };
                                    }
                                    byCounty[fullCountyKey].speciesSet.add(name);
                                    if (dateStr) {
                                        const date = new Date(dateStr);
                                        if (!isNaN(date.getTime())) {
                                            const dateISO = dateStr.trim();
                                            if (!byCounty[fullCountyKey].speciesWithDates[name]) {
                                                byCounty[fullCountyKey].speciesWithDates[name] = new Set();
                                            }
                                            byCounty[fullCountyKey].speciesWithDates[name].add(dateISO);
                                            
                                            if (!byCounty[fullCountyKey].speciesFirstDate[name] || 
                                                date < new Date(byCounty[fullCountyKey].speciesFirstDate[name])) {
                                                byCounty[fullCountyKey].speciesFirstDate[name] = date.toISOString();
                                            }
                                        }
                                    }
                                }
                            });
                            
                            // Convert Sets to arrays for storage
                            // speciesWithDates: convert Set of date strings to Array
                            const speciesWithDatesArray = {};
                            for (const [species, dates] of Object.entries(speciesWithDates)) {
                                speciesWithDatesArray[species] = Array.from(dates);
                            }
                            
                            for (const key of Object.keys(byCountry)) {
                                byCountry[key].species = Array.from(byCountry[key].speciesSet);
                                delete byCountry[key].speciesSet;
                                // Convert date Sets to arrays
                                const datesArray = {};
                                for (const [sp, dates] of Object.entries(byCountry[key].speciesWithDates)) {
                                    datesArray[sp] = Array.from(dates);
                                }
                                byCountry[key].speciesWithDates = datesArray;
                            }
                            for (const key of Object.keys(byState)) {
                                byState[key].species = Array.from(byState[key].speciesSet);
                                delete byState[key].speciesSet;
                                const datesArray = {};
                                for (const [sp, dates] of Object.entries(byState[key].speciesWithDates)) {
                                    datesArray[sp] = Array.from(dates);
                                }
                                byState[key].speciesWithDates = datesArray;
                            }
                            for (const key of Object.keys(byCounty)) {
                                byCounty[key].species = Array.from(byCounty[key].speciesSet);
                                delete byCounty[key].speciesSet;
                                const datesArray = {};
                                for (const [sp, dates] of Object.entries(byCounty[key].speciesWithDates)) {
                                    datesArray[sp] = Array.from(dates);
                                }
                                byCounty[key].speciesWithDates = datesArray;
                            }
                            
                            // Count countable species
                            const countableSpecies = Array.from(speciesSet).filter(sp => speciesCategories[sp] === 'species');
                            const nonCountable = {
                                spuh: Array.from(speciesSet).filter(sp => speciesCategories[sp] === 'spuh'),
                                slash: Array.from(speciesSet).filter(sp => speciesCategories[sp] === 'slash'),
                                domestic: Array.from(speciesSet).filter(sp => speciesCategories[sp] === 'domestic'),
                                hybrid: Array.from(speciesSet).filter(sp => speciesCategories[sp] === 'hybrid'),
                                other: Array.from(speciesSet).filter(sp => !['species', 'spuh', 'slash', 'domestic', 'hybrid'].includes(speciesCategories[sp]))
                            };
                            
                            console.log(`‚úÖ Parsed ZIP: ${speciesSet.size} total, ${countableSpecies.length} countable species, ${totalObservations} observations`);
                            console.log(`üìä Non-countable: ${nonCountable.spuh.length} spuhs, ${nonCountable.slash.length} slashes, ${nonCountable.domestic.length} domestics, ${nonCountable.hybrid.length} hybrids`);
                            console.log(`üåç Countries: ${Object.keys(byCountry).length} (${Array.from(countriesFound).join(', ')})`);
                            console.log(`üó∫Ô∏è States: ${Object.keys(byState).length} (${Array.from(statesFound).slice(0, 5).join(', ')}...)`);
                            
                            resolve({
                                species: Array.from(speciesSet),
                                speciesWithDates: speciesWithDatesArray,
                                speciesFirstDate: speciesFirstDate,
                                speciesCategories: speciesCategories,
                                countableCount: countableSpecies.length,
                                byCountry: byCountry,
                                byState: byState,
                                byCounty: byCounty,
                                totalObservations: totalObservations
                            });
                            
                        } catch (error) {
                            console.error('Parse error:', error);
                            reject(error);
                        }
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }
        
        async function displayUploadedLists() {
            const container = document.getElementById('uploadedListsContainer');
            if (!container) return;
            
            await loadAllBirdLists();
            
            if (Object.keys(allBirdLists).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 10px;">
                        <p style="color: #dc2626; font-weight: 600; margin: 0 0 8px 0;">‚ö†Ô∏è No World Life List uploaded yet</p>
                        <p style="color: var(--text-secondary); font-size: 0.85em; margin: 0;">Upload your World Life List below to get started. This is required before uploading any regional lists.</p>
                    </div>
                `;
                return;
            }
            
            // Check if world list exists
            const hasWorldList = !!allBirdLists['world'];
            
            let html = '';
            
            if (!hasWorldList) {
                html += `
                    <div style="background: #fef2f2; border: 1px solid #fecaca; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                        <p style="color: #dc2626; font-weight: 600; margin: 0; font-size: 0.9em;">‚ö†Ô∏è World Life List missing - please upload it first!</p>
                    </div>
                `;
            }
            
            html += '<div style="display: flex; flex-direction: column; gap: 8px;">';
            
            // Sort lists: world first, then by type
            const sortedKeys = Object.keys(allBirdLists).sort((a, b) => {
                if (a === 'world') return -1;
                if (b === 'world') return 1;
                return allBirdLists[a].name.localeCompare(allBirdLists[b].name);
            });
            
            sortedKeys.forEach(key => {
                const list = allBirdLists[key];
                const uploadDate = new Date(list.uploadDate).toLocaleDateString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric' 
                });
                const typeIcon = list.type === 'world' ? 'üåç' : 
                                 list.type === 'country' ? 'üè≥Ô∏è' :
                                 list.type === 'state' ? 'üó∫Ô∏è' :
                                 list.type === 'county' ? 'üìç' : list.type === 'region' ? 'ü¶Ö' : 'üìù';
                const isWorld = list.type === 'world';
                
                // Show last auto-update for world list
                let autoUpdateInfo = '';
                if (isWorld && list.lastAutoUpdate) {
                    const autoDate = new Date(list.lastAutoUpdate).toLocaleDateString('en-US', { 
                        month: 'short', day: 'numeric', year: 'numeric' 
                    });
                    autoUpdateInfo = `<div style="font-size: 0.75em; color: #10b981; margin-top: 2px;">üîÑ Auto-updated ${autoDate}</div>`;
                }
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-primary); border-radius: 6px; border: 1px solid ${isWorld ? '#10b981' : 'var(--border-color)'};">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${typeIcon} ${list.name}</div>
                            <div style="font-size: 0.8em; color: var(--text-secondary);">
                                ${list.count} species ‚Ä¢ Uploaded ${uploadDate}
                            </div>
                            ${autoUpdateInfo}
                        </div>
                        <button onclick="deleteBirdList('${key}')" title="Delete list" style="background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: bold; display: flex; align-items: center; justify-content: center; line-height: 1;">
                            √ó
                        </button>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function deleteBirdList(key) {
            const list = allBirdLists[key];
            if (!list) return;
            
            if (key === 'world') {
                if (!confirm('Are you sure you want to delete your World Life List? This will affect target filtering.')) {
                    return;
                }
            } else {
                if (!confirm(`Delete "${list.name}" list?`)) {
                    return;
                }
            }
            
            delete allBirdLists[key];
            saveAllBirdLists();
            displayUploadedLists();
            updateTargetListOptions();
            updateHeaderWithLifeList();
        }
        
        function updateTargetListOptions() {
            const select = document.getElementById('targetListType');
            const checkboxContainer = document.getElementById('regionalCheckboxes');
            if (!select) return;
            
            // Keep the standard options in the select
            const standardOptions = `
                <option value="all">Show All Species</option>
                <option value="life">Life List Targets Only</option>
                <option value="year">Year List Targets Only</option>
                <option value="month">Month List Targets Only</option>
                <option value="regional">Regional Lists (select below)</option>
                <option value="notable">Notable/Rare Targets</option>
            `;
            
            select.innerHTML = standardOptions;
            
            // Populate regional checkboxes
            if (checkboxContainer) {
                let checkboxHTML = '';
                
                // Sort lists: countries first, then special regions (ABA, etc), then states, then others
                const sortedKeys = Object.keys(allBirdLists)
                    .filter(key => key !== 'world')
                    .sort((a, b) => {
                        const typeOrder = { 'country': 0, 'region': 1, 'state': 2, 'county': 3, 'custom': 4 };
                        const aOrder = typeOrder[allBirdLists[a]?.type] ?? 5;
                        const bOrder = typeOrder[allBirdLists[b]?.type] ?? 5;
                        if (aOrder !== bOrder) return aOrder - bOrder;
                        return (allBirdLists[a]?.name || '').localeCompare(allBirdLists[b]?.name || '');
                    });
                
                sortedKeys.forEach(key => {
                    const list = allBirdLists[key];
                    const typeIcon = list.type === 'country' ? 'üè≥Ô∏è' :
                                     list.type === 'state' ? 'üó∫Ô∏è' :
                                     list.type === 'county' ? 'üìç' : list.type === 'region' ? 'ü¶Ö' : 'üìù';
                    checkboxHTML += `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; cursor: pointer; border-radius: 4px; margin-bottom: 4px; background: white; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="regional-checkbox" value="${key}" onchange="applyTargetFilter()" style="width: 16px; height: 16px;">
                            <span style="font-size: 0.85em;">${typeIcon} ${list.name}</span>
                            <span style="font-size: 0.75em; color: #6b7280; margin-left: auto;">${list.count} sp</span>
                        </label>
                    `;
                });
                
                if (sortedKeys.length === 0) {
                    checkboxHTML = '<div style="color: #6b7280; font-size: 0.85em; padding: 10px;">No regional lists uploaded yet. Upload via Bird Lists Manager.</div>';
                }
                
                checkboxContainer.innerHTML = checkboxHTML;
            }
        }
        
        function handleTargetFilterChange() {
            const listType = document.getElementById('targetListType').value;
            const regionalSection = document.getElementById('regionalMultiSelect');
            
            if (listType === 'regional') {
                regionalSection.style.display = 'block';
            } else {
                regionalSection.style.display = 'none';
                applyTargetFilter();
            }
        }
        
        function getSelectedRegionalLists() {
            const checkboxes = document.querySelectorAll('.regional-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function toggleDateFilter() {
            const inputs = document.getElementById('dateFilterInputs');
            const toggle = document.getElementById('dateFilterToggle');
            
            if (inputs.style.display === 'none') {
                inputs.style.display = 'block';
                toggle.textContent = '‚àí Hide Filter';
            } else {
                inputs.style.display = 'none';
                toggle.textContent = '+ Add Filter';
            }
        }
        
        function applyDateRangeFilter() {
            const startDate = document.getElementById('dateRangeStart').value;
            const endDate = document.getElementById('dateRangeEnd').value;
            const statusDiv = document.getElementById('dateFilterStatus');
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (start > end) {
                alert('Start date must be before end date');
                return;
            }
            
            activeListDateFilter = { start, end };
            
            // Count species within date range from world list
            const worldList = allBirdLists['world'];
            if (worldList && worldList.speciesWithDates) {
                let count = 0;
                Object.entries(worldList.speciesWithDates).forEach(([species, dateStr]) => {
                    const date = new Date(dateStr);
                    if (date >= start && date <= end) {
                        count++;
                    }
                });
                
                const startFormatted = new Date(startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const endFormatted = new Date(endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                statusDiv.innerHTML = `üìÖ <strong>Active:</strong> ${startFormatted} to ${endFormatted} ‚Äî <strong>${count} species</strong>`;
                statusDiv.style.display = 'block';
                
                // Update filtered list
                window.userDateFilteredList = new Set();
                Object.entries(worldList.speciesWithDates).forEach(([species, dateStr]) => {
                    const date = new Date(dateStr);
                    if (date >= start && date <= end) {
                        window.userDateFilteredList.add(species);
                    }
                });
                
                console.log(`üìÖ Date filter applied: ${window.userDateFilteredList.size} species from ${startDate} to ${endDate}`);
                
                // Collapse the inputs after applying
                document.getElementById('dateFilterInputs').style.display = 'none';
                document.getElementById('dateFilterToggle').textContent = '‚úé Edit Filter';
            } else {
                statusDiv.innerHTML = '‚ö†Ô∏è No date info in your list. Re-upload CSV with date column.';
                statusDiv.style.display = 'block';
            }
            
            // Refresh display if search is active
            if (allSightings && allSightings.length > 0) {
                displayBirds();
                updateBelowMapPanels();
            }
        }
        
        function clearDateRangeFilter() {
            activeListDateFilter = null;
            window.userDateFilteredList = null;
            document.getElementById('dateRangeStart').value = '';
            document.getElementById('dateRangeEnd').value = '';
            document.getElementById('dateFilterStatus').style.display = 'none';
            document.getElementById('dateFilterToggle').textContent = '+ Add Filter';
            
            console.log('üìÖ Date filter cleared');
            
            // Refresh display
            if (allSightings && allSightings.length > 0) {
                displayBirds();
                updateBelowMapPanels();
            }
        }
        
        // Initialize lists on page load
        function initBirdLists() {
            loadAllBirdLists();
            
            // Migrate legacy life list if exists
            const legacyList = loadFromLocalStorage(STORAGE_KEYS.LIFE_LIST);
            if (legacyList && legacyList.species && !allBirdLists['world']) {
                allBirdLists['world'] = {
                    code: 'world',
                    name: 'World Life List',
                    type: 'world',
                    species: legacyList.species,
                    speciesWithDates: {},
                    count: legacyList.species.length,
                    uploadDate: legacyList.updated || new Date().toISOString(),
                    fileName: 'migrated from legacy'
                };
                saveAllBirdLists();
                console.log('üìã Migrated legacy life list to new system');
            }
            
            displayUploadedLists();
            updateTargetListOptions();
        }
        
        // Auto-update life list from eBird API (last 30 days of observations)
        async function updateLifeListFromAPI() {
            if (!userApiKey) {
                console.log('‚è≠Ô∏è No API key, skipping life list update');
                return;
            }
            
            // Check if we have a world list to update
            loadAllBirdLists();
            const worldList = allBirdLists['world'];
            
            if (!worldList) {
                console.log('‚è≠Ô∏è No world life list uploaded yet, skipping auto-update');
                return;
            }
            
            console.log('üîÑ Checking for new species from eBird API (last 30 days)...');
            
            try {
                // Fetch user's recent observations (last 30 days)
                const response = await fetch('https://api.ebird.org/v2/data/obs/recent', {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });
                
                if (!response.ok) {
                    console.warn('‚ö†Ô∏è Could not fetch recent observations for life list update');
                    return;
                }
                
                const recentObs = await response.json();
                
                if (!recentObs || recentObs.length === 0) {
                    console.log('üìã No recent observations found');
                    return;
                }
                
                // Get unique species from recent observations
                const recentSpecies = new Set();
                const recentSpeciesWithDates = {};
                
                recentObs.forEach(obs => {
                    if (obs.comName) {
                        recentSpecies.add(obs.comName);
                        // Track most recent date for each species
                        if (!recentSpeciesWithDates[obs.comName] || 
                            new Date(obs.obsDt) > new Date(recentSpeciesWithDates[obs.comName])) {
                            recentSpeciesWithDates[obs.comName] = obs.obsDt;
                        }
                    }
                });
                
                // Find new species not in the world list
                const existingSpecies = new Set(worldList.species);
                const newSpecies = [];
                
                recentSpecies.forEach(species => {
                    if (!existingSpecies.has(species)) {
                        newSpecies.push(species);
                    }
                });
                
                if (newSpecies.length === 0) {
                    console.log('‚úÖ Life list is up to date (no new species in last 30 days)');
                    return;
                }
                
                // Add new species to the world list
                const updatedSpecies = [...worldList.species, ...newSpecies];
                const updatedDates = { ...worldList.speciesWithDates };
                
                // Add dates for new species
                newSpecies.forEach(species => {
                    if (recentSpeciesWithDates[species]) {
                        updatedDates[species] = recentSpeciesWithDates[species];
                    }
                });
                
                // Update the world list
                allBirdLists['world'] = {
                    ...worldList,
                    species: updatedSpecies,
                    speciesWithDates: updatedDates,
                    count: updatedSpecies.length,
                    lastAutoUpdate: new Date().toISOString()
                };
                
                saveAllBirdLists();
                
                // Also update legacy storage for compatibility
                saveLifeList(updatedSpecies, 'csv');
                userList = new Set(updatedSpecies);
                
                // Update UI
                updateHeaderWithLifeList();
                displayUploadedLists();
                
                console.log(`üéâ Added ${newSpecies.length} new species to your life list: ${newSpecies.join(', ')}`);
                
                // Show a subtle notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #10b981;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    font-size: 0.9em;
                    animation: slideIn 0.3s ease;
                `;
                notification.innerHTML = `üéâ <strong>${newSpecies.length} new species</strong> added to your life list!`;
                document.body.appendChild(notification);
                
                // Remove notification after 5 seconds
                setTimeout(() => {
                    notification.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
                
            } catch (error) {
                console.error('Error updating life list from API:', error);
            }
        }
        
        async function updateListsStatsPanel() {
            const container = document.getElementById('listsStatsDisplay');
            const countEl = document.getElementById('listsActiveCount');
            
            console.log('üîÑ updateListsStatsPanel called, container:', !!container, 'countEl:', !!countEl);
            
            if (!container) {
                console.log('‚ùå listsStatsDisplay container not found');
                return;
            }
            
            await loadAllBirdLists();
            const listCount = Object.keys(allBirdLists).length;
            console.log('üìã Lists to display:', listCount, Object.keys(allBirdLists));
            
            if (countEl) {
                countEl.textContent = listCount;
            }
            
            if (listCount === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                        <p style="margin: 0 0 15px 0;">No bird lists uploaded yet.</p>
                        <button onclick="openCSVImportModal()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üì• Import Lists
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="padding: 15px;">';
            
            // Get current active filter info
            const activeFilterValue = document.getElementById('targetListType')?.value || 'life';
            const activeFilterText = document.getElementById('targetListType')?.selectedOptions[0]?.text || 'Life List';
            const activeList = getTargetList();
            
            // Sort lists: world first, then by type
            const sortedKeys = Object.keys(allBirdLists).sort((a, b) => {
                if (a === 'world') return -1;
                if (b === 'world') return 1;
                const typeOrder = { 'country': 0, 'region': 1, 'state': 2, 'county': 3, 'custom': 4 };
                const aOrder = typeOrder[allBirdLists[a]?.type] ?? 5;
                const bOrder = typeOrder[allBirdLists[b]?.type] ?? 5;
                if (aOrder !== bOrder) return aOrder - bOrder;
                return allBirdLists[a].name.localeCompare(allBirdLists[b].name);
            });
            
            // Multi-report section header
            html += `
                <div style="background: #f5f3ff; padding: 10px 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #c4b5fd;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 0.85em; color: #5b21b6;">
                            <strong>üìä Multi-List Report:</strong> Check lists below, then click ‚Üí
                        </div>
                        <button onclick="runMultiListReport()" 
                                style="background: #7c3aed; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8em;">
                            Run Report
                        </button>
                    </div>
                </div>
            `;
            
            // Create list cards with checkboxes
            sortedKeys.forEach(key => {
                const list = allBirdLists[key];
                const uploadDate = new Date(list.uploadDate).toLocaleDateString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric' 
                });
                const typeIcon = list.type === 'world' ? 'üåç' : 
                                 list.type === 'country' ? 'üè≥Ô∏è' :
                                 list.type === 'state' ? 'üó∫Ô∏è' :
                                 list.type === 'county' ? 'üìç' : list.type === 'region' ? 'ü¶Ö' : 'üìù';
                const isWorld = list.type === 'world';
                
                // Check if this list is currently active as a target filter
                const selectedRegionals = activeFilterValue === 'regional' ? getSelectedRegionalLists() : [];
                const isActive = (activeFilterValue === 'life' && key === 'world') ||
                                 (activeFilterValue === 'regional' && selectedRegionals.includes(key));
                
                html += `
                    <div style="background: ${isActive ? 'linear-gradient(135deg, #f0fdf4, #dcfce7)' : 'var(--bg-primary)'}; 
                                border: 2px solid ${isActive ? '#10b981' : 'var(--border-color)'}; 
                                border-radius: 10px; 
                                padding: 12px; 
                                margin-bottom: 10px;
                                ${isActive ? 'box-shadow: 0 2px 8px rgba(16,185,129,0.2);' : ''}">
                        
                        <!-- Header with checkbox, name and count -->
                        <div style="display: flex; align-items: flex-start; gap: 10px;">
                            <input type="checkbox" class="report-list-checkbox" value="${key}" 
                                   style="width: 18px; height: 18px; margin-top: 2px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: var(--text-primary); font-size: 1em; display: flex; align-items: center; gap: 6px;">
                                    ${typeIcon} ${list.name}
                                    ${isActive ? '<span style="background: #10b981; color: white; font-size: 0.65em; padding: 2px 6px; border-radius: 4px; font-weight: 600;">FILTER ACTIVE</span>' : ''}
                                </div>
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 2px;">
                                    ${list.countableCount ? `
                                        <strong style="color: ${isWorld ? '#10b981' : '#3b82f6'};">${list.countableCount}</strong> species
                                        ${list.count > list.countableCount ? `<span style="color: #9ca3af; font-size: 0.9em;">(+${list.count - list.countableCount} other)</span>` : ''}
                                    ` : `
                                        <strong style="color: ${isWorld ? '#10b981' : '#3b82f6'};">${list.count}</strong> species
                                    `}
                                    ‚Ä¢ ${uploadDate}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action buttons -->
                        <div style="display: flex; gap: 8px; margin-top: 10px; margin-left: 28px;">
                            ${key !== 'world' ? `
                                <button onclick="toggleRegionalListFilter('${key}')" 
                                        style="flex: 1; background: ${isActive ? '#fee2e2' : '#10b981'}; color: ${isActive ? '#991b1b' : 'white'}; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8em;">
                                    ${isActive ? '‚úï Remove from Filter' : 'üéØ Use as Target Filter'}
                                </button>
                            ` : ''}
                            <button onclick="showListReport('${key}')" 
                                    title="View species list and filter by date" 
                                    style="background: #e0e7ff; color: #4f46e5; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8em;">
                                üìä Report
                            </button>
                        </div>
                    </div>
                `;
            });
            
            // Date filter status (if active)
            if (activeListDateFilter) {
                const startStr = activeListDateFilter.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const endStr = activeListDateFilter.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                html += `
                    <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #fcd34d;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.85em; color: #92400e; margin-bottom: 2px;">üìÖ Date Filter Active</div>
                                <div style="font-size: 0.9em; font-weight: 600; color: #78350f;">
                                    ${startStr} - ${endStr}
                                </div>
                            </div>
                            <button onclick="clearDateFilter()" style="background: #fcd34d; color: #78350f; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: 600;">
                                Clear
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Manage Lists button
            html += `
                <button onclick="openCSVImportModal()" 
                        style="width: 100%; background: #6366f1; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 5px; font-size: 0.95em;">
                    üìã Manage Lists
                </button>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Set a regional list as the active target filter
        function setListAsActiveFilter(listKey) {
            const select = document.getElementById('targetListType');
            if (!select) return;
            
            // Switch to regional mode
            select.value = 'regional';
            handleTargetFilterChange();
            
            // Check the checkbox for this list
            const checkbox = document.querySelector(`.regional-checkbox[value="${listKey}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
            
            // Apply the filter
            applyTargetFilter();
            
            // Update the panel to show the new active state
            updateListsStatsPanel();
        }
        
        function toggleRegionalListFilter(listKey) {
            const select = document.getElementById('targetListType');
            if (!select) return;
            
            // Ensure we're in regional mode
            if (select.value !== 'regional') {
                select.value = 'regional';
                handleTargetFilterChange();
            }
            
            // Toggle the checkbox
            const checkbox = document.querySelector(`.regional-checkbox[value="${listKey}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
            }
            
            applyTargetFilter();
            updateListsStatsPanel();
        }
        
        // Clear date filter
        function clearDateFilter() {
            activeListDateFilter = null;
            window.userDateFilteredList = null;
            updateListsStatsPanel();
            updateBelowMapPanels();
        }
        
        function openCSVImportModal() {
            openModal('csvImportModal');
            closeAccountMenu();
            displayUploadedLists();
            updateListTypeHelp();
        }

        function toggleAccountMenu() {
            const menu = document.getElementById('accountMenu');
            if (menu) {
                menu.classList.toggle('active');
            }
        }

        function closeAccountMenu() {
            const menu = document.getElementById('accountMenu');
            if (menu) {
                menu.classList.remove('active');
            }
        }
        
        // Show report for a specific list
        // Saved date ranges storage
        const SAVED_DATE_RANGES_KEY = 'travelingBirder_savedDateRanges';
        
        function getSavedDateRanges() {
            try {
                const saved = localStorage.getItem(SAVED_DATE_RANGES_KEY);
                return saved ? JSON.parse(saved) : [];
            } catch (e) {
                return [];
            }
        }
        
        function saveDateRange(name, startDate, endDate) {
            const ranges = getSavedDateRanges();
            // Check for duplicate name
            const existingIndex = ranges.findIndex(r => r.name.toLowerCase() === name.toLowerCase());
            if (existingIndex >= 0) {
                ranges[existingIndex] = { name, startDate, endDate };
            } else {
                ranges.push({ name, startDate, endDate });
            }
            localStorage.setItem(SAVED_DATE_RANGES_KEY, JSON.stringify(ranges));
        }
        
        function deleteSavedDateRange(name) {
            const ranges = getSavedDateRanges().filter(r => r.name !== name);
            localStorage.setItem(SAVED_DATE_RANGES_KEY, JSON.stringify(ranges));
        }
        
        // Run report on multiple selected lists
        function runMultiListReport() {
            const checkboxes = document.querySelectorAll('.report-list-checkbox:checked');
            const selectedKeys = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedKeys.length === 0) {
                alert('Please select at least one list to report on.');
                return;
            }
            
            if (selectedKeys.length === 1) {
                // Single list - use regular report
                showListReport(selectedKeys[0]);
                return;
            }
            
            // Multiple lists - combine them
            const combinedSpecies = new Map(); // species -> { lists: [], allDates: [], earliestDate }
            const listNames = [];
            let hasAnyDates = false;
            let totalWithDates = 0;
            
            selectedKeys.forEach(key => {
                const list = allBirdLists[key];
                if (!list) return;
                
                listNames.push(list.name);
                
                list.species.forEach(species => {
                    if (!combinedSpecies.has(species)) {
                        combinedSpecies.set(species, { lists: [], allDates: [], earliestDate: null });
                    }
                    combinedSpecies.get(species).lists.push(list.name);
                    
                    // Collect ALL dates for this species
                    if (list.speciesWithDates && list.speciesWithDates[species]) {
                        hasAnyDates = true;
                        const dates = list.speciesWithDates[species];
                        
                        // Handle both array format (new) and string format (old)
                        const dateArray = Array.isArray(dates) ? dates : [dates];
                        
                        dateArray.forEach(dateStr => {
                            if (dateStr) {
                                combinedSpecies.get(species).allDates.push(dateStr);
                                
                                // Track earliest date
                                const date = new Date(dateStr);
                                const current = combinedSpecies.get(species).earliestDate;
                                if (!current || date < current) {
                                    combinedSpecies.get(species).earliestDate = date;
                                }
                            }
                        });
                    }
                });
            });
            
            // Count species with dates
            combinedSpecies.forEach((data) => {
                if (data.allDates.length > 0) totalWithDates++;
            });
            
            // Store combined data globally for filtering
            window.multiListReportData = {
                combinedSpecies,
                listNames,
                selectedKeys,
                hasAnyDates,
                totalWithDates
            };
            
            // Create modal
            const totalSpecies = combinedSpecies.size;
            const savedRanges = getSavedDateRanges();
            
            // Build saved ranges HTML
            let savedRangesHtml = '';
            if (savedRanges.length > 0 && hasAnyDates) {
                savedRangesHtml = `
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 0.85em; font-weight: 600; color: #065f46; margin-bottom: 8px;">üìÖ Saved Date Ranges</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${savedRanges.map(range => `
                                <button onclick="applyMultiListDateFilter('${range.startDate}', '${range.endDate}')" 
                                        style="background: #d1fae5; color: #065f46; border: 1px solid #10b981; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 500;">
                                    ${range.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Build date filter section
            let dateFilterHtml = '';
            if (hasAnyDates) {
                dateFilterHtml = `
                    ${savedRangesHtml}
                    
                    <!-- Quick presets -->
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 0.85em; font-weight: 600; color: #374151; margin-bottom: 8px;">‚ö° Quick Presets</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            <button onclick="applyMultiListDateFilter('${new Date().getFullYear()}-01-01', '${new Date().toISOString().split('T')[0]}')" style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">${new Date().getFullYear()}</button>
                            <button onclick="applyMultiListDateFilter('${new Date().getFullYear()-1}-01-01', '${new Date().getFullYear()-1}-12-31')" style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">${new Date().getFullYear()-1}</button>
                            <button onclick="applyMultiListDateFilter('${new Date().getFullYear()-2}-01-01', '${new Date().getFullYear()-2}-12-31')" style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">${new Date().getFullYear()-2}</button>
                            <button onclick="applyMultiListQuickPreset('last30')" style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">Last 30 days</button>
                            <button onclick="applyMultiListQuickPreset('last90')" style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">Last 90 days</button>
                            <button onclick="applyMultiListQuickPreset('last365')" style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">Last 365 days</button>
                            <button onclick="applyMultiListDateFilter('2010-01-01', '2019-12-31')" style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">2010s</button>
                            <button onclick="applyMultiListDateFilter('2000-01-01', '2009-12-31')" style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">2000s</button>
                            <button onclick="applyMultiListDateFilter('1990-01-01', '1999-12-31')" style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">1990s</button>
                        </div>
                    </div>
                    
                    <!-- Custom date filter -->
                    <div style="background: #f5f3ff; border: 1px solid #c4b5fd; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="font-size: 0.9em; font-weight: 600; color: #5b21b6; margin-bottom: 10px;">üìÖ Custom Date Range</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label style="font-size: 0.75em; color: #6b7280;">Start Date</label>
                                <input type="date" id="multiReportStartDate" style="width: 100%; padding: 8px; border: 1px solid #c4b5fd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="font-size: 0.75em; color: #6b7280;">End Date</label>
                                <input type="date" id="multiReportEndDate" style="width: 100%; padding: 8px; border: 1px solid #c4b5fd; border-radius: 4px;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 8px;">
                            <button onclick="applyMultiListCustomDateFilter()" style="background: #7c3aed; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Apply Filter
                            </button>
                            <button onclick="clearMultiListDateFilter()" style="background: #6b7280; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Clear
                            </button>
                            <button onclick="promptSaveMultiListDateRange()" title="Save this date range for reuse" style="background: #10b981; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                üíæ Save
                            </button>
                        </div>
                    </div>
                `;
            } else {
                dateFilterHtml = `
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #fcd34d;">
                        <p style="margin: 0; color: #92400e; font-size: 0.85em;">üìÖ Date filtering not available - selected lists don't have date information.</p>
                    </div>
                `;
            }
            
            let modalHtml = `
                <div id="multiListReportModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target===this) this.remove();">
                    <div style="background: white; border-radius: 12px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; z-index: 1;">
                            <h2 style="margin: 0; color: #5b21b6;">üìä Combined Lists Report</h2>
                            <button onclick="this.closest('#multiListReportModal').remove()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #6b7280;">√ó</button>
                        </div>
                        <div style="padding: 20px;">
                            <!-- Lists included -->
                            <div style="background: #f5f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #c4b5fd;">
                                <div style="font-size: 0.85em; font-weight: 600; color: #5b21b6; margin-bottom: 8px;">üìã Lists Included:</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                    ${listNames.map(name => `<span style="background: #e0e7ff; color: #4338ca; padding: 4px 10px; border-radius: 4px; font-size: 0.85em;">${name}</span>`).join('')}
                                </div>
                            </div>
                            
                            <!-- Stats summary -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                                <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.75em; color: #065f46;">Total Species</div>
                                    <div style="font-size: 2em; font-weight: bold; color: #10b981;" id="multiReportTotalSpecies">${totalSpecies}</div>
                                </div>
                                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.75em; color: #1e40af;">With Dates</div>
                                    <div style="font-size: 2em; font-weight: bold; color: #3b82f6;" id="multiReportWithDates">${totalWithDates}</div>
                                    <div style="font-size: 0.7em; color: #6b7280;">species with dates</div>
                                </div>
                                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.75em; color: #92400e;">Lists Combined</div>
                                    <div style="font-size: 2em; font-weight: bold; color: #f59e0b;">${selectedKeys.length}</div>
                                </div>
                            </div>
                            
                            <!-- Date filter section -->
                            ${dateFilterHtml}
                            
                            <!-- Filter status -->
                            <div id="multiReportFilterStatus" style="display: none; background: #dbeafe; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #3b82f6;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span style="font-weight: 600; color: #1e40af;">üìÖ Filtered:</span>
                                        <span id="multiReportFilteredCount" style="color: #1e40af;">0</span> species
                                        <span id="multiReportFilterRange" style="color: #6b7280; font-size: 0.85em;"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Species list -->
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 0.9em; font-weight: 600; color: #374151; margin-bottom: 10px;">üê¶ Species (<span id="multiReportSpeciesCount">${totalSpecies}</span>)</div>
                                <div id="multiReportSpeciesList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                                    ${renderMultiListSpecies(combinedSpecies)}
                                </div>
                            </div>
                            
                            <!-- Export button -->
                            <button onclick="exportMultiListReport([${selectedKeys.map(k => `'${k}'`).join(',')}])" 
                                    style="width: 100%; background: #10b981; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                üì• Export Combined List (CSV)
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Render species list for multi-list report
        function renderMultiListSpecies(combinedSpecies, startDate = null, endDate = null) {
            let filtered = Array.from(combinedSpecies.entries());
            
            // Apply date filter if provided
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59); // Include entire end day
                
                filtered = filtered.filter(([species, data]) => {
                    // Check if ANY date falls within range
                    if (!data.allDates || data.allDates.length === 0) return false;
                    
                    return data.allDates.some(dateStr => {
                        const date = new Date(dateStr);
                        return date >= start && date <= end;
                    });
                });
                
                // Find the matching date for display
                filtered = filtered.map(([species, data]) => {
                    let matchingDate = null;
                    for (const dateStr of data.allDates) {
                        const date = new Date(dateStr);
                        if (date >= start && date <= end) {
                            if (!matchingDate || date < matchingDate) {
                                matchingDate = date;
                            }
                        }
                    }
                    return [species, { ...data, displayDate: matchingDate }];
                });
            }
            
            // Sort alphabetically
            filtered.sort((a, b) => a[0].localeCompare(b[0]));
            
            if (filtered.length === 0) {
                return '<div style="padding: 20px; text-align: center; color: #6b7280;">No species found in this date range.</div>';
            }
            
            return filtered.map(([species, data], i) => {
                const displayDate = data.displayDate || data.earliestDate;
                return `
                    <div style="padding: 10px 12px; border-bottom: 1px solid #f3f4f6; ${i % 2 === 0 ? 'background: #f9fafb;' : ''}">
                        <div style="font-weight: 500; color: #111827;">${species}</div>
                        <div style="font-size: 0.75em; color: #6b7280; margin-top: 2px;">
                            ${data.lists.length > 1 ? `Seen in ${data.lists.length} regions` : data.lists[0]}
                            ${displayDate ? ` ‚Ä¢ ${displayDate.toLocaleDateString()}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Apply date filter to multi-list report
        function applyMultiListDateFilter(startDate, endDate) {
            if (!window.multiListReportData) return;
            
            const { combinedSpecies } = window.multiListReportData;
            
            // Update the species list
            const speciesList = document.getElementById('multiReportSpeciesList');
            if (speciesList) {
                speciesList.innerHTML = renderMultiListSpecies(combinedSpecies, startDate, endDate);
            }
            
            // Count filtered species
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59);
            
            let filteredCount = 0;
            combinedSpecies.forEach((data) => {
                if (data.allDates && data.allDates.length > 0) {
                    const hasMatch = data.allDates.some(dateStr => {
                        const date = new Date(dateStr);
                        return date >= start && date <= end;
                    });
                    if (hasMatch) filteredCount++;
                }
            });
            
            // Update UI
            document.getElementById('multiReportSpeciesCount').textContent = filteredCount;
            document.getElementById('multiReportTotalSpecies').textContent = filteredCount;
            
            // Show filter status
            const filterStatus = document.getElementById('multiReportFilterStatus');
            if (filterStatus) {
                filterStatus.style.display = 'block';
                document.getElementById('multiReportFilteredCount').textContent = filteredCount;
                document.getElementById('multiReportFilterRange').textContent = ` (${startDate} to ${endDate})`;
            }
            
            // Update date inputs
            const startInput = document.getElementById('multiReportStartDate');
            const endInput = document.getElementById('multiReportEndDate');
            if (startInput) startInput.value = startDate;
            if (endInput) endInput.value = endDate;
            
            // Store current filter for export
            window.multiListReportData.currentFilter = { startDate, endDate };
        }
        
        // Apply quick preset to multi-list report
        function applyMultiListQuickPreset(preset) {
            const today = new Date();
            let startDate, endDate;
            
            switch (preset) {
                case 'last30':
                    startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                    endDate = today;
                    break;
                case 'last90':
                    startDate = new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000);
                    endDate = today;
                    break;
                case 'last365':
                    startDate = new Date(today.getTime() - 365 * 24 * 60 * 60 * 1000);
                    endDate = today;
                    break;
                default:
                    return;
            }
            
            applyMultiListDateFilter(
                startDate.toISOString().split('T')[0],
                endDate.toISOString().split('T')[0]
            );
        }
        
        // Apply custom date filter from inputs
        function applyMultiListCustomDateFilter() {
            const startDate = document.getElementById('multiReportStartDate')?.value;
            const endDate = document.getElementById('multiReportEndDate')?.value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates.');
                return;
            }
            
            applyMultiListDateFilter(startDate, endDate);
        }
        
        // Clear date filter on multi-list report
        function clearMultiListDateFilter() {
            if (!window.multiListReportData) return;
            
            const { combinedSpecies, totalWithDates } = window.multiListReportData;
            const totalSpecies = combinedSpecies.size;
            
            // Reset species list
            const speciesList = document.getElementById('multiReportSpeciesList');
            if (speciesList) {
                speciesList.innerHTML = renderMultiListSpecies(combinedSpecies);
            }
            
            // Reset counts
            document.getElementById('multiReportSpeciesCount').textContent = totalSpecies;
            document.getElementById('multiReportTotalSpecies').textContent = totalSpecies;
            
            // Hide filter status
            const filterStatus = document.getElementById('multiReportFilterStatus');
            if (filterStatus) {
                filterStatus.style.display = 'none';
            }
            
            // Clear inputs
            const startInput = document.getElementById('multiReportStartDate');
            const endInput = document.getElementById('multiReportEndDate');
            if (startInput) startInput.value = '';
            if (endInput) endInput.value = '';
            
            // Clear stored filter
            if (window.multiListReportData) {
                window.multiListReportData.currentFilter = null;
            }
        }
        
        // Save date range from multi-list report
        function promptSaveMultiListDateRange() {
            const startDate = document.getElementById('multiReportStartDate')?.value;
            const endDate = document.getElementById('multiReportEndDate')?.value;
            
            if (!startDate || !endDate) {
                alert('Please select a date range first.');
                return;
            }
            
            const name = prompt('Enter a name for this date range (e.g., "2024 Trip", "Summer 2023"):');
            if (!name) return;
            
            const savedRanges = getSavedDateRanges();
            savedRanges.push({ name, startDate, endDate });
            localStorage.setItem('travelingBirder_savedDateRanges', JSON.stringify(savedRanges));
            
            alert(`Date range "${name}" saved!`);
        }
        
        // Export combined multi-list report (respects current filter)
        function exportMultiListReport(listKeys) {
            const combinedSpecies = new Map();
            const listNames = [];
            
            listKeys.forEach(key => {
                const list = allBirdLists[key];
                if (!list) return;
                
                listNames.push(list.name);
                
                list.species.forEach(species => {
                    if (!combinedSpecies.has(species)) {
                        combinedSpecies.set(species, { lists: [], earliestDate: null });
                    }
                    combinedSpecies.get(species).lists.push(list.name);
                    
                    if (list.speciesWithDates && list.speciesWithDates[species]) {
                        const date = new Date(list.speciesWithDates[species]);
                        const current = combinedSpecies.get(species).earliestDate;
                        if (!current || date < current) {
                            combinedSpecies.get(species).earliestDate = date;
                        }
                    }
                });
            });
            
            // Check if there's an active filter
            let filtered = Array.from(combinedSpecies.entries());
            let filterSuffix = '';
            
            if (window.multiListReportData?.currentFilter) {
                const { startDate, endDate } = window.multiListReportData.currentFilter;
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59);
                
                filtered = filtered.filter(([species, data]) => {
                    if (!data.earliestDate) return false;
                    return data.earliestDate >= start && data.earliestDate <= end;
                });
                
                filterSuffix = `_${startDate}_to_${endDate}`;
            }
            
            // Build CSV
            let csv = 'Species,Regions Seen,First Date\n';
            filtered
                .sort((a, b) => a[0].localeCompare(b[0]))
                .forEach(([species, data]) => {
                    const date = data.earliestDate ? data.earliestDate.toISOString().split('T')[0] : '';
                    csv += `"${species}","${data.lists.join('; ')}","${date}"\n`;
                });
            
            // Download
            const filename = `Combined_${listNames.length}_Lists${filterSuffix}_${new Date().toISOString().split('T')[0]}.csv`;
            downloadCSV(csv, filename);
        }
        
        function showListReport(listKey) {
            const list = allBirdLists[listKey];
            if (!list) return;
            
            const savedRanges = getSavedDateRanges();
            
            // Check if list has date information
            const hasDateInfo = list.speciesWithDates && Object.keys(list.speciesWithDates).length > 0;
            const dateCount = hasDateInfo ? Object.keys(list.speciesWithDates).length : 0;
            
            // Build saved ranges HTML
            let savedRangesHtml = '';
            if (savedRanges.length > 0 && hasDateInfo) {
                savedRangesHtml = `
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 0.85em; font-weight: 600; color: #065f46; margin-bottom: 8px;">üìÖ Saved Date Ranges</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${savedRanges.map(range => `
                                <button onclick="applySavedDateRange('${range.startDate}', '${range.endDate}', '${listKey}')" 
                                        style="background: #d1fae5; color: #065f46; border: 1px solid #10b981; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                                    <span>${range.name}</span>
                                    <span onclick="event.stopPropagation(); deleteSavedRange('${range.name}', '${listKey}')" 
                                          style="color: #dc2626; font-weight: bold; margin-left: 4px;" title="Delete">√ó</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Build date filter section (only if dates available)
            let dateFilterHtml = '';
            if (hasDateInfo) {
                dateFilterHtml = `
                    <!-- Quick presets -->
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 0.85em; font-weight: 600; color: #374151; margin-bottom: 8px;">‚ö° Quick Presets</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;" id="quickPresetButtons">
                        </div>
                    </div>
                    
                    <!-- Date filter section -->
                    <div style="background: #f5f3ff; border: 1px solid #c4b5fd; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="font-size: 0.9em; font-weight: 600; color: #5b21b6; margin-bottom: 10px;">üìÖ Custom Date Range</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label style="font-size: 0.75em; color: #6b7280;">Start Date</label>
                                <input type="date" id="reportStartDate" style="width: 100%; padding: 8px; border: 1px solid #c4b5fd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="font-size: 0.75em; color: #6b7280;">End Date</label>
                                <input type="date" id="reportEndDate" style="width: 100%; padding: 8px; border: 1px solid #c4b5fd; border-radius: 4px;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px;">
                            <button onclick="filterListByDateRange('${listKey}')" style="background: #7c3aed; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Apply Filter
                            </button>
                            <button onclick="promptSaveDateRange('${listKey}')" title="Save this date range for reuse" style="background: #10b981; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                üíæ Save
                            </button>
                        </div>
                    </div>
                `;
            } else {
                dateFilterHtml = `
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #fcd34d;">
                        <p style="margin: 0 0 10px 0; color: #92400e; font-weight: 600;">üìÖ Date filtering not available</p>
                        <p style="margin: 0 0 10px 0; font-size: 0.85em; color: #78350f;">
                            Your uploaded list doesn't include observation dates. To enable date filtering:
                        </p>
                        <ol style="margin: 0; padding-left: 20px; font-size: 0.85em; color: #78350f;">
                            <li>Go to <a href="https://ebird.org/downloadMyData" target="_blank" style="color: #2563eb;">ebird.org/downloadMyData</a></li>
                            <li>Request and download your full eBird data</li>
                            <li>Re-upload that CSV file</li>
                        </ol>
                    </div>
                `;
            }
            
            // Create modal for report
            let modalHtml = `
                <div id="listReportModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target===this) this.remove();">
                    <div style="background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="margin: 0; color: #065f46;">üìä ${list.name} Report</h2>
                            <button onclick="this.closest('#listReportModal').remove()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #6b7280;">√ó</button>
                        </div>
                        <div style="padding: 20px;">
                            <!-- Stats summary -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.8em; color: #065f46;">Total Species</div>
                                    <div style="font-size: 2.5em; font-weight: bold; color: #10b981;">${list.count}</div>
                                </div>
                                <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.8em; color: #1e40af;">${hasDateInfo ? 'With Dates' : 'Uploaded'}</div>
                                    <div style="font-size: ${hasDateInfo ? '2.5em' : '1.2em'}; font-weight: ${hasDateInfo ? 'bold' : '600'}; color: #3b82f6;">
                                        ${hasDateInfo ? dateCount : new Date(list.uploadDate).toLocaleDateString()}
                                    </div>
                                    ${hasDateInfo ? '<div style="font-size: 0.75em; color: #6b7280;">species with dates</div>' : ''}
                                </div>
                            </div>
                            
                            <!-- Saved date ranges -->
                            ${savedRangesHtml}
                            
                            <!-- Date filter section or message -->
                            ${dateFilterHtml}
                            
                            <!-- Results area -->
                            <div id="filteredListResult"></div>
                            
                            <!-- Export buttons -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                                <button onclick="exportListToCSV('${listKey}')" style="background: #10b981; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    üì• Export Full List
                                </button>
                                <button onclick="this.closest('#listReportModal').remove()" style="background: #6b7280; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Populate quick preset buttons
            populateQuickPresets(listKey);
        }
        
        // Populate quick date range presets
        function populateQuickPresets(listKey) {
            const container = document.getElementById('quickPresetButtons');
            if (!container) return;
            
            const now = new Date();
            const currentYear = now.getFullYear();
            
            // Define presets
            const presets = [
                { name: `${currentYear}`, start: `${currentYear}-01-01`, end: `${currentYear}-12-31` },
                { name: `${currentYear - 1}`, start: `${currentYear - 1}-01-01`, end: `${currentYear - 1}-12-31` },
                { name: `${currentYear - 2}`, start: `${currentYear - 2}-01-01`, end: `${currentYear - 2}-12-31` },
                { name: 'Last 30 days', start: formatDateForInput(new Date(now - 30 * 24 * 60 * 60 * 1000)), end: formatDateForInput(now) },
                { name: 'Last 90 days', start: formatDateForInput(new Date(now - 90 * 24 * 60 * 60 * 1000)), end: formatDateForInput(now) },
                { name: 'Last 365 days', start: formatDateForInput(new Date(now - 365 * 24 * 60 * 60 * 1000)), end: formatDateForInput(now) },
            ];
            
            // Add decade presets if user has older data
            for (let decade = 2020; decade >= 1990; decade -= 10) {
                if (decade < currentYear - 5) {
                    presets.push({ 
                        name: `${decade}s`, 
                        start: `${decade}-01-01`, 
                        end: `${decade + 9}-12-31` 
                    });
                }
            }
            
            let html = presets.map(preset => `
                <button onclick="applyQuickPreset('${preset.start}', '${preset.end}', '${listKey}')" 
                        style="background: #e0e7ff; color: #4338ca; border: 1px solid #a5b4fc; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em; font-weight: 500;">
                    ${preset.name}
                </button>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // Format date for input field (YYYY-MM-DD)
        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }
        
        // Apply a quick preset
        function applyQuickPreset(startDate, endDate, listKey) {
            document.getElementById('reportStartDate').value = startDate;
            document.getElementById('reportEndDate').value = endDate;
            filterListByDateRange(listKey);
        }
        
        // Apply a saved date range
        function applySavedDateRange(startDate, endDate, listKey) {
            document.getElementById('reportStartDate').value = startDate;
            document.getElementById('reportEndDate').value = endDate;
            filterListByDateRange(listKey);
        }
        
        // Delete a saved date range
        function deleteSavedRange(name, listKey) {
            if (confirm(`Delete saved range "${name}"?`)) {
                deleteSavedDateRange(name);
                // Refresh the modal
                document.getElementById('listReportModal')?.remove();
                showListReport(listKey);
            }
        }
        
        // Prompt to save a date range
        function promptSaveDateRange(listKey) {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates first.');
                return;
            }
            
            // Create a simple name suggestion
            const start = new Date(startDate);
            const end = new Date(endDate);
            const startYear = start.getFullYear();
            const endYear = end.getFullYear();
            
            let suggestedName = '';
            if (startYear === endYear) {
                if (start.getMonth() === 0 && start.getDate() === 1 && 
                    end.getMonth() === 11 && end.getDate() === 31) {
                    suggestedName = `Year ${startYear}`;
                } else if (start.getMonth() === end.getMonth()) {
                    suggestedName = `${start.toLocaleDateString('en-US', { month: 'short' })} ${startYear}`;
                } else {
                    suggestedName = `${start.toLocaleDateString('en-US', { month: 'short' })} - ${end.toLocaleDateString('en-US', { month: 'short' })} ${startYear}`;
                }
            } else {
                suggestedName = `${startYear} - ${endYear}`;
            }
            
            const name = prompt('Name for this date range:', suggestedName);
            if (name && name.trim()) {
                saveDateRange(name.trim(), startDate, endDate);
                // Refresh the modal to show the new saved range
                document.getElementById('listReportModal')?.remove();
                showListReport(listKey);
            }
        }
        
        // Filter list by date range and show results
        function filterListByDateRange(listKey) {
            const list = allBirdLists[listKey];
            if (!list) return;
            
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const resultDiv = document.getElementById('filteredListResult');
            
            if (!startDate || !endDate) {
                resultDiv.innerHTML = '<p style="color: #ef4444;">Please select both start and end dates.</p>';
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59);
            
            // Filter species by date - use speciesWithDates if available
            const filteredSpecies = [];
            
            if (list.speciesWithDates && Object.keys(list.speciesWithDates).length > 0) {
                // speciesWithDates can be either:
                // - Array of date strings (new format): ["2025-01-15", "2025-03-20"]
                // - Single date string (old format): "2025-01-15T00:00:00.000Z"
                Object.entries(list.speciesWithDates).forEach(([speciesName, dates]) => {
                    // Handle both array format (new) and string format (old/legacy)
                    const dateArray = Array.isArray(dates) ? dates : [dates];
                    
                    // Check if ANY observation date falls within the range
                    let matchingDate = null;
                    for (const dateStr of dateArray) {
                        if (dateStr) {
                            const obsDate = new Date(dateStr);
                            if (obsDate >= start && obsDate <= end) {
                                // Found a match - use the earliest matching date for display
                                if (!matchingDate || obsDate < matchingDate) {
                                    matchingDate = obsDate;
                                }
                            }
                        }
                    }
                    
                    if (matchingDate) {
                        filteredSpecies.push({ 
                            name: speciesName, 
                            date: matchingDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }),
                            dateObj: matchingDate
                        });
                    }
                });
            } else if (list.species && Array.isArray(list.species)) {
                // No date info available - show helpful message
                resultDiv.innerHTML = `
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; color: #92400e; font-weight: 600;">üìÖ No date information found</p>
                        <p style="margin: 10px 0 0 0; font-size: 0.85em; color: #92400e;">
                            To use date filtering, download your <strong>full eBird data</strong>:
                        </p>
                        <ol style="text-align: left; margin: 15px 0; padding-left: 20px; font-size: 0.85em; color: #78350f;">
                            <li>Go to <a href="https://ebird.org/downloadMyData" target="_blank" style="color: #2563eb;">ebird.org/downloadMyData</a></li>
                            <li>Click "Request my observations"</li>
                            <li>Download the CSV when ready (check email)</li>
                            <li>Re-upload that CSV here</li>
                        </ol>
                        <p style="margin: 0; font-size: 0.8em; color: #92400e;">
                            The full export includes observation dates for each species.
                        </p>
                    </div>
                `;
                return;
            }
            
            // Sort by date
            filteredSpecies.sort((a, b) => a.dateObj - b.dateObj);
            
            if (filteredSpecies.length === 0) {
                resultDiv.innerHTML = `
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; color: #92400e;">No species found in this date range.</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 0.85em; color: #065f46;">Species in Date Range</div>
                            <div style="font-size: 2em; font-weight: bold; color: #10b981;">${filteredSpecies.length}</div>
                        </div>
                        <button onclick="exportFilteredList('${listKey}', '${startDate}', '${endDate}')" style="background: #10b981; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üì• Export Filtered
                        </button>
                    </div>
                </div>
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
            `;
            
            filteredSpecies.forEach((sp, i) => {
                const bgColor = i % 2 === 0 ? '#f9fafb' : 'white';
                html += `
                    <div style="padding: 8px 12px; background: ${bgColor}; display: flex; justify-content: space-between; border-bottom: 1px solid #f3f4f6;">
                        <span style="font-weight: 500;">${sp.name}</span>
                        <span style="color: #6b7280; font-size: 0.85em;">${sp.date}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            resultDiv.innerHTML = html;
        }
        
        // Export full list to CSV
        function exportListToCSV(listKey) {
            const list = allBirdLists[listKey];
            if (!list || !list.species) return;
            
            let csv = 'Common Name,Date\n';
            if (list.speciesWithDates) {
                Object.entries(list.speciesWithDates).forEach(([speciesName, dateStr]) => {
                    csv += `"${speciesName}","${dateStr || ''}"\n`;
                });
            } else if (Array.isArray(list.species)) {
                list.species.forEach(speciesName => {
                    csv += `"${speciesName}",""\n`;
                });
            }
            
            downloadCSV(csv, `${list.name.replace(/[^a-z0-9]/gi, '_')}_export.csv`);
        }
        
        // Export filtered list to CSV
        function exportFilteredList(listKey, startDate, endDate) {
            const list = allBirdLists[listKey];
            if (!list) return;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59);
            
            let csv = 'Common Name,Date\n';
            
            if (list.speciesWithDates) {
                Object.entries(list.speciesWithDates).forEach(([speciesName, dateStr]) => {
                    if (dateStr) {
                        const obsDate = new Date(dateStr);
                        if (obsDate >= start && obsDate <= end) {
                            csv += `"${speciesName}","${dateStr}"\n`;
                        }
                    }
                });
            }
            
            downloadCSV(csv, `${list.name.replace(/[^a-z0-9]/gi, '_')}_${startDate}_to_${endDate}.csv`);
        }
        
        // Generate report from panel date inputs
        function generateListReport() {
            const startDate = document.getElementById('listReportStart')?.value;
            const endDate = document.getElementById('listReportEnd')?.value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates.');
                return;
            }
            
            // Use world list if available
            const worldList = allBirdLists['world'];
            if (!worldList || !worldList.species) {
                alert('Please upload your World Life List first.');
                return;
            }
            
            showListReport('world');
            
            // Auto-fill dates after modal opens
            setTimeout(() => {
                document.getElementById('reportStartDate').value = startDate;
                document.getElementById('reportEndDate').value = endDate;
                filterListByDateRange('world');
            }, 100);
        }
        
        // Download CSV helper
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // ============================================
        // PRINTABLE REPORTS
        // ============================================
        
        function openPrintableReport(type) {
            let reportHTML = '';
            let title = '';
            
            if (type === 'route') {
                title = 'Route Birding Checklist - Traveling Birder';
                reportHTML = generateRouteChecklistReport();
            } else if (type === 'species') {
                title = 'Species Report - Traveling Birder';
                reportHTML = generateSpeciesReport();
            }
            
            // Create full HTML document for new tab
            const fullHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f9fafb;
        }
        @media print {
            body {
                background: white;
                padding: 0;
                max-width: 100%;
            }
            .no-print {
                display: none !important;
            }
            .print-checklist-item {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
        .print-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 10px;
            color: white;
        }
        .print-btn {
            background: white;
            color: #059669;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .print-btn:hover {
            background: #f0fdf4;
        }
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="no-print print-header">
        <div style="font-size: 1.2em; font-weight: 700;">ü¶Ö ${title}</div>
        <div style="display: flex; gap: 10px;">
            <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print Report</button>
            <button class="print-btn" onclick="window.close()" style="background: #fee2e2; color: #991b1b;">‚úï Close</button>
        </div>
    </div>
    ${reportHTML}
    <script>
        // Auto-focus for immediate printing if desired
        window.focus();
        
        // Filter functions for route checklist
        function filterRouteChecklist() {
            const showTargetsOnly = document.getElementById('showTargetsOnly')?.checked;
            const groupByLocation = document.getElementById('groupByLocation')?.checked;
            const content = document.getElementById('routeChecklistContent');
            
            if (!content) return;
            
            // Get all checklist items
            const allItems = content.querySelectorAll('.checklist-species');
            const locationSections = content.querySelectorAll('.location-section');
            
            allItems.forEach(item => {
                const isTarget = item.dataset.target === 'true';
                if (showTargetsOnly && !isTarget) {
                    item.style.display = 'none';
                } else {
                    item.style.display = 'flex';
                }
            });
            
            // Update location section visibility and counts
            locationSections.forEach(section => {
                const items = section.querySelectorAll('.checklist-species');
                const visibleItems = Array.from(items).filter(i => i.style.display !== 'none');
                const countSpan = section.querySelector('.species-count');
                if (countSpan) {
                    countSpan.textContent = visibleItems.length + ' species';
                }
                section.style.display = visibleItems.length > 0 ? 'block' : 'none';
            });
        }
    </script>
</body>
</html>`;
            
            // Open in new tab
            const newTab = window.open('', '_blank');
            if (newTab) {
                newTab.document.write(fullHTML);
                newTab.document.close();
            } else {
                alert('Please allow popups to view the report in a new tab.');
            }
        }
        
        function generateRouteChecklistReport() {
            if (!allSightings || allSightings.length === 0) {
                return '<p style="text-align: center; color: #6b7280;">No search results to report. Please perform a search first.</p>';
            }
            
            const searchLocation = document.getElementById('areaInput')?.value || 
                                   document.getElementById('originInput')?.value || 
                                   'Search Area';
            const timeRange = document.getElementById('timeRange')?.value || '7';
            const targetFilter = document.getElementById('targetListType')?.value || 'all';
            const targetFilterName = document.getElementById('targetListType')?.selectedOptions[0]?.text || 'All Species';
            const userSeenSpecies = getTargetList();
            
            const today = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            
            // Group species by hotspot if available
            const speciesByLocation = new Map();
            const allSpeciesSet = new Set();
            
            allSightings.forEach(s => {
                const loc = s.locName || 'Unknown Location';
                if (!speciesByLocation.has(loc)) {
                    speciesByLocation.set(loc, { 
                        species: new Set(), 
                        lat: s.lat, 
                        lng: s.lng,
                        isTarget: new Set()
                    });
                }
                speciesByLocation.get(loc).species.add(s.comName);
                allSpeciesSet.add(s.comName);
                
                // Check if target
                if (targetFilter !== 'all' && !userSeenSpecies.has(s.comName)) {
                    speciesByLocation.get(loc).isTarget.add(s.comName);
                }
            });
            
            // Count targets
            let targetCount = 0;
            if (targetFilter !== 'all') {
                allSpeciesSet.forEach(sp => {
                    if (!userSeenSpecies.has(sp)) targetCount++;
                });
            }
            
            let html = `
                <div style="font-family: Arial, sans-serif;">
                    <!-- Report Header -->
                    <div style="text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #10b981;">
                        <h1 style="margin: 0 0 5px 0; color: #065f46; font-size: 1.8em;">ü¶Ö Traveling Birder</h1>
                        <h2 style="margin: 0 0 10px 0; color: #111827; font-size: 1.3em;">Route Birding Checklist</h2>
                        <p style="margin: 0; color: #6b7280; font-size: 0.9em;">${today}</p>
                    </div>
                    
                    <!-- Search Summary -->
                    <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #10b981;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9em;">
                            <div><strong>üìç Location:</strong> ${searchLocation}</div>
                            <div><strong>üìÖ eBird Data:</strong> Last ${timeRange} days</div>
                            <div><strong>üéØ Filter:</strong> ${targetFilterName}</div>
                            <div><strong>üê¶ Total Species:</strong> ${allSpeciesSet.size}</div>
                            ${targetFilter !== 'all' ? `<div><strong>üéØ Target Species:</strong> ${targetCount}</div>` : ''}
                            <div><strong>üìç Locations:</strong> ${speciesByLocation.size}</div>
                        </div>
                    </div>
                    
                    <!-- Checklist Options (no-print) -->
                    <div class="no-print" style="margin-bottom: 20px; padding: 15px; background: #f5f3ff; border-radius: 8px; border: 1px solid #c4b5fd;">
                        <div style="font-weight: 600; color: #5b21b6; margin-bottom: 10px;">üìã Checklist Options:</div>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="showTargetsOnly" onchange="filterRouteChecklist()" ${targetFilter !== 'all' ? 'checked' : ''}>
                            <span>Show only target species (not yet seen)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="groupByLocation" onchange="filterRouteChecklist()" checked>
                            <span>Group by location</span>
                        </label>
                    </div>
                    
                    <!-- Checklist Content -->
                    <div id="routeChecklistContent">
                        ${generateChecklistByLocation(speciesByLocation, userSeenSpecies, targetFilter !== 'all')}
                    </div>
                    
                    <!-- Footer -->
                    <div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #e5e7eb; text-align: center; font-size: 0.8em; color: #9ca3af;">
                        Generated by Traveling Birder ‚Ä¢ Data from eBird.org
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function generateChecklistByLocation(speciesByLocation, userSeenSpecies, showTargetsOnly) {
            let html = '';
            
            speciesByLocation.forEach((data, location) => {
                const speciesList = Array.from(data.species).sort();
                const targetsList = Array.from(data.isTarget);
                
                // Always show all species, use CSS to hide if needed
                const displayList = speciesList;
                
                if (displayList.length === 0) return;
                
                const targetCount = targetsList.length;
                const totalCount = speciesList.length;
                
                html += `
                    <div class="print-checklist-item location-section" style="margin-bottom: 20px; page-break-inside: avoid;">
                        <div style="background: #f3f4f6; padding: 10px 15px; border-radius: 8px 8px 0 0; border: 1px solid #d1d5db; border-bottom: none;">
                            <div style="font-weight: 700; color: #111827; font-size: 1em;">üìç ${location}</div>
                            <div style="font-size: 0.8em; color: #6b7280; margin-top: 2px;">
                                <span class="species-count">${showTargetsOnly ? targetCount : totalCount} species</span>
                                ${targetCount > 0 ? `<span style="color: #f59e0b; margin-left: 8px;">(${targetCount} targets)</span>` : ''}
                            </div>
                        </div>
                        <div style="border: 1px solid #d1d5db; border-radius: 0 0 8px 8px; padding: 10px 15px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 5px;">
                                ${displayList.map(sp => {
                                    const isTarget = !userSeenSpecies.has(sp);
                                    const hideIfTargetsOnly = showTargetsOnly && !isTarget;
                                    return `
                                        <label class="checklist-species" data-target="${isTarget}" style="display: ${hideIfTargetsOnly ? 'none' : 'flex'}; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; ${isTarget ? 'background: #fef3c7;' : ''}">
                                            <input type="checkbox" style="width: 16px; height: 16px;">
                                            <span style="font-size: 0.85em; ${isTarget ? 'font-weight: 600; color: #92400e;' : 'color: #374151;'}">${sp}</span>
                                            ${isTarget ? '<span style="font-size: 0.7em; color: #f59e0b;">üéØ</span>' : ''}
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return html || '<p style="text-align: center; color: #6b7280;">No species to display.</p>';
        }
        
        function filterRouteChecklist() {
            const showTargetsOnly = document.getElementById('showTargetsOnly')?.checked;
            const groupByLocation = document.getElementById('groupByLocation')?.checked;
            const content = document.getElementById('routeChecklistContent');
            
            if (!content || !allSightings) return;
            
            const userSeenSpecies = getTargetList();
            
            if (groupByLocation) {
                // Rebuild grouped checklist
                const speciesByLocation = new Map();
                
                allSightings.forEach(s => {
                    const loc = s.locName || 'Unknown Location';
                    if (!speciesByLocation.has(loc)) {
                        speciesByLocation.set(loc, { 
                            species: new Set(), 
                            isTarget: new Set()
                        });
                    }
                    speciesByLocation.get(loc).species.add(s.comName);
                    
                    if (!userSeenSpecies.has(s.comName)) {
                        speciesByLocation.get(loc).isTarget.add(s.comName);
                    }
                });
                
                content.innerHTML = generateChecklistByLocation(speciesByLocation, userSeenSpecies, showTargetsOnly);
            } else {
                // Flat list
                const allSpecies = [...new Set(allSightings.map(s => s.comName))].sort();
                const displayList = showTargetsOnly 
                    ? allSpecies.filter(sp => !userSeenSpecies.has(sp))
                    : allSpecies;
                
                content.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 5px; padding: 15px; border: 1px solid #d1d5db; border-radius: 8px;">
                        ${displayList.map(sp => {
                            const isTarget = !userSeenSpecies.has(sp);
                            return `
                                <label style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; ${isTarget ? 'background: #fef3c7;' : ''}">
                                    <input type="checkbox" style="width: 16px; height: 16px;">
                                    <span style="font-size: 0.85em; ${isTarget ? 'font-weight: 600; color: #92400e;' : 'color: #374151;'}">${sp}</span>
                                    ${isTarget ? '<span style="font-size: 0.7em; color: #f59e0b;">üéØ</span>' : ''}
                                </label>
                            `;
                        }).join('')}
                    </div>
                `;
            }
        }
        
        function generateSpeciesReport() {
            if (!allSightings || allSightings.length === 0) {
                return '<p style="text-align: center; color: #6b7280;">No search results to report. Please perform a search first.</p>';
            }
            
            const searchLocation = document.getElementById('areaInput')?.value || 
                                   document.getElementById('originInput')?.value || 
                                   'Search Area';
            const timeRange = document.getElementById('timeRange')?.value || '7';
            const targetFilter = document.getElementById('targetListType')?.value || 'all';
            const targetFilterName = document.getElementById('targetListType')?.selectedOptions[0]?.text || 'All Species';
            const userSeenSpecies = getTargetList();
            
            const today = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            
            // Aggregate species data
            const speciesData = new Map();
            allSightings.forEach(s => {
                if (!speciesData.has(s.comName)) {
                    speciesData.set(s.comName, {
                        count: 0,
                        locations: new Set(),
                        lastSeen: null,
                        sciName: s.sciName || ''
                    });
                }
                const data = speciesData.get(s.comName);
                data.count++;
                data.locations.add(s.locName || 'Unknown');
                
                if (s.obsDt) {
                    const date = new Date(s.obsDt);
                    if (!data.lastSeen || date > data.lastSeen) {
                        data.lastSeen = date;
                    }
                }
            });
            
            // Sort by count (most reported first)
            const sortedSpecies = Array.from(speciesData.entries())
                .sort((a, b) => b[1].count - a[1].count);
            
            // Calculate stats
            const totalSpecies = sortedSpecies.length;
            let targetCount = 0;
            let seenCount = 0;
            
            sortedSpecies.forEach(([sp, data]) => {
                if (userSeenSpecies.has(sp)) {
                    seenCount++;
                } else {
                    targetCount++;
                }
            });
            
            let html = `
                <div style="font-family: Arial, sans-serif;">
                    <!-- Report Header -->
                    <div style="text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #6366f1;">
                        <h1 style="margin: 0 0 5px 0; color: #4338ca; font-size: 1.8em;">ü¶Ö Traveling Birder</h1>
                        <h2 style="margin: 0 0 10px 0; color: #111827; font-size: 1.3em;">Species Report</h2>
                        <p style="margin: 0; color: #6b7280; font-size: 0.9em;">${today}</p>
                    </div>
                    
                    <!-- Search Summary -->
                    <div style="background: #f5f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #c4b5fd;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9em;">
                            <div><strong>üìç Location:</strong> ${searchLocation}</div>
                            <div><strong>üìÖ eBird Data:</strong> Last ${timeRange} days</div>
                            <div><strong>üéØ Filter:</strong> ${targetFilterName}</div>
                            <div><strong>üìä Total Reports:</strong> ${allSightings.length.toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <!-- Stats Summary -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #10b981;">
                            <div style="font-size: 0.8em; color: #065f46;">Total Species</div>
                            <div style="font-size: 2em; font-weight: bold; color: #10b981;">${totalSpecies}</div>
                        </div>
                        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #f59e0b;">
                            <div style="font-size: 0.8em; color: #92400e;">Target Species</div>
                            <div style="font-size: 2em; font-weight: bold; color: #f59e0b;">${targetCount}</div>
                        </div>
                        <div style="background: #dbeafe; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #3b82f6;">
                            <div style="font-size: 0.8em; color: #1e40af;">Already Seen</div>
                            <div style="font-size: 2em; font-weight: bold; color: #3b82f6;">${seenCount}</div>
                        </div>
                    </div>
                    
                    <!-- Species Table -->
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #111827; font-size: 1.1em;">üê¶ Species List (${totalSpecies})</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">Species</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db; width: 80px;">Reports</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db; width: 80px;">Locations</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db; width: 100px;">Last Seen</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db; width: 80px;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedSpecies.map(([sp, data], i) => {
                                    const isTarget = !userSeenSpecies.has(sp);
                                    const lastSeenStr = data.lastSeen 
                                        ? data.lastSeen.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                                        : '-';
                                    return `
                                        <tr style="${isTarget ? 'background: #fef3c7;' : (i % 2 === 0 ? 'background: #f9fafb;' : '')}">
                                            <td style="padding: 8px 10px; border: 1px solid #d1d5db;">
                                                <div style="font-weight: ${isTarget ? '600' : '400'}; color: ${isTarget ? '#92400e' : '#111827'};">${sp}</div>
                                                ${data.sciName ? `<div style="font-size: 0.8em; color: #6b7280; font-style: italic;">${data.sciName}</div>` : ''}
                                            </td>
                                            <td style="padding: 8px 10px; border: 1px solid #d1d5db; text-align: center;">${data.count}</td>
                                            <td style="padding: 8px 10px; border: 1px solid #d1d5db; text-align: center;">${data.locations.size}</td>
                                            <td style="padding: 8px 10px; border: 1px solid #d1d5db; text-align: center;">${lastSeenStr}</td>
                                            <td style="padding: 8px 10px; border: 1px solid #d1d5db; text-align: center;">
                                                ${isTarget 
                                                    ? '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600;">TARGET</span>'
                                                    : '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">SEEN</span>'
                                                }
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Footer -->
                    <div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #e5e7eb; text-align: center; font-size: 0.8em; color: #9ca3af;">
                        Generated by Traveling Birder ‚Ä¢ Data from eBird.org
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function printReport() {
            window.print();
        }
        
        function exportSearchResults() {
            if (!allSightings || allSightings.length === 0) {
                alert('No search results to export. Please perform a search first.');
                return;
            }
            
            const userSeenSpecies = getTargetList();
            
            // Aggregate species data
            const speciesData = new Map();
            allSightings.forEach(s => {
                if (!speciesData.has(s.comName)) {
                    speciesData.set(s.comName, {
                        sciName: s.sciName || '',
                        count: 0,
                        locations: new Set(),
                        lastSeen: null
                    });
                }
                const data = speciesData.get(s.comName);
                data.count++;
                data.locations.add(s.locName || 'Unknown');
                
                if (s.obsDt) {
                    const date = new Date(s.obsDt);
                    if (!data.lastSeen || date > data.lastSeen) {
                        data.lastSeen = date;
                    }
                }
            });
            
            // Build CSV
            let csv = 'Common Name,Scientific Name,Reports,Locations,Last Seen,Status\n';
            
            Array.from(speciesData.entries())
                .sort((a, b) => b[1].count - a[1].count)
                .forEach(([sp, data]) => {
                    const status = userSeenSpecies.has(sp) ? 'Seen' : 'Target';
                    const lastSeen = data.lastSeen ? data.lastSeen.toISOString().split('T')[0] : '';
                    csv += `"${sp}","${data.sciName}",${data.count},${data.locations.size},"${lastSeen}","${status}"\n`;
                });
            
            const location = document.getElementById('areaInput')?.value || 
                            document.getElementById('originInput')?.value || 
                            'Search';
            const filename = `Birding_${location.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            
            downloadCSV(csv, filename);
        }

        function updateHeaderWithLifeList() {
            const headerDiv = document.getElementById('ebirdHeader');
            if (!headerDiv) return;
            
            const displayName = userName && userName !== 'eBird User' ? userName : 'eBird User';
            
            // Determine status and create detailed display
            let statusHTML = '';
            
            if (userList.size > 0) {
                const sourceIcon = userLifeListSource === 'csv' ? 'üìÑ' : 'üì°';
                const sourceText = userLifeListSource === 'csv' ? 'Full CSV' : 'API (30d)';
                const sourceColor = userLifeListSource === 'csv' ? '#10b981' : '#f59e0b';
                
                statusHTML = `
                    <div class="ebird-connected">
                        <div style="display: flex; flex-direction: column; gap: 4px; flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="ebird-connected-text">‚úÖ Connected: ${displayName}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px; font-size: 0.85em;">
                                <span style="color: var(--text-primary); font-weight: 600;">
                                    ü¶© ${userList.size} species
                                </span>
                                <span style="background: ${sourceColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.85em; font-weight: 600;">
                                    ${sourceIcon} ${sourceText}
                                </span>
                            </div>
                        </div>
                        <button class="disconnect-btn" onclick="disconnectEbird()">Disconnect</button>
                    </div>
                `;
            } else {
                // Connected but no species loaded
                statusHTML = `
                    <div class="ebird-connected">
                        <div style="display: flex; flex-direction: column; gap: 4px; flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="ebird-connected-text">‚úÖ Connected: ${displayName}</span>
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">
                                ‚ö†Ô∏è No species loaded - Import CSV or wait for API
                            </div>
                        </div>
                        <button class="disconnect-btn" onclick="disconnectEbird()">Disconnect</button>
                    </div>
                `;
            }
            
            headerDiv.innerHTML = statusHTML;
        }

        // Update connection status display on page load
        function updateConnectionStatus() {
            const headerDiv = document.getElementById('ebirdHeader');
            if (!headerDiv) return;
            
            // Check if connected
            if (ebirdAuthenticated && userApiKey) {
                updateHeaderWithLifeList();
            } else {
                // Check if we have stored life list but not connected
                const storedList = loadFromLocalStorage(STORAGE_KEYS.LIFE_LIST);
                if (storedList && storedList.species && storedList.species.length > 0) {
                    headerDiv.innerHTML = `
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 8px; margin-bottom: 5px;">
                            <div style="font-size: 0.85em; color: #92400e; font-weight: 600;">
                                üìÑ ${storedList.count} species loaded from ${storedList.source}
                            </div>
                            <div style="font-size: 0.75em; color: #92400e; margin-top: 2px;">
                                Connect to eBird for live data
                            </div>
                        </div>
                        <div class="ebird-login">
                            <input type="password" id="apiKey" placeholder="eBird API Key">
                            <button onclick="connectEbird()">Connect</button>
                        </div>
                        <div style="text-align: center; font-size: 0.75em; color: var(--text-secondary);">
                            Get free API key: <a href="https://ebird.org/api/keygen" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: none;">ebird.org/api/keygen</a>
                        </div>
                    `;
                }
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('accountMenu');
            const accountBtn = event.target.closest('.account-dropdown');
            
            if (menu && !accountBtn && !event.target.closest('.account-menu')) {
                menu.classList.remove('active');
            }
        });

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async function() {
            // Initialize IndexedDB first (for large data storage)
            await initIndexedDB();
            
            // Load saved settings
            const settings = loadSettings();
            darkModeEnabled = settings.darkMode || false;
            if (darkModeEnabled) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            
            // Load API key from localStorage
            const savedApiKey = localStorage.getItem('travelingBirder_apiKey');
            if (savedApiKey) {
                userApiKey = savedApiKey;
                ebirdAuthenticated = true;
            }
            
            // Load life list from localStorage if exists
            const savedLifeList = loadLifeList();
            if (savedLifeList.size > 0) {
                console.log(`üì• Loaded ${savedLifeList.size} species from localStorage (${userLifeListSource})`);
            }
            
            // Load year/month lists from localStorage if exists
            loadYearMonthLists();
            
            // Load marker style preference
            loadMarkerStylePreference();
            
            // Update header status
            updateHeaderStatus();
            
            // Initialize the Your Bird Lists panel (always visible)
            await loadAllBirdLists();
            updateListsStatsPanel();
            
            // Check if terms accepted - show on first visit
            const termsData = loadFromLocalStorage(STORAGE_KEYS.TERMS);
            if (!termsData || !termsData.accepted) {
                setTimeout(() => showTermsModal(), 1000);
            }
            
            // Check for returning user or show welcome overlay
            setTimeout(() => checkReturningUser(), 2000);
            
            console.log('‚úÖ v7.5 initialized with IndexedDB');
        });

        // ============================================
        // EBIRD AUTHENTICATION
        // ============================================
        async function connectEbird() {
            const apiKeyInput = document.getElementById('apiKey');
            const apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';

            if (!apiKey) {
                alert('Please enter your eBird API key');
                return;
            }

            console.log('üîë Connecting to eBird...');
            showLoading('Connecting to eBird...');

            try {
                // Test API key by fetching user's observations
                const response = await fetch(
                    `https://api.ebird.org/v2/data/obs/US/recent?maxResults=10`,
                    { headers: { 'X-eBirdApiToken': apiKey } }
                );

                if (!response.ok) {
                    hideLoading();
                    throw new Error('Invalid API key');
                }

                // Fetch user's complete life list
                updateLoadingStatus('Loading your species lists...');
                await fetchUserLifeList(apiKey);

                userApiKey = apiKey;
                ebirdAuthenticated = true;
                
                // Track successful connection
                if (typeof gtag === 'function') {
                    gtag('event', 'login', {
                        method: 'ebird_api'
                    });
                }
                
                // Save to localStorage
                localStorage.setItem('travelingBirder_apiKey', apiKey);

                // Update header status
                updateHeaderStatus();
                
                showSections();
                hideLoading();

                console.log(`‚úÖ Connected! User has ${userList.size} species`);
                
            } catch (error) {
                console.error('‚ùå eBird connection failed:', error);
                logBirderError('ebird_api', 'eBird connection failed', { error: error.message });
                hideLoading();
                alert('Failed to connect to eBird. Please check your API key.');
            }
        }

        async function fetchUserLifeList(apiKey) {
            console.log('üìã Fetching your eBird life list...');
            updateLoadingStatus('Loading your personal species lists...');
            
            const allSpecies = new Set();
            
            try {
                // KEY FIX: Use detail=full to get userDisplayName in responses!
                console.log('üîç Using detail=full to get observer information...');
                
                // Sample a few regions to identify the user
                const testRegions = ['US-VT', 'US-MA', 'US-NY', 'US-NH'];
                
                for (const region of testRegions) {
                    try {
                        // CRITICAL: Add detail=full parameter!
                        const response = await fetch(
                            `https://api.ebird.org/v2/data/obs/${region}/recent?maxResults=200&back=30&detail=full`,
                            { headers: { 'X-eBirdApiToken': apiKey } }
                        );
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            // Get username from first observation with userDisplayName
                            if (!userName && data.length > 0) {
                                for (const obs of data) {
                                    if (obs.userDisplayName) {
                                        userName = obs.userDisplayName;
                                        console.log(`üë§ Identified user: ${userName}`);
                                        break;
                                    }
                                }
                            }
                            
                            // If we found a username, collect their species
                            if (userName) {
                                data.forEach(obs => {
                                    if (obs.userDisplayName === userName) {
                                        allSpecies.add(obs.comName);
                                    }
                                });
                            }
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 100));
                    } catch (e) {
                        console.warn(`Couldn't fetch from ${region}`);
                    }
                    
                    // If we found the user, get more of their species
                    if (userName && allSpecies.size > 10) break;
                }
                
                // Now get more species from this user across many regions
                if (userName) {
                    console.log(`üìç Fetching ${userName}'s observations from multiple regions...`);
                    
                    const allRegions = [
                        'US-VT', 'US-NH', 'US-ME', 'US-MA', 'US-CT', 'US-RI',
                        'US-NY', 'US-NJ', 'US-PA', 'US-MD', 'US-VA',
                        'US-FL', 'US-TX', 'US-CA', 'US-AZ', 'US-CO'
                    ];
                    
                    for (const region of allRegions) {
                        try {
                            const response = await fetch(
                                `https://api.ebird.org/v2/data/obs/${region}/recent?maxResults=200&back=30&detail=full`,
                                { headers: { 'X-eBirdApiToken': apiKey } }
                            );
                            
                            if (response.ok) {
                                const data = await response.json();
                                const beforeCount = allSpecies.size;
                                
                                data.forEach(obs => {
                                    if (obs.userDisplayName === userName) {
                                        allSpecies.add(obs.comName);
                                    }
                                });
                                
                                const newSpecies = allSpecies.size - beforeCount;
                                if (newSpecies > 0) {
                                    console.log(`üìç ${region}: +${newSpecies} species (${allSpecies.size} total)`);
                                }
                            }
                            
                            await new Promise(resolve => setTimeout(resolve, 50));
                        } catch (e) {
                            console.warn(`Couldn't fetch from ${region}`);
                        }
                        
                        // Stop if we've found a good amount
                        if (allSpecies.size > 500) break;
                    }
                }

            } catch (error) {
                console.error('Error fetching life list:', error);
            }

            userList = allSpecies;
            
            // V7.0: Check if user has CSV imported list
            const storedList = loadFromLocalStorage(STORAGE_KEYS.LIFE_LIST);
            if (storedList && storedList.source === 'csv') {
                console.log(`üì• Found CSV-imported life list (${storedList.count} species)`);
                console.log(`üîÑ Merging with API data (${allSpecies.size} species from last 30 days)`);
                
                // Merge: Keep CSV list, add any new species from API
                storedList.species.forEach(sp => userList.add(sp));
                
                // Update stored list with merged data
                saveLifeList(Array.from(userList), 'csv');
                console.log(`‚úÖ Total: ${userList.size} species (CSV + recent API)`);
            } else {
                // No CSV, save API list
                saveLifeList(Array.from(userList), 'api');
                console.log(`‚úÖ Loaded ${userList.size} species from ${userName || 'user'}'s observations (last 30 days via API)`);
            }
            
            if (userList.size === 0) {
                console.warn('‚ö†Ô∏è No personal observations found in last 30 days.');
                console.log('üí° Tip: Import your eBird CSV for complete history (Menu ‚Üí Import Life List CSV)');
            }
            
            // Update header to show count
            updateHeaderWithLifeList();
            
            // Store for different list types
            window.userLifeList = new Set(userList);
            window.userYearList = new Set(userList);
            window.userMonthList = new Set(userList);
            window.userStateList = new Set(userList);
            window.userCountyList = new Set(userList);
            window.userCountryList = new Set(userList);
            window.userABAList = new Set(userList);
        }

        // ============================================
        // EXPECTED & NOTABLE TARGETS
        // ============================================
        
        async function fetchExpectedTargets(regionCode) {
            console.log(`‚≠ê Fetching expected seasonal targets for ${regionCode}...`);
            
            // Note: The product/top100 API only works at state level and above
            // For county-level searches, we skip this and rely on notable sightings instead
            const isCountyLevel = (regionCode.match(/-/g) || []).length >= 2;
            if (isCountyLevel) {
                console.log(`‚ÑπÔ∏è Skipping expected targets for county-level region (API limitation)`);
                return [];
            }
            
            try {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() + 1;
                const day = today.getDate();
                
                const url = `https://api.ebird.org/v2/product/top100/${regionCode}/${year}/${month}/${day}`;
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });
                
                if (response.ok) {
                    const top100 = await response.json();
                    console.log(`‚úÖ Got ${top100.length} expected species for ${regionCode}`);
                    
                    // top100 is array of {speciesCode: "...", frequency: 0.85}
                    // Store frequencies for display
                    top100.forEach(sp => {
                        targetFrequencies.set(sp.speciesCode, sp.frequency || 0);
                    });
                    
                    // Filter to species user hasn't seen
                    const userSeenSpecies = getTargetList();
                    const expectedTargetsData = top100.filter(sp => {
                        // Need to convert speciesCode to common name
                        // This will be resolved when we match with observations
                        return true; // We'll filter properly in displayBirds
                    });
                    
                    return expectedTargetsData;
                } else {
                    console.log(`‚ÑπÔ∏è Expected targets not available for ${regionCode}`);
                    return [];
                }
            } catch (error) {
                console.log(`‚ÑπÔ∏è Could not fetch expected targets: ${error.message}`);
                return [];
            }
        }
        
        async function fetchNotableTargets(regionCode) {
            console.log(`üíé Fetching notable/rare targets for ${regionCode}...`);
            
            try {
                const url = `https://api.ebird.org/v2/data/obs/${regionCode}/recent/notable?back=14`;
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });
                
                if (response.ok) {
                    const notable = await response.json();
                    console.log(`‚úÖ Got ${notable.length} notable sightings in ${regionCode}`);
                    
                    // Filter to species user hasn't seen
                    const userSeenSpecies = getTargetList();
                    const notableTargetsData = notable.filter(obs => 
                        !userSeenSpecies.has(obs.comName)
                    );
                    
                    console.log(`üíé Found ${notableTargetsData.length} notable targets you haven't seen`);
                    return notableTargetsData;
                } else {
                    console.warn(`‚ö†Ô∏è Could not fetch notable for ${regionCode}`);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching notable targets:', error);
                return [];
            }
        }
        
        function getRegionFromCoordinates(lat, lng) {
            // Simple US state detection based on coordinates
            // This is a rough approximation - eBird uses more precise regions
            
            if (lat >= 44 && lat <= 45.5 && lng >= -73.5 && lng <= -71) return 'US-VT';
            if (lat >= 42 && lat <= 43 && lng >= -73.5 && lng <= -69.5) return 'US-MA';
            if (lat >= 40 && lat <= 45 && lng >= -80 && lng <= -71) return 'US-NY';
            if (lat >= 24 && lat <= 31 && lng >= -88 && lng <= -79.5) return 'US-FL';
            if (lat >= 25 && lat <= 36.5 && lng >= -107 && lng <= -93) return 'US-TX';
            if (lat >= 32 && lat <= 42 && lng >=-125 && lng <= -114) return 'US-CA';
            
            // Default to US if we can't determine state
            return 'US';
        }


        function disconnectEbird() {
            ebirdAuthenticated = false;
            userApiKey = '';
            userList.clear();
            
            updateHeaderUI();
            hideSections();
            resetAll();
        }

        function updateHeaderUI() {
            const headerDiv = document.getElementById('ebirdHeader');
            
            if (ebirdAuthenticated) {
                const displayName = userName && userName !== 'eBird User' ? `${userName} - ` : '';
                const speciesText = userList.size > 0 ? `${userList.size} species` : 'Connected';
                headerDiv.innerHTML = `
                    <div class="ebird-connected">
                        <span class="ebird-connected-text">‚úÖ ${displayName}${speciesText}</span>
                        <button class="disconnect-btn" onclick="disconnectEbird()">Disconnect</button>
                    </div>
                `;
            } else {
                headerDiv.innerHTML = `
                    <div class="ebird-login">
                        <input type="password" id="apiKey" placeholder="eBird API Key">
                        <button onclick="connectEbird()">Connect</button>
                    </div>
                    <div style="text-align: center; font-size: 0.75em; color: var(--text-secondary);">
                        Get free API key: <a href="https://ebird.org/api/keygen" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: none;">ebird.org/api/keygen</a>
                    </div>
                `;
            }
        }

        function showSections() {
            const layers = document.getElementById('layersSection');
            const reset = document.getElementById('resetSection');
            if (layers) layers.style.display = 'block';
            if (reset) reset.style.display = 'block';
        }

        function hideSections() {
            const layers = document.getElementById('layersSection');
            const reset = document.getElementById('resetSection');
            if (layers) layers.style.display = 'none';
            if (reset) reset.style.display = 'none';
            // Don't hide belowMap entirely - just hide search-specific panels
            hideSearchPanels();
        }

        // ============================================
        // TARGET SPECIES FILTER
        // ============================================
        function applyTargetFilter() {
            if (!currentRoute || allSightings.length === 0) {
                return;
            }
            
            // Re-display birds with current filter
            displayBirds();
        }

        function getTargetList() {
            const listType = document.getElementById('targetListType').value;
            
            // Check for date filter first
            if (window.userDateFilteredList && window.userDateFilteredList.size > 0) {
                // Date filter overrides other filters
                return window.userDateFilteredList;
            }
            
            // Handle multi-select regional lists
            if (listType === 'regional') {
                const selectedRegions = getSelectedRegionalLists();
                const includeWorld = document.getElementById('includeWorldList')?.checked;
                
                if (selectedRegions.length === 0 && !includeWorld) {
                    // No regions selected, show all
                    return new Set();
                }
                
                // Combine all selected regional lists
                const combinedSet = new Set();
                
                selectedRegions.forEach(key => {
                    if (allBirdLists[key]) {
                        allBirdLists[key].species.forEach(sp => combinedSet.add(sp));
                    }
                });
                
                // Also add world list if checked
                if (includeWorld && allBirdLists['world']) {
                    allBirdLists['world'].species.forEach(sp => combinedSet.add(sp));
                }
                
                return combinedSet;
            }
            
            // Check for legacy regional list selection (for backward compatibility)
            if (listType.startsWith('regional_')) {
                const regionKey = listType.replace('regional_', '');
                if (allBirdLists[regionKey]) {
                    return new Set(allBirdLists[regionKey].species);
                }
            }
            
            switch(listType) {
                case 'life': 
                    // Use world list from new system, fallback to legacy
                    if (allBirdLists['world']) {
                        return new Set(allBirdLists['world'].species);
                    }
                    return window.userLifeList || userList;
                case 'year': 
                    // Use year list parsed from CSV (species seen this year)
                    if (window.userYearList && window.userYearList.size > 0) {
                        return window.userYearList;
                    }
                    // Fallback to life list if no year data
                    return window.userLifeList || userList;
                case 'month': 
                    // Use month list parsed from CSV (species seen this month)
                    if (window.userMonthList && window.userMonthList.size > 0) {
                        return window.userMonthList;
                    }
                    // Fallback to life list if no month data
                    return window.userLifeList || userList;
                case 'state': return window.userStateList || userList;
                case 'county': return window.userCountyList || userList;
                case 'country': return window.userCountryList || userList;
                case 'aba': return window.userABAList || userList;
                case 'all':
                default: return new Set(); // Empty set means show all
            }
        }

        // ============================================
        // ABA RARITY CODES
        // ============================================
        const ABA_RARITY_CODES = {
            // Code 1 - Common (Green)
            1: ['American Robin', 'Blue Jay', 'Northern Cardinal', 'Mourning Dove', 'American Crow',
                'House Sparrow', 'European Starling', 'Rock Pigeon', 'Red-winged Blackbird', 'Common Grackle'],
            
            // Code 2 - Uncommon (Yellow)
            2: ['Scarlet Tanager', 'Wood Thrush', 'Baltimore Oriole', 'Rose-breasted Grosbeak'],
            
            // Code 3 - Rare (Orange)
            3: ['Painted Bunting', 'Varied Thrush', 'Mountain Bluebird', 'Vermilion Flycatcher'],
            
            // Code 4 - Very Rare (Red)
            4: ['Kirtland\'s Warbler', 'California Condor', 'Whooping Crane', 'Spotted Owl'],
            
            // Code 5 - Mega Rare (Purple)
            5: ['Ivory-billed Woodpecker', 'Eskimo Curlew', 'Bachman\'s Warbler'],
            
            // Code 6 - Cannot be Found (Black)
            6: ['Passenger Pigeon', 'Carolina Parakeet', 'Great Auk']
        };

        function getABARarityCode(speciesName) {
            for (const [code, species] of Object.entries(ABA_RARITY_CODES)) {
                if (species.some(s => speciesName.includes(s) || s.includes(speciesName))) {
                    return parseInt(code);
                }
            }
            return 1; // Default to common if not in database
        }

        function shouldShowABARarity(code) {
            // Only filter by ABA code when in ABA mode
            if (markerStylePreference !== 'aba') return true;
            
            const checkbox = document.getElementById(`abaFilter${code}`);
            return checkbox ? checkbox.checked : true;
        }

        // ============================================
        // LOADING INDICATOR HELPERS
        // ============================================
        function showLoading(message = 'Searching...') {
            const indicator = document.getElementById('loadingIndicator');
            const status = document.getElementById('loadingStatus');
            if (indicator) {
                indicator.style.display = 'block';
                if (status) status.textContent = message;
            }
        }
        
        function hideLoading() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) indicator.style.display = 'none';
        }
        
        function updateLoadingStatus(message) {
            const status = document.getElementById('loadingStatus');
            if (status) status.textContent = message;
        }
        
        // ============================================
        // RADIUS VALIDATION (eBird max is 50km)
        // ============================================
        function validateAndConvertRadius(miles) {
            // eBird API accepts distance in km, max 50km
            const km = miles * 1.60934;
            if (km > 50) {
                console.warn(`‚ö†Ô∏è Radius ${miles} miles (${km.toFixed(1)}km) exceeds eBird max of 50km. Using 50km.`);
                return 50;
            }
            return Math.round(km);
        }

        // ============================================
        // REGION SELECTOR FUNCTIONS
        // ============================================
        
        // US States data
        const US_STATES = [
            { code: 'US-AL', name: 'Alabama' }, { code: 'US-AK', name: 'Alaska' }, { code: 'US-AZ', name: 'Arizona' },
            { code: 'US-AR', name: 'Arkansas' }, { code: 'US-CA', name: 'California' }, { code: 'US-CO', name: 'Colorado' },
            { code: 'US-CT', name: 'Connecticut' }, { code: 'US-DE', name: 'Delaware' }, { code: 'US-FL', name: 'Florida' },
            { code: 'US-GA', name: 'Georgia' }, { code: 'US-HI', name: 'Hawaii' }, { code: 'US-ID', name: 'Idaho' },
            { code: 'US-IL', name: 'Illinois' }, { code: 'US-IN', name: 'Indiana' }, { code: 'US-IA', name: 'Iowa' },
            { code: 'US-KS', name: 'Kansas' }, { code: 'US-KY', name: 'Kentucky' }, { code: 'US-LA', name: 'Louisiana' },
            { code: 'US-ME', name: 'Maine' }, { code: 'US-MD', name: 'Maryland' }, { code: 'US-MA', name: 'Massachusetts' },
            { code: 'US-MI', name: 'Michigan' }, { code: 'US-MN', name: 'Minnesota' }, { code: 'US-MS', name: 'Mississippi' },
            { code: 'US-MO', name: 'Missouri' }, { code: 'US-MT', name: 'Montana' }, { code: 'US-NE', name: 'Nebraska' },
            { code: 'US-NV', name: 'Nevada' }, { code: 'US-NH', name: 'New Hampshire' }, { code: 'US-NJ', name: 'New Jersey' },
            { code: 'US-NM', name: 'New Mexico' }, { code: 'US-NY', name: 'New York' }, { code: 'US-NC', name: 'North Carolina' },
            { code: 'US-ND', name: 'North Dakota' }, { code: 'US-OH', name: 'Ohio' }, { code: 'US-OK', name: 'Oklahoma' },
            { code: 'US-OR', name: 'Oregon' }, { code: 'US-PA', name: 'Pennsylvania' }, { code: 'US-RI', name: 'Rhode Island' },
            { code: 'US-SC', name: 'South Carolina' }, { code: 'US-SD', name: 'South Dakota' }, { code: 'US-TN', name: 'Tennessee' },
            { code: 'US-TX', name: 'Texas' }, { code: 'US-UT', name: 'Utah' }, { code: 'US-VT', name: 'Vermont' },
            { code: 'US-VA', name: 'Virginia' }, { code: 'US-WA', name: 'Washington' }, { code: 'US-WV', name: 'West Virginia' },
            { code: 'US-WI', name: 'Wisconsin' }, { code: 'US-WY', name: 'Wyoming' }, { code: 'US-DC', name: 'District of Columbia' }
        ];
        
        // Canadian Provinces
        const CA_PROVINCES = [
            { code: 'CA-AB', name: 'Alberta' }, { code: 'CA-BC', name: 'British Columbia' }, { code: 'CA-MB', name: 'Manitoba' },
            { code: 'CA-NB', name: 'New Brunswick' }, { code: 'CA-NL', name: 'Newfoundland and Labrador' },
            { code: 'CA-NS', name: 'Nova Scotia' }, { code: 'CA-NT', name: 'Northwest Territories' },
            { code: 'CA-NU', name: 'Nunavut' }, { code: 'CA-ON', name: 'Ontario' }, { code: 'CA-PE', name: 'Prince Edward Island' },
            { code: 'CA-QC', name: 'Quebec' }, { code: 'CA-SK', name: 'Saskatchewan' }, { code: 'CA-YT', name: 'Yukon' }
        ];
        
        // Mexican States
        const MX_STATES = [
            { code: 'MX-AGU', name: 'Aguascalientes' }, { code: 'MX-BCN', name: 'Baja California' },
            { code: 'MX-BCS', name: 'Baja California Sur' }, { code: 'MX-CAM', name: 'Campeche' },
            { code: 'MX-CHP', name: 'Chiapas' }, { code: 'MX-CHH', name: 'Chihuahua' },
            { code: 'MX-COA', name: 'Coahuila' }, { code: 'MX-COL', name: 'Colima' },
            { code: 'MX-DIF', name: 'Ciudad de M√©xico' }, { code: 'MX-DUR', name: 'Durango' },
            { code: 'MX-GUA', name: 'Guanajuato' }, { code: 'MX-GRO', name: 'Guerrero' },
            { code: 'MX-HID', name: 'Hidalgo' }, { code: 'MX-JAL', name: 'Jalisco' },
            { code: 'MX-MEX', name: 'Estado de M√©xico' }, { code: 'MX-MIC', name: 'Michoac√°n' },
            { code: 'MX-MOR', name: 'Morelos' }, { code: 'MX-NAY', name: 'Nayarit' },
            { code: 'MX-NLE', name: 'Nuevo Le√≥n' }, { code: 'MX-OAX', name: 'Oaxaca' },
            { code: 'MX-PUE', name: 'Puebla' }, { code: 'MX-QUE', name: 'Quer√©taro' },
            { code: 'MX-ROO', name: 'Quintana Roo' }, { code: 'MX-SLP', name: 'San Luis Potos√≠' },
            { code: 'MX-SIN', name: 'Sinaloa' }, { code: 'MX-SON', name: 'Sonora' },
            { code: 'MX-TAB', name: 'Tabasco' }, { code: 'MX-TAM', name: 'Tamaulipas' },
            { code: 'MX-TLA', name: 'Tlaxcala' }, { code: 'MX-VER', name: 'Veracruz' },
            { code: 'MX-YUC', name: 'Yucat√°n' }, { code: 'MX-ZAC', name: 'Zacatecas' }
        ];
        
        // Australian States
        const AU_STATES = [
            { code: 'AU-ACT', name: 'Australian Capital Territory' }, { code: 'AU-NSW', name: 'New South Wales' },
            { code: 'AU-NT', name: 'Northern Territory' }, { code: 'AU-QLD', name: 'Queensland' },
            { code: 'AU-SA', name: 'South Australia' }, { code: 'AU-TAS', name: 'Tasmania' },
            { code: 'AU-VIC', name: 'Victoria' }, { code: 'AU-WA', name: 'Western Australia' }
        ];
        
        function updateRegionSelectors() {
            const areaType = document.getElementById('areaType').value;
            
            // Hide all selectors first
            document.getElementById('customLocationInput').style.display = 'none';
            document.getElementById('countrySelector').style.display = 'none';
            document.getElementById('stateSelector').style.display = 'none';
            document.getElementById('countySelector').style.display = 'none';
            document.getElementById('selectedRegionDisplay').style.display = 'none';
            
            // Clear selected region
            document.getElementById('selectedRegionCode').value = '';
            
            // Show appropriate selector
            switch(areaType) {
                case 'custom':
                    document.getElementById('customLocationInput').style.display = 'block';
                    break;
                case 'country':
                    document.getElementById('countrySelector').style.display = 'block';
                    break;
                case 'state':
                    document.getElementById('stateSelector').style.display = 'block';
                    populateCountyStateSelect(); // Populate for county selector too
                    break;
                case 'county':
                    document.getElementById('countySelector').style.display = 'block';
                    populateCountyStateSelect();
                    break;
            }
            
            // Auto-enable region boundaries only mode for non-custom
            const regionOnlyCheckbox = document.getElementById('regionOnlyMode');
            if (areaType !== 'custom') {
                regionOnlyCheckbox.checked = true;
                toggleRegionOnlyMode();
            }
        }
        
        function populateCountyStateSelect() {
            const select = document.getElementById('countyStateSelect');
            select.innerHTML = '<option value="">-- Select a State --</option>';
            US_STATES.forEach(state => {
                select.innerHTML += `<option value="${state.code}">${state.name}</option>`;
            });
        }
        
        function onCountrySelected() {
            const countryCode = document.getElementById('countrySelect').value;
            if (countryCode) {
                setSelectedRegion(countryCode, document.getElementById('countrySelect').selectedOptions[0].text);
            }
        }
        
        function loadStatesForCountry() {
            const country = document.getElementById('stateCountrySelect').value;
            const stateSelect = document.getElementById('stateSelect');
            
            stateSelect.innerHTML = '<option value="">-- Select a State/Province --</option>';
            
            let states = [];
            switch(country) {
                case 'US': states = US_STATES; break;
                case 'CA': states = CA_PROVINCES; break;
                case 'MX': states = MX_STATES; break;
                case 'AU': states = AU_STATES; break;
            }
            
            states.forEach(state => {
                stateSelect.innerHTML += `<option value="${state.code}">${state.name}</option>`;
            });
        }
        
        function onStateSelected() {
            const stateCode = document.getElementById('stateSelect').value;
            if (stateCode) {
                const stateName = document.getElementById('stateSelect').selectedOptions[0].text;
                setSelectedRegion(stateCode, stateName);
            }
        }
        
        async function loadCountiesForState() {
            const stateCode = document.getElementById('countyStateSelect').value;
            const countySelect = document.getElementById('countySelect');
            const loadingDiv = document.getElementById('countyLoading');
            
            if (!stateCode) {
                countySelect.style.display = 'none';
                return;
            }
            
            // Show loading
            loadingDiv.style.display = 'block';
            countySelect.style.display = 'none';
            countySelect.innerHTML = '<option value="">-- Select a County --</option>';
            
            try {
                // Fetch counties from eBird API
                const url = `https://api.ebird.org/v2/ref/region/list/subnational2/${stateCode}`;
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });
                
                if (response.ok) {
                    const counties = await response.json();
                    counties.forEach(county => {
                        countySelect.innerHTML += `<option value="${county.code}">${county.name}</option>`;
                    });
                    countySelect.style.display = 'block';
                    console.log(`üìç Loaded ${counties.length} counties for ${stateCode}`);
                } else {
                    console.error('Failed to load counties');
                    countySelect.innerHTML = '<option value="">-- Could not load counties --</option>';
                    countySelect.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading counties:', error);
                countySelect.innerHTML = '<option value="">-- Error loading counties --</option>';
                countySelect.style.display = 'block';
            }
            
            loadingDiv.style.display = 'none';
        }
        
        function onCountySelected() {
            const countyCode = document.getElementById('countySelect').value;
            if (countyCode) {
                const countyName = document.getElementById('countySelect').selectedOptions[0].text;
                const stateName = document.getElementById('countyStateSelect').selectedOptions[0].text;
                setSelectedRegion(countyCode, `${countyName}, ${stateName}`);
                
                // Auto-select matching regional list if available
                autoSelectRegionalList(countyCode, countyName);
            }
        }
        
        function setSelectedRegion(code, name) {
            document.getElementById('selectedRegionCode').value = code;
            document.getElementById('selectedRegionName').textContent = name;
            document.getElementById('selectedRegionCodeDisplay').textContent = `eBird Region: ${code}`;
            document.getElementById('selectedRegionDisplay').style.display = 'block';
            
            // Also set areaInput for compatibility
            document.getElementById('areaInput').value = name;
            
            console.log(`‚úÖ Selected region: ${name} (${code})`);
        }
        
        // Auto-select regional list when a matching region is chosen
        function autoSelectRegionalList(regionCode, regionName) {
            const select = document.getElementById('targetListType');
            if (!select) return;
            
            // Look for a matching regional list
            for (let i = 0; i < select.options.length; i++) {
                const option = select.options[i];
                // Check if option value contains the region code or name matches
                if (option.value.includes(regionCode) || 
                    option.text.toLowerCase().includes(regionName.toLowerCase().split(',')[0])) {
                    select.value = option.value;
                    console.log(`üéØ Auto-selected regional list: ${option.text}`);
                    applyTargetFilter();
                    return;
                }
            }
            
            // No matching list found - show hint
            console.log(`üí° No regional list found for ${regionName}. Upload one for more accurate targets.`);
        }

        // ============================================
        // SEARCH DISPATCHER
        // ============================================
        function toggleRegionOnlyMode() {
            const checkbox = document.getElementById('regionOnlyMode');
            const radiusInput = document.getElementById('searchRadius');
            
            if (checkbox.checked) {
                radiusInput.disabled = true;
                radiusInput.style.opacity = '0.5';
                console.log('üó∫Ô∏è Region-only mode enabled - will search within region boundaries only');
            } else {
                radiusInput.disabled = false;
                radiusInput.style.opacity = '1';
                console.log('üìç Radius mode enabled - will use specified radius');
            }
        }

        async function performSearch() {
            const searchMode = document.getElementById('searchMode').value;
            
            // Track search event
            if (typeof gtag === 'function') {
                gtag('event', 'search', {
                    search_term: searchMode,
                    event_category: 'birding_search'
                });
            }
            
            if (searchMode === 'route') {
                await planRoute();
            } else {
                await searchArea();
            }
        }

        // ============================================
        // AREA-ONLY SEARCH
        // ============================================
        async function searchArea() {
            if (!ebirdAuthenticated) {
                alert('Please connect to eBird first');
                return;
            }

            const areaType = document.getElementById('areaType').value;
            const selectedRegionCode = document.getElementById('selectedRegionCode').value;
            const areaInput = document.getElementById('areaInput').value;
            
            // For region-based searches, require a selected region
            if (areaType !== 'custom' && !selectedRegionCode) {
                alert('Please select a region from the dropdown');
                return;
            }
            
            if (areaType === 'custom' && !areaInput) {
                alert('Please enter a location to search');
                return;
            }

            console.log(`üó∫Ô∏è Searching area: ${areaInput || selectedRegionCode}`);
            showLoading('Analyzing area...');

            // Clear previous results
            clearMarkers();
            clearHotspots();
            clearChecklists();
            allSightings = [];
            allHotspots = [];
            allChecklists = [];
            targetSpecies = [];

            try {
                const timeRange = parseInt(document.getElementById('timeRange').value);
                
                // If we have a direct region code, use it
                if (selectedRegionCode && areaType !== 'custom') {
                    console.log(`üìç Using selected eBird region code: ${selectedRegionCode}`);
                    
                    // Center map on region (approximate)
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ address: areaInput }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            const bounds = results[0].geometry.bounds || results[0].geometry.viewport;
                            map.fitBounds(bounds);
                        }
                    });
                    
                    await performRegionSearch(selectedRegionCode, timeRange);
                    return;
                }
                
                // Custom location - use geocoding
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: areaInput }, async (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const geometry = results[0].geometry;
                        const bounds = geometry.bounds || geometry.viewport;
                        
                        // Get center for initial positioning
                        const center = bounds.getCenter();
                        map.setCenter(center);
                        
                        // Check if region-only mode is enabled
                        const regionOnlyMode = document.getElementById('regionOnlyMode').checked;
                        
                        if (regionOnlyMode) {
                            // Region-only mode: Use eBird region code directly
                            console.log('üó∫Ô∏è Region-only mode: Searching within region boundaries');
                            map.fitBounds(bounds);
                            
                            // Try to convert location to eBird region code
                            const regionCode = await getRegionCodeFromLocation(areaInput);
                            
                            if (regionCode) {
                                console.log(`üìç Using eBird region code: ${regionCode}`);
                                await performRegionSearch(regionCode, timeRange);
                            } else {
                                console.log('‚ö†Ô∏è Could not determine region code, falling back to grid search');
                                const radiusMiles = parseInt(document.getElementById('searchRadius').value);
                                const radiusKm = validateAndConvertRadius(radiusMiles);
                                await performGridSearch(bounds, radiusKm, timeRange);
                            }
                        } else {
                            // Standard radius-based search
                            // Calculate area size to determine search strategy
                            const ne = bounds.getNorthEast();
                            const sw = bounds.getSouthWest();
                            const widthMiles = getDistance(ne.lat(), ne.lng(), ne.lat(), sw.lng());
                            const heightMiles = getDistance(ne.lat(), ne.lng(), sw.lat(), ne.lng());
                            const areaSizeMiles = Math.max(widthMiles, heightMiles);
                            
                            console.log(`üìè Area size: ${areaSizeMiles.toFixed(1)} miles (${widthMiles.toFixed(1)} √ó ${heightMiles.toFixed(1)})`);
                            
                            // Get radius and validate
                            const radiusMiles = parseInt(document.getElementById('searchRadius').value);
                            const radiusKm = validateAndConvertRadius(radiusMiles);
                            
                            // Determine if we need overlapping grid search
                            const maxSingleSearchMiles = 31; // eBird max radius
                            
                            if (areaSizeMiles <= maxSingleSearchMiles * 2) {
                                // Small area - single search
                                console.log('üìç Small area - using single search');
                                map.setZoom(10);
                                await performSingleAreaSearch(center.lat(), center.lng(), radiusKm, timeRange);
                            } else {
                                // Large area - overlapping grid search
                                console.log('üìç Large area - using overlapping grid search');
                                map.fitBounds(bounds);
                                await performGridSearch(bounds, radiusKm, timeRange);
                            }
                        }
                        
                        hideLoading();
                        console.log(`‚úÖ Area search complete`);
                    } else {
                        hideLoading();
                        alert('Could not find location. Please try a different search term.');
                    }
                });
            } catch (error) {
                console.error('‚ùå Area search error:', error);
                logBirderError('area_search', 'Area search failed', { error: error.message });
                hideLoading();
                alert('Error searching area');
            }
        }
        
        // Single area search (for small areas)
        async function performSingleAreaSearch(lat, lng, radiusKm, timeRange) {
            updateLoadingStatus('Finding birds...');
            const obsUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=${timeRange}`;
            const obsResponse = await fetch(obsUrl, {
                headers: { 'X-eBirdApiToken': userApiKey }
            });

            if (obsResponse.ok) {
                allSightings = await obsResponse.json();
                console.log(`üìç Found ${allSightings.length} observations`);

                // Identify target species
                const targetList = getTargetList();
                const listType = document.getElementById('targetListType').value;
                if (listType === 'all') {
                    targetSpecies = [];
                } else {
                    targetSpecies = allSightings.filter(obs => !targetList.has(obs.comName));
                }
                console.log(`üéØ Found ${targetSpecies.length} target species`);

                // Get hotspots and checklists
                updateLoadingStatus('Finding hotspots...');
                await fetchTop10Hotspots(lat, lng, radiusKm);
                updateLoadingStatus('Finding checklists...');
                await fetchTop10Checklists(lat, lng, radiusKm);

                // Display everything
                updateLoadingStatus('Displaying results...');
                displayBirds();
                displayHotspots();
                displayChecklists();
                updateBelowMapPanels();

                // Show below-map section
                document.getElementById('belowMap').style.display = 'block';
            }
        }
        
        // Overlapping grid search (for large areas like states, countries)
        async function performGridSearch(bounds, radiusKm, timeRange) {
            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();
            
            // Create grid of overlapping search points
            // Space them 20 miles apart for overlap with 31-mile radius
            const gridSpacingMiles = 20;
            const gridSpacingDegrees = gridSpacingMiles / 69; // Rough conversion
            
            const searchPoints = [];
            let latStep = sw.lat();
            while (latStep <= ne.lat()) {
                let lngStep = sw.lng();
                while (lngStep <= ne.lng()) {
                    searchPoints.push({ lat: latStep, lng: lngStep });
                    lngStep += gridSpacingDegrees;
                }
                latStep += gridSpacingDegrees;
            }
            
            console.log(`üéØ Creating ${searchPoints.length} overlapping search areas across the region`);
            updateLoadingStatus(`Searching ${searchPoints.length} overlapping areas...`);
            
            allObservations = []; // Use global variable
            const allHotspotsData = [];
            
            // Fetch from each grid point with progressive display
            for (let i = 0; i < searchPoints.length; i++) {
                const point = searchPoints[i];
                const progress = Math.round(((i + 1) / searchPoints.length) * 100);
                updateLoadingStatus(`Searching area ${i + 1}/${searchPoints.length} (${progress}%)...`);
                
                try {
                    // Get observations
                    const obsUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${point.lat}&lng=${point.lng}&dist=${radiusKm}&back=${timeRange}`;
                    const obsResponse = await fetch(obsUrl, {
                        headers: { 'X-eBirdApiToken': userApiKey }
                    });

                    if (obsResponse.ok) {
                        const observations = await obsResponse.json();
                        allObservations.push(...observations);
                        
                        // Progressive display every 5 searches or at end
                        if (i === 0 || (i + 1) % 5 === 0 || i === searchPoints.length - 1) {
                            // Remove duplicates
                            const uniqueObs = {};
                            allObservations.forEach(obs => {
                                const key = `${obs.speciesCode}-${obs.lat}-${obs.lng}-${obs.obsDt}`;
                                if (!uniqueObs[key]) uniqueObs[key] = obs;
                            });
                            allSightings = Object.values(uniqueObs);
                            
                            // Update target species
                            const targetList = getTargetList();
                            const listType = document.getElementById('targetListType').value;
                            if (listType === 'all') {
                                targetSpecies = [];
                            } else {
                                targetSpecies = allSightings.filter(obs => !targetList.has(obs.comName));
                            }
                            
                            // Display current results
                            displayBirds();
                            updateLoadingStatus(`Found ${allSightings.length} birds so far... (area ${i + 1}/${searchPoints.length})`);
                            console.log(`üê¶ Progressive update: ${allSightings.length} observations, ${targetSpecies.length} targets`);
                        }
                    }
                    
                    // Get hotspots (but don't fetch all to avoid too many API calls)
                    if (i % 3 === 0) { // Get hotspots from every 3rd point
                        const hotspotsUrl = `https://api.ebird.org/v2/ref/hotspot/geo?lat=${point.lat}&lng=${point.lng}&dist=${radiusKm}&fmt=json`;
                        const hotspotsResponse = await fetch(hotspotsUrl, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });
                        
                        if (hotspotsResponse.ok) {
                            const hotspots = await hotspotsResponse.json();
                            allHotspotsData.push(...hotspots);
                        }
                    }
                    
                    // Delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 150));
                    
                } catch (error) {
                    console.warn(`Failed to fetch area ${i + 1}:`, error);
                }
            }
            
            // Final processing
            updateLoadingStatus('Processing hotspots...');
            
            // Process hotspots
            const uniqueHotspots = {};
            allHotspotsData.forEach(h => {
                if (!uniqueHotspots[h.locId]) uniqueHotspots[h.locId] = h;
            });
            
            // Get species counts for top hotspots
            const hotspotsArray = Object.values(uniqueHotspots).slice(0, 20);
            const hotspotsWithCounts = [];
            const hotspotTimeRange = 30; // Always use 30 days for hotspot evaluation
            
            for (const hotspot of hotspotsArray) {
                try {
                    const obsUrl = `https://api.ebird.org/v2/data/obs/${hotspot.locId}/recent?back=${hotspotTimeRange}`;
                    const obsResponse = await fetch(obsUrl, {
                        headers: { 'X-eBirdApiToken': userApiKey }
                    });

                    if (obsResponse.ok) {
                        const observations = await obsResponse.json();
                        const uniqueSpecies = new Set(observations.map(obs => obs.speciesCode));
                        
                        // Count unique checklists
                        const uniqueChecklists = new Set(observations.map(obs => obs.subId).filter(id => id));
                        
                        // Only add if there are actual species
                        if (uniqueSpecies.size > 0) {
                            hotspotsWithCounts.push({
                                ...hotspot,
                                speciesCount: uniqueSpecies.size,
                                totalSpecies: uniqueSpecies.size,
                                recentObs: observations.length,
                                numChecklists: uniqueChecklists.size || 1,
                                timeRangeUsed: hotspotTimeRange
                            });
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (e) {
                    console.warn(`Couldn't fetch hotspot ${hotspot.locId}`);
                }
            }

            allHotspots = hotspotsWithCounts
                .filter(h => h.speciesCount > 0)
                .sort((a, b) => b.speciesCount - a.speciesCount)
                .slice(0, 10);
            
            // Get checklists from observations
            updateLoadingStatus('Processing checklists...');
            await fetchTop10ChecklistsFromObservations(allObservations);
            
            // Final display
            updateLoadingStatus('Displaying results...');
            displayBirds();
            displayHotspots();
            displayChecklists();
            updateBelowMapPanels();
            
            // Show below-map section
            document.getElementById('belowMap').style.display = 'block';
            
            console.log(`üìç Grid search complete: ${allSightings.length} observations from ${searchPoints.length} areas`);
        }

        // ============================================
        // REGION-ONLY SEARCH (No Radius)
        // ============================================
        
        async function getRegionCodeFromLocation(locationString) {
            // Convert location string to eBird region code
            const stateMap = {
                'vermont': 'US-VT', 'vt': 'US-VT',
                'new hampshire': 'US-NH', 'nh': 'US-NH',
                'maine': 'US-ME', 'me': 'US-ME',
                'massachusetts': 'US-MA', 'ma': 'US-MA',
                'connecticut': 'US-CT', 'ct': 'US-CT',
                'rhode island': 'US-RI', 'ri': 'US-RI',
                'new york': 'US-NY', 'ny': 'US-NY',
                'new jersey': 'US-NJ', 'nj': 'US-NJ',
                'pennsylvania': 'US-PA', 'pa': 'US-PA',
                'california': 'US-CA', 'ca': 'US-CA',
                'florida': 'US-FL', 'fl': 'US-FL',
                'texas': 'US-TX', 'tx': 'US-TX'
            };
            
            const location = locationString.toLowerCase();
            for (const [key, code] of Object.entries(stateMap)) {
                if (location.includes(key)) {
                    return code;
                }
            }
            return null;
        }
        
        async function performRegionSearch(regionCode, timeRange) {
            console.log(`üó∫Ô∏è Searching region ${regionCode} (within boundaries only)`);
            showLoading('Searching region...');
            
            try {
                const url = `https://api.ebird.org/v2/data/obs/${regionCode}/recent?maxResults=10000&back=${timeRange}&detail=full`;
                updateLoadingStatus(`Fetching observations from ${regionCode}...`);
                
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });
                
                if (response.ok) {
                    const observations = await response.json();
                    console.log(`üìç Found ${observations.length} observations in ${regionCode}`);
                    
                    // Store ALL unfiltered observations for checklists/hotspots
                    allObservations = observations;
                    
                    // Deduplicate for display
                    const uniqueObs = {};
                    observations.forEach(obs => {
                        const key = `${obs.lat}-${obs.lng}-${obs.speciesCode}`;
                        if (!uniqueObs[key] || new Date(obs.obsDt) > new Date(uniqueObs[key].obsDt)) {
                            uniqueObs[key] = obs;
                        }
                    });
                    
                    allSightings = Object.values(uniqueObs);
                    console.log(`üìç ${allSightings.length} unique observations`);
                    
                    // Calculate targets
                    const listType = document.getElementById('targetListType').value;
                    const targetList = getTargetList();
                    targetSpecies = listType === 'all' ? [] : allSightings.filter(obs => !targetList.has(obs.comName));
                    console.log(`üéØ Found ${targetSpecies.length} target species`);
                    
                    // Fetch expected/notable
                    const [expectedData, notableData] = await Promise.all([
                        fetchExpectedTargets(regionCode),
                        fetchNotableTargets(regionCode)
                    ]);
                    
                    expectedTargets = allSightings.filter(obs => !targetList.has(obs.comName) && targetFrequencies.has(obs.speciesCode));
                    notableTargets = notableData;
                    
                    console.log(`‚≠ê ${expectedTargets.length} expected, üíé ${notableTargets.length} notable`);
                    
                    // Get hotspots for region - use the region-specific endpoint
                    try {
                        // Fetch hotspots directly for this region (stays within boundaries)
                        const hotspotsUrl = `https://api.ebird.org/v2/ref/hotspot/${regionCode}?fmt=json`;
                        const hotspotsResponse = await fetch(hotspotsUrl, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });
                        
                        if (hotspotsResponse.ok) {
                            const hotspots = await hotspotsResponse.json();
                            console.log(`üìç Found ${hotspots.length} hotspots in ${regionCode}`);
                            
                            // Get species counts for top hotspots by activity (use 30 days)
                            const hotspotTimeRange = 30;
                            const hotspotsWithCounts = [];
                            
                            // Take hotspots with recent activity first (sorted by latestObsDt if available)
                            const sortedHotspots = hotspots
                                .filter(h => h.latestObsDt) // Only hotspots with recent activity
                                .sort((a, b) => new Date(b.latestObsDt) - new Date(a.latestObsDt))
                                .slice(0, 25); // Check top 25 most recently active
                            
                            for (const hotspot of sortedHotspots) {
                                try {
                                    const obsUrl = `https://api.ebird.org/v2/data/obs/${hotspot.locId}/recent?back=${hotspotTimeRange}`;
                                    const obsResponse = await fetch(obsUrl, {
                                        headers: { 'X-eBirdApiToken': userApiKey }
                                    });
                                    
                                    if (obsResponse.ok) {
                                        const observations = await obsResponse.json();
                                        const uniqueSpecies = new Set(observations.map(obs => obs.speciesCode));
                                        const uniqueChecklists = new Set(observations.map(obs => obs.subId).filter(id => id));
                                        
                                        if (uniqueSpecies.size > 0) {
                                            hotspotsWithCounts.push({
                                                ...hotspot,
                                                totalSpecies: uniqueSpecies.size,
                                                speciesCount: uniqueSpecies.size,
                                                numChecklists: uniqueChecklists.size || 1,
                                                timeRangeUsed: hotspotTimeRange
                                            });
                                        }
                                    }
                                    await new Promise(resolve => setTimeout(resolve, 50));
                                } catch (e) {
                                    // Skip this hotspot
                                }
                                
                                // Stop if we have enough good hotspots
                                if (hotspotsWithCounts.length >= 15) break;
                            }
                            
                            allHotspots = hotspotsWithCounts
                                .sort((a, b) => b.totalSpecies - a.totalSpecies)
                                .slice(0, 10);
                            
                            console.log(`‚úÖ Loaded ${allHotspots.length} hotspots within ${regionCode}`);
                        } else {
                            console.warn(`‚ö†Ô∏è Could not fetch hotspots for region: ${hotspotsResponse.status}`);
                            allHotspots = [];
                        }
                    } catch (hotspotError) {
                        console.warn('‚ö†Ô∏è Error fetching hotspots:', hotspotError);
                        allHotspots = [];
                    }
                    
                    // Fetch top checklists for the region (independent of search filters)
                    // Use last 7 days to find the best recent checklists
                    await fetchTopChecklistsForRegion(regionCode);
                    
                    displayBirds();
                    displayHotspots();
                    displayChecklists();
                    showBelowMapPanels();
                    updateBelowMapPanels();
                    
                    // Fetch region eBird stats (all-time species count)
                    fetchRegionEBirdStats(regionCode);
                    
                    // Auto-load Top eBirders for this region
                    autoLoadTopEBirdersForRegion(regionCode);
                } else {
                    alert(`Could not fetch observations for ${regionCode}. Try unchecking "Region boundaries only".`);
                }
            } catch (error) {
                console.error('Error in region search:', error);
                alert('Error searching region. Please try again.');
            }
            hideLoading();
        }

        // ============================================
        // ROUTE PLANNING
        // ============================================
        async function planRoute() {
            if (!ebirdAuthenticated) {
                alert('Please connect to eBird first');
                return;
            }

            const origin = document.getElementById('originInput').value;
            const destination = document.getElementById('destinationInput').value;

            if (!origin || !destination) {
                alert('Please enter both origin and destination');
                return;
            }

            console.log(`üöó Planning route: ${origin} ‚Üí ${destination}`);

            // Clear previous search results
            clearMarkers();
            clearHotspots();
            clearChecklists();
            allSightings = [];
            allHotspots = [];
            allChecklists = [];
            targetSpecies = [];

            try {
                // Calculate route
                const request = {
                    origin: origin,
                    destination: destination,
                    waypoints: tripWaypoints.map(wp => ({ location: wp.location, stopover: true })),
                    optimizeWaypoints: true, // Let Google optimize the order
                    travelMode: google.maps.TravelMode.DRIVING
                };

                directionsService.route(request, async (result, status) => {
                    if (status === 'OK') {
                        currentRoute = result;
                        directionsRenderer.setDirections(result);

                        // Get duration
                        const route = result.routes[0];
                        let totalDuration = 0;
                        route.legs.forEach(leg => {
                            totalDuration += leg.duration.value;
                        });
                        
                        routeDuration = formatDuration(totalDuration);
                        document.getElementById('durationText').textContent = routeDuration;
                        document.getElementById('routeDuration').classList.remove('hidden');
                        document.getElementById('printBtn').classList.remove('hidden');
                        document.getElementById('navBtn').classList.remove('hidden');

                        // Find birds along route
                        await findBirdsAlongRoute(route);

                        console.log(`‚úÖ Route calculated: ${routeDuration}`);
                    } else {
                        console.error('‚ùå Directions request failed:', status);
                        logBirderError('google_maps', 'Directions request failed', { status: status });
                        alert('Could not calculate route. Please check your locations.');
                    }
                });
            } catch (error) {
                console.error('‚ùå Route planning error:', error);
                logBirderError('route_planning', 'Route planning failed', { error: error.message });
                alert('Error planning route');
            }
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function getDistance(lat1, lng1, lat2, lng2) {
            // Haversine formula for distance in miles
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ============================================
        // FIND BIRDS ALONG ROUTE
        // ============================================
        async function findBirdsAlongRoute(route) {
            console.log('üîç Finding birds along entire route...');
            showLoading('Finding birds along route...');

            // Clear previous markers
            clearMarkers();

            // Get route bounds with buffer
            const radiusMiles = parseInt(document.getElementById('searchRadius').value);
            const radiusKm = validateAndConvertRadius(radiusMiles);
            const timeRange = parseInt(document.getElementById('timeRange').value);
            
            const path = route.overview_path;
            console.log(`üìç Route has ${path.length} points`);
            
            // Calculate total route distance in miles
            const totalDistanceMeters = route.legs.reduce((sum, leg) => sum + leg.distance.value, 0);
            const totalDistanceMiles = totalDistanceMeters / 1609.34;
            
            console.log(`üìè Total route distance: ${totalDistanceMiles.toFixed(1)} miles`);
            
            // Strategy: Create overlapping search circles every 20 miles
            // This ensures complete coverage even with eBird's 50km (31 mile) limit
            const searchIntervalMiles = 20; // Overlapping circles every 20 miles
            const numSearchPoints = Math.max(2, Math.ceil(totalDistanceMiles / searchIntervalMiles) + 1);
            
            console.log(`üéØ Creating ${numSearchPoints} overlapping search areas (every ~${searchIntervalMiles} miles)`);
            
            // Sample points evenly along route
            const samplePoints = [];
            const sampleInterval = Math.max(1, Math.floor(path.length / (numSearchPoints - 1)));
            
            for (let i = 0; i < path.length; i += sampleInterval) {
                samplePoints.push({
                    lat: path[i].lat(),
                    lng: path[i].lng()
                });
            }
            
            // Always include start and end
            if (samplePoints.length === 0 || samplePoints[0].lat !== path[0].lat()) {
                samplePoints.unshift({ lat: path[0].lat(), lng: path[0].lng() });
            }
            const lastPoint = path[path.length - 1];
            if (samplePoints[samplePoints.length - 1].lat !== lastPoint.lat()) {
                samplePoints.push({ lat: lastPoint.lat(), lng: lastPoint.lng() });
            }

            console.log(`üìç Searching ${samplePoints.length} overlapping areas along route (${radiusKm}km radius each)`);

            // Fetch birds from multiple overlapping points along route
            try {
                allObservations = []; // Use global variable
                const allHotspotsData = [];
                const allChecklistsData = [];
                
                // Fetch from each search area with progressive display
                for (let i = 0; i < samplePoints.length; i++) {
                    const point = samplePoints[i];
                    const progress = Math.round(((i + 1) / samplePoints.length) * 100);
                    updateLoadingStatus(`Searching area ${i + 1}/${samplePoints.length} (${progress}%)...`);
                    console.log(`üìç Fetching area ${i + 1}/${samplePoints.length} - Lat: ${point.lat.toFixed(4)}, Lng: ${point.lng.toFixed(4)}`);
                    
                    try {
                        // Get observations
                        const obsUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${point.lat}&lng=${point.lng}&dist=${radiusKm}&back=${timeRange}`;
                        const obsResponse = await fetch(obsUrl, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });

                        if (obsResponse.ok) {
                            const observations = await obsResponse.json();
                            allObservations.push(...observations);
                            
                            // Progressive display: Show birds as they arrive
                            if (i === 0 || (i + 1) % 3 === 0 || i === samplePoints.length - 1) {
                                // Remove duplicates for display
                                const uniqueObs = {};
                                allObservations.forEach(obs => {
                                    const key = `${obs.speciesCode}-${obs.lat}-${obs.lng}-${obs.obsDt}`;
                                    if (!uniqueObs[key]) uniqueObs[key] = obs;
                                });
                                allSightings = Object.values(uniqueObs);
                                
                                // Update target species
                                const targetList = getTargetList();
                                const listType = document.getElementById('targetListType').value;
                                if (listType === 'all') {
                                    targetSpecies = [];
                                } else {
                                    targetSpecies = allSightings.filter(obs => !targetList.has(obs.comName));
                                }
                                
                                // Display current results
                                displayBirds();
                                updateLoadingStatus(`Found ${allSightings.length} birds so far... (searching area ${i + 1}/${samplePoints.length})`);
                                console.log(`üê¶ Progressive update: ${allSightings.length} observations, ${targetSpecies.length} targets`);
                            }
                        }
                        
                        // Get hotspots for this point
                        const hotspotsUrl = `https://api.ebird.org/v2/ref/hotspot/geo?lat=${point.lat}&lng=${point.lng}&dist=${radiusKm}&fmt=json`;
                        const hotspotsResponse = await fetch(hotspotsUrl, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });
                        
                        if (hotspotsResponse.ok) {
                            const hotspots = await hotspotsResponse.json();
                            allHotspotsData.push(...hotspots);
                        }
                        
                        // Small delay to avoid rate limiting
                        if (i < samplePoints.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    } catch (error) {
                        console.warn(`Failed to fetch data for area ${i + 1}:`, error);
                    }
                }
                
                // Remove duplicates (same observation may appear from multiple sample points)
                const uniqueObs = {};
                allObservations.forEach(obs => {
                    const key = `${obs.speciesCode}-${obs.lat}-${obs.lng}-${obs.obsDt}`;
                    if (!uniqueObs[key]) {
                        uniqueObs[key] = obs;
                    }
                });
                allSightings = Object.values(uniqueObs);
                
                console.log(`üìç Found ${allSightings.length} unique observations along route`);

                // Identify target species
                const targetList = getTargetList();
                const listType = document.getElementById('targetListType').value;
                if (listType === 'all') {
                    targetSpecies = [];
                } else {
                    targetSpecies = allSightings.filter(obs => !targetList.has(obs.comName));
                }
                console.log(`üéØ Found ${targetSpecies.length} target species (${allSightings.length} total birds)`);
                
                // If no targets and filter is active, help user understand
                if (targetSpecies.length === 0 && listType !== 'all' && allSightings.length > 0) {
                    console.log(`‚ÑπÔ∏è No new birds for ${listType} list. You've seen all ${allSightings.length} birds on this route!`);
                    console.log(`üí° Tip: Switch to "Show All Species" to see them on the map.`);
                }
                
                // Fetch expected seasonal targets and notable sightings
                updateLoadingStatus('Finding expected seasonal targets...');
                const centerPoint = samplePoints[Math.floor(samplePoints.length / 2)];
                const regionCode = getRegionFromCoordinates(centerPoint.lat, centerPoint.lng);
                
                const [expectedData, notableData] = await Promise.all([
                    fetchExpectedTargets(regionCode),
                    fetchNotableTargets(regionCode)
                ]);
                
                // Filter expected targets to match observations we found
                expectedTargets = allSightings.filter(obs => {
                    const isTarget = !targetList.has(obs.comName);
                    const isInTop100 = expectedData.some(sp => 
                        targetFrequencies.has(obs.speciesCode)
                    );
                    return isTarget && isInTop100;
                });
                
                // Notable targets are already filtered by user's list
                notableTargets = notableData;
                
                console.log(`‚≠ê Found ${expectedTargets.length} expected seasonal targets`);
                console.log(`üíé Found ${notableTargets.length} notable rare targets`);

                // Process hotspots - distribute along route instead of just taking top globally
                updateLoadingStatus('Processing hotspots...');
                const uniqueHotspots = {};
                allHotspotsData.forEach(h => {
                    if (!uniqueHotspots[h.locId]) {
                        uniqueHotspots[h.locId] = h;
                    }
                });
                
                console.log(`üìç Found ${Object.keys(uniqueHotspots).length} unique hotspots total`);
                
                // Group hotspots by which sample point they're near
                const hotspotsBySection = [];
                const hotspotsPerSection = Math.ceil(10 / samplePoints.length); // Distribute evenly
                
                // For each section of the route, get the best hotspots
                for (let i = 0; i < samplePoints.length && hotspotsBySection.length < 30; i++) {
                    const point = samplePoints[i];
                    
                    // Get hotspots near this point
                    const nearbyHotspots = Object.values(uniqueHotspots).filter(h => {
                        const distance = getDistance(point.lat, point.lng, h.lat, h.lng);
                        return distance < radiusMiles * 1.5; // Within 1.5x the search radius
                    });
                    
                    hotspotsBySection.push(...nearbyHotspots.slice(0, hotspotsPerSection));
                }
                
                updateLoadingStatus('Getting hotspot species counts...');
                const hotspotTimeRange = 30; // Always use 30 days for hotspot evaluation
                console.log(`üìç Checking ${hotspotsBySection.length} hotspots for species counts (using ${hotspotTimeRange} days)`);
                
                // Get species counts for distributed hotspots
                const hotspotsWithCounts = [];
                for (const hotspot of hotspotsBySection) {
                    try {
                        const obsUrl = `https://api.ebird.org/v2/data/obs/${hotspot.locId}/recent?back=${hotspotTimeRange}`;
                        const obsResponse = await fetch(obsUrl, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });

                        if (obsResponse.ok) {
                            const observations = await obsResponse.json();
                            const uniqueSpecies = new Set(observations.map(obs => obs.speciesCode));
                            
                            // Count unique checklists
                            const uniqueChecklists = new Set(observations.map(obs => obs.subId).filter(id => id));
                            
                            console.log(`  üìç ${hotspot.locName}: ${uniqueSpecies.size} species in ${hotspotTimeRange} days (${uniqueChecklists.size} checklists)`);
                            
                            // Only add if there are actual species
                            if (uniqueSpecies.size > 0) {
                                hotspotsWithCounts.push({
                                    ...hotspot,
                                    speciesCount: uniqueSpecies.size,
                                    totalSpecies: uniqueSpecies.size,
                                    recentObs: observations.length,
                                    numChecklists: uniqueChecklists.size || 1,
                                    timeRangeUsed: hotspotTimeRange
                                });
                            }
                        } else {
                            console.log(`  ‚ö†Ô∏è ${hotspot.locName}: Failed to fetch (${obsResponse.status})`);
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 100));
                    } catch (e) {
                        console.warn(`Couldn't fetch data for hotspot ${hotspot.locId}`);
                    }
                }

                allHotspots = hotspotsWithCounts
                    .filter(h => h.speciesCount > 0)
                    .sort((a, b) => b.speciesCount - a.speciesCount)
                    .slice(0, 10);
                    
                console.log(`‚úÖ Found ${allHotspots.length} top hotspots (last 30 days):`, allHotspots.map(h => `${h.locName} (${h.speciesCount} species)`));

                // Get top checklists from observations
                updateLoadingStatus('Processing checklists...');
                await fetchTop10ChecklistsFromObservations(allObservations);

                // Display everything
                updateLoadingStatus('Displaying results...');
                displayBirds();
                displayHotspots();
                displayChecklists();
                updateBelowMapPanels();

                // Show below-map section
                document.getElementById('belowMap').style.display = 'block';
                
                hideLoading();

            } catch (error) {
                console.error('‚ùå Error finding birds:', error);
                logBirderError('route_search', 'Finding birds along route failed', { error: error.message });
                hideLoading();
                alert('Error finding birds along route');
            }
        }
        
        // Helper function to get checklists from observations
        async function fetchTop10ChecklistsFromObservations(observations) {
            const checklistMap = {};
            observations.forEach(obs => {
                if (obs.subId) {
                    if (!checklistMap[obs.subId]) {
                        checklistMap[obs.subId] = {
                            subId: obs.subId,
                            lat: obs.lat,
                            lng: obs.lng,
                            locName: obs.locName,
                            obsDt: obs.obsDt,
                            species: new Set(),
                            fullSpeciesCount: null // Will be fetched from API
                        };
                    }
                    checklistMap[obs.subId].species.add(obs.speciesCode);
                }
            });

            // Sort by observed species count first
            let checklistsWithCounts = Object.values(checklistMap).map(checklist => ({
                ...checklist,
                speciesCount: checklist.species.size
            }));
            
            checklistsWithCounts.sort((a, b) => b.speciesCount - a.speciesCount);
            
            // Take top 15 candidates and try to get full species counts
            const topCandidates = checklistsWithCounts.slice(0, 15);
            
            // Fetch full checklist details to get actual species count
            for (const checklist of topCandidates) {
                try {
                    const response = await fetch(`https://api.ebird.org/v2/product/checklist/view/${checklist.subId}`, {
                        headers: { 'X-eBirdApiToken': userApiKey }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.obs && Array.isArray(data.obs)) {
                            checklist.fullSpeciesCount = data.obs.length;
                            checklist.speciesCount = data.obs.length; // Use full count
                        }
                    }
                    await new Promise(resolve => setTimeout(resolve, 50));
                } catch (e) {
                    // Keep the observed count if fetch fails
                    console.warn(`Could not fetch full checklist ${checklist.subId}`);
                }
            }
            
            // Re-sort by full species count and take top 10
            allChecklists = topCandidates
                .sort((a, b) => b.speciesCount - a.speciesCount)
                .slice(0, 10);

            console.log(`‚úÖ Top 10 checklists:`, allChecklists.map(c => `${c.locName}: ${c.speciesCount} species`));
        }
        
        // Fetch top checklists for a region (independent of search filters)
        async function fetchTopChecklistsForRegion(regionCode) {
            console.log(`üìã Fetching top checklists for region ${regionCode}...`);
            
            try {
                // Fetch recent observations for the region (last 7 days for freshness)
                const obsUrl = `https://api.ebird.org/v2/data/obs/${regionCode}/recent?back=7`;
                const response = await fetch(obsUrl, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });
                
                if (!response.ok) {
                    console.warn(`‚ö†Ô∏è Could not fetch observations for checklists: ${response.status}`);
                    allChecklists = [];
                    return;
                }
                
                const observations = await response.json();
                console.log(`üìã Found ${observations.length} observations in region for checklist analysis`);
                
                // Group by checklist
                const checklistMap = {};
                observations.forEach(obs => {
                    if (obs.subId) {
                        if (!checklistMap[obs.subId]) {
                            checklistMap[obs.subId] = {
                                subId: obs.subId,
                                lat: obs.lat,
                                lng: obs.lng,
                                locName: obs.locName,
                                obsDt: obs.obsDt,
                                species: new Set()
                            };
                        }
                        checklistMap[obs.subId].species.add(obs.speciesCode);
                    }
                });
                
                // Sort by species count and take top candidates
                let candidates = Object.values(checklistMap)
                    .map(c => ({...c, speciesCount: c.species.size}))
                    .sort((a, b) => b.speciesCount - a.speciesCount)
                    .slice(0, 20);
                
                // Fetch full checklist details for accurate species counts
                for (const checklist of candidates) {
                    try {
                        const detailResponse = await fetch(`https://api.ebird.org/v2/product/checklist/view/${checklist.subId}`, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });
                        if (detailResponse.ok) {
                            const data = await detailResponse.json();
                            if (data.obs && Array.isArray(data.obs)) {
                                checklist.speciesCount = data.obs.length;
                            }
                        }
                        await new Promise(resolve => setTimeout(resolve, 50));
                    } catch (e) {
                        // Keep the observed count
                    }
                }
                
                // Re-sort and take top 10
                allChecklists = candidates
                    .sort((a, b) => b.speciesCount - a.speciesCount)
                    .slice(0, 10);
                
                console.log(`‚úÖ Top 10 checklists in ${regionCode}:`, allChecklists.map(c => `${c.locName}: ${c.speciesCount} species`));
                
            } catch (error) {
                console.error('Error fetching top checklists for region:', error);
                allChecklists = [];
            }
        }

        // ============================================
        // FETCH TOP 10 HOTSPOTS (BY SPECIES COUNT)
        // ============================================
        async function fetchTop10Hotspots(lat, lng, radius) {
            console.log('üìç Fetching top hotspots by recent checklist species counts...');

            try {
                // Get all hotspots in area
                const hotspotsUrl = `https://api.ebird.org/v2/ref/hotspot/geo?lat=${lat}&lng=${lng}&dist=${radius}&fmt=json`;
                const response = await fetch(hotspotsUrl, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch hotspots');
                }

                const hotspots = await response.json();
                console.log(`Found ${hotspots.length} total hotspots in area`);

                if (hotspots.length === 0) {
                    allHotspots = [];
                    return;
                }

                // Always use 30 days for hotspot evaluation
                const hotspotTimeRange = 30;
                
                console.log(`Using ${hotspotTimeRange} day time range for hotspot evaluation`);

                // For each hotspot, get recent observations
                const hotspotsWithData = [];

                // Limit to first 50 hotspots to avoid too many API calls
                const hotspotsToCheck = hotspots.slice(0, 50);
                
                // Fetch in parallel for better performance (batches of 5)
                const batchSize = 5;
                for (let i = 0; i < hotspotsToCheck.length; i += batchSize) {
                    const batch = hotspotsToCheck.slice(i, i + batchSize);
                    const batchPromises = batch.map(async (hotspot) => {
                        try {
                            const obsUrl = `https://api.ebird.org/v2/data/obs/${hotspot.locId}/recent?back=${hotspotTimeRange}`;
                            const obsResponse = await fetch(obsUrl, {
                                headers: { 'X-eBirdApiToken': userApiKey }
                            });

                            if (obsResponse.ok) {
                                const observations = await obsResponse.json();
                                
                                // Skip hotspots with no observations
                                if (!observations || observations.length === 0) {
                                    console.log(`  ‚è≠Ô∏è ${hotspot.locName}: No observations in ${hotspotTimeRange} days`);
                                    return null;
                                }
                                
                                // Group observations by checklist (subId) to find best single checklist
                                const checklistMap = {};
                                observations.forEach(obs => {
                                    const checklistId = obs.subId || 'unknown';
                                    if (!checklistMap[checklistId]) {
                                        checklistMap[checklistId] = {
                                            subId: checklistId,
                                            date: obs.obsDt,
                                            species: new Set(),
                                            obsCount: 0
                                        };
                                    }
                                    checklistMap[checklistId].species.add(obs.speciesCode);
                                    checklistMap[checklistId].obsCount++;
                                });
                                
                                // Find the checklist with the most species
                                const checklists = Object.values(checklistMap);
                                if (checklists.length === 0) return null;
                                
                                const bestChecklist = checklists.reduce((best, current) => 
                                    current.species.size > best.species.size ? current : best
                                , checklists[0]);
                                
                                // Skip if best checklist has 0 species (shouldn't happen but safety check)
                                if (bestChecklist.species.size === 0) {
                                    console.log(`  ‚è≠Ô∏è ${hotspot.locName}: Best checklist has 0 species`);
                                    return null;
                                }
                                
                                // Also calculate total unique species across all checklists
                                const totalUniqueSpecies = new Set(observations.map(obs => obs.speciesCode));
                                
                                return {
                                    ...hotspot,
                                    bestChecklistSpecies: bestChecklist.species.size,
                                    bestChecklistDate: bestChecklist.date,
                                    bestChecklistId: bestChecklist.subId,
                                    totalSpecies: totalUniqueSpecies.size,
                                    totalObs: observations.length,
                                    numChecklists: checklists.length,
                                    timeRangeUsed: hotspotTimeRange
                                };
                            }
                            return null;
                        } catch (e) {
                            console.warn(`Couldn't fetch data for hotspot ${hotspot.locId}:`, e.message);
                            return null;
                        }
                    });
                    
                    const results = await Promise.all(batchPromises);
                    const validResults = results.filter(h => h !== null && h.totalSpecies > 0);
                    hotspotsWithData.push(...validResults);
                    
                    // Stop if we have enough good hotspots
                    if (hotspotsWithData.length >= 15) break;
                }

                // Filter out any with 0 species, sort by TOTAL species (not best checklist), take top 10
                allHotspots = hotspotsWithData
                    .filter(h => h.totalSpecies > 0)
                    .sort((a, b) => b.totalSpecies - a.totalSpecies)
                    .slice(0, 10);

                if (allHotspots.length > 0) {
                    console.log(`‚úÖ Top ${allHotspots.length} hotspots by total species (last 30 days):`, 
                        allHotspots.map(h => `${h.locName}: ${h.totalSpecies} species`));
                } else {
                    console.log('‚ö†Ô∏è No hotspots with observations found in this area for the selected time range');
                }

            } catch (error) {
                console.error('‚ùå Error fetching hotspots:', error);
                allHotspots = [];
            }
        }

        // ============================================
        // DISPLAY BIRDS ON MAP
        // ============================================
        function displayBirds() {
            clearMarkers();

            const listType = document.getElementById('targetListType').value;
            const targetList = getTargetList();
            
            let birdsToShow = allSightings;
            
            // Apply target filter based on type
            if (listType === 'expected') {
                // Show only expected seasonal targets
                birdsToShow = expectedTargets;
            } else if (listType === 'notable') {
                // Show only notable rare targets
                birdsToShow = notableTargets;
            } else if (listType !== 'all') {
                // Show regular targets (haven't seen)
                birdsToShow = allSightings.filter(obs => !targetList.has(obs.comName));
            }

            console.log(`Displaying ${birdsToShow.length} bird markers (filter: ${listType})`);
            
            // Show helpful message when filter hides all birds
            if (birdsToShow.length === 0 && allSightings.length > 0) {
                if (listType === 'expected') {
                    console.log(`‚ÑπÔ∏è No expected seasonal targets found. This might be a transitional season.`);
                } else if (listType === 'notable') {
                    console.log(`‚ÑπÔ∏è No notable/rare birds recently reported in this area.`);
                } else {
                    console.log(`‚ÑπÔ∏è Filter is hiding all ${allSightings.length} birds. You've already seen them all!`);
                    console.log(`üí° Tip: Switch to "Show All Species" to see them on the map.`);
                }
            }

            birdsToShow.forEach(obs => {
                const isTarget = !targetList.has(obs.comName);
                const isExpected = expectedTargets.some(e => e.speciesCode === obs.speciesCode);
                const isNotable = notableTargets.some(n => n.speciesCode === obs.speciesCode);
                const abaCode = getABARarityCode(obs.comName);
                
                // Check ABA rarity filter
                if (!shouldShowABARarity(abaCode)) {
                    return; // Skip this bird
                }
                
                const color = getMarkerColor(obs, isTarget, abaCode, isExpected, isNotable);
                const actualCount = obs.howMany || 1;

                const marker = new google.maps.Marker({
                    position: { lat: obs.lat, lng: obs.lng },
                    map: map,
                    title: obs.comName,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: color,
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    }
                });

                // Store marker with species name for highlighting
                marker.speciesName = obs.comName;
                marker.abaCode = abaCode;

                const abaRarityText = ['', 'Common', 'Uncommon', 'Rare', 'Very Rare', 'Mega Rare', 'Extirpated'][abaCode] || 'Common';
                
                // Get frequency data if available
                const frequency = targetFrequencies.get(obs.speciesCode);
                const frequencyText = frequency ? 
                    `<p style="margin: 5px 0; font-size: 0.9em;"><strong>Frequency:</strong> ${(frequency * 100).toFixed(0)}% of checklists</p>` : '';
                
                // Determine target type badge (simplified - no confusing emojis)
                let targetBadge = '';
                if (isNotable) {
                    targetBadge = '<div style="background: #a855f7; color: white; padding: 4px 8px; border-radius: 4px; display: inline-block; margin: 5px 0; font-weight: 600; font-size: 0.8em;">NOTABLE</div>';
                } else if (isTarget) {
                    targetBadge = '<div style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; display: inline-block; margin: 5px 0; font-weight: 600; font-size: 0.8em;">TARGET</div>';
                }

                // Create checklist link if subId exists
                const checklistLink = obs.subId ? 
                    `<p style="margin: 5px 0; font-size: 0.9em;"><strong>Checklist:</strong> <a href="https://ebird.org/checklist/${obs.subId}" target="_blank" style="color: #10b981; text-decoration: underline;">View on eBird</a></p>` : '';

                // Use location name from eBird, clean up auto-generated names
                let locationName = obs.locName || 'Unknown Location';
                // If location looks like auto-generated coordinates, show a cleaner format
                if (locationName.toLowerCase().includes('auto selected') || locationName.match(/^[\d\.\-,\s]+$/)) {
                    locationName = 'Personal Location';
                }

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; max-width: 250px;">
                            <h3 style="margin: 0 0 8px 0; color: #065f46;">${obs.comName}</h3>
                            ${targetBadge}
                            ${frequencyText}
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>ABA Rarity:</strong> Code ${abaCode} (${abaRarityText})</p>
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>Location:</strong> ${locationName}</p>
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>Date:</strong> ${obs.obsDt}</p>
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>Count:</strong> ${actualCount}</p>
                            ${checklistLink}
                            <button onclick="addWaypoint(${obs.lat}, ${obs.lng}, '${locationName.replace(/'/g, "\\'")}', '${obs.comName.replace(/'/g, "\\'")}' )" 
                                    style="margin-top: 10px; padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                                ‚ûï Add to Route
                            </button>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markersArray.push(marker);
            });
        }

        // Current marker style preference
        let markerStylePreference = 'default'; // 'default' or 'aba'
        
        function getMarkerColor(obs, isTarget, abaCode, isExpected, isNotable) {
            // Check user preference
            const useABAStyle = markerStylePreference === 'aba';
            
            if (useABAStyle) {
                // Use ABA rarity colors only
                return getABARarityColor(abaCode);
            }
            
            // Default style: Target type based colors (simplified)
            // Priority 1: Notable rare targets (purple)
            if (isNotable) return '#a855f7'; // Purple for notable/rare
            
            // Priority 2: Regular target species (red)
            if (isTarget) return '#ef4444'; // Red for targets
            
            // Priority 3: Regular species on your list (green)
            return '#10b981'; // Green for species you've seen
        }
        
        // Set marker style via button toggle
        function setMarkerStyle(style) {
            markerStylePreference = style;
            
            // Update button states
            const btnTarget = document.getElementById('btnTargetStyle');
            const btnABA = document.getElementById('btnABAStyle');
            const defaultLegend = document.getElementById('defaultLegend');
            const abaLegend = document.getElementById('abaLegend');
            
            if (style === 'aba') {
                btnTarget.classList.remove('active');
                btnABA.classList.add('active');
                defaultLegend.style.display = 'none';
                abaLegend.style.display = 'block';
            } else {
                btnTarget.classList.add('active');
                btnABA.classList.remove('active');
                defaultLegend.style.display = 'block';
                abaLegend.style.display = 'none';
            }
            
            // Save preference
            localStorage.setItem('travelingBirder_markerStyle', style);
            
            // Refresh markers if we have data
            if (allSightings && allSightings.length > 0) {
                displayBirds();
            }
            
            console.log(`üé® Marker style: ${style}`);
        }
        
        // Legacy function for compatibility
        function changeMarkerStyle() {
            const styleSelect = document.getElementById('markerStyleSelect');
            if (styleSelect) {
                setMarkerStyle(styleSelect.value);
            }
        }
        
        // Load marker style preference on init
        function loadMarkerStylePreference() {
            const saved = localStorage.getItem('travelingBirder_markerStyle');
            if (saved) {
                setMarkerStyle(saved);
            }
        }
        
        // Updated ABA Rarity Colors (more distinct)
        function getABARarityColor(abaCode) {
            switch(abaCode) {
                case 1: return '#22c55e'; // Green - Common
                case 2: return '#eab308'; // Yellow - Uncommon
                case 3: return '#f97316'; // Orange - Rare
                case 4: return '#ef4444'; // Red - Very Rare
                case 5: return '#8b5cf6'; // Purple - Mega Rare
                case 6: return '#1f2937'; // Dark Gray - Extirpated
                default: return '#22c55e'; // Default to common
            }
        }

        // ABA Filter Functions
        function getActiveABACodes() {
            const codes = [];
            for (let i = 1; i <= 6; i++) {
                const checkbox = document.getElementById(`abaFilter${i}`);
                if (checkbox && checkbox.checked) {
                    codes.push(i);
                }
            }
            return codes;
        }

        function applyABAFilter() {
            // Only apply if ABA mode is active
            if (markerStylePreference !== 'aba') return;
            
            // Refresh the display with current filters
            if (allSightings && allSightings.length > 0) {
                displayBirds();
            }
            
            console.log('üéØ ABA filter applied:', getActiveABACodes());
        }

        function selectAllABA(selectAll) {
            for (let i = 1; i <= 6; i++) {
                const checkbox = document.getElementById(`abaFilter${i}`);
                if (checkbox) {
                    checkbox.checked = selectAll;
                }
            }
            applyABAFilter();
        }

        function selectRareABA() {
            // Select only Code 3+ (Rare and rarer)
            for (let i = 1; i <= 6; i++) {
                const checkbox = document.getElementById(`abaFilter${i}`);
                if (checkbox) {
                    checkbox.checked = (i >= 3);
                }
            }
            applyABAFilter();
        }

        function shouldShowByABACode(abaCode) {
            // If not in ABA mode, show all
            if (markerStylePreference !== 'aba') return true;
            
            const checkbox = document.getElementById(`abaFilter${abaCode}`);
            return checkbox ? checkbox.checked : true;
        }

        // ============================================
        // HIGHLIGHT SPECIES ON MAP
        // ============================================
        function highlightSpeciesOnMap(speciesName) {
            console.log(`üéØ Highlighting ${speciesName} on map`);
            
            // Find all markers for this species
            const speciesMarkers = markersArray.filter(marker => marker.speciesName === speciesName);
            
            if (speciesMarkers.length === 0) {
                alert(`No map markers found for ${speciesName}`);
                return;
            }
            
            // Reset all markers to normal size
            markersArray.forEach(marker => {
                marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: marker.icon.fillColor,
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2
                });
            });
            
            // Highlight the selected species markers
            speciesMarkers.forEach(marker => {
                marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 14, // Larger
                    fillColor: marker.icon.fillColor,
                    fillOpacity: 1,
                    strokeColor: '#fbbf24', // Gold border
                    strokeWeight: 4
                });
                
                // Make them bounce briefly
                marker.setAnimation(google.maps.Animation.BOUNCE);
                setTimeout(() => marker.setAnimation(null), 2000);
            });
            
            // Center map on first marker
            if (speciesMarkers.length > 0) {
                map.setCenter(speciesMarkers[0].getPosition());
                map.setZoom(12);
            }
            
            // Scroll map into view
            document.getElementById('map').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            console.log(`‚úÖ Highlighted ${speciesMarkers.length} markers for ${speciesName}`);
        }

        // ============================================
        // DISPLAY HOTSPOTS
        // ============================================
        function displayHotspots() {
            console.log('üó∫Ô∏è displayHotspots called, checkbox checked:', document.getElementById('showHotspots').checked);
            console.log('üó∫Ô∏è allHotspots array length:', allHotspots.length);
            
            if (!document.getElementById('showHotspots').checked) {
                clearHotspots();
                return;
            }

            clearHotspots();
            
            if (allHotspots.length === 0) {
                console.log('‚ÑπÔ∏è No hotspots to display - allHotspots is empty');
                return;
            }
            
            console.log('üìç Displaying hotspots:', allHotspots.map(h => h.locName));

            allHotspots.forEach((hotspot, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: hotspot.lat, lng: hotspot.lng },
                    map: map,
                    title: `Hotspot #${index + 1}: ${hotspot.locName}`,
                    label: {
                        text: `${index + 1}`,
                        color: 'white',
                        fontSize: '12px',
                        fontWeight: 'bold'
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 14,
                        fillColor: '#3b82f6',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    }
                });

                // Format the date nicely
                const bestDate = hotspot.bestChecklistDate ? 
                    new Date(hotspot.bestChecklistDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 
                    'Recent';
                
                // Always show "30 days" since that's what we use for hotspots
                const timeRangeText = '30 days';
                
                // Build the checklist link if available
                const checklistLink = hotspot.bestChecklistId && hotspot.bestChecklistId !== 'unknown' ? 
                    `<a href="https://ebird.org/checklist/${hotspot.bestChecklistId}" target="_blank" style="color: #3b82f6; text-decoration: underline;">View recent checklist ‚Üí</a>` : '';

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; max-width: 300px;">
                            <div style="background: #3b82f6; color: white; padding: 6px 10px; border-radius: 4px; font-size: 0.8em; font-weight: 600; display: inline-block; margin-bottom: 8px;">üìç HOTSPOT #${index + 1}</div>
                            <h3 style="margin: 0 0 10px 0; color: #065f46;">${hotspot.locName}</h3>
                            
                            <div style="background: #dbeafe; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                                <div style="font-size: 0.75em; color: #3b82f6; text-transform: uppercase; margin-bottom: 6px;">Species (Last 30 Days)</div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: #1e40af; font-weight: 600;">ü¶Ü Total Species:</span>
                                    <span style="color: #1e40af; font-weight: 700; font-size: 1.3em;">${hotspot.totalSpecies || hotspot.speciesCount || 0}</span>
                                </div>
                            </div>
                            
                            <div style="background: #f3f4f6; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 0.85em; color: #6b7280;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Checklists submitted:</span>
                                    <span style="font-weight: 600; color: #374151;">${hotspot.numChecklists || 0}</span>
                                </div>
                                ${hotspot.bestChecklistSpecies ? `<div style="display: flex; justify-content: space-between; margin-top: 4px;">
                                    <span>Best single checklist:</span>
                                    <span style="font-weight: 600; color: #374151;">${hotspot.bestChecklistSpecies} species</span>
                                </div>` : ''}
                            </div>
                            
                            <div style="margin-bottom: 10px; font-size: 0.85em; line-height: 1.6;">
                                <a href="https://ebird.org/hotspot/${hotspot.locId}" target="_blank" style="color: #10b981; text-decoration: underline;">View hotspot on eBird ‚Üí</a>
                                ${checklistLink ? '<br>' + checklistLink : ''}
                            </div>
                            
                            <button onclick="addWaypoint(${hotspot.lat}, ${hotspot.lng}, '${hotspot.locName.replace(/'/g, "\\'")}', 'Hotspot')" 
                                    style="padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-weight: 600;">
                                ‚ûï Add to Route
                            </button>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                hotspotsArray.push(marker);
            });

            console.log(`‚úÖ Displayed ${allHotspots.length} hotspot markers`);
        }

        // ============================================
        // FETCH TOP 10 CHECKLISTS (BY SPECIES COUNT)
        // ============================================
        async function fetchTop10Checklists(lat, lng, radius) {
            console.log('üìã Fetching top checklists...');

            try {
                // Get recent notable observations (these are often in checklists)
                const timeRange = parseInt(document.getElementById('timeRange').value);
                const obsUrl = `https://api.ebird.org/v2/data/obs/geo/recent/notable?lat=${lat}&lng=${lng}&dist=${radius}&back=${timeRange}&detail=full`;
                
                const response = await fetch(obsUrl, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });

                if (!response.ok) {
                    console.warn('Could not fetch notable observations for checklists');
                    allChecklists = [];
                    return;
                }

                const observations = await response.json();
                
                // Group by checklist (subId)
                const checklistMap = {};
                observations.forEach(obs => {
                    if (obs.subId) {
                        if (!checklistMap[obs.subId]) {
                            checklistMap[obs.subId] = {
                                subId: obs.subId,
                                lat: obs.lat,
                                lng: obs.lng,
                                locName: obs.locName,
                                obsDt: obs.obsDt,
                                species: new Set()
                            };
                        }
                        checklistMap[obs.subId].species.add(obs.speciesCode);
                    }
                });

                // Convert to array and add species count
                const checklistsWithCounts = Object.values(checklistMap).map(checklist => ({
                    ...checklist,
                    speciesCount: checklist.species.size
                }));

                // Sort by species count and take top 10
                allChecklists = checklistsWithCounts
                    .sort((a, b) => b.speciesCount - a.speciesCount)
                    .slice(0, 10);

                console.log(`‚úÖ Top 10 checklists:`, allChecklists.map(c => `${c.locName}: ${c.speciesCount} species`));

            } catch (error) {
                console.error('‚ùå Error fetching checklists:', error);
                allChecklists = [];
            }
        }

        // ============================================
        // DISPLAY TOP 10 CHECKLISTS
        // ============================================
        function displayChecklists() {
            if (!document.getElementById('showChecklists').checked) {
                clearChecklists();
                return;
            }

            clearChecklists();

            allChecklists.forEach((checklist, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: checklist.lat, lng: checklist.lng },
                    map: map,
                    title: `Checklist #${index + 1}: ${checklist.locName}`,
                    label: {
                        text: `${index + 1}`,
                        color: 'white',
                        fontSize: '12px',
                        fontWeight: 'bold'
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 14,
                        fillColor: '#8b5cf6', // Purple to match legend
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    }
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; max-width: 280px;">
                            <div style="background: #8b5cf6; color: white; padding: 6px 10px; border-radius: 4px; font-size: 0.8em; font-weight: 600; display: inline-block; margin-bottom: 8px;">üìã CHECKLIST #${index + 1}</div>
                            <h3 style="margin: 0 0 8px 0; color: #065f46;">${checklist.locName}</h3>
                            <div style="background: #f0fdf4; padding: 10px; border-radius: 6px; margin: 10px 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: #065f46; font-weight: 600;">üê¶ Species:</span>
                                    <span style="color: #065f46; font-weight: 700; font-size: 1.2em;">${checklist.speciesCount}</span>
                                </div>
                                <div style="font-size: 0.85em; color: #047857; margin-top: 4px;">${checklist.obsDt}</div>
                            </div>
                            <div style="margin-bottom: 10px; font-size: 0.85em;">
                                <a href="https://ebird.org/checklist/${checklist.subId}" target="_blank" style="color: #8b5cf6; text-decoration: underline;">View checklist on eBird ‚Üí</a>
                            </div>
                            <button onclick="addWaypoint(${checklist.lat}, ${checklist.lng}, '${checklist.locName.replace(/'/g, "\\'")}', 'Checklist #${index + 1}')" 
                                    style="padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-weight: 600;">
                                ‚ûï Add to Route
                            </button>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                checklistsArray.push(marker);
            });

            console.log(`‚úÖ Displayed ${allChecklists.length} checklist markers`);
        }

        function clearChecklists() {
            checklistsArray.forEach(marker => marker.setMap(null));
            checklistsArray = [];
        }

        // ============================================
        // WAYPOINT MANAGEMENT
        // ============================================
        function addWaypoint(lat, lng, locationName, speciesName, obsDate = null, obsCount = null) {
            // Try to find observation data for this location/species
            let lastSeen = obsDate;
            let sightingCount = obsCount;
            
            if (!lastSeen && allSightings && allSightings.length > 0) {
                // Find matching observations
                const matchingObs = allSightings.filter(obs => 
                    obs.locName === locationName || 
                    (obs.comName === speciesName && Math.abs(obs.lat - lat) < 0.01 && Math.abs(obs.lng - lng) < 0.01)
                );
                
                if (matchingObs.length > 0) {
                    // Get most recent date
                    const dates = matchingObs.map(o => o.obsDt).filter(d => d).sort().reverse();
                    if (dates.length > 0) {
                        lastSeen = dates[0];
                    }
                    sightingCount = matchingObs.length;
                }
            }
            
            const waypoint = {
                location: { lat, lng },
                name: locationName,
                species: speciesName,
                lastSeen: lastSeen,
                sightingCount: sightingCount
            };

            tripWaypoints.push(waypoint);
            console.log(`‚ûï Added waypoint: ${locationName} (last seen: ${lastSeen || 'unknown'})`);

            updateWaypointList();
            
            // Recalculate route with new waypoint
            if (currentRoute) {
                planRoute();
            }
        }

        function removeWaypoint(index) {
            tripWaypoints.splice(index, 1);
            console.log(`‚ûñ Removed waypoint at index ${index}`);
            
            updateWaypointList();
            
            // Recalculate route
            if (currentRoute) {
                planRoute();
            }
        }

        function updateWaypointList() {
            const listDiv = document.getElementById('waypointList');
            
            if (tripWaypoints.length === 0) {
                listDiv.innerHTML = '';
                return;
            }

            listDiv.innerHTML = '<h4 style="margin: 15px 0 10px 0; color: #065f46; font-size: 0.95em;">Waypoints:</h4>';
            
            tripWaypoints.forEach((wp, index) => {
                const div = document.createElement('div');
                div.className = 'waypoint-item';
                div.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 0.9em;">${wp.name}</div>
                        <div style="font-size: 0.8em; color: var(--text-secondary);">${wp.species}</div>
                    </div>
                    <button class="waypoint-remove" onclick="removeWaypoint(${index})">√ó</button>
                `;
                listDiv.appendChild(div);
            });
        }

        // ============================================
        // PRINT DIRECTIONS
        // ============================================
        function printDirections() {
            if (!currentRoute) {
                alert('No route to print');
                return;
            }

            const route = currentRoute.routes[0];
            const origin = document.getElementById('originInput').value;
            const destination = document.getElementById('destinationInput').value;
            
            // Get search criteria
            const searchType = document.getElementById('searchType')?.value || 'route';
            const timeRange = document.getElementById('timeRange')?.value || '3';
            const searchRadius = document.getElementById('searchRadius')?.value || '30';
            const targetFilter = document.getElementById('targetListType')?.value || 'targets';
            
            // Format time range text
            const timeRangeText = {
                '3': 'Last 3 days',
                '7': 'Last 7 days',
                '14': 'Last 2 weeks',
                '30': 'Last 30 days',
                '90': 'Last 3 months',
                '180': 'Last 6 months',
                '365': 'Last year'
            }[timeRange] || `Last ${timeRange} days`;
            
            // Format target filter text
            const filterText = {
                'all': 'All Species',
                'targets': 'Life List Targets Only',
                'year': 'Year List Targets Only',
                'month': 'Month List Targets Only',
                'notable': 'Notable/Rare Only',
                'expected': 'Expected Seasonal'
            }[targetFilter] || targetFilter;

            // Create printable content
            let printContent = `
                <html>
                <head>
                    <title>Birding Route - ${origin} to ${destination}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
                        h1 { color: #065f46; border-bottom: 2px solid #10b981; padding-bottom: 10px; }
                        h2 { color: #10b981; margin-top: 25px; }
                        .leg { margin: 15px 0; padding: 10px; background: #f9fafb; border-left: 4px solid #10b981; }
                        .waypoint { background: #dbeafe; padding: 12px; margin: 8px 0; border-radius: 6px; border-left: 4px solid #3b82f6; }
                        .waypoint-details { display: flex; justify-content: space-between; margin-top: 6px; font-size: 0.9em; color: #4b5563; }
                        .summary { background: #f0fdf4; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #10b981; }
                        .criteria { background: #fef3c7; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #f59e0b; }
                        .criteria-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
                        .criteria-item { font-size: 0.9em; }
                        .criteria-label { font-weight: bold; color: #92400e; }
                        .footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 0.85em; }
                        @media print { 
                            .no-print { display: none; }
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <h1>ü¶© Birding Trip Route</h1>
                    
                    <div class="summary">
                        <p style="margin: 0 0 8px 0;"><strong>üìç From:</strong> ${origin}</p>
                        <p style="margin: 0 0 8px 0;"><strong>üèÅ To:</strong> ${destination}</p>
                        <p style="margin: 0 0 8px 0;"><strong>‚è±Ô∏è Total Duration:</strong> ${routeDuration}</p>
                        <p style="margin: 0;"><strong>üéØ Birding Stops:</strong> ${tripWaypoints.length}</p>
                    </div>
                    
                    <div class="criteria">
                        <strong>üîç Search Criteria Used:</strong>
                        <div class="criteria-grid">
                            <div class="criteria-item"><span class="criteria-label">Search Type:</span> ${searchType === 'route' ? 'Route Search' : searchType === 'area' ? 'Area Search' : 'Species Search'}</div>
                            <div class="criteria-item"><span class="criteria-label">Time Range:</span> ${timeRangeText}</div>
                            <div class="criteria-item"><span class="criteria-label">Search Radius:</span> ${searchRadius} miles</div>
                            <div class="criteria-item"><span class="criteria-label">Filter:</span> ${filterText}</div>
                        </div>
                    </div>
            `;

            if (tripWaypoints.length > 0) {
                printContent += '<h2>üéØ Birding Stops</h2>';
                printContent += '<p style="font-size: 0.9em; color: #6b7280; margin-bottom: 15px;">Stops are listed in route order. Check eBird for latest sightings before visiting.</p>';
                
                tripWaypoints.forEach((wp, index) => {
                    const lastSeenText = wp.lastSeen ? 
                        `Last reported: ${new Date(wp.lastSeen).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}` : 
                        'Date: Check eBird';
                    const countText = wp.sightingCount ? `${wp.sightingCount} report${wp.sightingCount > 1 ? 's' : ''} in timeframe` : '';
                    
                    printContent += `
                        <div class="waypoint">
                            <strong>Stop ${index + 1}: ${wp.name}</strong><br>
                            <span style="color: #1e40af;">üê¶ ${wp.species}</span>
                            <div class="waypoint-details">
                                <span>üìÖ ${lastSeenText}</span>
                                ${countText ? `<span>üìä ${countText}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            printContent += '<h2>üó∫Ô∏è Turn-by-Turn Directions</h2>';

            route.legs.forEach((leg, legIndex) => {
                printContent += `
                    <div class="leg">
                        <h3 style="margin: 0 0 8px 0; font-size: 1em;">Leg ${legIndex + 1}: ${leg.start_address.split(',')[0]} ‚Üí ${leg.end_address.split(',')[0]}</h3>
                        <p style="margin: 0 0 10px 0;"><strong>Distance:</strong> ${leg.distance.text} | <strong>Duration:</strong> ${leg.duration.text}</p>
                `;
                
                leg.steps.forEach((step, stepIndex) => {
                    printContent += `<p style="margin: 4px 0; font-size: 0.9em;">${stepIndex + 1}. ${step.instructions} (${step.distance.text})</p>`;
                });

                printContent += '</div>';
            });

            printContent += `
                    <div class="footer">
                        <p>ü¶© Generated by <strong>Traveling Birder</strong> on ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        <p>‚ö†Ô∏è Always verify sightings on <a href="https://ebird.org">eBird.org</a> before traveling. Bird presence is not guaranteed.</p>
                        <p>üìß Questions? travelingbirder@gmail.com</p>
                    </div>
                </body>
                </html>
            `;

            // Open print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // ============================================
        // UPDATE BELOW-MAP PANELS
        // ============================================
        function updateBelowMapPanels() {
            // Get current time range selection
            const timeRangeSelect = document.getElementById('timeRange');
            const timeRangeText = timeRangeSelect ? timeRangeSelect.options[timeRangeSelect.selectedIndex].text : 'Last 7 days';
            const filterType = document.getElementById('targetListType')?.value || 'life';
            const filterText = document.getElementById('targetListType')?.options[document.getElementById('targetListType').selectedIndex]?.text || 'Life List';
            
            // Update date range displays
            const dateRangeHtml = `üìÖ ${timeRangeText}`;
            document.getElementById('targetDateRange').innerHTML = `${dateRangeHtml} ‚Ä¢ Filter: ${filterText}`;
            document.getElementById('sightingsDateRange').innerHTML = dateRangeHtml;
            document.getElementById('statsDateRange').innerHTML = dateRangeHtml;
            
            // Update counts - use unique species counts
            const totalTargets = new Set(targetSpecies.map(obs => obs.comName)).size;
            const notableCount = new Set(notableTargets.map(obs => obs.comName)).size;
            
            document.getElementById('targetCount').textContent = totalTargets;
            document.getElementById('sightingsCount').textContent = new Set(allSightings.map(obs => obs.comName)).size;
            
            // Update Dashboard Tiles
            updateDashboardTiles();
            
            // Update lists stats panel
            updateListsStatsPanel();

            // Enhanced Target Species List with probabilities and eBird links
            const targetList = document.getElementById('targetList');
            if (targetSpecies.length === 0) {
                targetList.innerHTML = '<p style="color: var(--text-secondary);">No target species found in this area.</p>';
            } else {
                // Group targets by species and calculate stats
                const speciesStats = {};
                targetSpecies.forEach(obs => {
                    if (!speciesStats[obs.comName]) {
                        speciesStats[obs.comName] = {
                            species: obs.comName,
                            speciesCode: obs.speciesCode,
                            sightings: [],
                            locations: new Set(),
                            checklists: new Set(),
                            recentObs: obs
                        };
                    }
                    speciesStats[obs.comName].sightings.push(obs);
                    speciesStats[obs.comName].locations.add(obs.locName);
                    if (obs.subId) speciesStats[obs.comName].checklists.add(obs.subId);
                    // Keep most recent observation
                    if (new Date(obs.obsDt) > new Date(speciesStats[obs.comName].recentObs.obsDt)) {
                        speciesStats[obs.comName].recentObs = obs;
                    }
                });

                const sortedTargets = Object.values(speciesStats).sort((a, b) => {
                    // Sort by frequency first (expected targets on top), then by sighting count
                    const freqA = targetFrequencies.get(a.speciesCode) || 0;
                    const freqB = targetFrequencies.get(b.speciesCode) || 0;
                    if (freqB !== freqA) return freqB - freqA;
                    return b.sightings.length - a.sightings.length;
                });

                let html = '<div style="margin-bottom: 15px; padding: 10px; background: #f0fdf4; border-radius: 6px; border-left: 4px solid #10b981;">';
                html += `<p style="margin: 0; font-size: 0.9em; color: #065f46;"><strong>üìÖ Data Range:</strong> ${timeRangeText} | <strong>Filter:</strong> ${filterText}</p>`;
                html += '</div>';
                
                html += '<div style="display: grid; gap: 12px;">';
                sortedTargets.forEach(stats => {
                    const abaCode = getABARarityCode(stats.species);
                    const abaRarityText = ['', 'Common', 'Uncommon', 'Rare', 'Very Rare', 'Mega Rare', 'Extirpated'][abaCode] || '';
                    const frequency = targetFrequencies.get(stats.speciesCode);
                    const isNotable = notableTargets.some(n => n.speciesCode === stats.speciesCode);
                    
                    // Determine badge and color (simplified)
                    let badgeColor = '#ef4444';
                    let badgeText = 'TARGET';
                    if (isNotable) {
                        badgeColor = '#a855f7';
                        badgeText = 'NOTABLE';
                    }
                    
                    // Frequency bar
                    const freqPercent = frequency ? Math.round(frequency * 100) : 0;
                    const freqBar = frequency ? 
                        `<div style="margin: 8px 0;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.75em; color: var(--text-secondary); margin-bottom: 3px;">
                                <span>Probability</span>
                                <span style="font-weight: 600; color: #10b981;">${freqPercent}%</span>
                            </div>
                            <div style="background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: #10b981; height: 100%; width: ${freqPercent}%;"></div>
                            </div>
                        </div>` : '';
                    
                    // eBird species page link
                    const ebirdSpeciesLink = `https://ebird.org/species/${stats.speciesCode}`;
                    // Most recent checklist link
                    const checklistLink = stats.recentObs.subId ? `https://ebird.org/checklist/${stats.recentObs.subId}` : null;
                    
                    html += `
                        <div style="background: white; border: 2px solid ${badgeColor}; border-radius: 8px; padding: 14px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <h4 style="margin: 0; color: #065f46; font-size: 1.05em; flex: 1;">${stats.species}</h4>
                                <div style="background: ${badgeColor}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.7em; font-weight: 600; white-space: nowrap; margin-left: 8px;">
                                    ${badgeText}
                                </div>
                            </div>
                            ${freqBar}
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 8px 0; padding: 8px; background: #f9fafb; border-radius: 4px;">
                                <div>
                                    <div style="font-size: 0.7em; color: var(--text-secondary); margin-bottom: 2px;">SIGHTINGS</div>
                                    <div style="font-size: 1.1em; font-weight: 600; color: #10b981;">${stats.sightings.length}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.7em; color: var(--text-secondary); margin-bottom: 2px;">LOCATIONS</div>
                                    <div style="font-size: 1.1em; font-weight: 600; color: #3b82f6;">${stats.locations.size}</div>
                                </div>
                            </div>
                            <p style="margin: 6px 0 3px 0; font-size: 0.75em; color: var(--text-secondary);">ABA Code ${abaCode} (${abaRarityText})</p>
                            <p style="margin: 3px 0; font-size: 0.8em; color: var(--text-secondary);">üìç Most recent: ${stats.recentObs.locName}</p>
                            <p style="margin: 3px 0; font-size: 0.8em; color: var(--text-secondary);">üìÖ ${stats.recentObs.obsDt}</p>
                            
                            <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
                                <button onclick="highlightSpeciesOnMap('${stats.species.replace(/'/g, "\\'")}')" 
                                        style="flex: 1; min-width: 120px; background: #10b981; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600;">
                                    üó∫Ô∏è Show on Map
                                </button>
                                <a href="${ebirdSpeciesLink}" target="_blank" 
                                   style="flex: 1; min-width: 120px; background: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; text-decoration: none; text-align: center;">
                                    üîó eBird Page
                                </a>
                                ${checklistLink ? `
                                <a href="${checklistLink}" target="_blank" 
                                   style="flex: 1; min-width: 120px; background: #8b5cf6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; text-decoration: none; text-align: center;">
                                    üìã View Checklist
                                </a>` : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                targetList.innerHTML = html;
            }

            // Sightings Summary - simple species list
            const sightingsList = document.getElementById('sightingsList');
            const speciesInArea = new Set(allSightings.map(obs => obs.comName));
            const speciesList = Array.from(speciesInArea).sort();

            let sightingsHtml = `
                <div style="margin-bottom: 12px; padding: 10px; background: #f0fdf4; border-radius: 6px; border-left: 4px solid #10b981;">
                    <p style="margin: 0; font-size: 0.85em; color: #065f46;"><strong>üìÖ ${timeRangeText}</strong> ‚Ä¢ ${speciesList.length} species reported</p>
                </div>
            `;
            
            speciesList.forEach(species => {
                const isTarget = !userList.has(species);
                const targetBadge = isTarget ? '<span style="background: #ef4444; color: white; padding: 1px 6px; border-radius: 3px; font-size: 0.7em; margin-left: 8px;">TARGET</span>' : '';
                const seenBadge = !isTarget ? '<span style="color: #10b981; margin-left: 8px;">‚úì</span>' : '';
                
                sightingsHtml += `
                    <div style="padding: 8px 12px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center;">
                        <span>${species}${targetBadge}${seenBadge}</span>
                    </div>
                `;
            });
            
            if (speciesList.length === 0) {
                sightingsHtml += '<p style="color: var(--text-secondary); padding: 10px;">No sightings found.</p>';
            }
            
            sightingsList.innerHTML = sightingsHtml;

            // Stats Display
            const statsDisplay = document.getElementById('statsDisplay');
            const userSpeciesInArea = allSightings.filter(obs => userList.has(obs.comName));
            const uniqueUserSpecies = new Set(userSpeciesInArea.map(obs => obs.comName));
            const uniqueTotalSpecies = new Set(allSightings.map(obs => obs.comName));
            const percentage = uniqueTotalSpecies.size > 0 
                ? Math.round((uniqueUserSpecies.size / uniqueTotalSpecies.size) * 100)
                : 0;

            statsDisplay.innerHTML = `
                <div style="margin-bottom: 12px; padding: 10px; background: #f0fdf4; border-radius: 6px; border-left: 4px solid #10b981;">
                    <p style="margin: 0; font-size: 0.85em; color: #065f46;"><strong>üìÖ Data Range:</strong> ${timeRangeText}</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 8px;">
                        <div style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 5px;">YOUR SPECIES</div>
                        <div style="font-size: 2em; font-weight: bold; color: #10b981;">${uniqueUserSpecies.size}</div>
                        <div style="font-size: 0.75em; color: var(--text-secondary);">seen in area</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f9fafb; border-radius: 8px;">
                        <div style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 5px;">REPORTED RECENTLY</div>
                        <div style="font-size: 2em; font-weight: bold; color: var(--text-primary);">${uniqueTotalSpecies.size}</div>
                        <div style="font-size: 0.75em; color: var(--text-secondary);">${timeRangeText.toLowerCase()}</div>
                    </div>
                </div>
                ${lastSearchedRegionCode && regionStatsCache[lastSearchedRegionCode] ? `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                        <div style="text-align: center; padding: 15px; background: #ede9fe; border-radius: 8px;">
                            <div style="font-size: 0.8em; color: #5b21b6; margin-bottom: 5px;">REGION ALL-TIME</div>
                            <div style="font-size: 2em; font-weight: bold; color: #7c3aed;">${regionStatsCache[lastSearchedRegionCode].allTimeCount}</div>
                            <div style="font-size: 0.75em; color: #5b21b6;">ever recorded</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 8px;">
                            <div style="font-size: 0.8em; color: #065f46; margin-bottom: 5px;">YOUR PROGRESS</div>
                            <div style="font-size: 2em; font-weight: bold; color: #10b981;">${Math.round((uniqueUserSpecies.size / regionStatsCache[lastSearchedRegionCode].allTimeCount) * 100)}%</div>
                            <div style="font-size: 0.75em; color: #065f46;">of region</div>
                        </div>
                    </div>
                ` : ''}
                <div style="text-align: center; padding: 12px; background: #fef3c7; border-radius: 8px; margin-bottom: 15px;">
                    <span style="font-weight: 600; color: #92400e;">You've seen ${percentage}% of species reported recently</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div style="text-align: center; padding: 12px; background: #fef2f2; border-radius: 8px;">
                        <div style="font-size: 0.75em; color: #991b1b; margin-bottom: 3px;">TARGETS</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #ef4444;">${totalTargets}</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: #f3e8ff; border-radius: 8px;">
                        <div style="font-size: 0.75em; color: #6b21a8; margin-bottom: 3px;">NOTABLE</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #a855f7;">${notableCount}</div>
                    </div>
                </div>
            `;
        }
        
        // Dashboard Tiles
        function updateDashboardTiles() {
            const container = document.getElementById('dashboardTiles');
            if (!container) return;
            
            loadAllBirdLists();
            
            // Get counts
            const worldList = allBirdLists['world'];
            const worldCount = worldList ? worldList.count : 0;
            
            // Active list count
            const activeList = getTargetList();
            const activeCount = activeList.size;
            const activeListName = document.getElementById('targetListType')?.options[document.getElementById('targetListType').selectedIndex]?.text.replace(' Targets Only', '').replace(' Only', '') || 'Life';
            
            // Get unique species in current search
            const uniqueInArea = new Set(allSightings.map(obs => obs.comName)).size;
            
            // Target count - use unique species, not raw observations
            const targetCount = new Set(targetSpecies.map(obs => obs.comName)).size;
            
            // Region all-time count
            const regionAllTime = (lastSearchedRegionCode && regionStatsCache[lastSearchedRegionCode]) 
                ? regionStatsCache[lastSearchedRegionCode].allTimeCount : 0;
            
            // Get time range text
            const timeRangeSelect = document.getElementById('timeRange');
            const timeRangeText = timeRangeSelect ? timeRangeSelect.options[timeRangeSelect.selectedIndex].text : 'Last 7 days';
            
            let html = `
                <!-- Your List (Active Filter) -->
                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(16,185,129,0.3);">
                    <div style="font-size: 0.7em; opacity: 0.9; margin-bottom: 4px;">üìã YOUR LIST</div>
                    <div style="font-size: 2em; font-weight: bold;">${activeCount}</div>
                    <div style="font-size: 0.75em; opacity: 0.8;">${activeListName}</div>
                </div>
                
                <!-- Reported Recently -->
                <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(59,130,246,0.3);">
                    <div style="font-size: 0.7em; opacity: 0.9; margin-bottom: 4px;">üìç REPORTED</div>
                    <div style="font-size: 2em; font-weight: bold;">${uniqueInArea}</div>
                    <div style="font-size: 0.75em; opacity: 0.8;">${timeRangeText.toLowerCase()}</div>
                </div>
                
                <!-- Targets -->
                <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(239,68,68,0.3);">
                    <div style="font-size: 0.7em; opacity: 0.9; margin-bottom: 4px;">üéØ TARGETS</div>
                    <div style="font-size: 2em; font-weight: bold;">${targetCount}</div>
                    <div style="font-size: 0.75em; opacity: 0.8;">to find</div>
                </div>
            `;
            
            // Add region all-time tile if available
            if (regionAllTime > 0) {
                html += `
                    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(139,92,246,0.3);">
                        <div style="font-size: 0.7em; opacity: 0.9; margin-bottom: 4px;">üìà REGION TOTAL</div>
                        <div style="font-size: 2em; font-weight: bold;">${regionAllTime}</div>
                        <div style="font-size: 0.75em; opacity: 0.8;">all-time</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // ============================================
        // REGION EBIRD STATS (All-time, Year, Month)
        // ============================================
        let lastSearchedRegionCode = null;
        let regionStatsCache = {};
        
        async function fetchRegionEBirdStats(regionCode) {
            if (!regionCode || !userApiKey) return;
            
            lastSearchedRegionCode = regionCode;
            const display = document.getElementById('regionStatsDisplay');
            const summaryCount = document.getElementById('regionAllTimeCount');
            
            if (!display) return;
            
            // Check cache
            if (regionStatsCache[regionCode]) {
                displayRegionStats(regionStatsCache[regionCode]);
                return;
            }
            
            display.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">üîÑ</div>
                    <p style="color: var(--text-secondary);">Loading eBird statistics for ${regionCode}...</p>
                </div>
            `;
            
            try {
                // Fetch all species ever recorded in the region
                const allTimeUrl = `https://api.ebird.org/v2/product/spplist/${regionCode}`;
                const allTimeResponse = await fetch(allTimeUrl, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });
                
                let allTimeCount = 0;
                if (allTimeResponse.ok) {
                    const allTimeData = await allTimeResponse.json();
                    allTimeCount = allTimeData.length;
                }
                
                // Get current year and month
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                
                // Fetch this year's species (using recent obs, estimate based on last 30 days extrapolated)
                // eBird doesn't have a direct "year species" endpoint, so we'll show what we can
                
                // Fetch checklist stats for region (for context)
                let regionName = regionCode;
                try {
                    const regionInfoUrl = `https://api.ebird.org/v2/ref/region/info/${regionCode}`;
                    const regionInfoResponse = await fetch(regionInfoUrl, {
                        headers: { 'X-eBirdApiToken': userApiKey }
                    });
                    if (regionInfoResponse.ok) {
                        const regionInfo = await regionInfoResponse.json();
                        regionName = regionInfo.result || regionCode;
                    }
                } catch (e) {
                    // Keep regionCode as name
                }
                
                // Store in cache
                const stats = {
                    regionCode,
                    regionName,
                    allTimeCount,
                    currentYear,
                    currentMonth,
                    monthName: monthNames[currentMonth]
                };
                
                regionStatsCache[regionCode] = stats;
                displayRegionStats(stats);
                
            } catch (error) {
                console.error('Error fetching region stats:', error);
                display.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <p style="color: #ef4444;">Error loading region statistics</p>
                        <p style="color: var(--text-secondary); font-size: 0.85em;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        function displayRegionStats(stats) {
            // Just update dashboard tiles and refresh the area stats
            // The region stats are now shown inline in the Area Statistics panel
            updateDashboardTiles();
            updateBelowMapPanels();
        }

        // ============================================
        // PANEL TOGGLES
        // ============================================
        function showBelowMapPanels() {
            const belowMap = document.getElementById('belowMap');
            if (belowMap) {
                belowMap.style.display = 'block';
            }
            // Show search-specific panels
            const dashboardTiles = document.getElementById('dashboardTiles');
            const reportButtons = document.getElementById('reportButtonsRow');
            const targetPanel = document.getElementById('targetPanelWrapper');
            const sightingsPanel = document.getElementById('sightingsPanelWrapper');
            const statsPanel = document.getElementById('statsPanelWrapper');
            
            if (dashboardTiles) dashboardTiles.style.display = 'grid';
            if (reportButtons) reportButtons.style.display = 'block';
            if (targetPanel) targetPanel.style.display = 'block';
            if (sightingsPanel) sightingsPanel.style.display = 'block';
            if (statsPanel) statsPanel.style.display = 'block';
        }
        
        function hideSearchPanels() {
            const dashboardTiles = document.getElementById('dashboardTiles');
            const reportButtons = document.getElementById('reportButtonsRow');
            const targetPanel = document.getElementById('targetPanelWrapper');
            const sightingsPanel = document.getElementById('sightingsPanelWrapper');
            const statsPanel = document.getElementById('statsPanelWrapper');
            
            if (dashboardTiles) dashboardTiles.style.display = 'none';
            if (reportButtons) reportButtons.style.display = 'none';
            if (targetPanel) targetPanel.style.display = 'none';
            if (sightingsPanel) sightingsPanel.style.display = 'none';
            if (statsPanel) statsPanel.style.display = 'none';
        }

        function togglePanel(panelId) {
            const content = document.getElementById(panelId + 'Content');
            const toggle = document.getElementById(panelId + 'Toggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.textContent = '+';
            } else {
                content.classList.add('expanded');
                toggle.textContent = '‚àí';
            }
        }

        function toggleLegend() {
            const content = document.getElementById('legendContent');
            const toggle = document.getElementById('legendToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚àí';
            } else {
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }

        function toggleQuickStart() {
            const modal = document.getElementById('quickStartModal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
            }
        }

        // ============================================
        // LAYER TOGGLES
        // ============================================
        function toggleHotspots() {
            if (document.getElementById('showHotspots').checked) {
                displayHotspots();
            } else {
                clearHotspots();
            }
        }

        function toggleChecklists() {
            if (document.getElementById('showChecklists').checked) {
                displayChecklists();
            } else {
                clearChecklists();
            }
        }

        // ============================================
        // SEARCH SPECIFIC SPECIES
        // ============================================
        async function searchSpecies() {
            const speciesName = document.getElementById('speciesSearch').value.trim();
            const location = document.getElementById('speciesLocation').value.trim();

            if (!speciesName) {
                alert('Please enter a species name');
                return;
            }
            
            // Check if eBird is connected for API access
            if (!userApiKey) {
                alert('Please connect to eBird first to search for species');
                return;
            }

            // Track species search
            if (typeof gtag === 'function') {
                gtag('event', 'search', {
                    search_term: speciesName,
                    event_category: 'species_search'
                });
            }

            console.log(`üîç Searching for ${speciesName} near ${location || 'current area'}`);
            showLoading('Searching for species...');

            try {
                let lat, lng;
                
                if (location && speciesLocationAutocomplete && speciesLocationAutocomplete.getPlace()) {
                    const place = speciesLocationAutocomplete.getPlace();
                    if (place.geometry) {
                        lat = place.geometry.location.lat();
                        lng = place.geometry.location.lng();
                    }
                } else if (map) {
                    const center = map.getCenter();
                    lat = center.lat();
                    lng = center.lng();
                }

                // Use species-specific radius and time range
                const radiusMiles = parseInt(document.getElementById('speciesSearchRadius').value) || 25;
                const radiusKm = validateAndConvertRadius(radiusMiles);
                const timeRange = parseInt(document.getElementById('speciesTimeRange').value) || 30;
                
                console.log(`üìç Searching within ${radiusMiles} miles, last ${timeRange} days`);

                const url = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=${timeRange}`;
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });

                if (!response.ok) {
                    throw new Error('Search failed');
                }

                const observations = await response.json();
                const matchingObs = observations.filter(obs => 
                    obs.comName.toLowerCase().includes(speciesName.toLowerCase())
                );

                if (matchingObs.length === 0) {
                    hideLoading();
                    alert(`No recent sightings of "${speciesName}" found in this area in the last ${timeRange} days within ${radiusMiles} miles.`);
                    return;
                }

                // Clear current markers and display search results
                clearMarkers();
                allSightings = matchingObs;
                targetSpecies = matchingObs.filter(obs => userList.has && !userList.has(obs.comName));
                
                displayBirds();
                
                // Zoom to first result
                if (matchingObs[0]) {
                    map.setCenter({ lat: matchingObs[0].lat, lng: matchingObs[0].lng });
                    map.setZoom(12);
                }

                hideLoading();
                console.log(`‚úÖ Found ${matchingObs.length} sightings of ${speciesName}`);

            } catch (error) {
                hideLoading();
                console.error('Error searching species:', error);
                logBirderError('species_search', 'Species search failed', { error: error.message, species: speciesName });
                alert('Error searching for species. Please try again.');
            }
        }

        // ============================================
        // TOP EBIRDERS FUNCTIONALITY
        // ============================================
        
        let currentTopEBirdersRegion = null;
        let topEBirdersData = [];
        
        // Common eBird regions for dropdown
        const ebirdRegions = [
            // US States
            { name: 'Alabama', code: 'US-AL' },
            { name: 'Alaska', code: 'US-AK' },
            { name: 'Arizona', code: 'US-AZ' },
            { name: 'Arkansas', code: 'US-AR' },
            { name: 'California', code: 'US-CA' },
            { name: 'Colorado', code: 'US-CO' },
            { name: 'Connecticut', code: 'US-CT' },
            { name: 'Delaware', code: 'US-DE' },
            { name: 'Florida', code: 'US-FL' },
            { name: 'Georgia', code: 'US-GA' },
            { name: 'Hawaii', code: 'US-HI' },
            { name: 'Idaho', code: 'US-ID' },
            { name: 'Illinois', code: 'US-IL' },
            { name: 'Indiana', code: 'US-IN' },
            { name: 'Iowa', code: 'US-IA' },
            { name: 'Kansas', code: 'US-KS' },
            { name: 'Kentucky', code: 'US-KY' },
            { name: 'Louisiana', code: 'US-LA' },
            { name: 'Maine', code: 'US-ME' },
            { name: 'Maryland', code: 'US-MD' },
            { name: 'Massachusetts', code: 'US-MA' },
            { name: 'Michigan', code: 'US-MI' },
            { name: 'Minnesota', code: 'US-MN' },
            { name: 'Mississippi', code: 'US-MS' },
            { name: 'Missouri', code: 'US-MO' },
            { name: 'Montana', code: 'US-MT' },
            { name: 'Nebraska', code: 'US-NE' },
            { name: 'Nevada', code: 'US-NV' },
            { name: 'New Hampshire', code: 'US-NH' },
            { name: 'New Jersey', code: 'US-NJ' },
            { name: 'New Mexico', code: 'US-NM' },
            { name: 'New York', code: 'US-NY' },
            { name: 'North Carolina', code: 'US-NC' },
            { name: 'North Dakota', code: 'US-ND' },
            { name: 'Ohio', code: 'US-OH' },
            { name: 'Oklahoma', code: 'US-OK' },
            { name: 'Oregon', code: 'US-OR' },
            { name: 'Pennsylvania', code: 'US-PA' },
            { name: 'Rhode Island', code: 'US-RI' },
            { name: 'South Carolina', code: 'US-SC' },
            { name: 'South Dakota', code: 'US-SD' },
            { name: 'Tennessee', code: 'US-TN' },
            { name: 'Texas', code: 'US-TX' },
            { name: 'Utah', code: 'US-UT' },
            { name: 'Vermont', code: 'US-VT' },
            { name: 'Virginia', code: 'US-VA' },
            { name: 'Washington', code: 'US-WA' },
            { name: 'West Virginia', code: 'US-WV' },
            { name: 'Wisconsin', code: 'US-WI' },
            { name: 'Wyoming', code: 'US-WY' }
        ];
        
        // Populate regions datalist
        function populateRegionsDatalist() {
            const datalist = document.getElementById('regionsList');
            if (!datalist) return;
            
            datalist.innerHTML = ebirdRegions.map(region => 
                `<option value="${region.code}">${region.name} (${region.code})</option>`
            ).join('');
        }
        
        // Call on page load
        window.addEventListener('DOMContentLoaded', populateRegionsDatalist);
        
        
        // Simple function to update Top eBirders panel with eBird links
        function updateTopEBirdersPanel(regionCode, regionName) {
            const display = document.getElementById('topEBirdersDisplay');
            const summary = document.getElementById('topEBirdersSummary');
            
            if (!display) return;
            
            if (!regionCode) {
                display.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 10px;">
                        Search a region to see Top 100 link
                    </div>
                `;
                if (summary) summary.textContent = 'View rankings on eBird';
                return;
            }
            
            const displayName = regionName || regionCode;
            const currentYear = new Date().getFullYear();
            
            // Build eBird Top 100 URLs
            const lifetimeUrl = `https://ebird.org/top100?locInfo.regionCode=${regionCode}&rankedBy=spp`;
            const yearUrl = `https://ebird.org/top100?locInfo.regionCode=${regionCode}&rankedBy=spp&year=${currentYear}`;
            const checklistsUrl = `https://ebird.org/top100?locInfo.regionCode=${regionCode}&rankedBy=cl`;
            
            if (summary) summary.textContent = displayName;
            
            display.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 1.1em; font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">
                        üèÜ ${displayName}
                    </div>
                    <div style="font-size: 0.85em; color: var(--text-secondary);">
                        View official eBird rankings
                    </div>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Lifetime Species -->
                    <a href="${lifetimeUrl}" target="_blank" 
                       style="display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 8px; text-decoration: none; font-weight: 600;">
                        <span>üåç All-Time Species</span>
                        <span style="opacity: 0.9;">View ‚Üí</span>
                    </a>
                    
                    <!-- Current Year Species -->
                    <a href="${yearUrl}" target="_blank" 
                       style="display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-radius: 8px; text-decoration: none; font-weight: 600;">
                        <span>üìÖ ${currentYear} Year List</span>
                        <span style="opacity: 0.9;">View ‚Üí</span>
                    </a>
                    
                    <!-- Checklists -->
                    <a href="${checklistsUrl}" target="_blank" 
                       style="display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border-radius: 8px; text-decoration: none; font-weight: 600;">
                        <span>üìã Most Checklists</span>
                        <span style="opacity: 0.9;">View ‚Üí</span>
                    </a>
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: #f0fdf4; border-radius: 8px; border: 1px solid #10b981;">
                    <div style="font-size: 0.85em; color: #065f46;">
                        <strong>üí° Tip:</strong> eBird's Top 100 shows lifetime and year rankings for all birders in any region - country, state, or county.
                    </div>
                </div>
            `;
        }
        
        // Auto-update panel when region is searched
        async function autoLoadTopEBirdersForRegion(regionCode) {
            if (!regionCode) return;
            
            // Get region name
            let regionName = regionCode;
            try {
                const infoUrl = `https://api.ebird.org/v2/ref/region/info/${regionCode}`;
                const infoResp = await fetch(infoUrl, { headers: { 'X-eBirdApiToken': userApiKey } });
                if (infoResp.ok) {
                    const info = await infoResp.json();
                    regionName = info.result || regionCode;
                }
            } catch (e) {}
            
            updateTopEBirdersPanel(regionCode, regionName);
        }

        // ============================================
        // MARKER MANAGEMENT
        // ============================================
        function clearMarkers() {
            markersArray.forEach(marker => marker.setMap(null));
            markersArray = [];
        }

        function clearHotspots() {
            hotspotsArray.forEach(marker => marker.setMap(null));
            hotspotsArray = [];
        }

        // ============================================
        // RESET ALL
        // ============================================
        function resetAll() {
            // Clear route
            if (directionsRenderer) {
                directionsRenderer.setDirections({ routes: [] });
            }
            currentRoute = null;
            tripWaypoints = [];
            routeDuration = '';

            // Clear markers
            clearMarkers();
            clearHotspots();
            clearChecklists();

            // Clear data
            allSightings = [];
            allHotspots = [];
            allChecklists = [];
            targetSpecies = [];

            // Reset UI
            document.getElementById('originInput').value = '';
            document.getElementById('destinationInput').value = '';
            document.getElementById('routeDuration').classList.add('hidden');
            document.getElementById('printBtn').classList.add('hidden');
            document.getElementById('navBtn').classList.add('hidden');
            // Don't hide belowMap entirely - just hide search-specific panels
            hideSearchPanels();
            document.getElementById('waypointList').innerHTML = '';

            // Reset map view
            if (map) {
                map.setCenter({ lat: 39.8283, lng: -98.5795 });
                map.setZoom(4);
            }

            console.log('üîÑ Reset complete');
        }

        // ============================================
        // WELCOME OVERLAY MANAGEMENT
        // ============================================
        
        function showWelcomeOverlay() {
            const overlay = document.getElementById('welcomeOverlay');
            if (overlay) {
                overlay.classList.remove('hidden');
                updateWelcomeSteps();
            }
        }
        
        function closeWelcomeOverlay() {
            const overlay = document.getElementById('welcomeOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
            // Mark as completed
            localStorage.setItem('travelingBirder_welcomeCompleted', 'true');
        }
        
        function skipWelcome() {
            closeWelcomeOverlay();
            // Show a reminder that features are limited
            setTimeout(() => {
                alert('Note: Without connecting to eBird and uploading your life list, you won\'t be able to filter for target species.\n\nYou can complete setup anytime by clicking "Get Started" or going to Menu > Import Life List CSV.');
            }, 500);
        }
        
        function updateWelcomeSteps() {
            const step1 = document.getElementById('welcomeStep1');
            const step2 = document.getElementById('welcomeStep2');
            const step1Num = document.getElementById('welcomeStep1Num');
            const step2Num = document.getElementById('welcomeStep2Num');
            const uploadBtn = document.getElementById('welcomeUploadBtn');
            const footer = document.getElementById('welcomeFooter');
            const existingDataBox = document.getElementById('existingDataBox');
            const uploadInstructions = document.getElementById('uploadInstructions');
            
            if (!step1 || !step2) return; // Guard against missing elements
            
            const apiConnected = ebirdAuthenticated && userApiKey;
            const csvUploaded = userList && userList.size > 0;
            
            // Update Step 1
            if (apiConnected) {
                step1.classList.remove('active');
                step1.classList.add('completed');
                step1Num.innerHTML = '‚úì';
            } else {
                step1.classList.add('active');
                step1.classList.remove('completed');
                step1Num.innerHTML = '1';
            }
            
            // Update Step 2 - use classList for label (not disabled attribute)
            if (apiConnected) {
                step2.classList.remove('disabled');
                if (uploadBtn) {
                    uploadBtn.classList.remove('disabled');
                    uploadBtn.style.pointerEvents = 'auto';
                    uploadBtn.style.opacity = '1';
                }
                
                if (csvUploaded) {
                    step2.classList.remove('active');
                    step2.classList.add('completed');
                    step2Num.innerHTML = '‚úì';
                    
                    // Show existing data info
                    if (existingDataBox && uploadInstructions) {
                        existingDataBox.style.display = 'block';
                        uploadInstructions.style.display = 'none';
                        
                        // Populate the data
                        const lifeCount = document.getElementById('existingLifeCount');
                        const yearCount = document.getElementById('existingYearCount');
                        const lastUpdate = document.getElementById('existingLastUpdate');
                        
                        if (lifeCount) lifeCount.textContent = userList.size + ' species';
                        if (yearCount) yearCount.textContent = (window.userYearList ? window.userYearList.size : '‚Äî') + ' species';
                        
                        if (lastUpdate) {
                            const savedDate = localStorage.getItem('travelingBirder_lastUpdate');
                            if (savedDate) {
                                const date = new Date(savedDate);
                                lastUpdate.textContent = date.toLocaleDateString('en-US', { 
                                    weekday: 'short',
                                    month: 'short', 
                                    day: 'numeric', 
                                    year: 'numeric' 
                                });
                            } else {
                                lastUpdate.textContent = 'Unknown';
                            }
                        }
                    }
                } else {
                    step2.classList.add('active');
                    step2.classList.remove('completed');
                    step2Num.innerHTML = '2';
                    
                    // Show upload instructions
                    if (existingDataBox && uploadInstructions) {
                        existingDataBox.style.display = 'none';
                        uploadInstructions.style.display = 'block';
                    }
                }
            }
            
            // Show footer if both complete
            if (apiConnected && csvUploaded) {
                footer.style.display = 'block';
            } else {
                footer.style.display = 'none';
            }
        }
        
        function showUploadInstructions() {
            const existingDataBox = document.getElementById('existingDataBox');
            const uploadInstructions = document.getElementById('uploadInstructions');
            
            if (existingDataBox) existingDataBox.style.display = 'none';
            if (uploadInstructions) uploadInstructions.style.display = 'block';
        }
        
        async function connectFromWelcome() {
            const apiKeyInput = document.getElementById('welcomeApiKey');
            const statusEl = document.getElementById('step1Status');
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                statusEl.className = 'step-status error';
                statusEl.textContent = '‚ùå Please paste your API key';
                return;
            }
            
            statusEl.className = 'step-status loading';
            statusEl.textContent = '‚è≥ Connecting to eBird...';
            
            try {
                const response = await fetch(
                    `https://api.ebird.org/v2/data/obs/US/recent?maxResults=5`,
                    { headers: { 'X-eBirdApiToken': apiKey } }
                );
                
                if (!response.ok) {
                    throw new Error('Invalid API key');
                }
                
                // Success!
                userApiKey = apiKey;
                ebirdAuthenticated = true;
                
                // Save to localStorage
                localStorage.setItem('travelingBirder_apiKey', apiKey);
                
                statusEl.className = 'step-status success';
                statusEl.textContent = '‚úÖ Connected successfully!';
                
                // Update the welcome steps
                updateWelcomeSteps();
                
                // Also update header
                updateHeaderStatus();
                
                console.log('‚úÖ Connected to eBird from welcome overlay');
                
                // Auto-update life list with recent observations
                await updateLifeListFromAPI();
                
            } catch (error) {
                console.error('Connection error:', error);
                statusEl.className = 'step-status error';
                statusEl.textContent = '‚ùå Invalid API key. Please check and try again.';
            }
        }
        
        // Tab switching for welcome upload options
        function showUploadTab(tab) {
            const zipTab = document.getElementById('zipUploadTab');
            const csvTab = document.getElementById('csvUploadTab');
            const zipBtn = document.getElementById('tabZipBtn');
            const csvBtn = document.getElementById('tabCsvBtn');
            
            if (tab === 'zip') {
                zipTab.style.display = 'block';
                csvTab.style.display = 'none';
                zipBtn.style.background = '#10b981';
                zipBtn.style.color = 'white';
                csvBtn.style.background = '#e5e7eb';
                csvBtn.style.color = '#374151';
            } else {
                zipTab.style.display = 'none';
                csvTab.style.display = 'block';
                zipBtn.style.background = '#e5e7eb';
                zipBtn.style.color = '#374151';
                csvBtn.style.background = '#10b981';
                csvBtn.style.color = 'white';
            }
        }
        
        // ZIP upload from welcome screen
        async function uploadZipFromWelcome(input) {
            const file = input.files[0];
            const statusEl = document.getElementById('welcomeZipStatus');
            const step2Status = document.getElementById('step2Status');
            
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.zip')) {
                statusEl.innerHTML = '<div style="color: #dc2626;">‚ùå Please select a ZIP file</div>';
                return;
            }
            
            statusEl.innerHTML = '<div style="color: #2563eb;">üì¶ Reading ZIP file...</div>';
            
            try {
                const zip = await JSZip.loadAsync(file);
                
                // Find the main CSV file
                let mainCsvFile = null;
                let mainCsvName = null;
                const csvPatterns = ['MyEBirdData', 'ebird_', 'observations', 'data'];
                
                for (const [filename, zipEntry] of Object.entries(zip.files)) {
                    if (filename.toLowerCase().endsWith('.csv') && !zipEntry.dir) {
                        const lowerName = filename.toLowerCase();
                        if (csvPatterns.some(p => lowerName.includes(p.toLowerCase())) || !mainCsvFile) {
                            mainCsvFile = zipEntry;
                            mainCsvName = filename;
                        }
                    }
                }
                
                if (!mainCsvFile) {
                    statusEl.innerHTML = '<div style="color: #dc2626;">‚ùå No CSV file found in ZIP</div>';
                    return;
                }
                
                statusEl.innerHTML = `<div style="color: #2563eb;">üìÑ Processing ${mainCsvName}...</div>`;
                
                // Extract and parse the CSV
                const csvContent = await mainCsvFile.async('string');
                const result = await parseEBirdDataCSV(csvContent);
                
                statusEl.innerHTML = `<div style="color: #2563eb;">üîÑ Creating lists from ${result.totalObservations.toLocaleString()} observations...</div>`;
                
                // Store as World Life List
                allBirdLists['world'] = {
                    type: 'world',
                    code: 'world',
                    name: 'World Life List',
                    species: result.species,
                    speciesWithDates: result.speciesWithDates,
                    count: result.species.length,
                    uploadDate: new Date().toISOString(),
                    fileName: file.name,
                    source: 'eBird ZIP export',
                    byCountry: result.byCountry,
                    byState: result.byState
                };
                
                saveAllBirdLists();
                saveLifeList(result.species, 'zip');
                userList = new Set(result.species);
                
                // Auto-generate regional lists
                let regionalListsCreated = 0;
                
                for (const [countryCode, countryData] of Object.entries(result.byCountry)) {
                    if (countryData.species.length >= 10) {
                        const listKey = `country_${countryCode}`;
                        allBirdLists[listKey] = {
                            type: 'country',
                            code: listKey,
                            name: countryData.name || countryCode,
                            species: countryData.species,
                            speciesWithDates: countryData.speciesWithDates,
                            count: countryData.species.length,
                            uploadDate: new Date().toISOString(),
                            source: 'auto-generated from ZIP'
                        };
                        regionalListsCreated++;
                    }
                }
                
                const sortedStates = Object.entries(result.byState)
                    .sort((a, b) => b[1].species.length - a[1].species.length)
                    .slice(0, 10);
                    
                for (const [stateCode, stateData] of sortedStates) {
                    if (stateData.species.length >= 10) {
                        const listKey = stateCode.replace('-', '_');
                        allBirdLists[listKey] = {
                            type: 'state',
                            code: listKey,
                            name: stateData.name || stateCode,
                            species: stateData.species,
                            speciesWithDates: stateData.speciesWithDates,
                            count: stateData.species.length,
                            uploadDate: new Date().toISOString(),
                            source: 'auto-generated from ZIP'
                        };
                        regionalListsCreated++;
                    }
                }
                
                saveAllBirdLists();
                updateTargetListOptions();
                updateHeaderWithLifeList();
                updateListsStatsPanel();
                
                // Show success in welcome screen
                statusEl.innerHTML = `
                    <div style="background: #d1fae5; padding: 12px; border-radius: 6px; border: 1px solid #10b981; margin-top: 10px;">
                        <div style="color: #065f46; font-weight: 600; margin-bottom: 6px;">‚úÖ Import Successful!</div>
                        <div style="color: #047857; font-size: 0.85em;">
                            üåç <strong>${result.species.length}</strong> species with dates<br>
                            üó∫Ô∏è <strong>${regionalListsCreated}</strong> regional lists auto-created
                        </div>
                    </div>
                `;
                
                // Also update step2 status
                if (step2Status) {
                    step2Status.className = 'step-status success';
                    step2Status.textContent = `‚úÖ ${result.species.length} species imported with full date data!`;
                }
                
                // Show the footer to continue
                const footer = document.getElementById('welcomeFooter');
                if (footer) {
                    footer.style.display = 'block';
                }
                
                // Mark step 2 as complete
                const step2 = document.getElementById('welcomeStep2');
                if (step2) {
                    step2.classList.add('completed');
                }
                
            } catch (error) {
                console.error('ZIP import error:', error);
                statusEl.innerHTML = `<div style="color: #dc2626;">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function uploadFromWelcome(input) {
            console.log('üìÇ Upload triggered');
            const file = input.files[0];
            const statusEl = document.getElementById('step2Status');
            
            if (!file) {
                console.log('‚ùå No file selected');
                return;
            }
            
            console.log(`üìÑ File selected: ${file.name}, size: ${file.size} bytes, type: ${file.type}`);
            
            statusEl.className = 'step-status loading';
            statusEl.textContent = '‚è≥ Processing your life list...';
            
            // Use FileReader for better mobile compatibility
            const reader = new FileReader();
            
            reader.onload = function(e) {
                console.log('üìñ File read successfully');
                const csvText = e.target.result;
                
                Papa.parse(csvText, {
                    complete: function(results) {
                        console.log(`üìä Parsed ${results.data.length} rows`);
                        try {
                            const data = results.data;
                            if (data.length < 2) {
                                statusEl.className = 'step-status error';
                                statusEl.textContent = '‚ùå CSV file appears to be empty';
                                return;
                            }
                            
                            // Find column indices
                            const headers = data[0].map(h => (h || '').toLowerCase().trim());
                            console.log('üìã Headers:', headers);
                            const nameIndex = headers.findIndex(h => h.includes('common name') || h === 'species');
                            const dateIndex = headers.findIndex(h => h === 'date');
                            
                            if (nameIndex === -1) {
                                statusEl.className = 'step-status error';
                                statusEl.textContent = '‚ùå Could not find "Common Name" column. Make sure this is an eBird life list CSV.';
                                return;
                            }
                            
                            // Parse species with dates
                            const speciesData = new Map();
                            const currentYear = new Date().getFullYear();
                            const currentMonth = new Date().getMonth();
                            
                            for (let i = 1; i < data.length; i++) {
                                const row = data[i];
                                if (!row || !row[nameIndex]) continue;
                                
                                const speciesName = row[nameIndex].trim();
                                if (!speciesName) continue;
                                
                                const dateStr = dateIndex !== -1 ? row[dateIndex] : null;
                                const lastSeenDate = dateStr ? new Date(dateStr) : null;
                                
                                if (!speciesData.has(speciesName) || (lastSeenDate && (!speciesData.get(speciesName) || lastSeenDate > speciesData.get(speciesName)))) {
                                    speciesData.set(speciesName, lastSeenDate);
                                }
                            }
                            
                            if (speciesData.size === 0) {
                                statusEl.className = 'step-status error';
                                statusEl.textContent = '‚ùå No species found in CSV file';
                                return;
                            }
                            
                            // Build lists
                            userList = new Set(speciesData.keys());
                            window.userLifeList = userList;
                            window.userYearList = new Set();
                            window.userMonthList = new Set();
                            
                            speciesData.forEach((date, species) => {
                                if (date) {
                                    if (date.getFullYear() === currentYear) {
                                        window.userYearList.add(species);
                                    }
                                    if (date.getFullYear() === currentYear && date.getMonth() === currentMonth) {
                                        window.userMonthList.add(species);
                                    }
                                }
                            });
                            
                            // Save to localStorage
                            saveLifeList(userList, 'csv');
                            localStorage.setItem('travelingBirder_yearList', JSON.stringify([...window.userYearList]));
                            localStorage.setItem('travelingBirder_monthList', JSON.stringify([...window.userMonthList]));
                            localStorage.setItem('travelingBirder_lastUpdate', new Date().toISOString());
                            
                            // Success!
                            statusEl.className = 'step-status success';
                            statusEl.innerHTML = `‚úÖ Loaded <strong>${userList.size}</strong> species! (${window.userYearList.size} seen this year)`;
                            
                            // Update welcome steps
                            updateWelcomeSteps();
                            
                            // Update header
                            updateHeaderStatus();
                            
                            console.log(`‚úÖ Life List: ${userList.size} | Year: ${window.userYearList.size} | Month: ${window.userMonthList.size}`);
                            
                        } catch (error) {
                            console.error('CSV parse error:', error);
                            statusEl.className = 'step-status error';
                            statusEl.textContent = '‚ùå Error parsing CSV file. Please check the format.';
                        }
                    },
                    error: function(error) {
                        console.error('Papa parse error:', error);
                        statusEl.className = 'step-status error';
                        statusEl.textContent = '‚ùå Error parsing file: ' + error.message;
                    }
                });
            };
            
            reader.onerror = function(e) {
                console.error('FileReader error:', e);
                statusEl.className = 'step-status error';
                statusEl.textContent = '‚ùå Error reading file. Please try again.';
            };
            
            // Read as text for better compatibility
            reader.readAsText(file);
            
            // Reset input so same file can be re-selected
            input.value = '';
        }
        
        function updateHeaderStatus() {
            const notConnected = document.getElementById('notConnectedStatus');
            const connected = document.getElementById('connectedStatus');
            
            const apiConnected = ebirdAuthenticated && userApiKey;
            const csvUploaded = userList && userList.size > 0;
            
            if (apiConnected && csvUploaded) {
                // Show connected status
                notConnected.style.display = 'none';
                connected.style.display = 'block';
                
                const speciesCount = userList.size;
                const yearCount = window.userYearList ? window.userYearList.size : 0;
                const displayName = userName || 'eBird User';
                
                connected.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; background: #ecfdf5; padding: 8px 15px; border-radius: 8px; border: 1px solid #10b981;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #10b981; font-size: 1.2em;">‚úÖ</span>
                            <span style="font-weight: 600; color: #065f46;">${speciesCount} species</span>
                        </div>
                        <button onclick="showWelcomeOverlay()" style="background: none; border: none; color: #10b981; cursor: pointer; font-size: 0.85em; text-decoration: underline;">
                            Update
                        </button>
                        <button onclick="disconnectEbird()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 0.85em;">
                            Disconnect
                        </button>
                    </div>
                `;
            } else if (apiConnected) {
                // API connected but no CSV
                notConnected.style.display = 'flex';
                notConnected.innerHTML = `
                    <span style="color: #f59e0b; font-weight: 600; font-size: 0.9em;">‚ö†Ô∏è Upload Life List</span>
                    <button onclick="showWelcomeOverlay()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.85em;">
                        Continue Setup
                    </button>
                `;
                connected.style.display = 'none';
            } else {
                // Not connected
                notConnected.style.display = 'flex';
                notConnected.innerHTML = `
                    <span style="color: #f59e0b; font-weight: 600; font-size: 0.9em;">‚ö†Ô∏è Setup Required</span>
                    <button onclick="showWelcomeOverlay()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.85em;">
                        Get Started
                    </button>
                `;
                connected.style.display = 'none';
            }
        }

        // Load year/month lists from localStorage
        function loadYearMonthLists() {
            try {
                const yearListData = localStorage.getItem('travelingBirder_yearList');
                const monthListData = localStorage.getItem('travelingBirder_monthList');
                
                if (yearListData) {
                    window.userYearList = new Set(JSON.parse(yearListData));
                    console.log(`üìÖ Loaded ${window.userYearList.size} species for year list`);
                }
                if (monthListData) {
                    window.userMonthList = new Set(JSON.parse(monthListData));
                    console.log(`üìÖ Loaded ${window.userMonthList.size} species for month list`);
                }
            } catch (error) {
                console.error('Error loading year/month lists:', error);
            }
        }

        // ============================================
        // RETURNING USER PROMPT
        // ============================================
        
        function checkReturningUser() {
            // Skip if welcome overlay should be shown
            const welcomeCompleted = localStorage.getItem('travelingBirder_welcomeCompleted');
            const apiConnected = ebirdAuthenticated && userApiKey;
            const csvUploaded = userList && userList.size > 0;
            
            // Show welcome overlay if not completed setup
            if (!apiConnected || !csvUploaded) {
                if (!welcomeCompleted) {
                    showWelcomeOverlay();
                }
                return;
            }
            
            // Check for returning user prompt
            const lastUpdate = localStorage.getItem('travelingBirder_lastUpdate');
            const dontAskUntil = localStorage.getItem('travelingBirder_dontAskUntil');
            
            // Don't show if user checked "don't ask"
            if (dontAskUntil && new Date(dontAskUntil) > new Date()) return;
            
            // Don't show if updated in last 7 days
            if (lastUpdate) {
                const daysSinceUpdate = (new Date() - new Date(lastUpdate)) / (1000 * 60 * 60 * 24);
                if (daysSinceUpdate < 7) return;
            }
            
            // Show the returning user prompt
            showReturningUserModal(userList.size, lastUpdate);
        }
        
        function showReturningUserModal(speciesCount, lastUpdate) {
            let modal = document.getElementById('returningUserModal');
            
            // Calculate days since last update
            let daysSince = '‚Äî';
            let dateDisplay = 'Unknown';
            let isOld = false;
            
            if (lastUpdate) {
                const lastDate = new Date(lastUpdate);
                const now = new Date();
                const diffDays = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));
                daysSince = diffDays;
                isOld = diffDays > 14;
                dateDisplay = lastDate.toLocaleDateString('en-US', { 
                    weekday: 'short',
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
            }
            
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'returningUserModal';
                modal.className = 'modal-overlay';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 480px; text-align: center; padding: 30px;">
                    <div style="font-size: 3em; margin-bottom: 15px;">ü¶©</div>
                    <h2 style="color: var(--text-primary); margin-bottom: 15px;">Welcome Back!</h2>
                    
                    <div style="background: var(--bg-primary); border-radius: 10px; padding: 18px; margin-bottom: 20px; text-align: left;">
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Your Current Data</div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <span style="color: var(--text-secondary);">Life List Species:</span>
                            <span style="font-weight: 700; color: #10b981; font-size: 1.2em;">${speciesCount || '‚Äî'}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <span style="color: var(--text-secondary);">Year List Species:</span>
                            <span style="font-weight: 600; color: #3b82f6;">${window.userYearList ? window.userYearList.size : '‚Äî'}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
                            <span style="color: var(--text-secondary);">Last Upload:</span>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; color: ${isOld ? '#f59e0b' : 'var(--text-primary)'};">${dateDisplay}</div>
                                <div style="font-size: 0.8em; color: ${isOld ? '#f59e0b' : 'var(--text-secondary)'};">${daysSince} days ago</div>
                            </div>
                        </div>
                    </div>
                    
                    ${isOld ? `
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                        <div style="color: #92400e; font-size: 0.95em; line-height: 1.5;">
                            <strong>‚ö†Ô∏è Your list may be outdated!</strong><br>
                            Upload a fresh CSV from eBird to ensure accurate year list filtering.
                        </div>
                    </div>
                    ` : `
                    <div style="background: #dbeafe; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                        <div style="color: #1e40af; font-size: 0.95em; line-height: 1.5;">
                            <strong>üê¶ Seen any new birds lately?</strong><br>
                            Keep your list updated for accurate target filtering!
                        </div>
                    </div>
                    `}
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="closeReturningUserModal(false)" style="background: #f3f4f6; color: #374151; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em;">
                            Keep Current
                        </button>
                        <button onclick="closeReturningUserModal(true)" style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em;">
                            üì§ Upload New List
                        </button>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label style="display: flex; align-items: center; justify-content: center; gap: 8px; color: var(--text-secondary); font-size: 0.85em; cursor: pointer;">
                            <input type="checkbox" id="dontAskAgainCheckbox" style="cursor: pointer;">
                            Don't ask again for 7 days
                        </label>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        function closeReturningUserModal(shouldUpdate) {
            const modal = document.getElementById('returningUserModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            const checkbox = document.getElementById('dontAskAgainCheckbox');
            if (checkbox && checkbox.checked) {
                const dontAskUntil = new Date();
                dontAskUntil.setDate(dontAskUntil.getDate() + 7);
                localStorage.setItem('travelingBirder_dontAskUntil', dontAskUntil.toISOString());
            }
            
            if (shouldUpdate) {
                showWelcomeOverlay();
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        console.log('‚úÖ All JavaScript loaded successfully');
        console.log('üìã Ready for eBird connection');

    </script>
    
    <!-- ============================================
         FOOTER - HOW IT WORKS
         ============================================ -->
    <div class="info-footer">
        <div style="max-width: 1200px; margin: 0 auto;">
            <h2 style="color: var(--accent-color); margin: 0 0 20px 0; font-size: 1.5em;">üîç How Traveling Birder Search Works</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 30px;">
                <div class="info-card" style="border-left-color: #10b981;">
                    <h3 style="color: var(--accent-color); margin: 0 0 10px 0; font-size: 1.1em;">üì° eBird API Limitations</h3>
                    <p style="margin: 0; line-height: 1.6; color: var(--text-primary);">
                        <strong>Search Radius:</strong> Maximum 50 km (31 miles) per search<br>
                        <strong>Time Range:</strong> Recent observations default to 30 days<br>
                        <strong>Life List:</strong> API only returns last 30 days of your data
                    </p>
                </div>
                
                <div class="info-card" style="border-left-color: #3b82f6;">
                    <h3 style="color: var(--accent-color); margin: 0 0 10px 0; font-size: 1.1em;">üîÑ Our Workarounds</h3>
                    <p style="margin: 0; line-height: 1.6; color: var(--text-primary);">
                        <strong>Routes & Large Areas:</strong> Multiple overlapping 31-mile searches every 20 miles for complete coverage<br>
                        <strong>Life List:</strong> Import your complete eBird CSV for full history<br>
                        <strong>Time Range:</strong> Adjustable from 7 days to 1 year for each search type
                    </p>
                </div>
                
                <div class="info-card" style="border-left-color: #f59e0b;">
                    <h3 style="color: var(--accent-color); margin: 0 0 10px 0; font-size: 1.1em;">üìä Performance</h3>
                    <p style="margin: 0; line-height: 1.6; color: var(--text-primary);">
                        <strong>Short routes (&lt;50 mi):</strong> Instant<br>
                        <strong>Long routes (200+ mi):</strong> 30-60 seconds<br>
                        <strong>Very long routes (1000+ mi):</strong> 2-3 minutes<br>
                        <strong>Top eBirders:</strong> 5-10 seconds (11 API calls)
                    </p>
                </div>
            </div>
            
            <div class="info-box-section warning-section">
                <h3 style="color: var(--text-primary); margin: 0 0 10px 0; font-size: 1.1em;">üéØ Why You Might Not See Expected Birds</h3>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <p style="margin: 0 0 10px 0;"><strong>1. Time Range:</strong> Default searches show last 3 days. Use the Time Range dropdown to see older sightings (up to 1 year).</p>
                    <p style="margin: 0 0 10px 0;"><strong>2. Search Radius:</strong> Default is 15 miles for main search, 25 miles for species search. Increase up to 31 miles max (eBird API limit).</p>
                    <p style="margin: 0 0 10px 0;"><strong>3. eBird Data Coverage:</strong> We only show birds reported to eBird. Remote areas may have sparse data.</p>
                    <p style="margin: 0 0 10px 0;"><strong>4. Target List Filter:</strong> If using Life List or Year List filters and seeing few results, you may have already seen most birds. Switch to "Show All Species".</p>
                    <p style="margin: 0 0 10px 0;"><strong>5. Life List Completeness:</strong> If you haven't imported your eBird CSV, your life list only includes the last 30 days. Import full CSV for accurate targets.</p>
                    <p style="margin: 0;"><strong>6. API Rate Limits:</strong> eBird may throttle requests for very large searches. If search fails, try smaller areas or wait a few minutes.</p>
                </div>
            </div>
            
            <div class="info-box-section tips-section">
                <h3 style="color: var(--text-primary); margin: 0 0 10px 0; font-size: 1.1em;">üí° Pro Tips for Best Results</h3>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <p style="margin: 0 0 10px 0;">‚úÖ <strong>Upload World Life List First:</strong> Go to ebird.org/downloadMyData and download your complete life list as the baseline.</p>
                    <p style="margin: 0 0 10px 0;">‚úÖ <strong>Add Regional Lists:</strong> For accurate county/state targets, upload separate regional lists from eBird.</p>
                    <p style="margin: 0 0 10px 0;">‚úÖ <strong>Auto-Update:</strong> Your life list updates automatically with new species when you connect (last 30 days from eBird API).</p>
                    <p style="margin: 0 0 10px 0;">‚úÖ <strong>Use Date Filter:</strong> Filter your list by date range for "decade lists" or trip-specific searches.</p>
                    <p style="margin: 0 0 10px 0;">‚úÖ <strong>Region Boundaries:</strong> Check "Region boundaries only" for county/state searches to stay within political borders.</p>
                    <p style="margin: 0 0 10px 0;">‚úÖ <strong>Top Checklists:</strong> Shows best recent checklists in the region by total species (not filtered by your targets).</p>
                    <p style="margin: 0;">‚úÖ <strong>Adjust Time Ranges:</strong> Use longer ranges (30 days, 6 months) for uncommon species.</p>
                </div>
            </div>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center; color: var(--text-secondary); font-size: 0.9em;">
                <p style="margin: 0 0 10px 0;">ü¶© <strong>Traveling Birder v7.5</strong> | Powered by <a href="https://ebird.org" target="_blank" style="color: #10b981; text-decoration: none;">eBird</a> and Google Maps</p>
                <p style="margin: 0 0 10px 0; font-size: 0.85em;">
                    Questions or feedback? <a href="/cdn-cgi/l/email-protection#780c0a190e1d1411161f1a110a1c1d0a381f15191114561b1715" style="color: #10b981; text-decoration: none;"><span class="__cf_email__" data-cfemail="740006150211181d1a13161d06101106341319151d185a171b19">[email&#160;protected]</span></a>
                </p>
                <p style="margin: 0; font-size: 0.8em; color: var(--text-secondary);">
                    ¬© 2024-2025 Traveling Birder. All rights reserved. | 
                    <span onclick="showTermsModal()" style="cursor: pointer; text-decoration: underline;">Terms & Privacy</span>
                </p>
            </div>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <div id="csvImportModal" class="modal-overlay">
        <div class="modal" style="max-width: 700px;">
            <span class="modal-close" onclick="closeModal('csvImportModal')">&times;</span>
            <h2>üì• Bird Lists Manager</h2>
            
            <!-- NEW: eBird Data ZIP Upload (Recommended) -->
            <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #10b981;">
                <h3 style="margin: 0 0 10px 0; font-size: 1em; color: #065f46;">‚≠ê Recommended: Upload Your Full eBird Data (ZIP)</h3>
                <p style="margin: 0 0 10px 0; font-size: 0.9em; color: #047857;">
                    Upload your complete eBird data export ZIP file. This includes all your observations with dates, locations, and can automatically generate life lists and regional lists.
                </p>
                <ol style="margin: 0 0 12px 0; padding-left: 20px; font-size: 0.85em; color: #065f46;">
                    <li>Go to <a href="https://ebird.org/downloadMyData" target="_blank" style="color: #2563eb; font-weight: 600;">ebird.org/downloadMyData</a></li>
                    <li>Click <strong>"Request my observations"</strong></li>
                    <li>Wait for email (usually a few minutes)</li>
                    <li>Download the ZIP file and upload it here</li>
                </ol>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="file" id="ebirdZipInput" accept=".zip" style="flex: 1; padding: 8px; border: 1px solid #10b981; border-radius: 6px; background: white;">
                    <button onclick="handleEBirdZipUpload()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                        üì¶ Import ZIP
                    </button>
                </div>
                <div id="zipUploadStatus" style="margin-top: 10px; font-size: 0.85em; display: none;"></div>
            </div>
            
            <div style="text-align: center; color: var(--text-secondary); margin: 15px 0; font-size: 0.9em;">
                ‚îÄ‚îÄ‚îÄ OR upload individual CSV files ‚îÄ‚îÄ‚îÄ
            </div>
            
            <!-- Step 1: World Life List Required -->
            <div class="info-box success" style="margin-bottom: 15px;">
                <p style="margin: 0 0 8px 0; font-weight: 600;">‚úÖ Option 2: Upload Individual CSV Files</p>
                <p style="margin: 0; font-size: 0.9em;">Your <strong>World Life List</strong> must be uploaded before any regional lists. This is your complete birding history and serves as the baseline for all target filtering.</p>
                <ol style="margin: 10px 0 0 0; padding-left: 20px; font-size: 0.85em;">
                    <li>Go to <a href="https://ebird.org/downloadMyData" target="_blank" style="color: #065f46; font-weight: 600;">ebird.org/downloadMyData</a></li>
                    <li>Leave "Region" set to <strong>"World"</strong> (or don't select any region)</li>
                    <li>Download and upload that CSV here first</li>
                </ol>
                <div style="background: #fef3c7; padding: 10px; border-radius: 6px; margin-top: 12px; border: 1px solid #fcd34d;">
                    <p style="margin: 0; font-size: 0.85em; color: #92400e;">
                        <strong>‚ö†Ô∏è CSV Limitation:</strong> The eBird life list CSV only includes the <strong>most recent sighting date</strong> for each species, not your full observation history. This means date filtering (year lists, trip reports) won't work accurately. For full date support, use the <strong>ZIP upload</strong> option above.
                    </p>
                </div>
            </div>
            
            <!-- Step 2: Regional Lists -->
            <div class="info-box warning" style="margin-bottom: 15px;">
                <p style="margin: 0 0 8px 0; font-weight: 600;">üìç Step 3 (Optional): Upload Regional Lists</p>
                <p style="margin: 0; font-size: 0.9em;">Your World Life List shows your <strong>most recent sighting location</strong> for each species, not all locations where you've seen it. To accurately search for targets in a specific region (state, county, country), download a <strong>separate regional list</strong> from eBird for that area.</p>
            </div>
            
            <!-- Current Lists Display -->
            <div id="currentListsSection" style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h3 style="margin: 0 0 12px 0; font-size: 1em; color: var(--text-primary);">üìã Your Uploaded Lists</h3>
                <div id="uploadedListsContainer">
                    <p style="color: var(--text-secondary); font-size: 0.9em; margin: 0;">No lists uploaded yet. Start by uploading your World Life List!</p>
                </div>
            </div>
            
            <!-- Upload New List Section -->
            <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #10b981;">
                <h3 style="margin: 0 0 12px 0; font-size: 1em; color: #065f46;">‚ûï Upload Individual CSV</h3>
                
                <div style="margin-bottom: 12px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 6px; font-size: 0.9em;">List Type:</label>
                    <select id="uploadListType" onchange="updateListTypeHelp()" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.95em;">
                        <option value="world">üåç World Life List (required first)</option>
                        <option value="country">üè≥Ô∏è Country List</option>
                        <option value="state">üó∫Ô∏è State/Province List</option>
                        <option value="county">üìç County List</option>
                        <option value="custom">üìù Custom Region</option>
                    </select>
                </div>
                
                <!-- Region Selector (shows for country/state/county) -->
                <div id="uploadRegionSelector" style="display: none; margin-bottom: 12px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 6px; font-size: 0.9em;">Select Region:</label>
                    <select id="uploadCountrySelect" onchange="loadUploadStates()" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; display: none;">
                        <option value="">-- Select Country --</option>
                        <option value="US">United States</option>
                        <option value="CA">Canada</option>
                        <option value="MX">Mexico</option>
                        <option value="GB">United Kingdom</option>
                        <option value="AU">Australia</option>
                        <option value="CR">Costa Rica</option>
                        <option value="other">Other (enter code manually)</option>
                    </select>
                    <select id="uploadStateSelect" onchange="loadUploadCounties()" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; display: none;">
                        <option value="">-- Select State --</option>
                    </select>
                    <select id="uploadCountySelect" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; display: none;">
                        <option value="">-- Select County --</option>
                    </select>
                    <input type="text" id="uploadCustomRegion" placeholder="Enter region name (e.g., 'Ecuador' or 'Texas Hill Country')" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; display: none;">
                </div>
                
                <div id="listTypeHelp" style="background: #dbeafe; padding: 10px; border-radius: 6px; margin-bottom: 12px; font-size: 0.85em; color: #1e40af;">
                    üí° <strong>World Life List:</strong> Download from <a href="https://ebird.org/downloadMyData" target="_blank" style="color: #1e40af;">ebird.org/downloadMyData</a> ‚Üí Select "Life List"
                </div>
                
                <div style="margin-bottom: 12px;">
                    <input type="file" id="csvFileInput" accept=".csv" style="margin: 0; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; width: 100%;">
                </div>
                
                <button onclick="handleCSVUpload()" style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 1em; width: 100%; font-weight: 600;">
                    üì• Upload List
                </button>
            </div>
            
            <!-- Download Instructions -->
            <div class="info-box info" style="margin-bottom: 15px;">
                <p style="margin: 0 0 8px 0; font-weight: 600;">üì• How to Download Regional Lists from eBird:</p>
                <ol style="margin: 0; padding-left: 20px; font-size: 0.85em; line-height: 1.6;">
                    <li>Go to <a href="https://ebird.org/downloadMyData" target="_blank" style="color: #10b981; font-weight: 600;">ebird.org/downloadMyData</a></li>
                    <li>Under "Region", select the specific region (Country, State, or County)</li>
                    <li>Click "Download" to get the CSV</li>
                    <li>Upload here and tag with the matching region</li>
                </ol>
            </div>
            
            <div class="info-box info">
                <p style="margin: 0; font-size: 0.85em;">üîí <strong>Privacy:</strong> All lists are processed and stored locally on your device. Nothing is uploaded to any server.</p>
            </div>
        </div>
    </div>

    <!-- Terms & Conditions Modal -->
    <div id="termsModal" class="modal-overlay">
        <div class="modal">
            <span class="modal-close" onclick="closeModal('termsModal')">&times;</span>
            <h2>üìã Terms of Use & Privacy</h2>
            
            <div style="max-height: 400px; overflow-y: auto; background: var(--bg-primary); padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid var(--border-color);">
                <h3>TRAVELING BIRDER - TERMS OF USE</h3>
                <p style="font-size: 0.85em; margin-bottom: 20px;">Last Updated: December 20, 2025</p>
                
                <h4>1. YOUR DATA & PRIVACY</h4>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li>Your life list data is stored locally on YOUR device only</li>
                    <li>We do NOT upload, store, or access your personal birding data</li>
                    <li>We do NOT sell or share your information with third parties</li>
                    <li>Your eBird API key is stored securely in your browser's localStorage</li>
                    <li>All data processing happens entirely on your device</li>
                    <li>No cookies are used for tracking purposes</li>
                </ul>
                
                <h4>2. EBIRD API USAGE</h4>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li>This app uses the eBird API to fetch bird observation data</li>
                    <li>eBird API has a 30-day limitation for recent observations (eBird policy)</li>
                    <li>You can import your full CSV from eBird for complete historical data</li>
                    <li>All API usage follows eBird's Terms of Service</li>
                    <li>eBird data is owned by Cornell Lab of Ornithology</li>
                </ul>
                
                <h4>3. GOOGLE MAPS</h4>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li>This app uses Google Maps for route planning and visualization</li>
                    <li>Google Maps usage is subject to Google's Terms of Service</li>
                    <li>Location searches and directions are processed by Google</li>
                </ul>
                
                <h4>4. NO WARRANTY</h4>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li>This app is provided "as is" for birding assistance</li>
                    <li>We are not responsible for missed birds or inaccurate data</li>
                    <li>eBird data may have gaps, errors, or delays</li>
                    <li>Always verify rare sightings independently before traveling</li>
                    <li>Bird presence is not guaranteed - conditions change</li>
                </ul>
                
                <h4>5. ACCEPTABLE USE</h4>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li>Use this app responsibly and ethically</li>
                    <li>Respect wildlife and their habitats</li>
                    <li>Follow local birding ethics and eBird guidelines</li>
                    <li>Do not disturb nesting birds or sensitive areas</li>
                    <li>Respect private property and access restrictions</li>
                </ul>
                
                <h4>6. CONTACT & SUPPORT</h4>
                <ul style="line-height: 1.8;">
                    <li>Questions or feedback: <a href="/cdn-cgi/l/email-protection#ef9b9d8e998a838681888d869d8b8a9daf88828e8683c18c8082" style="color: #10b981;"><span class="__cf_email__" data-cfemail="97e3e5f6e1f2fbfef9f0f5fee5f3f2e5d7f0faf6fefbb9f4f8fa">[email&#160;protected]</span></a></li>
                    <li>Report issues via GitHub or email</li>
                    <li>We respect your privacy and will never share your information</li>
                </ul>
            </div>
            
            <button onclick="acceptTerms()" style="width: 100%; padding: 15px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer;">
                ‚úÖ I Accept These Terms
            </button>
        </div>
    </div>

    <!-- Cookie Consent Banner for EEA/GDPR -->
    <div id="cookieConsentBanner" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #1f2937; color: white; padding: 15px 20px; z-index: 10000; box-shadow: 0 -4px 20px rgba(0,0,0,0.3);">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 15px;">
            <div style="flex: 1; min-width: 300px;">
                <p style="margin: 0 0 5px 0; font-weight: 600;">üç™ Cookie Consent</p>
                <p style="margin: 0; font-size: 0.9em; color: #9ca3af;">We use cookies to analyze site usage and improve your experience. Your data stays on your device - we only collect anonymous analytics.</p>
            </div>
            <div style="display: flex; gap: 10px; flex-shrink: 0;">
                <button onclick="acceptCookies()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Accept</button>
                <button onclick="declineCookies()" style="padding: 10px 20px; background: transparent; color: white; border: 1px solid #6b7280; border-radius: 6px; cursor: pointer;">Decline</button>
            </div>
        </div>
    </div>

    <script>
        // Cookie consent functions
        function showCookieBanner() {
            const consent = localStorage.getItem('travelingBirder_cookieConsent');
            if (!consent) {
                document.getElementById('cookieConsentBanner').style.display = 'block';
            }
        }

        function acceptCookies() {
            document.getElementById('cookieConsentBanner').style.display = 'none';
            if (typeof grantAnalyticsConsent === 'function') {
                grantAnalyticsConsent();
            }
        }

        function declineCookies() {
            document.getElementById('cookieConsentBanner').style.display = 'none';
            if (typeof denyAnalyticsConsent === 'function') {
                denyAnalyticsConsent();
            }
        }

        // Show banner on load (with slight delay)
        setTimeout(showCookieBanner, 1500);
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('üîß Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
        
        // PWA Install prompt handling
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show install button in UI
            showInstallButton();
        });
        
        function showInstallButton() {
            // Add install button to header if not already present
            const header = document.querySelector('.app-header');
            if (header && !document.getElementById('pwaInstallBtn')) {
                const installBtn = document.createElement('button');
                installBtn.id = 'pwaInstallBtn';
                installBtn.innerHTML = 'üì≤ Install App';
                installBtn.style.cssText = 'background: #10b981; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em; margin-left: 10px;';
                installBtn.onclick = installPWA;
                header.querySelector('.header-actions')?.appendChild(installBtn);
            }
        }
        
        async function installPWA() {
            if (!deferredPrompt) return;
            
            // Show the install prompt
            deferredPrompt.prompt();
            
            // Wait for the user to respond to the prompt
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User ${outcome} the install prompt`);
            
            // Clear the deferred prompt
            deferredPrompt = null;
            
            // Hide the install button
            const btn = document.getElementById('pwaInstallBtn');
            if (btn) btn.remove();
        }
        
        // Handle successful installation
        window.addEventListener('appinstalled', () => {
            console.log('üéâ PWA was installed');
            deferredPrompt = null;
            const btn = document.getElementById('pwaInstallBtn');
            if (btn) btn.remove();
        });
    </script>

    <!-- Printable Report Modal -->
    <div id="printableReportModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #111827;" id="reportModalTitle">üìä Search Report</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="printReport()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        üñ®Ô∏è Print
                    </button>
                    <button onclick="closeModal('printableReportModal')" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Close
                    </button>
                </div>
            </div>
            <div id="printableReportContent">
                <!-- Report content will be populated by JS -->
            </div>
        </div>
    </div>
    
    <!-- Print-only styles -->
    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            #printableReportModal,
            #printableReportModal * {
                visibility: visible;
            }
            #printableReportModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
            }
            #printableReportModal .modal-content {
                max-width: 100%;
                max-height: none;
                box-shadow: none;
                padding: 20px;
            }
            #printableReportModal .modal-header button {
                display: none;
            }
            .no-print {
                display: none !important;
            }
            .print-checklist-item {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
    </style>

</body>
</html>