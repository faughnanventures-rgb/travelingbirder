<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traveling Birder v5.0 - Route-Based Birding Planner</title>
    <!-- BUILD: 2024-12-18-COMPLETE-REDESIGN-v5.0 -->
    
    <!-- Google Maps Script with Callback -->
    <script>
        var mapInitPending = false;
        window.initMap = function() {
            console.log('üó∫Ô∏è Google Maps callback triggered');
            mapInitPending = true;
            if (document.readyState === 'complete') {
                if (typeof realInitMap === 'function') {
                    console.log('‚úÖ Calling realInitMap immediately');
                    realInitMap();
                }
            }
        };
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvpU9tANBmnbKqMM2UWvELa9nRcrhneY0&libraries=places,geometry&callback=initMap"></script>
    
    <!-- CSV Parser for Life List Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Dark Mode Variables */
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: white;
            --text-primary: #374151;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
        }

        [data-theme="dark"] {
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --border-color: var(--text-primary);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        /* ============================================
           HEADER STYLES
           ============================================ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: var(--bg-secondary);
            border-bottom: 3px solid #10b981;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-left h1 {
            margin: 0;
            font-size: 1.6em;
            color: var(--text-primary);
        }

        .header-left p {
            margin: 3px 0 0 0;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .help-btn {
            background: #fbbf24;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.4em;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(251, 191, 36, 0.3);
            transition: all 0.3s;
        }

        .help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }

        .ebird-login {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ebird-login input {
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9em;
            width: 220px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .ebird-login input::placeholder {
            color: var(--text-secondary);
        }

        .ebird-login button {
            padding: 10px 20px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.3s;
        }

        .ebird-login button:hover {
            background: #059669;
        }

        .ebird-connected {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-primary);
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .ebird-connected-text {
            font-size: 0.9em;
            color: var(--text-primary);
            font-weight: 600;
        }

        .disconnect-btn {
            padding: 6px 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
        }

        /* ============================================
           QUICK START MODAL
           ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 35px;
            max-width: 650px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.8em;
        }

        .modal-close {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.4em;
            cursor: pointer;
            font-weight: bold;
            line-height: 1;
        }

        .modal-content ol {
            padding-left: 25px;
            line-height: 2;
            color: var(--text-primary);
        }

        .modal-content strong {
            color: var(--text-primary);
        }

        .modal-content p {
            color: var(--text-primary);
        }
            color: #065f46;
        }

        .modal-tips {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
            border: 1px solid #10b981;
        }

        .modal-tips strong {
            display: block;
            margin-bottom: 12px;
            color: #065f46;
            font-size: 1.1em;
        }

        .modal-tips ul {
            margin: 0;
            padding-left: 25px;
            font-size: 0.95em;
            color: #047857;
        }

        /* ============================================
           MAIN LAYOUT
           ============================================ */
        .main-layout {
            display: grid;
            grid-template-columns: 420px 1fr;
            height: calc(100vh - 80px);
            gap: 0;
        }

        .sidebar {
            background: var(--bg-secondary);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
        }

        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #10b981;
            border-radius: 4px;
        }

        .map-container {
            position: relative;
            height: 100%;
            min-height: 600px;
        }

        #map {
            width: 100%;
            height: 100%;
            min-height: 600px;
        }

        /* ============================================
           SIDEBAR SECTIONS
           ============================================ */
        .section {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 18px;
            margin-bottom: 18px;
        }

        .section h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.15em;
            padding-bottom: 10px;
            border-bottom: 2px solid #10b981;
        }

        .section label {
            color: var(--text-primary);
        }

        .section select, .section input {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        }

        .input-group {
            margin-bottom: 14px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9em;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 11px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9em;
            transition: all 0.3s;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .input-group input::placeholder {
            color: var(--text-secondary);
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Checkbox styling for dark mode */
        input[type="checkbox"] {
            accent-color: #10b981;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        /* Better checkbox visibility in dark mode */
        [data-theme="dark"] input[type="checkbox"] {
            filter: brightness(1.2);
        }

        button.primary-btn {
            width: 100%;
            padding: 12px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        button.primary-btn:hover {
            background: #059669;
        }

        button.secondary-btn {
            width: 100%;
            padding: 10px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 8px;
        }

        button.secondary-btn:hover {
            background: #4b5563;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-size: 0.9em;
            color: var(--text-primary);
        }

        /* ============================================
           FLOATING MAP LEGEND
           ============================================ */
        .map-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            max-width: 280px;
            z-index: 100;
            border: 1px solid var(--border-color);
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .legend-header h4 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1em;
        }

        .legend-toggle {
            font-size: 1.2em;
            font-weight: bold;
            color: #10b981;
        }

        .legend-content {
            font-size: 0.85em;
            color: var(--text-primary);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
            color: var(--text-primary);
        }

        .legend-item span {
            color: var(--text-primary);
        }

        .legend-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .legend-marker.target { background: #ef4444; }
        .legend-marker.rare { background: #f59e0b; }
        .legend-marker.common { background: #10b981; }
        .legend-marker.hotspot { background: #3b82f6; }

        /* ============================================
           BELOW MAP PANELS
           ============================================ */
        .below-map {
            background: white;
            border-top: 2px solid var(--border-color);
        }

        .panels-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: #e5e7eb;
        }

        .panel {
            background: white;
            padding: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .panel:hover {
            background: #f9fafb;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .panel-header h3 {
            margin: 0;
            color: #065f46;
            font-size: 1.1em;
        }

        .panel-toggle {
            font-size: 1.5em;
            color: #10b981;
            font-weight: bold;
        }

        .panel-summary {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .panel-content {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .panel-content.expanded {
            display: block;
        }

        /* ============================================
           ROUTE CONTROLS
           ============================================ */
        .route-duration {
            background: #dbeafe;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            margin: 12px 0;
            font-weight: 600;
            color: #1e40af;
        }

        .waypoint-list {
            margin-top: 12px;
        }

        .waypoint-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f3f4f6;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 0.85em;
        }

        .waypoint-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 3px 8px;
            font-size: 0.8em;
            cursor: pointer;
        }

        /* ============================================
           RESPONSIVE DESIGN
           ============================================ */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 360px 1fr;
            }
        }

        @media (max-width: 968px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .main-layout {
                grid-template-columns: 1fr;
                height: auto;
            }

            .sidebar {
                height: auto;
                max-height: 60vh;
            }

            .map-container {
                height: 500px;
            }

            .panels-container {
                grid-template-columns: 1fr;
            }

            .ebird-login input {
                width: 180px;
            }
        }

        @media (max-width: 640px) {
            .header-left h1 {
                font-size: 1.3em;
            }

            .ebird-login {
                flex-direction: column;
                width: 100%;
            }

            .ebird-login input,
            .ebird-login button {
                width: 100%;
            }

            .help-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2em;
            }
        }

        /* ============================================
           PRINT STYLES
           ============================================ */
        @media print {
            .header,
            .sidebar,
            .below-map,
            .map-legend {
                display: none !important;
            }

            .map-container {
                height: 100vh !important;
            }

            #map {
                height: 100vh !important;
            }
        }

        /* ============================================
           MODAL STYLES
           ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal h2 {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 1.5em;
        }

        .modal h3 {
            margin: 20px 0 10px 0;
            color: var(--text-primary);
            font-size: 1.2em;
        }

        .modal h4 {
            margin: 15px 0 8px 0;
            color: var(--text-primary);
            font-size: 1em;
        }

        .modal p, .modal li {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .modal-close {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .info-box {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid;
        }

        .info-box.warning {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .info-box.success {
            background: #d1fae5;
            border-color: #10b981;
        }

        .info-box.info {
            background: #e0e7ff;
            border-color: #6366f1;
        }

        [data-theme="dark"] .info-box.warning {
            background: #78350f;
        }

        [data-theme="dark"] .info-box.success {
            background: #064e3b;
        }

        [data-theme="dark"] .info-box.info {
            background: #312e81;
        }

        /* Account Menu Dropdown */
        .account-dropdown {
            position: relative;
        }

        .account-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 220px;
            margin-top: 8px;
            z-index: 1000;
        }

        .account-menu.active {
            display: block;
        }

        .account-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
            color: var(--text-primary);
            font-size: 0.95em;
        }

        .account-menu-item:hover {
            background: var(--bg-primary);
        }

        .account-menu-item:last-child {
            border-bottom: none;
        }

        .menu-toggle-btn {
            background: #6b7280;
            border: none;
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
            font-weight: 500;
        }

        .menu-toggle-btn:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        [data-theme="dark"] .menu-toggle-btn {
            background: #374151;
        }

        [data-theme="dark"] .menu-toggle-btn:hover {
            background: #4b5563;
        }

        /* ============================================
           UTILITY CLASSES
           ============================================ */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        /* ============================================
           GOOGLE PLACES AUTOCOMPLETE STYLING
           ============================================ */
        .pac-container {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-top: 4px;
            z-index: 10000 !important;
        }

        .pac-item {
            padding: 10px;
            cursor: pointer;
            border-top: 1px solid var(--border-color);
        }

        .pac-item:first-child {
            border-top: none;
        }

        .pac-item:hover {
            background: #f0fdf4;
        }

        .pac-item-query {
            color: #065f46;
            font-weight: 600;
        }

        .pac-icon {
            margin-top: 2px;
        }
        
        @keyframes fly {
            0%, 100% { transform: translateY(0px) rotate(-5deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }
    </style>
</head>
<body>
    <!-- ============================================
         HEADER
         ============================================ -->
    <div class="header">
        <div class="header-left">
            <h1>ü¶© Traveling Birder</h1>
            <p>Plan your birding trip with target species along your route</p>
        </div>
        <div class="header-right">
            <button class="help-btn" onclick="toggleQuickStart()" title="Quick Start Guide" style="display: flex; align-items: center; gap: 8px; padding: 0 15px; border-radius: 20px; width: auto;">
                <span style="font-size: 1.3em;">üí°</span>
                <span style="font-size: 0.9em; font-weight: 600;">Quick Start</span>
            </button>
            
            <!-- Account/Settings Menu -->
            <div class="account-dropdown">
                <button class="menu-toggle-btn" onclick="toggleAccountMenu()" title="Settings & Features">
                    ‚öôÔ∏è Menu
                </button>
                <div id="accountMenu" class="account-menu">
                    <div class="account-menu-item" onclick="openCSVImportModal()">
                        üì• Import Life List CSV
                    </div>
                    <div class="account-menu-item" onclick="exportCurrentSearchCSV()">
                        üì§ Export Search Results
                    </div>
                    <div class="account-menu-item" onclick="exportLifeListCSV()">
                        üíæ Export My Life List
                    </div>
                    <div class="account-menu-item" onclick="toggleDarkMode()">
                        üåì Toggle Dark Mode
                    </div>
                    <div class="account-menu-item" onclick="showTermsModal()">
                        üìã Terms & Privacy
                    </div>
                </div>
            </div>
            
            <div id="ebirdHeader" style="display: flex; flex-direction: column; gap: 5px;">
                <div class="ebird-login">
                    <input type="password" id="apiKey" placeholder="eBird API Key">
                    <button onclick="connectEbird()">Connect</button>
                </div>
                <div style="text-align: center; font-size: 0.75em; color: var(--text-secondary);">
                    Get free API key: <a href="https://ebird.org/api/keygen" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: none;">ebird.org/api/keygen</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         QUICK START MODAL
         ============================================ -->
    <div id="quickStartModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí° Quick Start Guide</h2>
                <button class="modal-close" onclick="toggleQuickStart()">√ó</button>
            </div>
            <ol>
                <li><strong>Connect eBird:</strong> Enter your API key in the top-right (get free at <a href="https://ebird.org/api/keygen" target="_blank" style="color: #10b981;">ebird.org/api/keygen</a>)</li>
                <li><strong>Plan Route:</strong> Enter your starting point and destination</li>
                <li><strong>Set Parameters:</strong> Choose search radius and time range</li>
                <li><strong>View Results:</strong> See target species (birds NOT on your list) along your route</li>
                <li><strong>Add Waypoints:</strong> Click any bird or hotspot marker to add it as a stop</li>
                <li><strong>Print Directions:</strong> Get turn-by-turn directions with your birding stops</li>
            </ol>
            <div class="modal-tips">
                <strong>üí° Pro Tips:</strong>
                <ul>
                    <li>Target species are birds you haven't seen yet - find new lifers!</li>
                    <li>Top 10 hotspots are ranked by most species recently seen</li>
                    <li>Click markers to add waypoints and plan the perfect birding route</li>
                    <li>Use Print Directions to take your route on the road</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ============================================
         MAIN LAYOUT
         ============================================ -->
    <div class="main-layout">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <!-- Route Planning Section -->
            <div class="section">
                <h3>üöó Search Mode</h3>
                <div class="input-group">
                    <label>Search Type</label>
                    <select id="searchMode" onchange="toggleSearchMode()">
                        <option value="route">Route (Origin ‚Üí Destination)</option>
                        <option value="area">Area Only (County/State/ABA)</option>
                    </select>
                </div>
                
                <!-- Route Mode Fields -->
                <div id="routeModeFields">
                    <div class="input-group">
                        <label>Origin <span style="font-size: 0.8em; color: #10b981;">(üîç Type to search)</span></label>
                        <input type="text" id="originInput" placeholder="e.g., Boston, MA or 02108">
                    </div>
                    <div class="input-group">
                        <label>Destination <span style="font-size: 0.8em; color: #10b981;">(üîç Type to search)</span></label>
                        <input type="text" id="destinationInput" placeholder="e.g., Portland, ME or 04101">
                    </div>
                </div>
                
                <!-- Area Mode Fields -->
                <div id="areaModeFields" style="display: none;">
                    <div class="input-group">
                        <label>Location Type</label>
                        <select id="areaType">
                            <option value="custom">Custom Location</option>
                            <option value="county">County</option>
                            <option value="state">State</option>
                            <option value="country">Country</option>
                            <option value="aba">ABA Area</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Location <span style="font-size: 0.8em; color: #10b981;">(üîç Type to search)</span></label>
                        <input type="text" id="areaInput" placeholder="e.g., Suffolk County, MA or California">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Search Radius (miles)</label>
                    <input type="number" id="searchRadius" value="15" min="1" max="100" placeholder="Enter miles">
                    <div style="margin-top: 10px; padding: 10px; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-color);">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="regionOnlyMode" onchange="toggleRegionOnlyMode()" style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                            <span style="line-height: 1.5; color: var(--text-primary); font-weight: 500;">
                                Region boundaries only (no radius expansion)
                            </span>
                        </label>
                        <div style="font-size: 0.8em; color: var(--text-secondary); margin-top: 6px; margin-left: 28px; line-height: 1.4;">
                            ‚úÖ Perfect for state/county searches - stays within boundaries
                        </div>
                    </div>
                    <div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 8px; line-height: 1.4;">
                        ‚ÑπÔ∏è eBird API maximum is 31 miles (50km). For longer routes, the app automatically searches multiple overlapping areas to ensure complete coverage.
                    </div>
                </div>
                <div class="input-group">
                    <label>Time Range</label>
                    <select id="timeRange">
                        <option value="1">Last 1 day</option>
                        <option value="3">Last 3 days</option>
                        <option value="7">Last 7 days</option>
                        <option value="14">Last 14 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="45">Last 45 days</option>
                        <option value="365">Calendar Year</option>
                    </select>
                </div>
                
                <!-- Map Layers (moved here from separate section) -->
                <div id="layersSection" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                    <h4 style="margin: 0 0 10px 0; color: #065f46; font-size: 0.95em;">üó∫Ô∏è Map Layers</h4>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="showHotspots" onchange="toggleHotspots()" checked>
                            <label for="showHotspots">Show Top 10 Hotspots</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showChecklists" onchange="toggleChecklists()" checked>
                            <label for="showChecklists">Show Top 10 Checklists</label>
                        </div>
                    </div>
                    <div class="input-group" style="margin-top: 10px;">
                        <label>Target Species Filter</label>
                        <select id="targetListType" onchange="applyTargetFilter()">
                            <option value="all">Show All Species</option>
                            <option value="life">Life List Targets Only</option>
                            <option value="year">Year List Targets Only</option>
                            <option value="month">Month List Targets Only</option>
                            <option value="state">State List Targets Only</option>
                            <option value="county">County List Targets Only</option>
                            <option value="country">Country List Targets Only</option>
                            <option value="aba">ABA Area Targets Only</option>
                            <option value="expected">‚≠ê Expected Seasonal Targets</option>
                            <option value="notable">üíé Notable/Rare Targets</option>
                        </select>
                        <div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 4px; line-height: 1.4;">
                            <strong>New!</strong> Expected = Common for this season. Notable = Rare birds recently seen.
                        </div>
                    </div>
                </div>
                
                <button class="primary-btn" onclick="performSearch()">üîç Find Birds</button>
                
                <!-- Loading Indicator -->
                <div id="loadingIndicator" style="display: none; margin-top: 15px; text-align: center; padding: 15px; background: #f0fdf4; border-radius: 8px; border: 2px solid #10b981;">
                    <div style="font-size: 2em; animation: fly 2s ease-in-out infinite;">ü¶©</div>
                    <div style="margin-top: 8px; font-weight: 600; color: #065f46;">Finding birds along your route...</div>
                    <div style="margin-top: 4px; font-size: 0.85em; color: #047857;" id="loadingStatus">Searching...</div>
                </div>
                
                <div id="routeDuration" class="route-duration hidden">
                    Duration: <span id="durationText">--</span>
                </div>
                <button class="secondary-btn hidden" id="printBtn" onclick="printDirections()">üñ®Ô∏è Print Directions</button>
                
                <div id="waypointList" class="waypoint-list"></div>
            </div>

            <!-- ABA Rarity Filter -->
            <div class="section" id="abaRaritySection" style="display: none;">
                <h3>üéØ ABA Rarity Filter</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="showABA1" checked>
                        <label for="showABA1">Code 1 (Common) üü¢</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showABA2" checked>
                        <label for="showABA2">Code 2 (Uncommon) üü°</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showABA3" checked>
                        <label for="showABA3">Code 3 (Rare) üü†</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showABA4" checked>
                        <label for="showABA4">Code 4 (Very Rare) üî¥</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showABA5" checked>
                        <label for="showABA5">Code 5 (Mega Rare) üü£</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showABA6" checked>
                        <label for="showABA6">Code 6 (Cannot be Found) ‚ö´</label>
                    </div>
                </div>
                <button class="secondary-btn" onclick="applyTargetFilter()" style="margin-top: 10px;">Apply Filter</button>
            </div>

            <!-- Target Species Search -->
            <div class="section" id="speciesSearchSection">
                <h3>üîç Search Specific Species</h3>
                <div class="input-group">
                    <label>Species Name or Code <span style="font-size: 0.75em; color: var(--text-secondary);">(type to see suggestions)</span></label>
                    <input type="text" id="speciesSearch" list="speciesList" placeholder="e.g., Scarlet Tanager or SCTA" oninput="filterSpecies(this.value)">
                    <datalist id="speciesList"></datalist>
                </div>
                <div class="input-group">
                    <label>Location (optional)</label>
                    <input type="text" id="speciesLocation" placeholder="City, County, or State">
                </div>
                <div class="input-group">
                    <label>Search Radius (miles)</label>
                    <input type="number" id="speciesSearchRadius" value="25" min="1" max="100" placeholder="Enter miles">
                    <div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 4px;">
                        How far from the location to search (max 31 miles)
                    </div>
                </div>
                <div class="input-group">
                    <label>Time Range</label>
                    <select id="speciesTimeRange">
                        <option value="7">Last 7 days</option>
                        <option value="14">Last 14 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="60">Last 2 months</option>
                        <option value="90">Last 3 months</option>
                        <option value="180">Last 6 months</option>
                        <option value="365">Last year</option>
                    </select>
                    <div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 4px;">
                        How recent should the sightings be?
                    </div>
                </div>
                <button class="primary-btn" onclick="searchSpecies()">üîç Search Species</button>
            </div>

            <!-- Reset Button -->
            <div class="section" id="resetSection" style="display: none;">
                <button class="secondary-btn" onclick="resetAll()">üîÑ Reset All</button>
            </div>
        </div>

        <!-- MAP CONTAINER -->
        <div class="map-container">
            <div id="map">
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f9fafb;">
                    <div style="text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 3em; margin-bottom: 10px;">üó∫Ô∏è</div>
                        <div style="font-size: 1.2em; font-weight: 600;">Loading Map...</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">Please wait a moment</div>
                    </div>
                </div>
            </div>
            
            <!-- Floating Legend -->
            <div class="map-legend">
                <div class="legend-header" onclick="toggleLegend()">
                    <h4>üîë Map Legend</h4>
                    <span class="legend-toggle" id="legendToggle">‚àí</span>
                </div>
                <div class="legend-content" id="legendContent">
                    <div class="legend-item">
                        <div class="legend-marker target"></div>
                        <span>üî¥ Target Species (not on your list)</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 18px; height: 18px; border-radius: 50%; background: #fbbf24; border: 2px solid white; margin-right: 8px;"></div>
                        <span>‚≠ê Expected Seasonal Targets</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 18px; height: 18px; border-radius: 50%; background: #a855f7; border: 2px solid white; margin-right: 8px;"></div>
                        <span>üíé Notable/Rare Targets</span>
                    </div>
                    <div style="margin: 8px 0; padding: 8px 0; border-top: 1px solid var(--border-color); border-bottom: 1px solid #e5e7eb;">
                        <strong style="font-size: 0.85em; color: var(--text-primary); display: block; margin-bottom: 6px;">ABA Rarity Codes:</strong>
                        <div class="legend-item" style="margin: 3px 0;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #10b981; margin-right: 6px;"></div>
                            <span style="font-size: 0.8em;">Code 1 - Common</span>
                        </div>
                        <div class="legend-item" style="margin: 3px 0;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #fbbf24; margin-right: 6px;"></div>
                            <span style="font-size: 0.8em;">Code 2 - Uncommon</span>
                        </div>
                        <div class="legend-item" style="margin: 3px 0;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #f59e0b; margin-right: 6px;"></div>
                            <span style="font-size: 0.8em;">Code 3 - Rare</span>
                        </div>
                        <div class="legend-item" style="margin: 3px 0;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #ef4444; margin-right: 6px;"></div>
                            <span style="font-size: 0.8em;">Code 4 - Very Rare</span>
                        </div>
                        <div class="legend-item" style="margin: 3px 0;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #a855f7; margin-right: 6px;"></div>
                            <span style="font-size: 0.8em;">Code 5 - Mega Rare</span>
                        </div>
                        <div class="legend-item" style="margin: 3px 0;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #374151; margin-right: 6px;"></div>
                            <span style="font-size: 0.8em;">Code 6 - Extirpated</span>
                        </div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker hotspot"></div>
                        <span>üîµ Top 10 Hotspots (numbered 1-10)</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 18px; height: 18px; border-radius: 50%; background: #10b981; color: white; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; margin-right: 8px; border: 2px solid white;">1</div>
                        <span>üü¢ Top 10 Checklists (numbered 1-10)</span>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); font-size: 0.8em; color: var(--text-secondary);">
                        Click any marker to add as waypoint<br>
                        Click target species card to highlight on map
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         BELOW MAP PANELS
         ============================================ -->
    <div class="below-map" id="belowMap" style="display: none;">
        <div class="panels-container">
            <!-- Target Species Panel -->
            <div class="panel" onclick="togglePanel('targetPanel')">
                <div class="panel-header">
                    <h3>üéØ Target Species</h3>
                    <span class="panel-toggle" id="targetPanelToggle">+</span>
                </div>
                <div class="panel-summary">
                    <span id="targetCount">0</span> species you haven't seen
                </div>
                <div class="panel-content" id="targetPanelContent">
                    <div id="targetList"></div>
                </div>
            </div>

            <!-- Sightings Panel -->
            <div class="panel" onclick="togglePanel('sightingsPanel')">
                <div class="panel-header">
                    <h3>üìç Recent Sightings</h3>
                    <span class="panel-toggle" id="sightingsPanelToggle">+</span>
                </div>
                <div class="panel-summary">
                    <span id="sightingsCount">0</span> total observations
                </div>
                <div class="panel-content" id="sightingsPanelContent">
                    <div id="sightingsList"></div>
                </div>
            </div>

            <!-- Stats Panel -->
            <div class="panel" onclick="togglePanel('statsPanel')">
                <div class="panel-header">
                    <h3>üìä Area Statistics</h3>
                    <span class="panel-toggle" id="statsPanelToggle">+</span>
                </div>
                <div class="panel-summary">
                    Your stats vs area overall
                </div>
                <div class="panel-content" id="statsPanelContent">
                    <div id="statsDisplay"></div>
                </div>
            </div>

            <!-- Top eBirders Panel -->
            <div class="panel" onclick="togglePanel('topEBirdersPanel')">
                <div class="panel-header">
                    <h3>üèÜ Top 10 Regional eBirders</h3>
                    <span class="panel-toggle" id="topEBirdersPanelToggle">+</span>
                </div>
                <div class="panel-summary">
                    Leading birders by species count
                </div>
                <div class="panel-content" id="topEBirdersPanelContent" style="padding: 0;">
                    <!-- Controls -->
                    <div style="padding: 15px; background: var(--bg-primary); border-bottom: 1px solid var(--border-color);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label style="display: block; font-size: 0.85em; font-weight: 600; margin-bottom: 5px; color: var(--text-primary);">Region</label>
                                <input type="text" id="topEBirdersRegion" list="regionsList" placeholder="Type region name..." style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.9em;">
                                <datalist id="regionsList"></datalist>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85em; font-weight: 600; margin-bottom: 5px; color: var(--text-primary);">Time Period</label>
                                <select id="topEBirdersTimePeriod" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.9em;">
                                    <option value="life">All Time</option>
                                    <option value="year" selected>2025 (Current Year)</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="loadTopEBirders()" style="width: 100%; padding: 10px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.95em;">
                            üîç Show Top 100
                        </button>
                    </div>
                    
                    <!-- Results -->
                    <div id="topEBirdersList" style="padding: 15px;">
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            Select a region and click "Show Top 100" to see leading eBirders
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         JAVASCRIPT
         ============================================ -->
    <script>
        console.log('üöÄ Traveling Birder v5.0 Starting');

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let map;
        let directionsService;
        let directionsRenderer;
        let originAutocomplete;
        let destinationAutocomplete;
        let areaAutocomplete;
        let speciesLocationAutocomplete;
        
        let ebirdAuthenticated = false;
        let userApiKey = '';
        let userName = '';
        let userList = new Set();
        
        // V7.0 FEATURES - GLOBAL STATE
        let userLifeListSource = 'api'; // 'api', 'csv', or 'manual'
        let darkModeEnabled = false;

        // localStorage keys
        const STORAGE_KEYS = {
            LIFE_LIST: 'travelingBirder_lifeList',
            SETTINGS: 'travelingBirder_settings',
            API_KEY: 'travelingBirder_apiKey',
            TERMS: 'travelingBirder_termsAccepted'
        };
        
        let currentRoute = null;
        let tripWaypoints = [];
        let routeDuration = '';
        
        let allObservations = []; // NEW: Unfiltered raw observations for checklists/hotspots
        let allSightings = [];
        let allHotspots = [];
        let allChecklists = [];
        let targetSpecies = [];
        let expectedTargets = []; // Seasonal expected targets
        let notableTargets = []; // Rare/notable targets
        let targetFrequencies = new Map(); // Species -> frequency data
        
        let markersArray = [];
        let hotspotsArray = [];
        let checklistsArray = [];
        
        // Save/Share Routes
        let savedRoutes = [];
        let currentWaypoints = [];

        // ============================================
        // MAP INITIALIZATION
        // ============================================
        function realInitMap() {
            console.log('üó∫Ô∏è realInitMap() called');
            
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('‚ùå Map element not found');
                return;
            }

            // Clear loading message
            mapElement.innerHTML = '';

            try {
                map = new google.maps.Map(mapElement, {
                    center: { lat: 39.8283, lng: -98.5795 }, // Center of USA
                    zoom: 4,
                    mapTypeControl: true,
                    streetViewControl: false,
                    fullscreenControl: true
                });

                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: false,
                    polylineOptions: {
                        strokeColor: '#10b981',
                        strokeWeight: 4
                    }
                });

                // Initialize autocompletes
                initializeAutocompletes();

                console.log('‚úÖ Map initialized successfully');
                console.log('‚úÖ Autocomplete fields ready');
            } catch (error) {
                console.error('‚ùå Error initializing map:', error);
                mapElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #fef2f2; color: #991b1b; padding: 20px; text-align: center;"><div><div style="font-size: 2em; margin-bottom: 10px;">‚ö†Ô∏è</div><div style="font-weight: 600;">Map Failed to Load</div><div style="font-size: 0.9em; margin-top: 5px;">Please refresh the page</div></div></div>';
            }
        }

        // Wait for page to load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üìÑ DOM Content Loaded');
                if (mapInitPending && typeof realInitMap === 'function') {
                    realInitMap();
                } else {
                    console.log('‚è≥ Waiting for Google Maps API...');
                    // Retry after a delay if API not ready
                    setTimeout(function() {
                        if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                            console.log('‚úÖ Google Maps API loaded, initializing map...');
                            realInitMap();
                        } else {
                            console.error('‚ùå Google Maps API failed to load');
                        }
                    }, 1000);
                }
            });
        } else {
            console.log('üìÑ DOM already loaded');
            if (mapInitPending && typeof realInitMap === 'function') {
                realInitMap();
            } else {
                // Retry initialization
                setTimeout(function() {
                    if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                        console.log('‚úÖ Google Maps API loaded (delayed), initializing map...');
                        realInitMap();
                    }
                }, 1000);
            }
        }

        // ============================================
        // AUTOCOMPLETE INITIALIZATION
        // ============================================
        function initializeAutocompletes() {
            const originInput = document.getElementById('originInput');
            const destinationInput = document.getElementById('destinationInput');
            const areaInput = document.getElementById('areaInput');
            const speciesLocationInput = document.getElementById('speciesLocation');

            if (originInput) {
                originAutocomplete = new google.maps.places.Autocomplete(originInput, {
                    types: ['geocode']
                });
            }

            if (destinationInput) {
                destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput, {
                    types: ['geocode']
                });
            }

            if (areaInput) {
                areaAutocomplete = new google.maps.places.Autocomplete(areaInput, {
                    types: ['geocode']
                });
            }

            if (speciesLocationInput) {
                speciesLocationAutocomplete = new google.maps.places.Autocomplete(speciesLocationInput, {
                    types: ['geocode']
                });
            }
            
            // Load eBird taxonomy for species autocomplete
            loadEBirdTaxonomy();
        }

        // ============================================
        // SEARCH MODE TOGGLE
        // ============================================
        function toggleSearchMode() {
            const mode = document.getElementById('searchMode').value;
            const routeFields = document.getElementById('routeModeFields');
            const areaFields = document.getElementById('areaModeFields');
            
            if (mode === 'route') {
                routeFields.style.display = 'block';
                areaFields.style.display = 'none';
            } else {
                routeFields.style.display = 'none';
                areaFields.style.display = 'block';
            }
        }
        
        // Make function globally accessible
        window.toggleSearchMode = toggleSearchMode;

        // ============================================
        // EBIRD TAXONOMY FOR SPECIES AUTOCOMPLETE
        // ============================================
        let ebirdTaxonomy = [];
        
        async function loadEBirdTaxonomy() {
            try {
                // Fetch eBird taxonomy (subset of common species with codes)
                console.log('üìö Loading eBird species taxonomy...');
                
                // Create a common species database with codes
                ebirdTaxonomy = [
                    { name: 'Snow Goose', code: 'SNGO' },
                    { name: 'Canada Goose', code: 'CANG' },
                    { name: 'Wood Duck', code: 'WODU' },
                    { name: 'Mallard', code: 'MALL' },
                    { name: 'Northern Pintail', code: 'NOPI' },
                    { name: 'Blue-winged Teal', code: 'BWTE' },
                    { name: 'Northern Shoveler', code: 'NSHO' },
                    { name: 'Green-winged Teal', code: 'GWTE' },
                    { name: 'Ring-necked Duck', code: 'RNDU' },
                    { name: 'Greater Scaup', code: 'GRSC' },
                    { name: 'Lesser Scaup', code: 'LESC' },
                    { name: 'Common Goldeneye', code: 'COGO' },
                    { name: 'Hooded Merganser', code: 'HOME' },
                    { name: 'Common Merganser', code: 'COME' },
                    { name: 'Red-breasted Merganser', code: 'RBME' },
                    { name: 'Wild Turkey', code: 'WITU' },
                    { name: 'Northern Bobwhite', code: 'NOBO' },
                    { name: 'Common Loon', code: 'COLO' },
                    { name: 'Pied-billed Grebe', code: 'PBGR' },
                    { name: 'Double-crested Cormorant', code: 'DCCO' },
                    { name: 'American White Pelican', code: 'AWPE' },
                    { name: 'Great Blue Heron', code: 'GBHE' },
                    { name: 'Great Egret', code: 'GREG' },
                    { name: 'Snowy Egret', code: 'SNEG' },
                    { name: 'Green Heron', code: 'GRHE' },
                    { name: 'Black-crowned Night-Heron', code: 'BCNH' },
                    { name: 'Turkey Vulture', code: 'TUVU' },
                    { name: 'Osprey', code: 'OSPR' },
                    { name: 'Bald Eagle', code: 'BAEA' },
                    { name: 'Northern Harrier', code: 'NOHA' },
                    { name: 'Sharp-shinned Hawk', code: 'SSHA' },
                    { name: 'Cooper\'s Hawk', code: 'COHA' },
                    { name: 'Red-shouldered Hawk', code: 'RSHA' },
                    { name: 'Red-tailed Hawk', code: 'RTHA' },
                    { name: 'American Kestrel', code: 'AMKE' },
                    { name: 'Merlin', code: 'MERL' },
                    { name: 'Peregrine Falcon', code: 'PEFA' },
                    { name: 'American Coot', code: 'AMCO' },
                    { name: 'Killdeer', code: 'KILL' },
                    { name: 'American Woodcock', code: 'AMWO' },
                    { name: 'Wilson\'s Snipe', code: 'WISN' },
                    { name: 'Spotted Sandpiper', code: 'SPSA' },
                    { name: 'Greater Yellowlegs', code: 'GRYE' },
                    { name: 'Lesser Yellowlegs', code: 'LEYE' },
                    { name: 'Ring-billed Gull', code: 'RBGU' },
                    { name: 'Herring Gull', code: 'HERG' },
                    { name: 'Rock Pigeon', code: 'ROPI' },
                    { name: 'Mourning Dove', code: 'MODO' },
                    { name: 'Yellow-billed Cuckoo', code: 'YBCU' },
                    { name: 'Black-billed Cuckoo', code: 'BBCU' },
                    { name: 'Eastern Screech-Owl', code: 'EASO' },
                    { name: 'Great Horned Owl', code: 'GHOW' },
                    { name: 'Barred Owl', code: 'BADO' },
                    { name: 'Common Nighthawk', code: 'CONI' },
                    { name: 'Chimney Swift', code: 'CHSW' },
                    { name: 'Ruby-throated Hummingbird', code: 'RTHU' },
                    { name: 'Belted Kingfisher', code: 'BEKI' },
                    { name: 'Red-headed Woodpecker', code: 'RHWO' },
                    { name: 'Red-bellied Woodpecker', code: 'RBWO' },
                    { name: 'Downy Woodpecker', code: 'DOWO' },
                    { name: 'Hairy Woodpecker', code: 'HAWO' },
                    { name: 'Northern Flicker', code: 'NOFL' },
                    { name: 'Pileated Woodpecker', code: 'PIWO' },
                    { name: 'Eastern Wood-Pewee', code: 'EAWP' },
                    { name: 'Least Flycatcher', code: 'LEFL' },
                    { name: 'Eastern Phoebe', code: 'EAPH' },
                    { name: 'Great Crested Flycatcher', code: 'GCFL' },
                    { name: 'Eastern Kingbird', code: 'EAKI' },
                    { name: 'White-eyed Vireo', code: 'WEVI' },
                    { name: 'Yellow-throated Vireo', code: 'YTVI' },
                    { name: 'Blue-headed Vireo', code: 'BHVI' },
                    { name: 'Warbling Vireo', code: 'WAVI' },
                    { name: 'Red-eyed Vireo', code: 'REVI' },
                    { name: 'Blue Jay', code: 'BLJA' },
                    { name: 'American Crow', code: 'AMCR' },
                    { name: 'Fish Crow', code: 'FICR' },
                    { name: 'Common Raven', code: 'CORA' },
                    { name: 'Tree Swallow', code: 'TRES' },
                    { name: 'Bank Swallow', code: 'BANS' },
                    { name: 'Barn Swallow', code: 'BARS' },
                    { name: 'Cliff Swallow', code: 'CLSW' },
                    { name: 'Carolina Chickadee', code: 'CACH' },
                    { name: 'Black-capped Chickadee', code: 'BCCH' },
                    { name: 'Tufted Titmouse', code: 'TUFT' },
                    { name: 'Red-breasted Nuthatch', code: 'RBNU' },
                    { name: 'White-breasted Nuthatch', code: 'WBNU' },
                    { name: 'Brown Creeper', code: 'BRCR' },
                    { name: 'House Wren', code: 'HOWR' },
                    { name: 'Winter Wren', code: 'WIWR' },
                    { name: 'Carolina Wren', code: 'CARW' },
                    { name: 'Blue-gray Gnatcatcher', code: 'BGGN' },
                    { name: 'Golden-crowned Kinglet', code: 'GCKI' },
                    { name: 'Ruby-crowned Kinglet', code: 'RCKI' },
                    { name: 'Eastern Bluebird', code: 'EABL' },
                    { name: 'Veery', code: 'VEER' },
                    { name: 'Gray-cheeked Thrush', code: 'GCTH' },
                    { name: 'Swainson\'s Thrush', code: 'SWTH' },
                    { name: 'Hermit Thrush', code: 'HETH' },
                    { name: 'Wood Thrush', code: 'WOTH' },
                    { name: 'American Robin', code: 'AMRO' },
                    { name: 'Gray Catbird', code: 'GRCA' },
                    { name: 'Brown Thrasher', code: 'BRTH' },
                    { name: 'Northern Mockingbird', code: 'NOMO' },
                    { name: 'European Starling', code: 'EUST' },
                    { name: 'Cedar Waxwing', code: 'CEDW' },
                    { name: 'House Sparrow', code: 'HOSP' },
                    { name: 'American Goldfinch', code: 'AMGO' },
                    { name: 'Purple Finch', code: 'PUFI' },
                    { name: 'House Finch', code: 'HOFI' },
                    { name: 'Pine Siskin', code: 'PISI' },
                    { name: 'Chipping Sparrow', code: 'CHSP' },
                    { name: 'Field Sparrow', code: 'FISP' },
                    { name: 'Dark-eyed Junco', code: 'DEJU' },
                    { name: 'White-crowned Sparrow', code: 'WCSP' },
                    { name: 'White-throated Sparrow', code: 'WTSP' },
                    { name: 'Song Sparrow', code: 'SOSP' },
                    { name: 'Swamp Sparrow', code: 'SWSP' },
                    { name: 'Eastern Towhee', code: 'EATO' },
                    { name: 'Scarlet Tanager', code: 'SCTA' },
                    { name: 'Northern Cardinal', code: 'NOCA' },
                    { name: 'Rose-breasted Grosbeak', code: 'RBGR' },
                    { name: 'Indigo Bunting', code: 'INBU' },
                    { name: 'Bobolink', code: 'BOBO' },
                    { name: 'Red-winged Blackbird', code: 'RWBL' },
                    { name: 'Eastern Meadowlark', code: 'EAME' },
                    { name: 'Common Grackle', code: 'COGR' },
                    { name: 'Brown-headed Cowbird', code: 'BHCO' },
                    { name: 'Orchard Oriole', code: 'OROR' },
                    { name: 'Baltimore Oriole', code: 'BAOR' },
                    { name: 'Ovenbird', code: 'OVEN' },
                    { name: 'Northern Waterthrush', code: 'NOWA' },
                    { name: 'Black-and-white Warbler', code: 'BAWW' },
                    { name: 'Prothonotary Warbler', code: 'PROW' },
                    { name: 'Tennessee Warbler', code: 'TEWA' },
                    { name: 'Nashville Warbler', code: 'NAWA' },
                    { name: 'Common Yellowthroat', code: 'COYE' },
                    { name: 'American Redstart', code: 'AMRE' },
                    { name: 'Cape May Warbler', code: 'CMWA' },
                    { name: 'Northern Parula', code: 'NOPA' },
                    { name: 'Magnolia Warbler', code: 'MAWA' },
                    { name: 'Bay-breasted Warbler', code: 'BBWA' },
                    { name: 'Blackburnian Warbler', code: 'BLBW' },
                    { name: 'Yellow Warbler', code: 'YEWA' },
                    { name: 'Chestnut-sided Warbler', code: 'CSWA' },
                    { name: 'Blackpoll Warbler', code: 'BLPW' },
                    { name: 'Black-throated Blue Warbler', code: 'BTBW' },
                    { name: 'Palm Warbler', code: 'PAWA' },
                    { name: 'Pine Warbler', code: 'PIWA' },
                    { name: 'Yellow-rumped Warbler', code: 'YRWA' },
                    { name: 'Black-throated Green Warbler', code: 'BTNW' },
                    { name: 'Canada Warbler', code: 'CAWA' },
                    { name: 'Wilson\'s Warbler', code: 'WIWA' }
                ];
                
                console.log(`‚úÖ Loaded ${ebirdTaxonomy.length} species with codes`);
                populateSpeciesDatalist();
            } catch (error) {
                console.error('‚ùå Error loading taxonomy:', error);
            }
        }

        function populateSpeciesDatalist() {
            const datalist = document.getElementById('speciesList');
            if (!datalist) return;
            
            datalist.innerHTML = '';
            ebirdTaxonomy.forEach(species => {
                const option = document.createElement('option');
                option.value = species.name;
                option.setAttribute('data-code', species.code);
                option.textContent = `${species.name} (${species.code})`;
                datalist.appendChild(option);
            });
        }

        function filterSpecies(value) {
            if (!value || value.length < 2) return;
            
            const datalist = document.getElementById('speciesList');
            if (!datalist) return;
            
            const searchTerm = value.toUpperCase();
            const filtered = ebirdTaxonomy.filter(species => 
                species.name.toUpperCase().includes(searchTerm) ||
                species.code.includes(searchTerm)
            );
            
            datalist.innerHTML = '';
            filtered.forEach(species => {
                const option = document.createElement('option');
                option.value = species.name;
                option.setAttribute('data-code', species.code);
                option.textContent = `${species.name} (${species.code})`;
                datalist.appendChild(option);
            });
        }

        // ============================================
        // V7.0 FEATURES - LOCALSTORAGE MANAGEMENT
        // ============================================
        
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                return false;
            }
        }

        function loadFromLocalStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return null;
            }
        }

        function saveLifeList(species, source = 'api') {
            const data = {
                species: Array.isArray(species) ? species : Array.from(species),
                source: source,
                updated: new Date().toISOString(),
                count: species.length || species.size || 0
            };
            saveToLocalStorage(STORAGE_KEYS.LIFE_LIST, data);
            userLifeListSource = source;
            console.log(`üíæ Saved ${data.count} species from ${source}`);
        }

        function loadLifeList() {
            const data = loadFromLocalStorage(STORAGE_KEYS.LIFE_LIST);
            if (data && data.species) {
                userList = new Set(data.species);
                userLifeListSource = data.source || 'api';
                console.log(`üì• Loaded ${data.count} species from ${data.source}`);
                return new Set(data.species);
            }
            return new Set();
        }

        function saveSettings(settings) {
            saveToLocalStorage(STORAGE_KEYS.SETTINGS, settings);
        }

        function loadSettings() {
            return loadFromLocalStorage(STORAGE_KEYS.SETTINGS) || {
                darkMode: false,
                defaultRadius: 15,
                defaultTimeRange: 30
            };
        }

        function toggleDarkMode() {
            darkModeEnabled = !darkModeEnabled;
            document.documentElement.setAttribute('data-theme', darkModeEnabled ? 'dark' : 'light');
            
            const settings = loadSettings();
            settings.darkMode = darkModeEnabled;
            saveSettings(settings);
            
            console.log(`üåì Dark mode: ${darkModeEnabled ? 'ON' : 'OFF'}`);
            closeAccountMenu();
        }

        // ============================================
        // V7.0 FEATURES - CSV IMPORT/EXPORT
        // ============================================
        
        function importeBirdCSV(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    reject(new Error('No file provided'));
                    return;
                }

                if (typeof Papa === 'undefined') {
                    reject(new Error('Papaparse library not loaded'));
                    return;
                }

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        try {
                            const species = new Set();
                            
                            results.data.forEach(row => {
                                const commonName = row['Common Name'] || row['Species'] || row['species'];
                                if (commonName && commonName.trim()) {
                                    species.add(commonName.trim());
                                }
                            });

                            if (species.size === 0) {
                                reject(new Error('No species found in CSV. Make sure it\'s an eBird export with a "Common Name" column.'));
                                return;
                            }

                            // Save to localStorage
                            saveLifeList(Array.from(species), 'csv');
                            userList = species;

                            console.log(`‚úÖ Imported ${species.size} species from CSV`);
                            resolve(species);
                        } catch (error) {
                            reject(error);
                        }
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }

        function exportSpeciesListCSV(species, filename = 'my-bird-list.csv') {
            const speciesArray = Array.isArray(species) ? species : Array.from(species);
            
            const csv = 'Common Name\n' + speciesArray.join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log(`üì• Exported ${speciesArray.length} species to ${filename}`);
            closeAccountMenu();
        }

        function exportCurrentSearchCSV() {
            if (!allSightings || allSightings.length === 0) {
                alert('No search results to export. Please perform a search first.');
                return;
            }

            const uniqueSpecies = [...new Set(allSightings.map(s => s.comName))];
            exportSpeciesListCSV(uniqueSpecies, 'search-results.csv');
        }

        function exportLifeListCSV() {
            if (!userList || userList.size === 0) {
                alert('No life list to export. Please connect to eBird or import a CSV first.');
                return;
            }

            exportSpeciesListCSV(userList, 'my-life-list.csv');
        }

        // ============================================
        // V7.0 FEATURES - MODAL & UI CONTROLS
        // ============================================
        
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function openCSVImportModal() {
            openModal('csvImportModal');
            closeAccountMenu();
        }

        function showTermsModal() {
            openModal('termsModal');
            closeAccountMenu();
        }

        function acceptTerms() {
            saveToLocalStorage(STORAGE_KEYS.TERMS, {
                accepted: true,
                date: new Date().toISOString()
            });
            closeModal('termsModal');
            console.log('‚úÖ Terms accepted');
        }

        async function handleCSVUpload() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file first');
                return;
            }
            
            showLoading('Importing CSV...');
            
            try {
                const species = await importeBirdCSV(file);
                
                hideLoading();
                closeModal('csvImportModal');
                
                alert(`‚úÖ Successfully imported ${species.size} species!`);
                
                // Update header
                updateHeaderWithLifeList();
                
                // Reload any active search
                if (allSightings && allSightings.length > 0) {
                    displayBirds();
                }
                
            } catch (error) {
                hideLoading();
                alert('Error importing CSV: ' + error.message);
                console.error(error);
            }
        }

        function toggleAccountMenu() {
            const menu = document.getElementById('accountMenu');
            if (menu) {
                menu.classList.toggle('active');
            }
        }

        function closeAccountMenu() {
            const menu = document.getElementById('accountMenu');
            if (menu) {
                menu.classList.remove('active');
            }
        }

        function updateHeaderWithLifeList() {
            const headerDiv = document.getElementById('ebirdHeader');
            if (!headerDiv) return;
            
            const displayName = userName && userName !== 'eBird User' ? userName : 'eBird User';
            
            // Determine status and create detailed display
            let statusHTML = '';
            
            if (userList.size > 0) {
                const sourceIcon = userLifeListSource === 'csv' ? 'üìÑ' : 'üì°';
                const sourceText = userLifeListSource === 'csv' ? 'Full CSV' : 'API (30d)';
                const sourceColor = userLifeListSource === 'csv' ? '#10b981' : '#f59e0b';
                
                statusHTML = `
                    <div class="ebird-connected">
                        <div style="display: flex; flex-direction: column; gap: 4px; flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="ebird-connected-text">‚úÖ Connected: ${displayName}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px; font-size: 0.85em;">
                                <span style="color: var(--text-primary); font-weight: 600;">
                                    ü¶© ${userList.size} species
                                </span>
                                <span style="background: ${sourceColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.85em; font-weight: 600;">
                                    ${sourceIcon} ${sourceText}
                                </span>
                            </div>
                        </div>
                        <button class="disconnect-btn" onclick="disconnectEbird()">Disconnect</button>
                    </div>
                `;
            } else {
                // Connected but no species loaded
                statusHTML = `
                    <div class="ebird-connected">
                        <div style="display: flex; flex-direction: column; gap: 4px; flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="ebird-connected-text">‚úÖ Connected: ${displayName}</span>
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">
                                ‚ö†Ô∏è No species loaded - Import CSV or wait for API
                            </div>
                        </div>
                        <button class="disconnect-btn" onclick="disconnectEbird()">Disconnect</button>
                    </div>
                `;
            }
            
            headerDiv.innerHTML = statusHTML;
        }

        // Update connection status display on page load
        function updateConnectionStatus() {
            const headerDiv = document.getElementById('ebirdHeader');
            if (!headerDiv) return;
            
            // Check if connected
            if (ebirdAuthenticated && userApiKey) {
                updateHeaderWithLifeList();
            } else {
                // Check if we have stored life list but not connected
                const storedList = loadFromLocalStorage(STORAGE_KEYS.LIFE_LIST);
                if (storedList && storedList.species && storedList.species.length > 0) {
                    headerDiv.innerHTML = `
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 8px; margin-bottom: 5px;">
                            <div style="font-size: 0.85em; color: #92400e; font-weight: 600;">
                                üìÑ ${storedList.count} species loaded from ${storedList.source}
                            </div>
                            <div style="font-size: 0.75em; color: #92400e; margin-top: 2px;">
                                Connect to eBird for live data
                            </div>
                        </div>
                        <div class="ebird-login">
                            <input type="password" id="apiKey" placeholder="eBird API Key">
                            <button onclick="connectEbird()">Connect</button>
                        </div>
                        <div style="text-align: center; font-size: 0.75em; color: var(--text-secondary);">
                            Get free API key: <a href="https://ebird.org/api/keygen" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: none;">ebird.org/api/keygen</a>
                        </div>
                    `;
                }
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('accountMenu');
            const accountBtn = event.target.closest('.account-dropdown');
            
            if (menu && !accountBtn && !event.target.closest('.account-menu')) {
                menu.classList.remove('active');
            }
        });

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Load saved settings
            const settings = loadSettings();
            darkModeEnabled = settings.darkMode || false;
            if (darkModeEnabled) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            
            // Load life list from localStorage if exists
            const savedLifeList = loadLifeList();
            if (savedLifeList.size > 0) {
                console.log(`üì• Loaded ${savedLifeList.size} species from localStorage (${userLifeListSource})`);
                // Update header to show loaded status
                updateConnectionStatus();
            }
            
            // Check if terms accepted - show on first visit
            const termsData = loadFromLocalStorage(STORAGE_KEYS.TERMS);
            if (!termsData || !termsData.accepted) {
                setTimeout(() => showTermsModal(), 2000);
            }
            
            console.log('‚úÖ v7.0 initialized with CSV import/export features');
        });

        // ============================================
        // EBIRD AUTHENTICATION
        // ============================================
        async function connectEbird() {
            const apiKeyInput = document.getElementById('apiKey');
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey) {
                alert('Please enter your eBird API key');
                return;
            }

            console.log('üîë Connecting to eBird...');
            showLoading('Connecting to eBird...');

            try {
                // Test API key by fetching user's observations
                const response = await fetch(
                    `https://api.ebird.org/v2/data/obs/US/recent?maxResults=10`,
                    { headers: { 'X-eBirdApiToken': apiKey } }
                );

                if (!response.ok) {
                    hideLoading();
                    throw new Error('Invalid API key');
                }

                // Fetch user's complete life list
                updateLoadingStatus('Loading your species lists...');
                await fetchUserLifeList(apiKey);

                userApiKey = apiKey;
                ebirdAuthenticated = true;

                updateHeaderUI();
                showSections();
                hideLoading();

                console.log(`‚úÖ Connected! User has ${userList.size} species`);
                
            } catch (error) {
                console.error('‚ùå eBird connection failed:', error);
                hideLoading();
                alert('Failed to connect to eBird. Please check your API key.');
            }
        }

        async function fetchUserLifeList(apiKey) {
            console.log('üìã Fetching your eBird life list...');
            updateLoadingStatus('Loading your personal species lists...');
            
            const allSpecies = new Set();
            
            try {
                // KEY FIX: Use detail=full to get userDisplayName in responses!
                console.log('üîç Using detail=full to get observer information...');
                
                // Sample a few regions to identify the user
                const testRegions = ['US-VT', 'US-MA', 'US-NY', 'US-NH'];
                
                for (const region of testRegions) {
                    try {
                        // CRITICAL: Add detail=full parameter!
                        const response = await fetch(
                            `https://api.ebird.org/v2/data/obs/${region}/recent?maxResults=200&back=30&detail=full`,
                            { headers: { 'X-eBirdApiToken': apiKey } }
                        );
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            // Get username from first observation with userDisplayName
                            if (!userName && data.length > 0) {
                                for (const obs of data) {
                                    if (obs.userDisplayName) {
                                        userName = obs.userDisplayName;
                                        console.log(`üë§ Identified user: ${userName}`);
                                        break;
                                    }
                                }
                            }
                            
                            // If we found a username, collect their species
                            if (userName) {
                                data.forEach(obs => {
                                    if (obs.userDisplayName === userName) {
                                        allSpecies.add(obs.comName);
                                    }
                                });
                            }
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 100));
                    } catch (e) {
                        console.warn(`Couldn't fetch from ${region}`);
                    }
                    
                    // If we found the user, get more of their species
                    if (userName && allSpecies.size > 10) break;
                }
                
                // Now get more species from this user across many regions
                if (userName) {
                    console.log(`üìç Fetching ${userName}'s observations from multiple regions...`);
                    
                    const allRegions = [
                        'US-VT', 'US-NH', 'US-ME', 'US-MA', 'US-CT', 'US-RI',
                        'US-NY', 'US-NJ', 'US-PA', 'US-MD', 'US-VA',
                        'US-FL', 'US-TX', 'US-CA', 'US-AZ', 'US-CO'
                    ];
                    
                    for (const region of allRegions) {
                        try {
                            const response = await fetch(
                                `https://api.ebird.org/v2/data/obs/${region}/recent?maxResults=200&back=30&detail=full`,
                                { headers: { 'X-eBirdApiToken': apiKey } }
                            );
                            
                            if (response.ok) {
                                const data = await response.json();
                                const beforeCount = allSpecies.size;
                                
                                data.forEach(obs => {
                                    if (obs.userDisplayName === userName) {
                                        allSpecies.add(obs.comName);
                                    }
                                });
                                
                                const newSpecies = allSpecies.size - beforeCount;
                                if (newSpecies > 0) {
                                    console.log(`üìç ${region}: +${newSpecies} species (${allSpecies.size} total)`);
                                }
                            }
                            
                            await new Promise(resolve => setTimeout(resolve, 50));
                        } catch (e) {
                            console.warn(`Couldn't fetch from ${region}`);
                        }
                        
                        // Stop if we've found a good amount
                        if (allSpecies.size > 500) break;
                    }
                }

            } catch (error) {
                console.error('Error fetching life list:', error);
            }

            userList = allSpecies;
            
            // V7.0: Check if user has CSV imported list
            const storedList = loadFromLocalStorage(STORAGE_KEYS.LIFE_LIST);
            if (storedList && storedList.source === 'csv') {
                console.log(`üì• Found CSV-imported life list (${storedList.count} species)`);
                console.log(`üîÑ Merging with API data (${allSpecies.size} species from last 30 days)`);
                
                // Merge: Keep CSV list, add any new species from API
                storedList.species.forEach(sp => userList.add(sp));
                
                // Update stored list with merged data
                saveLifeList(Array.from(userList), 'csv');
                console.log(`‚úÖ Total: ${userList.size} species (CSV + recent API)`);
            } else {
                // No CSV, save API list
                saveLifeList(Array.from(userList), 'api');
                console.log(`‚úÖ Loaded ${userList.size} species from ${userName || 'user'}'s observations (last 30 days via API)`);
            }
            
            if (userList.size === 0) {
                console.warn('‚ö†Ô∏è No personal observations found in last 30 days.');
                console.log('üí° Tip: Import your eBird CSV for complete history (Menu ‚Üí Import Life List CSV)');
            }
            
            // Update header to show count
            updateHeaderWithLifeList();
            
            // Store for different list types
            window.userLifeList = new Set(userList);
            window.userYearList = new Set(userList);
            window.userMonthList = new Set(userList);
            window.userStateList = new Set(userList);
            window.userCountyList = new Set(userList);
            window.userCountryList = new Set(userList);
            window.userABAList = new Set(userList);
        }

        // ============================================
        // EXPECTED & NOTABLE TARGETS
        // ============================================
        
        async function fetchExpectedTargets(regionCode) {
            console.log(`‚≠ê Fetching expected seasonal targets for ${regionCode}...`);
            
            try {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() + 1;
                const day = today.getDate();
                
                const url = `https://api.ebird.org/v2/product/top100/${regionCode}/${year}/${month}/${day}`;
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });
                
                if (response.ok) {
                    const top100 = await response.json();
                    console.log(`‚úÖ Got ${top100.length} expected species for ${regionCode}`);
                    
                    // top100 is array of {speciesCode: "...", frequency: 0.85}
                    // Store frequencies for display
                    top100.forEach(sp => {
                        targetFrequencies.set(sp.speciesCode, sp.frequency || 0);
                    });
                    
                    // Filter to species user hasn't seen
                    const userSeenSpecies = getTargetList();
                    const expectedTargetsData = top100.filter(sp => {
                        // Need to convert speciesCode to common name
                        // This will be resolved when we match with observations
                        return true; // We'll filter properly in displayBirds
                    });
                    
                    return expectedTargetsData;
                } else {
                    console.warn(`‚ö†Ô∏è Could not fetch top 100 for ${regionCode}`);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching expected targets:', error);
                return [];
            }
        }
        
        async function fetchNotableTargets(regionCode) {
            console.log(`üíé Fetching notable/rare targets for ${regionCode}...`);
            
            try {
                const url = `https://api.ebird.org/v2/data/obs/${regionCode}/recent/notable?back=14`;
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });
                
                if (response.ok) {
                    const notable = await response.json();
                    console.log(`‚úÖ Got ${notable.length} notable sightings in ${regionCode}`);
                    
                    // Filter to species user hasn't seen
                    const userSeenSpecies = getTargetList();
                    const notableTargetsData = notable.filter(obs => 
                        !userSeenSpecies.has(obs.comName)
                    );
                    
                    console.log(`üíé Found ${notableTargetsData.length} notable targets you haven't seen`);
                    return notableTargetsData;
                } else {
                    console.warn(`‚ö†Ô∏è Could not fetch notable for ${regionCode}`);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching notable targets:', error);
                return [];
            }
        }
        
        function getRegionFromCoordinates(lat, lng) {
            // Simple US state detection based on coordinates
            // This is a rough approximation - eBird uses more precise regions
            
            if (lat >= 44 && lat <= 45.5 && lng >= -73.5 && lng <= -71) return 'US-VT';
            if (lat >= 42 && lat <= 43 && lng >= -73.5 && lng <= -69.5) return 'US-MA';
            if (lat >= 40 && lat <= 45 && lng >= -80 && lng <= -71) return 'US-NY';
            if (lat >= 24 && lat <= 31 && lng >= -88 && lng <= -79.5) return 'US-FL';
            if (lat >= 25 && lat <= 36.5 && lng >= -107 && lng <= -93) return 'US-TX';
            if (lat >= 32 && lat <= 42 && lng >=-125 && lng <= -114) return 'US-CA';
            
            // Default to US if we can't determine state
            return 'US';
        }


        function disconnectEbird() {
            ebirdAuthenticated = false;
            userApiKey = '';
            userList.clear();
            
            updateHeaderUI();
            hideSections();
            resetAll();
        }

        function updateHeaderUI() {
            const headerDiv = document.getElementById('ebirdHeader');
            
            if (ebirdAuthenticated) {
                const displayName = userName && userName !== 'eBird User' ? `${userName} - ` : '';
                const speciesText = userList.size > 0 ? `${userList.size} species` : 'Connected';
                headerDiv.innerHTML = `
                    <div class="ebird-connected">
                        <span class="ebird-connected-text">‚úÖ ${displayName}${speciesText}</span>
                        <button class="disconnect-btn" onclick="disconnectEbird()">Disconnect</button>
                    </div>
                `;
            } else {
                headerDiv.innerHTML = `
                    <div class="ebird-login">
                        <input type="password" id="apiKey" placeholder="eBird API Key">
                        <button onclick="connectEbird()">Connect</button>
                    </div>
                    <div style="text-align: center; font-size: 0.75em; color: var(--text-secondary);">
                        Get free API key: <a href="https://ebird.org/api/keygen" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: none;">ebird.org/api/keygen</a>
                    </div>
                `;
            }
        }

        function showSections() {
            document.getElementById('layersSection').style.display = 'block';
            document.getElementById('abaRaritySection').style.display = 'block';
            document.getElementById('resetSection').style.display = 'block';
        }

        function hideSections() {
            document.getElementById('layersSection').style.display = 'none';
            document.getElementById('abaRaritySection').style.display = 'none';
            document.getElementById('resetSection').style.display = 'none';
            document.getElementById('belowMap').style.display = 'none';
        }

        // ============================================
        // TARGET SPECIES FILTER
        // ============================================
        function applyTargetFilter() {
            if (!currentRoute || allSightings.length === 0) {
                return;
            }
            
            // Re-display birds with current filter
            displayBirds();
        }

        function getTargetList() {
            const listType = document.getElementById('targetListType').value;
            
            switch(listType) {
                case 'life': return window.userLifeList || userList;
                case 'year': return window.userYearList || userList;
                case 'month': return window.userMonthList || userList;
                case 'state': return window.userStateList || userList;
                case 'county': return window.userCountyList || userList;
                case 'country': return window.userCountryList || userList;
                case 'aba': return window.userABAList || userList;
                case 'all':
                default: return new Set(); // Empty set means show all
            }
        }

        // ============================================
        // ABA RARITY CODES
        // ============================================
        const ABA_RARITY_CODES = {
            // Code 1 - Common (Green)
            1: ['American Robin', 'Blue Jay', 'Northern Cardinal', 'Mourning Dove', 'American Crow',
                'House Sparrow', 'European Starling', 'Rock Pigeon', 'Red-winged Blackbird', 'Common Grackle'],
            
            // Code 2 - Uncommon (Yellow)
            2: ['Scarlet Tanager', 'Wood Thrush', 'Baltimore Oriole', 'Rose-breasted Grosbeak'],
            
            // Code 3 - Rare (Orange)
            3: ['Painted Bunting', 'Varied Thrush', 'Mountain Bluebird', 'Vermilion Flycatcher'],
            
            // Code 4 - Very Rare (Red)
            4: ['Kirtland\'s Warbler', 'California Condor', 'Whooping Crane', 'Spotted Owl'],
            
            // Code 5 - Mega Rare (Purple)
            5: ['Ivory-billed Woodpecker', 'Eskimo Curlew', 'Bachman\'s Warbler'],
            
            // Code 6 - Cannot be Found (Black)
            6: ['Passenger Pigeon', 'Carolina Parakeet', 'Great Auk']
        };

        function getABARarityCode(speciesName) {
            for (const [code, species] of Object.entries(ABA_RARITY_CODES)) {
                if (species.some(s => speciesName.includes(s) || s.includes(speciesName))) {
                    return parseInt(code);
                }
            }
            return 1; // Default to common if not in database
        }

        function getABARarityColor(code) {
            const colors = {
                1: '#10b981', // Green
                2: '#fbbf24', // Yellow
                3: '#f59e0b', // Orange
                4: '#ef4444', // Red
                5: '#a855f7', // Purple
                6: '#374151'  // Black/Gray
            };
            return colors[code] || '#10b981';
        }

        function shouldShowABARarity(code) {
            const checkbox = document.getElementById(`showABA${code}`);
            return checkbox ? checkbox.checked : true;
        }

        // ============================================
        // LOADING INDICATOR HELPERS
        // ============================================
        function showLoading(message = 'Searching...') {
            const indicator = document.getElementById('loadingIndicator');
            const status = document.getElementById('loadingStatus');
            if (indicator) {
                indicator.style.display = 'block';
                if (status) status.textContent = message;
            }
        }
        
        function hideLoading() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) indicator.style.display = 'none';
        }
        
        function updateLoadingStatus(message) {
            const status = document.getElementById('loadingStatus');
            if (status) status.textContent = message;
        }
        
        // ============================================
        // RADIUS VALIDATION (eBird max is 50km)
        // ============================================
        function validateAndConvertRadius(miles) {
            // eBird API accepts distance in km, max 50km
            const km = miles * 1.60934;
            if (km > 50) {
                console.warn(`‚ö†Ô∏è Radius ${miles} miles (${km.toFixed(1)}km) exceeds eBird max of 50km. Using 50km.`);
                return 50;
            }
            return Math.round(km);
        }

        // ============================================
        // SEARCH DISPATCHER
        // ============================================
        function toggleRegionOnlyMode() {
            const checkbox = document.getElementById('regionOnlyMode');
            const radiusInput = document.getElementById('searchRadius');
            
            if (checkbox.checked) {
                radiusInput.disabled = true;
                radiusInput.style.opacity = '0.5';
                console.log('üó∫Ô∏è Region-only mode enabled - will search within region boundaries only');
            } else {
                radiusInput.disabled = false;
                radiusInput.style.opacity = '1';
                console.log('üìç Radius mode enabled - will use specified radius');
            }
        }

        async function performSearch() {
            const searchMode = document.getElementById('searchMode').value;
            
            if (searchMode === 'route') {
                await planRoute();
            } else {
                await searchArea();
            }
        }

        // ============================================
        // AREA-ONLY SEARCH
        // ============================================
        async function searchArea() {
            if (!ebirdAuthenticated) {
                alert('Please connect to eBird first');
                return;
            }

            const areaInput = document.getElementById('areaInput').value;
            if (!areaInput) {
                alert('Please enter a location to search');
                return;
            }

            console.log(`üó∫Ô∏è Searching area: ${areaInput}`);
            showLoading('Analyzing area...');

            // Clear previous results
            clearMarkers();
            clearHotspots();
            clearChecklists();
            allSightings = [];
            allHotspots = [];
            allChecklists = [];
            targetSpecies = [];

            try {
                // Get geocode for the area
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: areaInput }, async (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const geometry = results[0].geometry;
                        const bounds = geometry.bounds || geometry.viewport;
                        
                        // Get center for initial positioning
                        const center = bounds.getCenter();
                        map.setCenter(center);
                        
                        // Check if region-only mode is enabled
                        const regionOnlyMode = document.getElementById('regionOnlyMode').checked;
                        const timeRange = parseInt(document.getElementById('timeRange').value);
                        
                        if (regionOnlyMode) {
                            // Region-only mode: Use eBird region code directly
                            console.log('üó∫Ô∏è Region-only mode: Searching within region boundaries');
                            map.fitBounds(bounds);
                            
                            // Try to convert location to eBird region code
                            const regionCode = await getRegionCodeFromLocation(areaInput);
                            
                            if (regionCode) {
                                console.log(`üìç Using eBird region code: ${regionCode}`);
                                await performRegionSearch(regionCode, timeRange);
                            } else {
                                console.log('‚ö†Ô∏è Could not determine region code, falling back to grid search');
                                const radiusMiles = parseInt(document.getElementById('searchRadius').value);
                                const radiusKm = validateAndConvertRadius(radiusMiles);
                                await performGridSearch(bounds, radiusKm, timeRange);
                            }
                        } else {
                            // Standard radius-based search
                            // Calculate area size to determine search strategy
                            const ne = bounds.getNorthEast();
                            const sw = bounds.getSouthWest();
                            const widthMiles = getDistance(ne.lat(), ne.lng(), ne.lat(), sw.lng());
                            const heightMiles = getDistance(ne.lat(), ne.lng(), sw.lat(), ne.lng());
                            const areaSizeMiles = Math.max(widthMiles, heightMiles);
                            
                            console.log(`üìè Area size: ${areaSizeMiles.toFixed(1)} miles (${widthMiles.toFixed(1)} √ó ${heightMiles.toFixed(1)})`);
                            
                            // Get radius and validate
                            const radiusMiles = parseInt(document.getElementById('searchRadius').value);
                            const radiusKm = validateAndConvertRadius(radiusMiles);
                            
                            // Determine if we need overlapping grid search
                            const maxSingleSearchMiles = 31; // eBird max radius
                            
                            if (areaSizeMiles <= maxSingleSearchMiles * 2) {
                                // Small area - single search
                                console.log('üìç Small area - using single search');
                                map.setZoom(10);
                                await performSingleAreaSearch(center.lat(), center.lng(), radiusKm, timeRange);
                            } else {
                                // Large area - overlapping grid search
                                console.log('üìç Large area - using overlapping grid search');
                                map.fitBounds(bounds);
                                await performGridSearch(bounds, radiusKm, timeRange);
                            }
                        }
                        
                        hideLoading();
                        console.log(`‚úÖ Area search complete`);
                    } else {
                        hideLoading();
                        alert('Could not find location. Please try a different search term.');
                    }
                });
            } catch (error) {
                console.error('‚ùå Area search error:', error);
                hideLoading();
                alert('Error searching area');
            }
        }
        
        // Single area search (for small areas)
        async function performSingleAreaSearch(lat, lng, radiusKm, timeRange) {
            updateLoadingStatus('Finding birds...');
            const obsUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=${timeRange}`;
            const obsResponse = await fetch(obsUrl, {
                headers: { 'X-eBirdApiToken': userApiKey }
            });

            if (obsResponse.ok) {
                allSightings = await obsResponse.json();
                console.log(`üìç Found ${allSightings.length} observations`);

                // Identify target species
                const targetList = getTargetList();
                const listType = document.getElementById('targetListType').value;
                if (listType === 'all') {
                    targetSpecies = [];
                } else {
                    targetSpecies = allSightings.filter(obs => !targetList.has(obs.comName));
                }
                console.log(`üéØ Found ${targetSpecies.length} target species`);

                // Get hotspots and checklists
                updateLoadingStatus('Finding hotspots...');
                await fetchTop10Hotspots(lat, lng, radiusKm);
                updateLoadingStatus('Finding checklists...');
                await fetchTop10Checklists(lat, lng, radiusKm);

                // Display everything
                updateLoadingStatus('Displaying results...');
                displayBirds();
                displayHotspots();
                displayChecklists();
                updateBelowMapPanels();

                // Show below-map section
                document.getElementById('belowMap').style.display = 'block';
            }
        }
        
        // Overlapping grid search (for large areas like states, countries)
        async function performGridSearch(bounds, radiusKm, timeRange) {
            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();
            
            // Create grid of overlapping search points
            // Space them 20 miles apart for overlap with 31-mile radius
            const gridSpacingMiles = 20;
            const gridSpacingDegrees = gridSpacingMiles / 69; // Rough conversion
            
            const searchPoints = [];
            let latStep = sw.lat();
            while (latStep <= ne.lat()) {
                let lngStep = sw.lng();
                while (lngStep <= ne.lng()) {
                    searchPoints.push({ lat: latStep, lng: lngStep });
                    lngStep += gridSpacingDegrees;
                }
                latStep += gridSpacingDegrees;
            }
            
            console.log(`üéØ Creating ${searchPoints.length} overlapping search areas across the region`);
            updateLoadingStatus(`Searching ${searchPoints.length} overlapping areas...`);
            
            allObservations = []; // Use global variable
            const allHotspotsData = [];
            
            // Fetch from each grid point with progressive display
            for (let i = 0; i < searchPoints.length; i++) {
                const point = searchPoints[i];
                const progress = Math.round(((i + 1) / searchPoints.length) * 100);
                updateLoadingStatus(`Searching area ${i + 1}/${searchPoints.length} (${progress}%)...`);
                
                try {
                    // Get observations
                    const obsUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${point.lat}&lng=${point.lng}&dist=${radiusKm}&back=${timeRange}`;
                    const obsResponse = await fetch(obsUrl, {
                        headers: { 'X-eBirdApiToken': userApiKey }
                    });

                    if (obsResponse.ok) {
                        const observations = await obsResponse.json();
                        allObservations.push(...observations);
                        
                        // Progressive display every 5 searches or at end
                        if (i === 0 || (i + 1) % 5 === 0 || i === searchPoints.length - 1) {
                            // Remove duplicates
                            const uniqueObs = {};
                            allObservations.forEach(obs => {
                                const key = `${obs.speciesCode}-${obs.lat}-${obs.lng}-${obs.obsDt}`;
                                if (!uniqueObs[key]) uniqueObs[key] = obs;
                            });
                            allSightings = Object.values(uniqueObs);
                            
                            // Update target species
                            const targetList = getTargetList();
                            const listType = document.getElementById('targetListType').value;
                            if (listType === 'all') {
                                targetSpecies = [];
                            } else {
                                targetSpecies = allSightings.filter(obs => !targetList.has(obs.comName));
                            }
                            
                            // Display current results
                            displayBirds();
                            updateLoadingStatus(`Found ${allSightings.length} birds so far... (area ${i + 1}/${searchPoints.length})`);
                            console.log(`üê¶ Progressive update: ${allSightings.length} observations, ${targetSpecies.length} targets`);
                        }
                    }
                    
                    // Get hotspots (but don't fetch all to avoid too many API calls)
                    if (i % 3 === 0) { // Get hotspots from every 3rd point
                        const hotspotsUrl = `https://api.ebird.org/v2/ref/hotspot/geo?lat=${point.lat}&lng=${point.lng}&dist=${radiusKm}&fmt=json`;
                        const hotspotsResponse = await fetch(hotspotsUrl, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });
                        
                        if (hotspotsResponse.ok) {
                            const hotspots = await hotspotsResponse.json();
                            allHotspotsData.push(...hotspots);
                        }
                    }
                    
                    // Delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 150));
                    
                } catch (error) {
                    console.warn(`Failed to fetch area ${i + 1}:`, error);
                }
            }
            
            // Final processing
            updateLoadingStatus('Processing hotspots...');
            
            // Process hotspots
            const uniqueHotspots = {};
            allHotspotsData.forEach(h => {
                if (!uniqueHotspots[h.locId]) uniqueHotspots[h.locId] = h;
            });
            
            // Get species counts for top hotspots
            const hotspotsArray = Object.values(uniqueHotspots).slice(0, 20);
            const hotspotsWithCounts = [];
            
            for (const hotspot of hotspotsArray) {
                try {
                    const obsUrl = `https://api.ebird.org/v2/data/obs/${hotspot.locId}/recent?back=${timeRange}`;
                    const obsResponse = await fetch(obsUrl, {
                        headers: { 'X-eBirdApiToken': userApiKey }
                    });

                    if (obsResponse.ok) {
                        const observations = await obsResponse.json();
                        const uniqueSpecies = new Set(observations.map(obs => obs.speciesCode));
                        
                        hotspotsWithCounts.push({
                            ...hotspot,
                            speciesCount: uniqueSpecies.size,
                            recentObs: observations.length
                        });
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (e) {
                    console.warn(`Couldn't fetch hotspot ${hotspot.locId}`);
                }
            }

            allHotspots = hotspotsWithCounts
                .sort((a, b) => b.speciesCount - a.speciesCount)
                .slice(0, 10);
            
            // Get checklists from observations
            updateLoadingStatus('Processing checklists...');
            await fetchTop10ChecklistsFromObservations(allObservations);
            
            // Final display
            updateLoadingStatus('Displaying results...');
            displayBirds();
            displayHotspots();
            displayChecklists();
            updateBelowMapPanels();
            
            // Show below-map section
            document.getElementById('belowMap').style.display = 'block';
            
            console.log(`üìç Grid search complete: ${allSightings.length} observations from ${searchPoints.length} areas`);
        }

        // ============================================
        // REGION-ONLY SEARCH (No Radius)
        // ============================================
        
        async function getRegionCodeFromLocation(locationString) {
            // Convert location string to eBird region code
            const stateMap = {
                'vermont': 'US-VT', 'vt': 'US-VT',
                'new hampshire': 'US-NH', 'nh': 'US-NH',
                'maine': 'US-ME', 'me': 'US-ME',
                'massachusetts': 'US-MA', 'ma': 'US-MA',
                'connecticut': 'US-CT', 'ct': 'US-CT',
                'rhode island': 'US-RI', 'ri': 'US-RI',
                'new york': 'US-NY', 'ny': 'US-NY',
                'new jersey': 'US-NJ', 'nj': 'US-NJ',
                'pennsylvania': 'US-PA', 'pa': 'US-PA',
                'california': 'US-CA', 'ca': 'US-CA',
                'florida': 'US-FL', 'fl': 'US-FL',
                'texas': 'US-TX', 'tx': 'US-TX'
            };
            
            const location = locationString.toLowerCase();
            for (const [key, code] of Object.entries(stateMap)) {
                if (location.includes(key)) {
                    return code;
                }
            }
            return null;
        }
        
        async function performRegionSearch(regionCode, timeRange) {
            console.log(`üó∫Ô∏è Searching region ${regionCode} (within boundaries only)`);
            showLoading('Searching region...');
            
            try {
                const url = `https://api.ebird.org/v2/data/obs/${regionCode}/recent?maxResults=10000&back=${timeRange}&detail=full`;
                updateLoadingStatus(`Fetching observations from ${regionCode}...`);
                
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });
                
                if (response.ok) {
                    const observations = await response.json();
                    console.log(`üìç Found ${observations.length} observations in ${regionCode}`);
                    
                    // Store ALL unfiltered observations for checklists/hotspots
                    allObservations = observations;
                    
                    // Deduplicate for display
                    const uniqueObs = {};
                    observations.forEach(obs => {
                        const key = `${obs.lat}-${obs.lng}-${obs.speciesCode}`;
                        if (!uniqueObs[key] || new Date(obs.obsDt) > new Date(uniqueObs[key].obsDt)) {
                            uniqueObs[key] = obs;
                        }
                    });
                    
                    allSightings = Object.values(uniqueObs);
                    console.log(`üìç ${allSightings.length} unique observations`);
                    
                    // Calculate targets
                    const listType = document.getElementById('targetListType').value;
                    const targetList = getTargetList();
                    targetSpecies = listType === 'all' ? [] : allSightings.filter(obs => !targetList.has(obs.comName));
                    console.log(`üéØ Found ${targetSpecies.length} target species`);
                    
                    // Fetch expected/notable
                    const [expectedData, notableData] = await Promise.all([
                        fetchExpectedTargets(regionCode),
                        fetchNotableTargets(regionCode)
                    ]);
                    
                    expectedTargets = allSightings.filter(obs => !targetList.has(obs.comName) && targetFrequencies.has(obs.speciesCode));
                    notableTargets = notableData;
                    
                    console.log(`‚≠ê ${expectedTargets.length} expected, üíé ${notableTargets.length} notable`);
                    
                    // Get hotspots
                    try {
                        const hotspotsResponse = await fetch(`https://api.ebird.org/v2/ref/hotspot/${regionCode}`, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });
                        if (hotspotsResponse.ok) {
                            const hotspotsText = await hotspotsResponse.text();
                            try {
                                allHotspots = JSON.parse(hotspotsText);
                                console.log(`‚úÖ Loaded ${allHotspots.length} hotspots`);
                            } catch (jsonError) {
                                console.warn('‚ö†Ô∏è Could not parse hotspots JSON, skipping hotspots');
                                allHotspots = [];
                            }
                        }
                    } catch (hotspotError) {
                        console.warn('‚ö†Ô∏è Error fetching hotspots:', hotspotError);
                        allHotspots = [];
                    }
                    
                    // Get checklists from UNFILTERED observations
                    const checklistMap = new Map();
                    allObservations.forEach(obs => {
                        if (obs.subId) {
                            if (!checklistMap.has(obs.subId)) {
                                checklistMap.set(obs.subId, {
                                    subId: obs.subId, locName: obs.locName,
                                    lat: obs.lat, lng: obs.lng, obsDt: obs.obsDt,
                                    species: new Set(),
                                    observer: obs.userDisplayName || 'Unknown'
                                });
                            }
                            checklistMap.get(obs.subId).species.add(obs.comName);
                        }
                    });
                    
                    allChecklists = Array.from(checklistMap.values())
                        .map(c => ({...c, speciesCount: c.species.size}))
                        .sort((a, b) => b.speciesCount - a.speciesCount)
                        .slice(0, 10);
                    
                    displayBirds();
                    displayHotspots();
                    displayChecklists();
                    showBelowMapPanels();
                    updateBelowMapPanels();
                    
                    // Auto-load Top eBirders for this region
                    autoLoadTopEBirdersForRegion(regionCode);
                } else {
                    alert(`Could not fetch observations for ${regionCode}. Try unchecking "Region boundaries only".`);
                }
            } catch (error) {
                console.error('Error in region search:', error);
                alert('Error searching region. Please try again.');
            }
            hideLoading();
        }

        // ============================================
        // ROUTE PLANNING
        // ============================================
        async function planRoute() {
            if (!ebirdAuthenticated) {
                alert('Please connect to eBird first');
                return;
            }

            const origin = document.getElementById('originInput').value;
            const destination = document.getElementById('destinationInput').value;

            if (!origin || !destination) {
                alert('Please enter both origin and destination');
                return;
            }

            console.log(`üöó Planning route: ${origin} ‚Üí ${destination}`);

            // Clear previous search results
            clearMarkers();
            clearHotspots();
            clearChecklists();
            allSightings = [];
            allHotspots = [];
            allChecklists = [];
            targetSpecies = [];

            try {
                // Calculate route
                const request = {
                    origin: origin,
                    destination: destination,
                    waypoints: tripWaypoints.map(wp => ({ location: wp.location, stopover: true })),
                    optimizeWaypoints: true, // Let Google optimize the order
                    travelMode: google.maps.TravelMode.DRIVING
                };

                directionsService.route(request, async (result, status) => {
                    if (status === 'OK') {
                        currentRoute = result;
                        directionsRenderer.setDirections(result);

                        // Get duration
                        const route = result.routes[0];
                        let totalDuration = 0;
                        route.legs.forEach(leg => {
                            totalDuration += leg.duration.value;
                        });
                        
                        routeDuration = formatDuration(totalDuration);
                        document.getElementById('durationText').textContent = routeDuration;
                        document.getElementById('routeDuration').classList.remove('hidden');
                        document.getElementById('printBtn').classList.remove('hidden');

                        // Find birds along route
                        await findBirdsAlongRoute(route);

                        console.log(`‚úÖ Route calculated: ${routeDuration}`);
                    } else {
                        console.error('‚ùå Directions request failed:', status);
                        alert('Could not calculate route. Please check your locations.');
                    }
                });
            } catch (error) {
                console.error('‚ùå Route planning error:', error);
                alert('Error planning route');
            }
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function getDistance(lat1, lng1, lat2, lng2) {
            // Haversine formula for distance in miles
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ============================================
        // FIND BIRDS ALONG ROUTE
        // ============================================
        async function findBirdsAlongRoute(route) {
            console.log('üîç Finding birds along entire route...');
            showLoading('Finding birds along route...');

            // Clear previous markers
            clearMarkers();

            // Get route bounds with buffer
            const radiusMiles = parseInt(document.getElementById('searchRadius').value);
            const radiusKm = validateAndConvertRadius(radiusMiles);
            const timeRange = parseInt(document.getElementById('timeRange').value);
            
            const path = route.overview_path;
            console.log(`üìç Route has ${path.length} points`);
            
            // Calculate total route distance in miles
            const totalDistanceMeters = route.legs.reduce((sum, leg) => sum + leg.distance.value, 0);
            const totalDistanceMiles = totalDistanceMeters / 1609.34;
            
            console.log(`üìè Total route distance: ${totalDistanceMiles.toFixed(1)} miles`);
            
            // Strategy: Create overlapping search circles every 20 miles
            // This ensures complete coverage even with eBird's 50km (31 mile) limit
            const searchIntervalMiles = 20; // Overlapping circles every 20 miles
            const numSearchPoints = Math.max(2, Math.ceil(totalDistanceMiles / searchIntervalMiles) + 1);
            
            console.log(`üéØ Creating ${numSearchPoints} overlapping search areas (every ~${searchIntervalMiles} miles)`);
            
            // Sample points evenly along route
            const samplePoints = [];
            const sampleInterval = Math.max(1, Math.floor(path.length / (numSearchPoints - 1)));
            
            for (let i = 0; i < path.length; i += sampleInterval) {
                samplePoints.push({
                    lat: path[i].lat(),
                    lng: path[i].lng()
                });
            }
            
            // Always include start and end
            if (samplePoints.length === 0 || samplePoints[0].lat !== path[0].lat()) {
                samplePoints.unshift({ lat: path[0].lat(), lng: path[0].lng() });
            }
            const lastPoint = path[path.length - 1];
            if (samplePoints[samplePoints.length - 1].lat !== lastPoint.lat()) {
                samplePoints.push({ lat: lastPoint.lat(), lng: lastPoint.lng() });
            }

            console.log(`üìç Searching ${samplePoints.length} overlapping areas along route (${radiusKm}km radius each)`);

            // Fetch birds from multiple overlapping points along route
            try {
                allObservations = []; // Use global variable
                const allHotspotsData = [];
                const allChecklistsData = [];
                
                // Fetch from each search area with progressive display
                for (let i = 0; i < samplePoints.length; i++) {
                    const point = samplePoints[i];
                    const progress = Math.round(((i + 1) / samplePoints.length) * 100);
                    updateLoadingStatus(`Searching area ${i + 1}/${samplePoints.length} (${progress}%)...`);
                    console.log(`üìç Fetching area ${i + 1}/${samplePoints.length} - Lat: ${point.lat.toFixed(4)}, Lng: ${point.lng.toFixed(4)}`);
                    
                    try {
                        // Get observations
                        const obsUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${point.lat}&lng=${point.lng}&dist=${radiusKm}&back=${timeRange}`;
                        const obsResponse = await fetch(obsUrl, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });

                        if (obsResponse.ok) {
                            const observations = await obsResponse.json();
                            allObservations.push(...observations);
                            
                            // Progressive display: Show birds as they arrive
                            if (i === 0 || (i + 1) % 3 === 0 || i === samplePoints.length - 1) {
                                // Remove duplicates for display
                                const uniqueObs = {};
                                allObservations.forEach(obs => {
                                    const key = `${obs.speciesCode}-${obs.lat}-${obs.lng}-${obs.obsDt}`;
                                    if (!uniqueObs[key]) uniqueObs[key] = obs;
                                });
                                allSightings = Object.values(uniqueObs);
                                
                                // Update target species
                                const targetList = getTargetList();
                                const listType = document.getElementById('targetListType').value;
                                if (listType === 'all') {
                                    targetSpecies = [];
                                } else {
                                    targetSpecies = allSightings.filter(obs => !targetList.has(obs.comName));
                                }
                                
                                // Display current results
                                displayBirds();
                                updateLoadingStatus(`Found ${allSightings.length} birds so far... (searching area ${i + 1}/${samplePoints.length})`);
                                console.log(`üê¶ Progressive update: ${allSightings.length} observations, ${targetSpecies.length} targets`);
                            }
                        }
                        
                        // Get hotspots for this point
                        const hotspotsUrl = `https://api.ebird.org/v2/ref/hotspot/geo?lat=${point.lat}&lng=${point.lng}&dist=${radiusKm}&fmt=json`;
                        const hotspotsResponse = await fetch(hotspotsUrl, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });
                        
                        if (hotspotsResponse.ok) {
                            const hotspots = await hotspotsResponse.json();
                            allHotspotsData.push(...hotspots);
                        }
                        
                        // Small delay to avoid rate limiting
                        if (i < samplePoints.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    } catch (error) {
                        console.warn(`Failed to fetch data for area ${i + 1}:`, error);
                    }
                }
                
                // Remove duplicates (same observation may appear from multiple sample points)
                const uniqueObs = {};
                allObservations.forEach(obs => {
                    const key = `${obs.speciesCode}-${obs.lat}-${obs.lng}-${obs.obsDt}`;
                    if (!uniqueObs[key]) {
                        uniqueObs[key] = obs;
                    }
                });
                allSightings = Object.values(uniqueObs);
                
                console.log(`üìç Found ${allSightings.length} unique observations along route`);

                // Identify target species
                const targetList = getTargetList();
                const listType = document.getElementById('targetListType').value;
                if (listType === 'all') {
                    targetSpecies = [];
                } else {
                    targetSpecies = allSightings.filter(obs => !targetList.has(obs.comName));
                }
                console.log(`üéØ Found ${targetSpecies.length} target species (${allSightings.length} total birds)`);
                
                // If no targets and filter is active, help user understand
                if (targetSpecies.length === 0 && listType !== 'all' && allSightings.length > 0) {
                    console.log(`‚ÑπÔ∏è No new birds for ${listType} list. You've seen all ${allSightings.length} birds on this route!`);
                    console.log(`üí° Tip: Switch to "Show All Species" to see them on the map.`);
                }
                
                // Fetch expected seasonal targets and notable sightings
                updateLoadingStatus('Finding expected seasonal targets...');
                const centerPoint = samplePoints[Math.floor(samplePoints.length / 2)];
                const regionCode = getRegionFromCoordinates(centerPoint.lat, centerPoint.lng);
                
                const [expectedData, notableData] = await Promise.all([
                    fetchExpectedTargets(regionCode),
                    fetchNotableTargets(regionCode)
                ]);
                
                // Filter expected targets to match observations we found
                expectedTargets = allSightings.filter(obs => {
                    const isTarget = !targetList.has(obs.comName);
                    const isInTop100 = expectedData.some(sp => 
                        targetFrequencies.has(obs.speciesCode)
                    );
                    return isTarget && isInTop100;
                });
                
                // Notable targets are already filtered by user's list
                notableTargets = notableData;
                
                console.log(`‚≠ê Found ${expectedTargets.length} expected seasonal targets`);
                console.log(`üíé Found ${notableTargets.length} notable rare targets`);

                // Process hotspots - distribute along route instead of just taking top globally
                updateLoadingStatus('Processing hotspots...');
                const uniqueHotspots = {};
                allHotspotsData.forEach(h => {
                    if (!uniqueHotspots[h.locId]) {
                        uniqueHotspots[h.locId] = h;
                    }
                });
                
                console.log(`üìç Found ${Object.keys(uniqueHotspots).length} unique hotspots total`);
                
                // Group hotspots by which sample point they're near
                const hotspotsBySection = [];
                const hotspotsPerSection = Math.ceil(10 / samplePoints.length); // Distribute evenly
                
                // For each section of the route, get the best hotspots
                for (let i = 0; i < samplePoints.length && hotspotsBySection.length < 30; i++) {
                    const point = samplePoints[i];
                    
                    // Get hotspots near this point
                    const nearbyHotspots = Object.values(uniqueHotspots).filter(h => {
                        const distance = getDistance(point.lat, point.lng, h.lat, h.lng);
                        return distance < radiusMiles * 1.5; // Within 1.5x the search radius
                    });
                    
                    hotspotsBySection.push(...nearbyHotspots.slice(0, hotspotsPerSection));
                }
                
                updateLoadingStatus('Getting hotspot species counts...');
                // Get species counts for distributed hotspots
                const hotspotsWithCounts = [];
                for (const hotspot of hotspotsBySection) {
                    try {
                        const obsUrl = `https://api.ebird.org/v2/data/obs/${hotspot.locId}/recent?back=${timeRange}`;
                        const obsResponse = await fetch(obsUrl, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });

                        if (obsResponse.ok) {
                            const observations = await obsResponse.json();
                            const uniqueSpecies = new Set(observations.map(obs => obs.speciesCode));
                            
                            hotspotsWithCounts.push({
                                ...hotspot,
                                speciesCount: uniqueSpecies.size,
                                recentObs: observations.length
                            });
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 100));
                    } catch (e) {
                        console.warn(`Couldn't fetch data for hotspot ${hotspot.locId}`);
                    }
                }

                allHotspots = hotspotsWithCounts
                    .sort((a, b) => b.speciesCount - a.speciesCount)
                    .slice(0, 10);
                    
                console.log(`‚úÖ Found top 10 hotspots distributed along route`);

                // Get top checklists from observations
                updateLoadingStatus('Processing checklists...');
                await fetchTop10ChecklistsFromObservations(allObservations);

                // Display everything
                updateLoadingStatus('Displaying results...');
                displayBirds();
                displayHotspots();
                displayChecklists();
                updateBelowMapPanels();

                // Show below-map section
                document.getElementById('belowMap').style.display = 'block';
                
                hideLoading();

            } catch (error) {
                console.error('‚ùå Error finding birds:', error);
                hideLoading();
                alert('Error finding birds along route');
            }
        }
        
        // Helper function to get checklists from observations
        async function fetchTop10ChecklistsFromObservations(observations) {
            const checklistMap = {};
            observations.forEach(obs => {
                if (obs.subId) {
                    if (!checklistMap[obs.subId]) {
                        checklistMap[obs.subId] = {
                            subId: obs.subId,
                            lat: obs.lat,
                            lng: obs.lng,
                            locName: obs.locName,
                            obsDt: obs.obsDt,
                            species: new Set()
                        };
                    }
                    checklistMap[obs.subId].species.add(obs.speciesCode);
                }
            });

            const checklistsWithCounts = Object.values(checklistMap).map(checklist => ({
                ...checklist,
                speciesCount: checklist.species.size
            }));

            allChecklists = checklistsWithCounts
                .sort((a, b) => b.speciesCount - a.speciesCount)
                .slice(0, 10);

            console.log(`‚úÖ Top 10 checklists from route observations`);
        }

        // ============================================
        // FETCH TOP 10 HOTSPOTS (BY SPECIES COUNT)
        // ============================================
        async function fetchTop10Hotspots(lat, lng, radius) {
            console.log('üìç Fetching top hotspots...');

            try {
                // Get all hotspots in area
                const hotspotsUrl = `https://api.ebird.org/v2/ref/hotspot/geo?lat=${lat}&lng=${lng}&dist=${radius}&fmt=json`;
                const response = await fetch(hotspotsUrl, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch hotspots');
                }

                const hotspots = await response.json();
                console.log(`Found ${hotspots.length} total hotspots`);

                // For each hotspot, get recent species count
                const hotspotsWithCounts = [];
                const timeRange = parseInt(document.getElementById('timeRange').value);

                // Limit to first 30 hotspots to avoid too many API calls
                const hotspotsToCheck = hotspots.slice(0, 30);

                for (const hotspot of hotspotsToCheck) {
                    try {
                        const obsUrl = `https://api.ebird.org/v2/data/obs/${hotspot.locId}/recent?back=${timeRange}`;
                        const obsResponse = await fetch(obsUrl, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });

                        if (obsResponse.ok) {
                            const observations = await obsResponse.json();
                            const uniqueSpecies = new Set(observations.map(obs => obs.speciesCode));
                            
                            hotspotsWithCounts.push({
                                ...hotspot,
                                speciesCount: uniqueSpecies.size,
                                recentObs: observations.length
                            });
                        }
                    } catch (e) {
                        console.warn(`Couldn't fetch data for hotspot ${hotspot.locId}`);
                    }
                }

                // Sort by species count (descending) and take top 10
                allHotspots = hotspotsWithCounts
                    .sort((a, b) => b.speciesCount - a.speciesCount)
                    .slice(0, 10);

                console.log(`‚úÖ Top 10 hotspots by species diversity:`, allHotspots.map(h => `${h.locName}: ${h.speciesCount} species`));

            } catch (error) {
                console.error('‚ùå Error fetching hotspots:', error);
                allHotspots = [];
            }
        }

        // ============================================
        // DISPLAY BIRDS ON MAP
        // ============================================
        function displayBirds() {
            clearMarkers();

            const listType = document.getElementById('targetListType').value;
            const targetList = getTargetList();
            
            let birdsToShow = allSightings;
            
            // Apply target filter based on type
            if (listType === 'expected') {
                // Show only expected seasonal targets
                birdsToShow = expectedTargets;
            } else if (listType === 'notable') {
                // Show only notable rare targets
                birdsToShow = notableTargets;
            } else if (listType !== 'all') {
                // Show regular targets (haven't seen)
                birdsToShow = allSightings.filter(obs => !targetList.has(obs.comName));
            }

            console.log(`Displaying ${birdsToShow.length} bird markers (filter: ${listType})`);
            
            // Show helpful message when filter hides all birds
            if (birdsToShow.length === 0 && allSightings.length > 0) {
                if (listType === 'expected') {
                    console.log(`‚ÑπÔ∏è No expected seasonal targets found. This might be a transitional season.`);
                } else if (listType === 'notable') {
                    console.log(`‚ÑπÔ∏è No notable/rare birds recently reported in this area.`);
                } else {
                    console.log(`‚ÑπÔ∏è Filter is hiding all ${allSightings.length} birds. You've already seen them all!`);
                    console.log(`üí° Tip: Switch to "Show All Species" to see them on the map.`);
                }
            }

            birdsToShow.forEach(obs => {
                const isTarget = !targetList.has(obs.comName);
                const isExpected = expectedTargets.some(e => e.speciesCode === obs.speciesCode);
                const isNotable = notableTargets.some(n => n.speciesCode === obs.speciesCode);
                const abaCode = getABARarityCode(obs.comName);
                
                // Check ABA rarity filter
                if (!shouldShowABARarity(abaCode)) {
                    return; // Skip this bird
                }
                
                const color = getMarkerColor(obs, isTarget, abaCode, isExpected, isNotable);
                const actualCount = obs.howMany || 1;

                const marker = new google.maps.Marker({
                    position: { lat: obs.lat, lng: obs.lng },
                    map: map,
                    title: obs.comName,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: color,
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    }
                });

                // Store marker with species name for highlighting
                marker.speciesName = obs.comName;
                marker.abaCode = abaCode;

                const abaRarityText = ['', 'Common', 'Uncommon', 'Rare', 'Very Rare', 'Mega Rare', 'Extirpated'][abaCode] || 'Common';
                
                // Get frequency data if available
                const frequency = targetFrequencies.get(obs.speciesCode);
                const frequencyText = frequency ? 
                    `<p style="margin: 5px 0; font-size: 0.9em;"><strong>Frequency:</strong> ${(frequency * 100).toFixed(0)}% of checklists</p>` : '';
                
                // Determine target type badge
                let targetBadge = '';
                if (isNotable) {
                    targetBadge = '<div style="background: #a855f7; color: white; padding: 4px 8px; border-radius: 4px; display: inline-block; margin: 5px 0; font-weight: 600; font-size: 0.85em;">üíé NOTABLE/RARE</div>';
                } else if (isExpected) {
                    targetBadge = '<div style="background: #fbbf24; color: white; padding: 4px 8px; border-radius: 4px; display: inline-block; margin: 5px 0; font-weight: 600; font-size: 0.85em;">‚≠ê EXPECTED SEASONAL</div>';
                } else if (isTarget) {
                    targetBadge = '<div style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; display: inline-block; margin: 5px 0; font-weight: 600; font-size: 0.85em;">üéØ TARGET SPECIES</div>';
                }

                // Create checklist link if subId exists
                const checklistLink = obs.subId ? 
                    `<p style="margin: 5px 0; font-size: 0.9em;"><strong>Checklist:</strong> <a href="https://ebird.org/checklist/${obs.subId}" target="_blank" style="color: #10b981; text-decoration: underline;">View on eBird</a></p>` : '';

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; max-width: 250px;">
                            <h3 style="margin: 0 0 8px 0; color: #065f46;">${obs.comName}</h3>
                            ${targetBadge}
                            ${frequencyText}
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>ABA Rarity:</strong> Code ${abaCode} (${abaRarityText})</p>
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>Location:</strong> ${obs.locName}</p>
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>Date:</strong> ${obs.obsDt}</p>
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>Count:</strong> ${actualCount}</p>
                            ${checklistLink}
                            <button onclick="addWaypoint(${obs.lat}, ${obs.lng}, '${obs.locName.replace(/'/g, "\\'")}', '${obs.comName.replace(/'/g, "\\'")}' )" 
                                    style="margin-top: 10px; padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                                ‚ûï Add to Route
                            </button>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markersArray.push(marker);
            });
        }

        function getMarkerColor(obs, isTarget, abaCode, isExpected, isNotable) {
            // Priority 1: Notable rare targets (purple)
            if (isNotable) return '#a855f7'; // Purple for notable/rare
            
            // Priority 2: Expected seasonal targets (gold)
            if (isExpected) return '#fbbf24'; // Gold for expected seasonal
            
            // Priority 3: Regular target species (red)
            if (isTarget) return '#ef4444'; // Red for targets
            
            // Priority 4: ABA rarity
            return getABARarityColor(abaCode);
        }

        // ============================================
        // HIGHLIGHT SPECIES ON MAP
        // ============================================
        function highlightSpeciesOnMap(speciesName) {
            console.log(`üéØ Highlighting ${speciesName} on map`);
            
            // Find all markers for this species
            const speciesMarkers = markersArray.filter(marker => marker.speciesName === speciesName);
            
            if (speciesMarkers.length === 0) {
                alert(`No map markers found for ${speciesName}`);
                return;
            }
            
            // Reset all markers to normal size
            markersArray.forEach(marker => {
                marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: marker.icon.fillColor,
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2
                });
            });
            
            // Highlight the selected species markers
            speciesMarkers.forEach(marker => {
                marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 14, // Larger
                    fillColor: marker.icon.fillColor,
                    fillOpacity: 1,
                    strokeColor: '#fbbf24', // Gold border
                    strokeWeight: 4
                });
                
                // Make them bounce briefly
                marker.setAnimation(google.maps.Animation.BOUNCE);
                setTimeout(() => marker.setAnimation(null), 2000);
            });
            
            // Center map on first marker
            if (speciesMarkers.length > 0) {
                map.setCenter(speciesMarkers[0].getPosition());
                map.setZoom(12);
            }
            
            // Scroll map into view
            document.getElementById('map').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            console.log(`‚úÖ Highlighted ${speciesMarkers.length} markers for ${speciesName}`);
        }

        // ============================================
        // DISPLAY HOTSPOTS
        // ============================================
        function displayHotspots() {
            if (!document.getElementById('showHotspots').checked) {
                clearHotspots();
                return;
            }

            clearHotspots();

            allHotspots.forEach((hotspot, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: hotspot.lat, lng: hotspot.lng },
                    map: map,
                    title: hotspot.locName,
                    label: {
                        text: `${index + 1}`,
                        color: 'white',
                        fontSize: '12px',
                        fontWeight: 'bold'
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 14,
                        fillColor: '#3b82f6',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    }
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; max-width: 280px;">
                            <h3 style="margin: 0 0 8px 0; color: #065f46;">#${index + 1} ${hotspot.locName}</h3>
                            <div style="background: #dbeafe; padding: 8px; border-radius: 4px; margin-bottom: 10px;">
                                <p style="margin: 0; font-weight: 600; color: #1e40af;">ü¶Ü ${hotspot.speciesCount || 'Loading...'} species recently</p>
                                <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #3b82f6;">${hotspot.recentObs || 0} observations</p>
                            </div>
                            <p style="margin: 0 0 8px 0; font-size: 0.85em; color: var(--text-secondary);">
                                <a href="https://ebird.org/hotspot/${hotspot.locId}" target="_blank" style="color: #10b981; text-decoration: underline;">View on eBird</a>
                            </p>
                            <button onclick="addWaypoint(${hotspot.lat}, ${hotspot.lng}, '${hotspot.locName.replace(/'/g, "\\'")}', 'Hotspot')" 
                                    style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                                ‚ûï Add to Route
                            </button>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                hotspotsArray.push(marker);
            });

            console.log(`‚úÖ Displayed ${allHotspots.length} hotspot markers`);
        }

        // ============================================
        // FETCH TOP 10 CHECKLISTS (BY SPECIES COUNT)
        // ============================================
        async function fetchTop10Checklists(lat, lng, radius) {
            console.log('üìã Fetching top checklists...');

            try {
                // Get recent notable observations (these are often in checklists)
                const timeRange = parseInt(document.getElementById('timeRange').value);
                const obsUrl = `https://api.ebird.org/v2/data/obs/geo/recent/notable?lat=${lat}&lng=${lng}&dist=${radius}&back=${timeRange}&detail=full`;
                
                const response = await fetch(obsUrl, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });

                if (!response.ok) {
                    console.warn('Could not fetch notable observations for checklists');
                    allChecklists = [];
                    return;
                }

                const observations = await response.json();
                
                // Group by checklist (subId)
                const checklistMap = {};
                observations.forEach(obs => {
                    if (obs.subId) {
                        if (!checklistMap[obs.subId]) {
                            checklistMap[obs.subId] = {
                                subId: obs.subId,
                                lat: obs.lat,
                                lng: obs.lng,
                                locName: obs.locName,
                                obsDt: obs.obsDt,
                                species: new Set()
                            };
                        }
                        checklistMap[obs.subId].species.add(obs.speciesCode);
                    }
                });

                // Convert to array and add species count
                const checklistsWithCounts = Object.values(checklistMap).map(checklist => ({
                    ...checklist,
                    speciesCount: checklist.species.size
                }));

                // Sort by species count and take top 10
                allChecklists = checklistsWithCounts
                    .sort((a, b) => b.speciesCount - a.speciesCount)
                    .slice(0, 10);

                console.log(`‚úÖ Top 10 checklists:`, allChecklists.map(c => `${c.locName}: ${c.speciesCount} species`));

            } catch (error) {
                console.error('‚ùå Error fetching checklists:', error);
                allChecklists = [];
            }
        }

        // ============================================
        // DISPLAY TOP 10 CHECKLISTS
        // ============================================
        function displayChecklists() {
            if (!document.getElementById('showChecklists').checked) {
                clearChecklists();
                return;
            }

            clearChecklists();

            allChecklists.forEach((checklist, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: checklist.lat, lng: checklist.lng },
                    map: map,
                    title: `Checklist #${index + 1}: ${checklist.locName}`,
                    label: {
                        text: `${index + 1}`,
                        color: 'white',
                        fontSize: '11px',
                        fontWeight: 'bold'
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: '#10b981',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    }
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; max-width: 280px;">
                            <h3 style="margin: 0 0 8px 0; color: #065f46;">üìã Checklist #${index + 1}</h3>
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>Location:</strong> ${checklist.locName}</p>
                            <div style="background: #f0fdf4; padding: 8px; border-radius: 4px; margin: 10px 0;">
                                <p style="margin: 0; font-weight: 600; color: #065f46;">üê¶ ${checklist.speciesCount} species in checklist</p>
                                <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #047857;">${checklist.obsDt}</p>
                            </div>
                            <button onclick="addWaypoint(${checklist.lat}, ${checklist.lng}, '${checklist.locName.replace(/'/g, "\\'")}', 'Checklist #${index + 1}')" 
                                    style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                                ‚ûï Add to Route
                            </button>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                checklistsArray.push(marker);
            });

            console.log(`‚úÖ Displayed ${allChecklists.length} checklist markers`);
        }

        function clearChecklists() {
            checklistsArray.forEach(marker => marker.setMap(null));
            checklistsArray = [];
        }

        // ============================================
        // WAYPOINT MANAGEMENT
        // ============================================
        function addWaypoint(lat, lng, locationName, speciesName) {
            const waypoint = {
                location: { lat, lng },
                name: locationName,
                species: speciesName
            };

            tripWaypoints.push(waypoint);
            console.log(`‚ûï Added waypoint: ${locationName}`);

            updateWaypointList();
            
            // Recalculate route with new waypoint
            if (currentRoute) {
                planRoute();
            }
        }

        function removeWaypoint(index) {
            tripWaypoints.splice(index, 1);
            console.log(`‚ûñ Removed waypoint at index ${index}`);
            
            updateWaypointList();
            
            // Recalculate route
            if (currentRoute) {
                planRoute();
            }
        }

        function updateWaypointList() {
            const listDiv = document.getElementById('waypointList');
            
            if (tripWaypoints.length === 0) {
                listDiv.innerHTML = '';
                return;
            }

            listDiv.innerHTML = '<h4 style="margin: 15px 0 10px 0; color: #065f46; font-size: 0.95em;">Waypoints:</h4>';
            
            tripWaypoints.forEach((wp, index) => {
                const div = document.createElement('div');
                div.className = 'waypoint-item';
                div.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 0.9em;">${wp.name}</div>
                        <div style="font-size: 0.8em; color: var(--text-secondary);">${wp.species}</div>
                    </div>
                    <button class="waypoint-remove" onclick="removeWaypoint(${index})">√ó</button>
                `;
                listDiv.appendChild(div);
            });
        }

        // ============================================
        // PRINT DIRECTIONS
        // ============================================
        function printDirections() {
            if (!currentRoute) {
                alert('No route to print');
                return;
            }

            const route = currentRoute.routes[0];
            const origin = document.getElementById('originInput').value;
            const destination = document.getElementById('destinationInput').value;

            // Create printable content
            let printContent = `
                <html>
                <head>
                    <title>Birding Route - ${origin} to ${destination}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #065f46; }
                        h2 { color: #10b981; margin-top: 20px; }
                        .leg { margin: 15px 0; padding: 10px; background: #f9fafb; border-left: 4px solid #10b981; }
                        .waypoint { background: #dbeafe; padding: 8px; margin: 8px 0; border-radius: 4px; }
                        .summary { background: #f0fdf4; padding: 15px; border-radius: 8px; margin: 20px 0; }
                    </style>
                </head>
                <body>
                    <h1>ü¶© Birding Trip Route</h1>
                    <div class="summary">
                        <p><strong>From:</strong> ${origin}</p>
                        <p><strong>To:</strong> ${destination}</p>
                        <p><strong>Total Duration:</strong> ${routeDuration}</p>
                        <p><strong>Waypoints:</strong> ${tripWaypoints.length}</p>
                    </div>
            `;

            if (tripWaypoints.length > 0) {
                printContent += '<h2>üéØ Birding Stops</h2>';
                tripWaypoints.forEach((wp, index) => {
                    printContent += `
                        <div class="waypoint">
                            <strong>Stop ${index + 1}:</strong> ${wp.name}<br>
                            <em>${wp.species}</em>
                        </div>
                    `;
                });
            }

            printContent += '<h2>üó∫Ô∏è Turn-by-Turn Directions</h2>';

            route.legs.forEach((leg, legIndex) => {
                printContent += `
                    <div class="leg">
                        <h3>Leg ${legIndex + 1}: ${leg.start_address} ‚Üí ${leg.end_address}</h3>
                        <p><strong>Distance:</strong> ${leg.distance.text} | <strong>Duration:</strong> ${leg.duration.text}</p>
                `;
                
                leg.steps.forEach((step, stepIndex) => {
                    printContent += `<p>${stepIndex + 1}. ${step.instructions} (${step.distance.text})</p>`;
                });

                printContent += '</div>';
            });

            printContent += `
                    <p style="margin-top: 30px; color: var(--text-secondary); font-size: 0.9em;">
                        Generated by Traveling Birder - ${new Date().toLocaleDateString()}
                    </p>
                </body>
                </html>
            `;

            // Open print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // ============================================
        // UPDATE BELOW-MAP PANELS
        // ============================================
        function updateBelowMapPanels() {
            // Update counts with breakdown
            const totalTargets = targetSpecies.length;
            const expectedCount = expectedTargets.length;
            const notableCount = notableTargets.length;
            
            let countText = `${totalTargets} species`;
            if (expectedCount > 0 || notableCount > 0) {
                countText += ` (‚≠ê${expectedCount} expected, üíé${notableCount} notable)`;
            }
            
            document.getElementById('targetCount').textContent = totalTargets;
            document.getElementById('sightingsCount').textContent = allSightings.length;

            // Enhanced Target Species List with probabilities
            const targetList = document.getElementById('targetList');
            if (targetSpecies.length === 0) {
                targetList.innerHTML = '<p style="color: var(--text-secondary);">No target species found in this area.</p>';
            } else {
                // Group targets by species and calculate stats
                const speciesStats = {};
                targetSpecies.forEach(obs => {
                    if (!speciesStats[obs.comName]) {
                        speciesStats[obs.comName] = {
                            species: obs.comName,
                            speciesCode: obs.speciesCode,
                            sightings: [],
                            locations: new Set(),
                            recentObs: obs
                        };
                    }
                    speciesStats[obs.comName].sightings.push(obs);
                    speciesStats[obs.comName].locations.add(obs.locName);
                    // Keep most recent observation
                    if (new Date(obs.obsDt) > new Date(speciesStats[obs.comName].recentObs.obsDt)) {
                        speciesStats[obs.comName].recentObs = obs;
                    }
                });

                const sortedTargets = Object.values(speciesStats).sort((a, b) => {
                    // Sort by frequency first (expected targets on top), then by sighting count
                    const freqA = targetFrequencies.get(a.speciesCode) || 0;
                    const freqB = targetFrequencies.get(b.speciesCode) || 0;
                    if (freqB !== freqA) return freqB - freqA;
                    return b.sightings.length - a.sightings.length;
                });

                let html = '<div style="margin-bottom: 15px; padding: 10px; background: #f0fdf4; border-radius: 6px; border-left: 4px solid #10b981;">';
                html += '<p style="margin: 0; font-size: 0.9em; color: #065f46;"><strong>Legend:</strong> ‚≠ê = Expected seasonal target | üíé = Rare/notable | Frequency = % of checklists reporting</p>';
                html += '</div>';
                
                html += '<div style="display: grid; gap: 12px;">';
                sortedTargets.forEach(stats => {
                    const abaCode = getABARarityCode(stats.species);
                    const abaRarityText = ['', 'Common', 'Uncommon', 'Rare', 'Very Rare', 'Mega Rare', 'Extirpated'][abaCode] || '';
                    const frequency = targetFrequencies.get(stats.speciesCode);
                    const isExpected = expectedTargets.some(e => e.speciesCode === stats.speciesCode);
                    const isNotable = notableTargets.some(n => n.speciesCode === stats.speciesCode);
                    
                    // Determine badge and color
                    let badge = 'üéØ';
                    let badgeColor = '#ef4444';
                    let badgeText = 'Target';
                    if (isNotable) {
                        badge = 'üíé';
                        badgeColor = '#a855f7';
                        badgeText = 'Notable/Rare';
                    } else if (isExpected) {
                        badge = '‚≠ê';
                        badgeColor = '#fbbf24';
                        badgeText = 'Expected';
                    }
                    
                    // Frequency bar
                    const freqPercent = frequency ? Math.round(frequency * 100) : 0;
                    const freqBar = frequency ? 
                        `<div style="margin: 8px 0;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.75em; color: var(--text-secondary); margin-bottom: 3px;">
                                <span>Probability</span>
                                <span style="font-weight: 600; color: #10b981;">${freqPercent}%</span>
                            </div>
                            <div style="background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: #10b981; height: 100%; width: ${freqPercent}%;"></div>
                            </div>
                        </div>` : '';
                    
                    html += `
                        <div onclick="highlightSpeciesOnMap('${stats.species.replace(/'/g, "\\'")}' )" 
                             style="background: white; border: 2px solid ${badgeColor}; border-radius: 8px; padding: 14px; cursor: pointer; transition: all 0.2s;" 
                             onmouseover="this.style.background='#f0fdf4'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';" 
                             onmouseout="this.style.background='white'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <h4 style="margin: 0; color: #065f46; font-size: 1.05em; flex: 1;">${stats.species}</h4>
                                <div style="background: ${badgeColor}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600; white-space: nowrap; margin-left: 8px;">
                                    ${badge} ${badgeText}
                                </div>
                            </div>
                            ${freqBar}
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 8px 0; padding: 8px; background: #f9fafb; border-radius: 4px;">
                                <div>
                                    <div style="font-size: 0.7em; color: var(--text-secondary); margin-bottom: 2px;">SIGHTINGS</div>
                                    <div style="font-size: 1.1em; font-weight: 600; color: #10b981;">${stats.sightings.length}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.7em; color: var(--text-secondary); margin-bottom: 2px;">LOCATIONS</div>
                                    <div style="font-size: 1.1em; font-weight: 600; color: #3b82f6;">${stats.locations.size}</div>
                                </div>
                            </div>
                            <p style="margin: 6px 0 3px 0; font-size: 0.75em; color: var(--text-secondary);">ABA Code ${abaCode} (${abaRarityText})</p>
                            <p style="margin: 3px 0; font-size: 0.8em; color: var(--text-secondary);">üìç Most recent: ${stats.recentObs.locName}</p>
                            <p style="margin: 3px 0; font-size: 0.8em; color: var(--text-secondary);">üìÖ ${stats.recentObs.obsDt}</p>
                            <p style="margin: 8px 0 0 0; font-size: 0.75em; color: #10b981; font-weight: 600;">üó∫Ô∏è Click to show all ${stats.sightings.length} sighting(s) on map</p>
                        </div>
                    `;
                });
                html += '</div>';
                targetList.innerHTML = html;
            }

            // Sightings Summary
            const sightingsList = document.getElementById('sightingsList');
            const speciesCounts = {};
            allSightings.forEach(obs => {
                speciesCounts[obs.comName] = (speciesCounts[obs.comName] || 0) + 1;
            });

            const topSpecies = Object.entries(speciesCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);

            let sightingsHtml = '<h4 style="margin-bottom: 10px;">Most Common Species</h4>';
            topSpecies.forEach(([species, count]) => {
                sightingsHtml += `
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f3f4f6;">
                        <span>${species}</span>
                        <span style="font-weight: 600; color: #10b981;">${count}</span>
                    </div>
                `;
            });
            sightingsList.innerHTML = sightingsHtml;

            // Stats Display
            const statsDisplay = document.getElementById('statsDisplay');
            const userSpeciesInArea = allSightings.filter(obs => userList.has(obs.comName));
            const uniqueUserSpecies = new Set(userSpeciesInArea.map(obs => obs.comName));
            const uniqueTotalSpecies = new Set(allSightings.map(obs => obs.comName));
            const percentage = uniqueTotalSpecies.size > 0 
                ? Math.round((uniqueUserSpecies.size / uniqueTotalSpecies.size) * 100)
                : 0;

            statsDisplay.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 8px;">
                        <div style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 5px;">YOUR SPECIES</div>
                        <div style="font-size: 2em; font-weight: bold; color: #10b981;">${uniqueUserSpecies.size}</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f9fafb; border-radius: 8px;">
                        <div style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 5px;">TOTAL SPECIES</div>
                        <div style="font-size: 2em; font-weight: bold; color: var(--text-primary);">${uniqueTotalSpecies.size}</div>
                    </div>
                </div>
                <div style="text-align: center; padding: 12px; background: #fef3c7; border-radius: 8px;">
                    <span style="font-weight: 600; color: #92400e;">You've seen ${percentage}% of species in this area</span>
                </div>
            `;
        }

        // ============================================
        // PANEL TOGGLES
        // ============================================
        function showBelowMapPanels() {
            const belowMap = document.getElementById('belowMap');
            if (belowMap) {
                belowMap.style.display = 'block';
            }
        }

        function togglePanel(panelId) {
            const content = document.getElementById(panelId + 'Content');
            const toggle = document.getElementById(panelId + 'Toggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.textContent = '+';
            } else {
                content.classList.add('expanded');
                toggle.textContent = '‚àí';
            }
        }

        function toggleLegend() {
            const content = document.getElementById('legendContent');
            const toggle = document.getElementById('legendToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚àí';
            } else {
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }

        function toggleQuickStart() {
            const modal = document.getElementById('quickStartModal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
            }
        }

        // ============================================
        // LAYER TOGGLES
        // ============================================
        function toggleHotspots() {
            if (document.getElementById('showHotspots').checked) {
                displayHotspots();
            } else {
                clearHotspots();
            }
        }

        function toggleChecklists() {
            if (document.getElementById('showChecklists').checked) {
                displayChecklists();
            } else {
                clearChecklists();
            }
        }

        // ============================================
        // SEARCH SPECIFIC SPECIES
        // ============================================
        async function searchSpecies() {
            const speciesName = document.getElementById('speciesSearch').value.trim();
            const location = document.getElementById('speciesLocation').value.trim();

            if (!speciesName) {
                alert('Please enter a species name');
                return;
            }
            
            // Check if eBird is connected for API access
            if (!userApiKey) {
                alert('Please connect to eBird first to search for species');
                return;
            }

            console.log(`üîç Searching for ${speciesName} near ${location || 'current area'}`);
            showLoading('Searching for species...');

            try {
                let lat, lng;
                
                if (location && speciesLocationAutocomplete && speciesLocationAutocomplete.getPlace()) {
                    const place = speciesLocationAutocomplete.getPlace();
                    if (place.geometry) {
                        lat = place.geometry.location.lat();
                        lng = place.geometry.location.lng();
                    }
                } else if (map) {
                    const center = map.getCenter();
                    lat = center.lat();
                    lng = center.lng();
                }

                // Use species-specific radius and time range
                const radiusMiles = parseInt(document.getElementById('speciesSearchRadius').value) || 25;
                const radiusKm = validateAndConvertRadius(radiusMiles);
                const timeRange = parseInt(document.getElementById('speciesTimeRange').value) || 30;
                
                console.log(`üìç Searching within ${radiusMiles} miles, last ${timeRange} days`);

                const url = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=${timeRange}`;
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });

                if (!response.ok) {
                    throw new Error('Search failed');
                }

                const observations = await response.json();
                const matchingObs = observations.filter(obs => 
                    obs.comName.toLowerCase().includes(speciesName.toLowerCase())
                );

                if (matchingObs.length === 0) {
                    hideLoading();
                    alert(`No recent sightings of "${speciesName}" found in this area in the last ${timeRange} days within ${radiusMiles} miles.`);
                    return;
                }

                // Clear current markers and display search results
                clearMarkers();
                allSightings = matchingObs;
                targetSpecies = matchingObs.filter(obs => userList.has && !userList.has(obs.comName));
                
                displayBirds();
                
                // Zoom to first result
                if (matchingObs[0]) {
                    map.setCenter({ lat: matchingObs[0].lat, lng: matchingObs[0].lng });
                    map.setZoom(12);
                }

                hideLoading();
                console.log(`‚úÖ Found ${matchingObs.length} sightings of ${speciesName}`);

            } catch (error) {
                hideLoading();
                console.error('Error searching species:', error);
                alert('Error searching for species. Please try again.');
            }
        }

        // ============================================
        // TOP EBIRDERS FUNCTIONALITY
        // ============================================
        
        let currentTopEBirdersRegion = null;
        let topEBirdersData = [];
        
        // Common eBird regions for dropdown
        const ebirdRegions = [
            // US States
            { name: 'Alabama', code: 'US-AL' },
            { name: 'Alaska', code: 'US-AK' },
            { name: 'Arizona', code: 'US-AZ' },
            { name: 'Arkansas', code: 'US-AR' },
            { name: 'California', code: 'US-CA' },
            { name: 'Colorado', code: 'US-CO' },
            { name: 'Connecticut', code: 'US-CT' },
            { name: 'Delaware', code: 'US-DE' },
            { name: 'Florida', code: 'US-FL' },
            { name: 'Georgia', code: 'US-GA' },
            { name: 'Hawaii', code: 'US-HI' },
            { name: 'Idaho', code: 'US-ID' },
            { name: 'Illinois', code: 'US-IL' },
            { name: 'Indiana', code: 'US-IN' },
            { name: 'Iowa', code: 'US-IA' },
            { name: 'Kansas', code: 'US-KS' },
            { name: 'Kentucky', code: 'US-KY' },
            { name: 'Louisiana', code: 'US-LA' },
            { name: 'Maine', code: 'US-ME' },
            { name: 'Maryland', code: 'US-MD' },
            { name: 'Massachusetts', code: 'US-MA' },
            { name: 'Michigan', code: 'US-MI' },
            { name: 'Minnesota', code: 'US-MN' },
            { name: 'Mississippi', code: 'US-MS' },
            { name: 'Missouri', code: 'US-MO' },
            { name: 'Montana', code: 'US-MT' },
            { name: 'Nebraska', code: 'US-NE' },
            { name: 'Nevada', code: 'US-NV' },
            { name: 'New Hampshire', code: 'US-NH' },
            { name: 'New Jersey', code: 'US-NJ' },
            { name: 'New Mexico', code: 'US-NM' },
            { name: 'New York', code: 'US-NY' },
            { name: 'North Carolina', code: 'US-NC' },
            { name: 'North Dakota', code: 'US-ND' },
            { name: 'Ohio', code: 'US-OH' },
            { name: 'Oklahoma', code: 'US-OK' },
            { name: 'Oregon', code: 'US-OR' },
            { name: 'Pennsylvania', code: 'US-PA' },
            { name: 'Rhode Island', code: 'US-RI' },
            { name: 'South Carolina', code: 'US-SC' },
            { name: 'South Dakota', code: 'US-SD' },
            { name: 'Tennessee', code: 'US-TN' },
            { name: 'Texas', code: 'US-TX' },
            { name: 'Utah', code: 'US-UT' },
            { name: 'Vermont', code: 'US-VT' },
            { name: 'Virginia', code: 'US-VA' },
            { name: 'Washington', code: 'US-WA' },
            { name: 'West Virginia', code: 'US-WV' },
            { name: 'Wisconsin', code: 'US-WI' },
            { name: 'Wyoming', code: 'US-WY' }
        ];
        
        // Populate regions datalist
        function populateRegionsDatalist() {
            const datalist = document.getElementById('regionsList');
            if (!datalist) return;
            
            datalist.innerHTML = ebirdRegions.map(region => 
                `<option value="${region.code}">${region.name} (${region.code})</option>`
            ).join('');
        }
        
        // Call on page load
        window.addEventListener('DOMContentLoaded', populateRegionsDatalist);
        
        async function loadTopEBirders() {
            const regionInput = document.getElementById('topEBirdersRegion').value.trim();
            const timePeriod = document.getElementById('topEBirdersTimePeriod').value;
            
            if (!regionInput) {
                alert('Please enter or select a region');
                return;
            }
            
            if (!userApiKey) {
                alert('Please connect to eBird first');
                return;
            }
            
            // Extract region code if format is "Name (CODE)"
            let regionCode = regionInput;
            const match = regionInput.match(/\(([^)]+)\)$/);
            if (match) {
                regionCode = match[1];
            }
            
            console.log(`üèÜ Loading Top 100 for ${regionCode} (${timePeriod})`);
            showLoading('Loading Top 100 eBirders...');
            
            try {
                // Determine time parameter (y = year, life = lifetime)
                const time = timePeriod === 'year' ? 'y' : 'life';
                const year = new Date().getFullYear();
                
                // Fetch top 100
                const url = time === 'y' 
                    ? `https://api.ebird.org/v2/product/top100/${regionCode}/${year}/1/12`
                    : `https://api.ebird.org/v2/product/top100/${regionCode}/1/12`;
                    
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch top 100: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    hideLoading();
                    alert('No top 100 data available for this region');
                    return;
                }
                
                // Store top 10
                topEBirdersData = data.slice(0, 10);
                currentTopEBirdersRegion = regionCode;
                
                // Display results
                await displayTopEBirders(topEBirdersData, regionCode, timePeriod);
                
                hideLoading();
                console.log(`‚úÖ Loaded ${topEBirdersData.length} top eBirders`);
                
            } catch (error) {
                hideLoading();
                console.error('Error loading top eBirders:', error);
                alert('Error loading top 100 data. Please try again.');
            }
        }
        
        async function displayTopEBirders(data, regionCode, timePeriod) {
            const container = document.getElementById('topEBirdersList');
            if (!container) return;
            
            const year = new Date().getFullYear();
            const timePeriodText = timePeriod === 'year' ? `2025` : 'All Time';
            
            // Find user's ranking if they're in the list
            const userRank = data.findIndex(birder => 
                birder.userDisplayName === userName
            );
            
            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-primary); border-radius: 8px; border-left: 4px solid #10b981;">
                    <h4 style="margin: 0 0 5px 0; color: var(--text-primary); font-size: 1.1em;">
                        üèÜ Top 10 eBirders in ${regionCode} - ${timePeriodText}
                    </h4>
                    <div style="font-size: 0.85em; color: var(--text-secondary);">
                        Ranked by species count
                    </div>
                </div>
            `;
            
            // Show user's rank if found
            if (userRank >= 0) {
                html += `
                    <div style="margin-bottom: 15px; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <strong style="color: #92400e;">Your Ranking: #${userRank + 1}</strong> 
                        with ${data[userRank].numSpecies} species
                    </div>
                `;
            }
            
            // Table header
            html += `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead>
                        <tr style="background: var(--bg-primary); border-bottom: 2px solid var(--border-color);">
                            <th style="padding: 10px; text-align: left; color: var(--text-primary);">Rank</th>
                            <th style="padding: 10px; text-align: left; color: var(--text-primary);">Name</th>
                            <th style="padding: 10px; text-align: center; color: var(--text-primary);">Checklists</th>
                            <th style="padding: 10px; text-align: center; color: var(--text-primary);">Species</th>
                            <th style="padding: 10px; text-align: left; color: var(--text-primary);">Most Recent Addition</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Display each birder
            for (let i = 0; i < data.length; i++) {
                const birder = data[i];
                const isUser = birder.userDisplayName === userName;
                const rowStyle = isUser ? 'background: #fef3c7;' : i % 2 === 0 ? 'background: var(--bg-primary);' : '';
                
                // Medal emoji for top 3
                let rankDisplay = `${i + 1}.`;
                if (i === 0) rankDisplay = 'ü•á';
                else if (i === 1) rankDisplay = 'ü•à';
                else if (i === 2) rankDisplay = 'ü•â';
                
                // Try to fetch recent addition (this would be from additional API call)
                const recentAddition = await getRecentAddition(birder.userDisplayName, regionCode);
                
                html += `
                    <tr style="${rowStyle} border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 10px; font-weight: 600; color: var(--text-primary);">${rankDisplay}</td>
                        <td style="padding: 10px;">
                            <a href="https://ebird.org/profile/${birder.profileHandle || ''}" 
                               target="_blank" 
                               style="color: #10b981; text-decoration: none; font-weight: 600;">
                                ${birder.userDisplayName}
                            </a>
                        </td>
                        <td style="padding: 10px; text-align: center; color: var(--text-secondary);">
                            ${birder.numChecklists || '-'}
                        </td>
                        <td style="padding: 10px; text-align: center;">
                            <strong style="color: var(--text-primary);">${birder.numSpecies}</strong>
                        </td>
                        <td style="padding: 10px; font-size: 0.85em; color: var(--text-secondary);">
                            ${recentAddition || 'Loading...'}
                        </td>
                    </tr>
                `;
            }
            
            html += `
                    </tbody>
                </table>
                
                <div style="margin-top: 15px; padding: 12px; background: var(--bg-primary); border-radius: 6px; text-align: center; font-size: 0.85em; color: var(--text-secondary);">
                    üí° Click any name to view their eBird profile
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        async function getRecentAddition(userName, regionCode) {
            try {
                // Fetch recent observations for this user
                const url = `https://api.ebird.org/v2/data/obs/${regionCode}/recent?maxResults=100&back=30&detail=full`;
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });
                
                if (!response.ok) return 'Data unavailable';
                
                const obs = await response.json();
                
                // Filter to this user's observations
                const userObs = obs.filter(o => o.userDisplayName === userName);
                
                if (userObs.length === 0) return 'No recent data';
                
                // Get most recent observation
                const mostRecent = userObs[0];
                return `${mostRecent.comName} (${new Date(mostRecent.obsDt).toLocaleDateString()})`;
                
            } catch (error) {
                console.error('Error fetching recent addition:', error);
                return 'Error loading';
            }
        }
        
        // Auto-load after area search
        async function autoLoadTopEBirdersForRegion(regionCode) {
            if (!regionCode) return;
            
            // Set region in input
            const regionInput = document.getElementById('topEBirdersRegion');
            if (regionInput) {
                regionInput.value = regionCode;
                
                // Auto-expand panel
                const panel = document.getElementById('topEBirdersPanelContent');
                const toggle = document.getElementById('topEBirdersPanelToggle');
                if (panel && toggle) {
                    panel.classList.add('active');
                    toggle.textContent = '‚àí';
                }
                
                // Auto-load
                setTimeout(() => loadTopEBirders(), 500);
            }
        }

        // ============================================
        // MARKER MANAGEMENT
        // ============================================
        function clearMarkers() {
            markersArray.forEach(marker => marker.setMap(null));
            markersArray = [];
        }

        function clearHotspots() {
            hotspotsArray.forEach(marker => marker.setMap(null));
            hotspotsArray = [];
        }

        // ============================================
        // RESET ALL
        // ============================================
        function resetAll() {
            // Clear route
            if (directionsRenderer) {
                directionsRenderer.setDirections({ routes: [] });
            }
            currentRoute = null;
            tripWaypoints = [];
            routeDuration = '';

            // Clear markers
            clearMarkers();
            clearHotspots();
            clearChecklists();

            // Clear data
            allSightings = [];
            allHotspots = [];
            allChecklists = [];
            targetSpecies = [];

            // Reset UI
            document.getElementById('originInput').value = '';
            document.getElementById('destinationInput').value = '';
            document.getElementById('routeDuration').classList.add('hidden');
            document.getElementById('printBtn').classList.add('hidden');
            document.getElementById('belowMap').style.display = 'none';
            document.getElementById('waypointList').innerHTML = '';

            // Reset map view
            if (map) {
                map.setCenter({ lat: 39.8283, lng: -98.5795 });
                map.setZoom(4);
            }

            console.log('üîÑ Reset complete');
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        console.log('‚úÖ All JavaScript loaded successfully');
        console.log('üìã Ready for eBird connection');

    </script>
    
    <!-- ============================================
         FOOTER - HOW IT WORKS
         ============================================ -->
    <div style="background: #f9fafb; border-top: 2px solid var(--border-color); padding: 40px 20px; margin-top: 40px;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <h2 style="color: #065f46; margin: 0 0 20px 0; font-size: 1.5em;">üîç How Traveling Birder Search Works</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 30px;">
                <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
                    <h3 style="color: #065f46; margin: 0 0 10px 0; font-size: 1.1em;">üì° eBird API Limitations</h3>
                    <p style="margin: 0; line-height: 1.6; color: var(--text-primary);">
                        <strong>Search Radius:</strong> Maximum 50 km (31 miles) per search<br>
                        <strong>Time Range:</strong> Recent observations default to 30 days<br>
                        <strong>Life List:</strong> API only returns last 30 days of your data
                    </p>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h3 style="color: #065f46; margin: 0 0 10px 0; font-size: 1.1em;">üîÑ Our Workarounds</h3>
                    <p style="margin: 0; line-height: 1.6; color: var(--text-primary);">
                        <strong>Routes & Large Areas:</strong> Multiple overlapping 31-mile searches every 20 miles for complete coverage<br>
                        <strong>Life List:</strong> Import your complete eBird CSV for full history<br>
                        <strong>Time Range:</strong> Adjustable from 7 days to 1 year for each search type
                    </p>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h3 style="color: #065f46; margin: 0 0 10px 0; font-size: 1.1em;">üìä Performance</h3>
                    <p style="margin: 0; line-height: 1.6; color: var(--text-primary);">
                        <strong>Short routes (&lt;50 mi):</strong> Instant<br>
                        <strong>Long routes (200+ mi):</strong> 30-60 seconds<br>
                        <strong>Very long routes (1000+ mi):</strong> 2-3 minutes<br>
                        <strong>Top eBirders:</strong> 5-10 seconds (11 API calls)
                    </p>
                </div>
            </div>
            
            <div style="background: #ecfdf5; padding: 20px; border-radius: 8px; border: 1px solid #10b981;">
                <h3 style="color: #065f46; margin: 0 0 10px 0; font-size: 1.1em;">üéØ Why You Might Not See Expected Birds</h3>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <p style="margin: 0 0 10px 0;"><strong>1. Time Range:</strong> Default searches show last 30 days. Use the Time Range dropdown to see older sightings (up to 1 year). Species search and main search have independent time settings.</p>
                    <p style="margin: 0 0 10px 0;"><strong>2. Search Radius:</strong> Default is 15 miles for main search, 25 miles for species search. Birds may be outside this range. Increase up to 31 miles max (eBird API limit).</p>
                    <p style="margin: 0 0 10px 0;"><strong>3. eBird Data Coverage:</strong> We only show birds reported to eBird. Remote areas may have sparse data. Check eBird.org directly for your region's coverage.</p>
                    <p style="margin: 0 0 10px 0;"><strong>4. Target List Filter:</strong> If using Life List or Year List filters and seeing few results, you may have already seen most birds. Switch to "Show All Species" to see everything.</p>
                    <p style="margin: 0 0 10px 0;"><strong>5. ABA Rarity Filter:</strong> If unchecking Code 1-6, you'll hide those species. Enable all codes to see everything.</p>
                    <p style="margin: 0 0 10px 0;"><strong>6. Life List Completeness:</strong> If you haven't imported your eBird CSV, your life list only includes the last 30 days. Import full CSV under eBird connection for accurate targets.</p>
                    <p style="margin: 0 0 10px 0;"><strong>7. Region-Only Mode:</strong> "Region boundaries only" checkbox limits to exact state/county bounds (no radius). Uncheck for wider coverage with 31-mile radius expansion.</p>
                    <p style="margin: 0 0 10px 0;"><strong>8. Seasonal Filters:</strong> "Expected Seasonal Targets" shows only common birds for the current season. Use "Life List Targets Only" or "Month List Targets Only" to see all species you haven't seen.</p>
                    <p style="margin: 0;"><strong>9. API Rate Limits:</strong> eBird may throttle requests for very large searches. If search fails, try smaller areas or wait a few minutes.</p>
                </div>
            </div>
            
            <div style="background: #eff6ff; padding: 20px; border-radius: 8px; border: 1px solid #3b82f6; margin-top: 20px;">
                <h3 style="color: #065f46; margin: 0 0 10px 0; font-size: 1.1em;">üí° Pro Tips for Best Results</h3>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <p style="margin: 0 0 10px 0;">‚úÖ <strong>Import Full Life List:</strong> Upload your complete eBird CSV for accurate target identification across all time periods.</p>
                    <p style="margin: 0 0 10px 0;">‚úÖ <strong>Adjust Time Ranges:</strong> For winter birds, search "Last 6 months" or "Last year" instead of default 30 days.</p>
                    <p style="margin: 0 0 10px 0;">‚úÖ <strong>Use Species Search:</strong> For rare species, use Species Search with 100-mile radius and "Last year" time range to cast a wider net.</p>
                    <p style="margin: 0 0 10px 0;">‚úÖ <strong>Region vs Grid:</strong> For states/counties, use "Region boundaries only" for exact political boundaries. Uncheck for radius-based searches.</p>
                    <p style="margin: 0;">‚úÖ <strong>Check Top eBirders:</strong> See what other birders are finding in your area and compare your list with theirs.</p>
                </div>
            </div>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center; color: var(--text-secondary); font-size: 0.9em;">
                <p style="margin: 0 0 10px 0;">ü¶© <strong>Traveling Birder v7.1</strong> | Powered by eBird and Google Maps | 
                <a href="https://ebird.org/api/keygen" target="_blank" style="color: #10b981; text-decoration: none;">Get eBird API Key</a></p>
                <p style="margin: 0; font-size: 0.85em;">
                    Questions or feedback? Contact: <a href="mailto:faughnan-ventures@gmail.com" style="color: #10b981; text-decoration: none;">faughnan-ventures@gmail.com</a>
                </p>
            </div>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <div id="csvImportModal" class="modal-overlay">
        <div class="modal">
            <span class="modal-close" onclick="closeModal('csvImportModal')">&times;</span>
            <h2>üì• Import Your eBird Life List</h2>
            
            <div class="info-box warning">
                <p style="margin: 0 0 10px 0; font-weight: 600;">‚ö†Ô∏è eBird API Limitation</p>
                <p style="margin: 0;">The eBird API only provides the last <strong>30 days</strong> of your observations. This is an eBird policy limitation.</p>
            </div>
            
            <div class="info-box success">
                <p style="margin: 0 0 10px 0; font-weight: 600;">‚úÖ Solution: Upload Your Complete History</p>
                <ol style="margin: 10px 0 0 20px;">
                    <li>Visit <a href="https://ebird.org/myebird" target="_blank" style="color: #10b981; font-weight: 600;">ebird.org/myebird</a></li>
                    <li>Click "Download My Data" (right sidebar)</li>
                    <li>Select the CSV file and upload it here:</li>
                </ol>
            </div>
            
            <div style="margin: 20px 0;">
                <input type="file" id="csvFileInput" accept=".csv" style="margin: 10px 0; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; width: 100%;">
                <button onclick="handleCSVUpload()" style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 1em; width: 100%; font-weight: 600; margin-top: 10px;">
                    üì• Upload CSV
                </button>
            </div>
            
            <div class="info-box info">
                <p style="margin: 0; font-size: 0.9em;">üîí <strong>Privacy:</strong> Your CSV is processed locally on your device. It is never uploaded to any server. All data stays on your computer.</p>
            </div>
        </div>
    </div>

    <!-- Terms & Conditions Modal -->
    <div id="termsModal" class="modal-overlay">
        <div class="modal">
            <span class="modal-close" onclick="closeModal('termsModal')">&times;</span>
            <h2>üìã Terms of Use & Privacy</h2>
            
            <div style="max-height: 400px; overflow-y: auto; background: var(--bg-primary); padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid var(--border-color);">
                <h3>TRAVELING BIRDER - TERMS OF USE</h3>
                <p style="font-size: 0.85em; margin-bottom: 20px;">Last Updated: December 18, 2024</p>
                
                <h4>1. YOUR DATA & PRIVACY</h4>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li>Your life list data is stored locally on YOUR device only</li>
                    <li>We do NOT upload, store, or access your personal birding data</li>
                    <li>We do NOT sell or share your information with third parties</li>
                    <li>Your eBird API key is stored securely in your browser</li>
                    <li>All data processing happens on your device</li>
                </ul>
                
                <h4>2. EBIRD API USAGE</h4>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li>This app uses the eBird API to fetch bird observation data</li>
                    <li>eBird API has a 30-day limitation for personal observations (eBird policy)</li>
                    <li>You can import your full CSV from eBird for complete historical data</li>
                    <li>All API usage follows eBird's Terms of Service</li>
                </ul>
                
                <h4>3. NO WARRANTY</h4>
                <ul style="line-height: 1.8; margin-bottom: 20px;">
                    <li>This app is provided "as is" for birding assistance</li>
                    <li>We are not responsible for missed birds or inaccurate data</li>
                    <li>eBird data may have gaps, errors, or delays</li>
                    <li>Always verify rare sightings independently before traveling</li>
                </ul>
                
                <h4>4. CONTACT & SUPPORT</h4>
                <ul style="line-height: 1.8;">
                    <li>Questions: <a href="/cdn-cgi/l/email-protection#ec8a8d998b84828d82c19a898298999e899fac8b818d8580c28f8381" style="color: #10b981;"><span class="__cf_email__" data-cfemail="14727561737c7a757a3962717a6061667167547379757d783a777b79">[email&#160;protected]</span></a></li>
                    <li>We respect your privacy and will never spam you</li>
                    <li>Bug reports and feature requests welcome</li>
                </ul>
            </div>
            
          