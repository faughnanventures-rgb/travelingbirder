<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traveling Birder - eBird Location Alerts</title>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvpU9tANBmnbKqMM2UWvELa9nRcrhneY0&libraries=places,geometry&callback=initMap"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .header {
            background: white;
            color: #065f46;
            padding: 35px;
            text-align: center;
            border-bottom: 3px solid #10b981;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: #065f46;
        }

        .header p {
            font-size: 1.1em;
            position: relative;
            z-index: 1;
            font-weight: 400;
            color: #6b7280;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: calc(100vh - 200px);
            min-height: 600px;
        }

        .sidebar {
            background: white;
            padding: 25px;
            overflow-y: auto;
            border-right: 1px solid #e5e7eb;
        }

        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f9fafb;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #10b981;
            border-radius: 4px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h3 {
            color: #065f46;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #10b981;
            padding-bottom: 8px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
            font-size: 0.9em;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        button {
            width: 100%;
            padding: 12px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        button:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .alert-item {
            background: white;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #10b981;
            transition: all 0.3s;
        }

        .alert-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transform: translateX(4px);
        }

        .alert-item strong {
            color: #065f46;
            display: block;
            margin-bottom: 5px;
            font-size: 1.05em;
        }

        .alert-item small {
            color: #6b7280;
            font-size: 0.85em;
        }

        .remove-btn {
            background: #ef4444;
            padding: 6px 12px;
            font-size: 0.8em;
            margin-top: 8px;
            width: auto;
        }

        .remove-btn:hover {
            background: #dc2626;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 0 0 20px 0;
        }

        .route-mode {
            background: #fef3c7;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #fbbf24;
        }

        .route-mode p {
            font-size: 0.85em;
            color: #92400e;
        }

        .login-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .login-section.authenticated {
            background: #ecfdf5;
            border: 2px solid #10b981;
        }

        .api-key-input {
            position: relative;
        }

        .api-key-input input {
            padding-right: 40px;
        }

        .toggle-visibility {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            width: auto;
            margin: 0;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-badge.connected {
            background: #10b981;
            color: white;
        }

        .status-badge.disconnected {
            background: #ef4444;
            color: white;
        }

        .filter-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-btn {
            padding: 10px;
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0;
        }

        .filter-btn:hover {
            transform: none;
            box-shadow: none;
            background: #f9fafb;
            border-color: #10b981;
        }

        .filter-btn.active {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .time-filter-group {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 15px;
        }

        .time-filter-btn {
            padding: 8px 4px;
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0;
        }

        .time-filter-btn:hover {
            transform: none;
            box-shadow: none;
            background: #f9fafb;
            border-color: #10b981;
        }

        .time-filter-btn.active {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .filter-section-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.85em;
        }

        .user-info {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            border: 1px solid #d1fae5;
        }

        .user-info p {
            margin: 5px 0;
            color: #374151;
        }

        .logout-btn {
            background: #6b7280;
            font-size: 0.9em;
            padding: 8px;
            margin-top: 8px;
        }

        .logout-btn:hover {
            background: #4b5563;
        }

        .list-filter-section {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .checkbox-group {
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            cursor: pointer;
            accent-color: #10b981;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        #speciesDropdown {
            margin-top: 5px;
        }

        #speciesDropdown div:last-child {
            border-bottom: none;
        }

        .species-dropdown-item {
            transition: background-color 0.2s;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-box {
            background: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
            transition: all 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #10b981;
        }

        .stat-box .number {
            font-size: 2em;
            font-weight: bold;
            color: #10b981;
        }

        .stat-box .label {
            font-size: 0.85em;
            color: #6b7280;
            margin-top: 5px;
            font-weight: 500;
        }

        .location-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: white;
            color: #065f46;
            padding: 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #10b981;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 600;
            color: #065f46;
        }

        .close {
            color: #6b7280;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: auto;
            line-height: 1;
            transition: opacity 0.2s;
        }

        .close:hover {
            transform: none;
            box-shadow: none;
            opacity: 0.6;
            color: #065f46;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .species-list {
            list-style: none;
            padding: 0;
        }

        .species-item {
            padding: 14px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .species-item:last-child {
            border-bottom: none;
        }

        .species-item:hover {
            background: #f9fafb;
        }

        .species-name {
            font-weight: 500;
            color: #374151;
        }

        .species-count {
            background: #ecfdf5;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            color: #10b981;
            font-weight: 600;
            border: 1px solid #d1fae5;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .target-badge {
            background: #10b981;
            color: white;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 0.75em;
            margin-left: 8px;
            font-weight: 700;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 320px 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .header p {
                font-size: 1em;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .main-content {
                grid-template-columns: 1fr;
                height: auto;
                min-height: auto;
            }

            .sidebar {
                max-height: 60vh;
                overflow-y: auto;
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }

            #map {
                height: 400px;
                min-height: 400px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .header p {
                font-size: 0.9em;
            }

            .filter-group {
                grid-template-columns: 1fr 1fr;
            }

            .time-filter-group {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .location-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .sidebar {
                padding: 15px;
            }

            .section {
                margin-bottom: 20px;
            }

            .section h3 {
                font-size: 1em;
            }

            button {
                padding: 10px;
                font-size: 0.9em;
            }

            .filter-btn, .time-filter-btn {
                font-size: 0.7em;
                padding: 6px 2px;
            }

            .stat-box .number {
                font-size: 1.5em;
            }

            .modal-header h2 {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <!-- Modal for species list -->
    <div id="speciesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Recent Observations</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading-spinner">Loading...</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ü¶© Traveling Birder</h1>
            <p>Track bird sightings on your route and filter by your personal lists</p>
            <p style="font-size: 0.9em; margin-top: 8px; opacity: 0.8;">Questions? Email <a href="mailto:faughnan-ventures@gmail.com" style="color: #10b981; text-decoration: none; font-weight: 600;">faughnan-ventures@gmail.com</a></p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="section" style="background: white; border: 1px solid #e5e7eb; margin-bottom: 20px; border-radius: 8px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleInstructions()">
                        <h3 style="margin: 0; border: none; padding: 0; color: #065f46;">üìñ Quick Start Guide</h3>
                        <span id="instructionsToggle" style="font-size: 1.5em; font-weight: bold; color: #10b981;">‚àí</span>
                    </div>
                    <div id="instructionsContent" style="margin-top: 15px;">
                        <ol style="margin: 0; padding-left: 20px; line-height: 1.8; color: #374151;">
                            <li><strong>Connect eBird:</strong> Enter your API key (get free at <a href="https://ebird.org/api/keygen" target="_blank" style="color: #10b981; font-weight: 600;">ebird.org/api/keygen</a>)</li>
                            <li><strong>Set Filters:</strong> Choose list scope, time period, and observation filters</li>
                            <li><strong>Search:</strong> Pick location or route mode, select time range (1-365 days)</li>
                            <li><strong>Explore:</strong> Toggle hotspots and top checklists, click markers for details</li>
                            <li><strong>Set Alerts:</strong> Get notified when target birds appear in your area</li>
                        </ol>
                        <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-top: 12px; border: 1px solid #e5e7eb;">
                            <strong style="color: #374151;">üí° Pro Tips:</strong>
                            <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 0.9em; color: #6b7280;">
                                <li>Use "Show only birds NOT on my list" to find lifers</li>
                                <li>Check top checklists to see what's possible</li>
                                <li>Hotspots show the most productive birding locations</li>
                                <li><span style="color: #10b981; font-weight: 600;">TARGET</span> badges highlight rare/notable species</li>
                                <li>Route mode shows sightings along your entire drive</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="section" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleLegend()">
                        <h3 style="margin: 0; border: none; padding: 0; color: #065f46;">üîë Map Legend</h3>
                        <span id="legendToggle" style="font-size: 1.5em; font-weight: bold; color: #10b981;">‚àí</span>
                    </div>
                    <div id="legendContent" style="margin-top: 15px;">
                        <div style="margin-bottom: 12px;">
                            <strong style="display: block; margin-bottom: 8px; color: #374151; font-size: 0.95em;">Bird Sightings:</strong>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; background: #10b981; margin-right: 8px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                <span style="font-size: 0.9em; color: #6b7280;">Common species</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; background: #fbbf24; margin-right: 8px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                <span style="font-size: 0.9em; color: #6b7280;">Uncommon species</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; background: #ef4444; margin-right: 8px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                <span style="font-size: 0.9em; color: #6b7280;">Rare species</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; background: #10b981; margin-right: 8px; border: 3px solid #0d9488; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                <span style="font-size: 0.9em; color: #6b7280;"><strong>Teal border:</strong> On your eBird list</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 12px;">
                            <strong style="display: block; margin-bottom: 8px; color: #374151; font-size: 0.95em;">Map Layers:</strong>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span style="display: inline-block; margin-right: 8px; font-size: 1.2em;">üìç</span>
                                <span style="font-size: 0.9em; color: #6b7280;">eBird Hotspots (click for species count)</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span style="display: inline-block; width: 24px; height: 24px; border-radius: 50%; background: #0d9488; margin-right: 8px; border: 2px solid white; color: white; text-align: center; line-height: 20px; font-size: 0.75em; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">1</span>
                                <span style="font-size: 0.9em; color: #6b7280;">Top Checklists (ranked by species)</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span style="display: inline-block; width: 30px; height: 4px; background: #0d9488; margin-right: 8px; border-radius: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                <span style="font-size: 0.9em; color: #6b7280;">Driving route</span>
                            </div>
                        </div>

                        <div>
                            <strong style="display: block; margin-bottom: 8px; color: #374151; font-size: 0.95em;">Badges:</strong>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span class="target-badge" style="margin-left: 0; margin-right: 8px;">TARGET</span>
                                <span style="font-size: 0.9em; color: #6b7280;">Notable/rare bird for the area</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>üîë eBird Account</h3>
                    <div id="loginSection" class="login-section">
                        <div class="input-group api-key-input">
                            <label>eBird API Key</label>
                            <input type="password" id="apiKey" placeholder="Enter your eBird API key">
                            <button class="toggle-visibility" onclick="toggleApiKeyVisibility()" type="button">üëÅÔ∏è</button>
                        </div>
                        <button onclick="connectEbird()">Connect to eBird</button>
                        <p style="font-size: 0.85em; color: #6c757d; margin-top: 10px;">
                            Get your free API key at <a href="https://ebird.org/api/keygen" target="_blank" style="color: #2c5f2d;">ebird.org/api/keygen</a>
                        </p>
                        <div id="userInfo"></div>
                    </div>
                </div>

                <div class="section" id="listFilterSection" style="display: none;">
                    <h3>üìã My eBird Lists</h3>
                    <div class="list-filter-section">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2c5f2d;">Geographic Scope</label>
                        <div class="filter-group">
                            <button class="filter-btn active" data-scope="county" onclick="setScope('county')">County</button>
                            <button class="filter-btn" data-scope="state" onclick="setScope('state')">State</button>
                            <button class="filter-btn" data-scope="country" onclick="setScope('country')">Country</button>
                            <button class="filter-btn" data-scope="world" onclick="setScope('world')">World</button>
                        </div>
                        
                        <label style="display: block; margin: 15px 0 10px 0; font-weight: 600; color: #2c5f2d;">Time Period</label>
                        <div class="filter-group">
                            <button class="filter-btn" data-period="month" onclick="setPeriod('month')">This Month</button>
                            <button class="filter-btn" data-period="year" onclick="setPeriod('year')">This Year</button>
                            <button class="filter-btn active" data-period="life" onclick="setPeriod('life')">Life List</button>
                        </div>

                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="showOnMyList" onchange="updateListFilter()">
                                <label for="showOnMyList">Show only birds on my list</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="showNotOnMyList" onchange="updateListFilter()">
                                <label for="showNotOnMyList">Show only birds NOT on my list</label>
                            </div>
                        </div>

                        <button onclick="refreshUserList()" style="margin-top: 15px;">Refresh My List</button>
                    </div>
                </div>

                <div class="section">
                    <h3>üîç Search Options</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2c5f2d;">Search Mode</label>
                        <div class="filter-group">
                            <button class="filter-btn active" data-mode="location" onclick="setSearchMode('location')">Single Location</button>
                            <button class="filter-btn" data-mode="route" onclick="setSearchMode('route')">Driving Route</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label class="filter-section-label">Time Range</label>
                        <div class="time-filter-group">
                            <button class="time-filter-btn" data-days="1" onclick="setTimeRange(1)">1 day</button>
                            <button class="time-filter-btn" data-days="3" onclick="setTimeRange(3)">3 days</button>
                            <button class="time-filter-btn active" data-days="7" onclick="setTimeRange(7)">7 days</button>
                            <button class="time-filter-btn" data-days="14" onclick="setTimeRange(14)">14 days</button>
                        </div>
                        <div class="time-filter-group">
                            <button class="time-filter-btn" data-days="21" onclick="setTimeRange(21)">21 days</button>
                            <button class="time-filter-btn" data-days="30" onclick="setTimeRange(30)">30 days</button>
                            <button class="time-filter-btn" data-days="year" onclick="setTimeRange('year')">Cal Year</button>
                            <button class="time-filter-btn" data-days="365" onclick="setTimeRange(365)">365 days</button>
                        </div>
                    </div>

                    <div id="locationSearch">
                        <div class="input-group">
                            <label>City/Town</label>
                            <input type="text" id="city" placeholder="e.g., Boston" value="Boston">
                        </div>
                        <div class="location-row">
                            <div class="input-group">
                                <label>State</label>
                                <input type="text" id="state" placeholder="e.g., MA" value="MA">
                            </div>
                            <div class="input-group">
                                <label>Country</label>
                                <input type="text" id="country" placeholder="e.g., USA" value="USA">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Search Radius (miles)</label>
                            <input type="number" id="radius" placeholder="15" value="15" min="1" max="50">
                        </div>
                        <button onclick="searchLocation()">Search Sightings</button>
                    </div>

                    <div id="routeSearch" style="display: none;">
                        <div class="input-group">
                            <label>Starting Location</label>
                            <input type="text" id="origin" placeholder="e.g., Boston, MA">
                        </div>
                        <div class="input-group">
                            <label>Destination</label>
                            <input type="text" id="destination" placeholder="e.g., Portland, ME">
                        </div>
                        <div class="input-group">
                            <label>Route Buffer (miles)</label>
                            <input type="number" id="routeBuffer" placeholder="10" value="10" min="1" max="50">
                        </div>
                        <button onclick="searchRoute()">Find Route & Sightings</button>
                        <button onclick="clearRouteSearch()" style="background: #6c757d; margin-top: 5px;">Clear Route</button>
                    </div>
                </div>

                <div class="section">
                    <h3>üó∫Ô∏è Map Layers</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="showHotspots" onchange="toggleHotspots()">
                            <label for="showHotspots">Show eBird Hotspots</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showTopChecklists" onchange="toggleTopChecklists()">
                            <label for="showTopChecklists">Show Top 10 Checklists</label>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>üîî View Species</h3>
                    <div class="input-group" style="position: relative;">
                        <label>Search Species</label>
                        <input 
                            type="text" 
                            id="speciesSearch" 
                            placeholder="Start typing species name..."
                            autocomplete="off"
                            oninput="searchSpecies()"
                            onfocus="showSpeciesDropdown()"
                        >
                        <div id="speciesDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #97bc62; border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-top: 5px;"></div>
                    </div>
                    <div class="input-group">
                        <label>Alert Radius (miles)</label>
                        <input type="number" id="alertRadius" placeholder="15" value="15" min="1" max="50">
                    </div>
                    <div class="input-group">
                        <label>Alert Type</label>
                        <select id="alertType">
                            <option value="location">Current Location</option>
                            <option value="route">Along Route</option>
                            <option value="both">Both</option>
                        </select>
                    </div>
                    <button onclick="addAlert()">Add Alert</button>
                </div>

                <div class="section">
                    <h3>üìã Active Alerts</h3>
                    <div id="alertsList"></div>
                </div>

                <div class="stats">
                    <div class="stat-box">
                        <div class="number" id="sightingCount">0</div>
                        <div class="label">Sightings</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="alertCount">0</div>
                        <div class="label">Alerts</div>
                    </div>
                </div>

                <div class="section" style="margin-top: 20px;">
                    <h3>üìä Area Statistics</h3>
                    <div class="stats" style="grid-template-columns: 1fr;">
                        <div class="stat-box" style="cursor: pointer;" onclick="showRecentObservations('selected')" title="Click to see species list">
                            <div class="number" id="weekSpeciesCount">-</div>
                            <div class="label" id="selectedRangeLabel">Last 7 Days</div>
                        </div>
                        <div class="stat-box" style="cursor: pointer;" onclick="showRecentObservations('month')" title="Click to see species list">
                            <div class="number" id="monthSpeciesCount">-</div>
                            <div class="label">Last 30 Days</div>
                        </div>
                        <div class="stat-box" style="cursor: pointer;" onclick="showRecentObservations('year')" title="Click to see recent observations">
                            <div class="number" id="yearSpeciesCount">-</div>
                            <div class="label">Last 365 Days</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="map"></div>
        </div>
    </div>

    <script>
        let map;
        let markers = [];
        let alerts = [];
        let routeMode = false;
        let routePoints = [];
        let routePath = null;
        let currentLocation = { lat: 42.3601, lng: -71.0589 };
        let geocoder;
        let directionsService;
        let directionsRenderer;
        let currentRoute = null;
        let searchMode = 'location'; // 'location' or 'route'
        let recentObservations = { week: [], month: [], year: [] };
        let targetSpecies = [];
        let timeRangeDays = 7; // Default to 7 days
        let hotspotMarkers = [];
        let checklistMarkers = [];
        let hotspotsData = [];
        let topChecklists = [];
        let allSpecies = []; // eBird taxonomy
        let selectedSpecies = null;
        
        // eBird authentication and list data
        let ebirdApiKey = null;
        let ebirdAuthenticated = false;
        let userList = new Set();
        let listScope = 'county';
        let listPeriod = 'life';
        let userLocation = { county: 'US-MA-017', state: 'US-MA', country: 'US' }; // Default: Middlesex County, MA

        // Demo bird sighting data (spread along Boston to Portland, ME route)
        const demoSightings = [
            // Boston area
            { species: "Bald Eagle", speciesCode: "baleag", lat: 42.3601, lng: -71.0589, date: "2024-12-15", rarity: "uncommon" },
            { species: "Red-tailed Hawk", speciesCode: "rethaw", lat: 42.3650, lng: -71.0640, date: "2024-12-15", rarity: "common" },
            { species: "Great Blue Heron", speciesCode: "grbher3", lat: 42.3580, lng: -71.0550, date: "2024-12-14", rarity: "common" },
            { species: "Peregrine Falcon", speciesCode: "perfal", lat: 42.3620, lng: -71.0600, date: "2024-12-15", rarity: "rare" },
            { species: "American Goldfinch", speciesCode: "amegfi", lat: 42.3590, lng: -71.0570, date: "2024-12-15", rarity: "common" },
            { species: "Northern Cardinal", speciesCode: "norcar", lat: 42.3610, lng: -71.0610, date: "2024-12-14", rarity: "common" },
            { species: "Blue Jay", speciesCode: "blujay", lat: 42.3630, lng: -71.0560, date: "2024-12-15", rarity: "common" },
            { species: "Snowy Owl", speciesCode: "snoowl1", lat: 42.3640, lng: -71.0620, date: "2024-12-13", rarity: "rare" },
            
            // Along I-95 North
            { species: "Turkey Vulture", speciesCode: "turvul", lat: 42.5500, lng: -70.9500, date: "2024-12-15", rarity: "common" },
            { species: "American Crow", speciesCode: "amecro", lat: 42.7800, lng: -70.8700, date: "2024-12-15", rarity: "common" },
            { species: "Black-capped Chickadee", speciesCode: "bkcchi", lat: 43.0100, lng: -70.7500, date: "2024-12-14", rarity: "common" },
            { species: "Tufted Titmouse", speciesCode: "tuftit", lat: 43.2500, lng: -70.6800, date: "2024-12-15", rarity: "common" },
            
            // New Hampshire section
            { species: "Downy Woodpecker", speciesCode: "dowwoo", lat: 43.0900, lng: -70.7600, date: "2024-12-15", rarity: "common" },
            { species: "Hairy Woodpecker", speciesCode: "haiwoo", lat: 43.1200, lng: -70.7400, date: "2024-12-14", rarity: "common" },
            { species: "White-breasted Nuthatch", speciesCode: "whbnut", lat: 43.2000, lng: -70.7000, date: "2024-12-15", rarity: "common" },
            
            // Approaching Portland
            { species: "Common Raven", speciesCode: "comrav", lat: 43.5000, lng: -70.3500, date: "2024-12-15", rarity: "common" },
            { species: "Ring-billed Gull", speciesCode: "ribgul", lat: 43.6000, lng: -70.2800, date: "2024-12-15", rarity: "common" },
            { species: "Herring Gull", speciesCode: "hergul", lat: 43.6400, lng: -70.2600, date: "2024-12-14", rarity: "common" },
            
            // Portland area
            { species: "Barrow's Goldeneye", speciesCode: "bargol", lat: 43.6591, lng: -70.2568, date: "2024-12-15", rarity: "rare" },
            { species: "Common Eider", speciesCode: "comeid", lat: 43.6700, lng: -70.2400, date: "2024-12-15", rarity: "uncommon" },
            { species: "Purple Sandpiper", speciesCode: "pursan", lat: 43.6615, lng: -70.2483, date: "2024-12-14", rarity: "uncommon" },
            { species: "Harlequin Duck", speciesCode: "harduc", lat: 43.6650, lng: -70.2450, date: "2024-12-15", rarity: "rare" },
        ];

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: currentLocation,
                zoom: 12,
                mapTypeControl: true,
                streetViewControl: false,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: false,
                polylineOptions: {
                    strokeColor: '#4285F4',
                    strokeWeight: 5,
                    strokeOpacity: 0.8
                }
            });

            map.addListener('click', function(event) {
                if (routeMode) {
                    addRoutePoint(event.latLng);
                }
            });

            // Check for saved API key
            const savedApiKey = localStorage.getItem('ebirdApiKey');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }

            // Load initial demo sightings
            searchLocation();
        }

        // eBird Authentication Functions
        async function connectEbird() {
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiKey) {
                alert('Please enter your eBird API key');
                return;
            }

            try {
                // Test the API key by making a simple request
                const response = await fetch('https://api.ebird.org/v2/ref/taxonomy/ebird?fmt=json&species=baleag', {
                    headers: {
                        'X-eBirdApiToken': apiKey
                    }
                });

                if (response.ok) {
                    ebirdApiKey = apiKey;
                    ebirdAuthenticated = true;
                    
                    // Store in localStorage for persistence
                    localStorage.setItem('ebirdApiKey', apiKey);
                    
                    updateAuthUI();
                    await loadUserList();
                    await loadSpeciesTaxonomy(); // Load species for autocomplete
                    showNotification('‚úÖ Successfully connected to eBird!');
                } else {
                    throw new Error('Invalid API key');
                }
            } catch (error) {
                alert('Failed to connect to eBird. Please check your API key and try again.');
                console.error('eBird connection error:', error);
            }
        }

        function disconnectEbird() {
            ebirdApiKey = null;
            ebirdAuthenticated = false;
            userList.clear();
            localStorage.removeItem('ebirdApiKey');
            
            // Uncheck filter boxes
            document.getElementById('showOnMyList').checked = false;
            document.getElementById('showNotOnMyList').checked = false;
            
            updateAuthUI();
            searchLocation(); // Refresh map without filters
            showNotification('Disconnected from eBird');
        }

        function updateAuthUI() {
            const loginSection = document.getElementById('loginSection');
            const listFilterSection = document.getElementById('listFilterSection');
            const userInfoDiv = document.getElementById('userInfo');

            if (ebirdAuthenticated) {
                loginSection.classList.add('authenticated');
                listFilterSection.style.display = 'block';
                
                userInfoDiv.innerHTML = `
                    <div class="user-info">
                        <span class="status-badge connected">‚óè Connected</span>
                        <p><strong>API Key:</strong> ${ebirdApiKey.substring(0, 8)}...</p>
                        <p><strong>List:</strong> ${userList.size} species</p>
                        <button class="logout-btn" onclick="disconnectEbird()">Disconnect</button>
                    </div>
                `;
                
                document.getElementById('apiKey').disabled = true;
            } else {
                loginSection.classList.remove('authenticated');
                listFilterSection.style.display = 'none';
                userInfoDiv.innerHTML = '<span class="status-badge disconnected">‚óè Not Connected</span>';
                document.getElementById('apiKey').disabled = false;
            }
        }

        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('apiKey');
            const button = event.target;
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                button.textContent = 'üôà';
            } else {
                apiKeyInput.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        // eBird List Management
        async function loadUserList() {
            if (!ebirdAuthenticated) return;

            try {
                showNotification('Loading your eBird list...');
                
                // Determine region code based on scope
                let regionCode = userLocation.country;
                
                if (listScope === 'county') {
                    regionCode = userLocation.county;
                } else if (listScope === 'state') {
                    regionCode = userLocation.state;
                } else if (listScope === 'world') {
                    regionCode = 'world';
                }

                // Calculate date range based on period
                let url = `https://api.ebird.org/v2/product/spplist/${regionCode}`;
                const params = new URLSearchParams();
                
                if (listPeriod === 'month') {
                    const today = new Date();
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                    params.append('startDate', formatDate(firstDay));
                    params.append('endDate', formatDate(today));
                } else if (listPeriod === 'year') {
                    const today = new Date();
                    const firstDay = new Date(today.getFullYear(), 0, 1);
                    params.append('startDate', formatDate(firstDay));
                    params.append('endDate', formatDate(today));
                }

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url, {
                    headers: {
                        'X-eBirdApiToken': ebirdApiKey
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Data is array of species codes
                    userList.clear();
                    data.forEach(speciesCode => {
                        userList.add(speciesCode);
                    });

                    updateAuthUI();
                    searchLocation(); // Refresh map with new filters
                    showNotification(`‚úÖ Loaded ${userList.size} species from your ${listScope} ${listPeriod} list`);
                } else {
                    throw new Error(`Failed to load user list: ${response.status}`);
                }
            } catch (error) {
                console.error('Error loading user list:', error);
                showNotification('‚ö†Ô∏è Error loading your list. Using demo data.');
            }
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function setScope(scope) {
            listScope = scope;
            
            // Update button states
            document.querySelectorAll('[data-scope]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            refreshUserList();
        }

        function setPeriod(period) {
            listPeriod = period;
            
            // Update button states
            document.querySelectorAll('[data-period]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            refreshUserList();
        }

        function updateListFilter() {
            const showOnList = document.getElementById('showOnMyList').checked;
            const showNotOnList = document.getElementById('showNotOnMyList').checked;
            
            // Prevent both being checked
            if (showOnList && showNotOnList) {
                if (event.target.id === 'showOnMyList') {
                    document.getElementById('showNotOnMyList').checked = false;
                } else {
                    document.getElementById('showOnMyList').checked = false;
                }
            }
            
            searchLocation();
        }

        async function loadAreaStatistics(lat, lng, radiusMiles) {
            const radiusKm = Math.round(radiusMiles * 1.60934);
            
            // Reset counts
            document.getElementById('monthSpeciesCount').textContent = '-';
            document.getElementById('yearSpeciesCount').textContent = '-';
            document.getElementById('weekSpeciesCount').textContent = '-';

            if (!ebirdAuthenticated) {
                // Show demo data if not authenticated
                document.getElementById('monthSpeciesCount').textContent = '45';
                document.getElementById('yearSpeciesCount').textContent = '128';
                document.getElementById('weekSpeciesCount').textContent = '32';
                return;
            }

            try {
                const today = new Date();
                
                // Calculate back parameter based on timeRangeDays
                let backDays = timeRangeDays;
                let useCalendarYear = false;
                
                if (timeRangeDays === 'year') {
                    useCalendarYear = true;
                    const yearStart = new Date(today.getFullYear(), 0, 1);
                    const diffTime = Math.abs(today - yearStart);
                    backDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                }
                
                // Fetch observations for selected time range
                const primaryUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=${backDays}`;
                const primaryResponse = await fetch(primaryUrl, {
                    headers: { 'X-eBirdApiToken': ebirdApiKey }
                });

                if (primaryResponse.ok) {
                    const primaryData = await primaryResponse.json();
                    recentObservations.week = primaryData; // Store in week for now
                    
                    // Count unique species
                    const primarySpecies = new Set(primaryData.map(obs => obs.speciesCode));
                    document.getElementById('weekSpeciesCount').textContent = primarySpecies.size;
                }

                // Fetch 30-day observations for "This Month"
                const monthUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=30`;
                const monthResponse = await fetch(monthUrl, {
                    headers: { 'X-eBirdApiToken': ebirdApiKey }
                });

                if (monthResponse.ok) {
                    const monthData = await monthResponse.json();
                    recentObservations.month = monthData;
                    
                    const monthSpecies = new Set(monthData.map(obs => obs.speciesCode));
                    document.getElementById('monthSpeciesCount').textContent = monthSpecies.size;
                }

                // For year, try to get calendar year data
                if (useCalendarYear) {
                    // Calendar year is same as primary search
                    document.getElementById('yearSpeciesCount').textContent = document.getElementById('weekSpeciesCount').textContent;
                } else {
                    // Get full year estimate
                    const yearUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=365`;
                    const yearResponse = await fetch(yearUrl, {
                        headers: { 'X-eBirdApiToken': ebirdApiKey }
                    });

                    if (yearResponse.ok) {
                        const yearData = await yearResponse.json();
                        recentObservations.year = yearData;
                        
                        const yearSpecies = new Set(yearData.map(obs => obs.speciesCode));
                        document.getElementById('yearSpeciesCount').textContent = yearSpecies.size;
                    }
                }

                // Get target species for the selected time range
                await loadTargetSpecies(lat, lng, radiusKm, backDays);

            } catch (error) {
                console.error('Error loading area statistics:', error);
                document.getElementById('monthSpeciesCount').textContent = '?';
                document.getElementById('yearSpeciesCount').textContent = '?';
                document.getElementById('weekSpeciesCount').textContent = '?';
            }
        }

        async function loadTargetSpecies(lat, lng, radiusKm, backDays = 14) {
            try {
                // Get notable observations (rare/unusual birds)
                const notableUrl = `https://api.ebird.org/v2/data/obs/geo/recent/notable?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=${Math.min(backDays, 30)}`;
                const response = await fetch(notableUrl, {
                    headers: { 'X-eBirdApiToken': ebirdApiKey }
                });

                if (response.ok) {
                    targetSpecies = await response.json();
                }
            } catch (error) {
                console.error('Error loading target species:', error);
            }
        }

        function showRecentObservations(period) {
            const modal = document.getElementById('speciesModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            // Set title
            const titles = {
                selected: document.getElementById('selectedRangeLabel').textContent,
                week: 'Species Observed in Last 7 Days',
                month: 'Species Observed in Last 30 Days',
                year: 'Species Observed in Last 365 Days'
            };
            modalTitle.textContent = titles[period] || 'Recent Observations';

            // Show loading
            modalBody.innerHTML = '<div class="loading-spinner">Loading species list...</div>';
            modal.style.display = 'block';

            if (!ebirdAuthenticated) {
                modalBody.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #6c757d;">
                        <p>Connect to eBird to see actual species data for this area.</p>
                        <p style="margin-top: 15px;">This feature requires an eBird API key to fetch real-time observation data.</p>
                    </div>
                `;
                return;
            }

            // Get the observations for the period
            let observations = [];
            if (period === 'selected') {
                observations = recentObservations.week || []; // Primary data is stored in 'week'
            } else {
                observations = recentObservations[period] || [];
            }
            
            if (observations.length === 0) {
                modalBody.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #6c757d;">
                        <p>No observations found for this period.</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">Try searching a different location or expanding your search radius.</p>
                    </div>
                `;
                return;
            }

            // Count observations by species
            const speciesCounts = {};
            const speciesNames = {};
            observations.forEach(obs => {
                if (!speciesCounts[obs.speciesCode]) {
                    speciesCounts[obs.speciesCode] = 0;
                    speciesNames[obs.speciesCode] = obs.comName;
                }
                speciesCounts[obs.speciesCode]++;
            });

            // Convert to array and sort by count
            const speciesArray = Object.keys(speciesCounts).map(code => ({
                code: code,
                name: speciesNames[code],
                count: speciesCounts[code],
                isTarget: targetSpecies.some(t => t.speciesCode === code)
            }));
            speciesArray.sort((a, b) => b.count - a.count);

            // Build species list HTML
            let html = '<ul class="species-list">';
            speciesArray.forEach(species => {
                html += `
                    <li class="species-item">
                        <span class="species-name">
                            ${species.name}
                            ${species.isTarget ? '<span class="target-badge">TARGET</span>' : ''}
                        </span>
                        <span class="species-count">${species.count} obs.</span>
                    </li>
                `;
            });
            html += '</ul>';

            if (targetSpecies.length > 0 && period === 'selected') {
                html = `
                    <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #fbbf24;">
                        <strong style="color: #856404;">üéØ ${targetSpecies.length} Target Species</strong>
                        <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #856404;">
                            These are notable/rare birds recently seen in this area
                        </p>
                    </div>
                ` + html;
            }

            modalBody.innerHTML = html;
        }

        function closeModal() {
            document.getElementById('speciesModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('speciesModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        async function loadHotspots(lat, lng, radiusMiles) {
            if (!ebirdAuthenticated) {
                showNotification('Please connect to eBird to view hotspots');
                document.getElementById('showHotspots').checked = false;
                return;
            }

            try {
                const radiusKm = Math.round(radiusMiles * 1.60934);
                
                // Fetch hotspots in the area
                const hotspotsUrl = `https://api.ebird.org/v2/ref/hotspot/geo?lat=${lat}&lng=${lng}&dist=${radiusKm}&fmt=json`;
                const response = await fetch(hotspotsUrl, {
                    headers: { 'X-eBirdApiToken': ebirdApiKey }
                });

                if (response.ok) {
                    hotspotsData = await response.json();
                    
                    // For each hotspot, get recent species count
                    const backDays = timeRangeDays === 'year' ? 365 : timeRangeDays;
                    
                    // Fetch recent observations for each hotspot (limit to first 50 for performance)
                    const hotspotsToProcess = hotspotsData.slice(0, 50);
                    const hotspotPromises = hotspotsToProcess.map(async (hotspot) => {
                        const obsUrl = `https://api.ebird.org/v2/data/obs/${hotspot.locId}/recent?back=${backDays}`;
                        try {
                            const obsResponse = await fetch(obsUrl, {
                                headers: { 'X-eBirdApiToken': ebirdApiKey }
                            });
                            if (obsResponse.ok) {
                                const observations = await obsResponse.json();
                                const speciesSet = new Set(observations.map(obs => obs.speciesCode));
                                hotspot.speciesCount = speciesSet.size;
                            } else {
                                hotspot.speciesCount = 0;
                            }
                        } catch (error) {
                            hotspot.speciesCount = 0;
                        }
                        return hotspot;
                    });

                    await Promise.all(hotspotPromises);
                    
                    if (document.getElementById('showHotspots').checked) {
                        displayHotspots();
                    }
                }
            } catch (error) {
                console.error('Error loading hotspots:', error);
                showNotification('Error loading hotspots');
            }
        }

        function displayHotspots() {
            // Clear existing hotspot markers
            hotspotMarkers.forEach(marker => marker.setMap(null));
            hotspotMarkers = [];

            hotspotsData.forEach(hotspot => {
                const marker = new google.maps.Marker({
                    position: { lat: hotspot.lat, lng: hotspot.lng },
                    map: map,
                    title: hotspot.locName,
                    icon: {
                        path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                        scale: 5,
                        fillColor: '#FF6B35',
                        fillOpacity: 0.9,
                        strokeColor: '#ffffff',
                        strokeWeight: 2,
                        rotation: 180
                    },
                    zIndex: 100
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; max-width: 250px;">
                            <h3 style="margin: 0 0 10px 0; color: #FF6B35;">üìç ${hotspot.locName}</h3>
                            <p style="margin: 5px 0;"><strong>Species Count:</strong> ${hotspot.speciesCount || 'Loading...'}</p>
                            <p style="margin: 5px 0; font-size: 0.9em; color: #6c757d;">
                                ${hotspot.lat.toFixed(4)}, ${hotspot.lng.toFixed(4)}
                            </p>
                            <p style="margin: 10px 0 0 0;">
                                <a href="https://ebird.org/hotspot/${hotspot.locId}" target="_blank" style="color: #2c5f2d; font-weight: 600;">
                                    View on eBird ‚Üí
                                </a>
                            </p>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                hotspotMarkers.push(marker);
            });

            showNotification(`Loaded ${hotspotsData.length} hotspots`);
        }

        function toggleHotspots() {
            const show = document.getElementById('showHotspots').checked;
            
            if (show) {
                if (hotspotsData.length === 0) {
                    // Load hotspots if not already loaded
                    const radiusMiles = searchMode === 'location' 
                        ? parseFloat(document.getElementById('radius').value)
                        : parseFloat(document.getElementById('routeBuffer').value);
                    loadHotspots(currentLocation.lat, currentLocation.lng, radiusMiles);
                } else {
                    displayHotspots();
                }
            } else {
                // Hide hotspot markers
                hotspotMarkers.forEach(marker => marker.setMap(null));
            }
        }

        async function loadTopChecklists(lat, lng, radiusMiles) {
            if (!ebirdAuthenticated) {
                showNotification('Please connect to eBird to view top checklists');
                document.getElementById('showTopChecklists').checked = false;
                return;
            }

            try {
                const radiusKm = Math.round(radiusMiles * 1.60934);
                const backDays = timeRangeDays === 'year' ? 30 : Math.min(timeRangeDays, 30); // eBird API limits back parameter
                
                // Fetch recent observations
                const obsUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=${backDays}&maxResults=200`;
                const response = await fetch(obsUrl, {
                    headers: { 'X-eBirdApiToken': ebirdApiKey }
                });

                if (response.ok) {
                    const observations = await response.json();
                    
                    // Group by checklist (subId)
                    const checklistMap = {};
                    observations.forEach(obs => {
                        if (!checklistMap[obs.subId]) {
                            checklistMap[obs.subId] = {
                                subId: obs.subId,
                                locId: obs.locId,
                                locName: obs.locName,
                                lat: obs.lat,
                                lng: obs.lng,
                                obsDt: obs.obsDt,
                                species: new Set(),
                                obsCount: 0
                            };
                        }
                        checklistMap[obs.subId].species.add(obs.speciesCode);
                        checklistMap[obs.subId].obsCount++;
                    });

                    // Convert to array and sort by species count
                    topChecklists = Object.values(checklistMap)
                        .map(checklist => ({
                            ...checklist,
                            speciesCount: checklist.species.size
                        }))
                        .sort((a, b) => b.speciesCount - a.speciesCount)
                        .slice(0, 10);

                    if (document.getElementById('showTopChecklists').checked) {
                        displayTopChecklists();
                    }
                }
            } catch (error) {
                console.error('Error loading top checklists:', error);
                showNotification('Error loading top checklists');
            }
        }

        function displayTopChecklists() {
            // Clear existing checklist markers
            checklistMarkers.forEach(marker => marker.setMap(null));
            checklistMarkers = [];

            topChecklists.forEach((checklist, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: checklist.lat, lng: checklist.lng },
                    map: map,
                    label: {
                        text: String(index + 1),
                        color: 'white',
                        fontSize: '12px',
                        fontWeight: 'bold'
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 14,
                        fillColor: '#4285F4',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    },
                    zIndex: 200
                });

                const date = new Date(checklist.obsDt);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; max-width: 300px;">
                            <h3 style="margin: 0 0 10px 0; color: #4285F4;">#{${index + 1}} Top Checklist</h3>
                            <p style="margin: 5px 0;"><strong>Location:</strong> ${checklist.locName}</p>
                            <p style="margin: 5px 0;"><strong>Species:</strong> ${checklist.speciesCount}</p>
                            <p style="margin: 5px 0;"><strong>Date:</strong> ${formattedDate}</p>
                            <p style="margin: 10px 0 0 0;">
                                <a href="https://ebird.org/checklist/${checklist.subId}" target="_blank" style="color: #2c5f2d; font-weight: 600; text-decoration: none; padding: 8px 16px; background: #e7f5e8; border-radius: 6px; display: inline-block;">
                                    View Checklist on eBird ‚Üí
                                </a>
                            </p>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                checklistMarkers.push(marker);
            });

            showNotification(`Showing top ${topChecklists.length} checklists`);
        }

        function toggleTopChecklists() {
            const show = document.getElementById('showTopChecklists').checked;
            
            if (show) {
                if (topChecklists.length === 0) {
                    // Load top checklists if not already loaded
                    const radiusMiles = searchMode === 'location' 
                        ? parseFloat(document.getElementById('radius').value)
                        : parseFloat(document.getElementById('routeBuffer').value);
                    loadTopChecklists(currentLocation.lat, currentLocation.lng, radiusMiles);
                } else {
                    displayTopChecklists();
                }
            } else {
                // Hide checklist markers
                checklistMarkers.forEach(marker => marker.setMap(null));
            }
        }

        async function refreshUserList() {
            if (!ebirdAuthenticated) {
                alert('Please connect to eBird first');
                return;
            }
            
            await loadUserList();
        }

        // Location and Search Functions
        function setSearchMode(mode) {
            searchMode = mode;
            
            // Update button states
            document.querySelectorAll('[data-mode]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Toggle search sections
            if (mode === 'location') {
                document.getElementById('locationSearch').style.display = 'block';
                document.getElementById('routeSearch').style.display = 'none';
            } else {
                document.getElementById('locationSearch').style.display = 'none';
                document.getElementById('routeSearch').style.display = 'block';
            }
        }

        function setTimeRange(days) {
            timeRangeDays = days;
            
            // Update button states
            document.querySelectorAll('[data-days]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update the stat box label
            const labels = {
                1: 'Last 1 Day',
                3: 'Last 3 Days',
                7: 'Last 7 Days',
                14: 'Last 14 Days',
                21: 'Last 21 Days',
                30: 'Last 30 Days',
                365: 'Last 365 Days',
                'year': 'Calendar Year'
            };
            document.getElementById('selectedRangeLabel').textContent = labels[days] || `Last ${days} Days`;
            
            // Clear existing hotspots and checklists data
            hotspotsData = [];
            topChecklists = [];
            
            // Refresh current search with new time range
            if (searchMode === 'location' && currentLocation) {
                searchLocation();
            } else if (searchMode === 'route' && currentRoute) {
                // Re-run the last route search
                searchRoute();
            }
        }

        async function searchRoute() {
            const origin = document.getElementById('origin').value.trim();
            const destination = document.getElementById('destination').value.trim();
            const bufferMiles = parseFloat(document.getElementById('routeBuffer').value);
            const bufferKm = bufferMiles * 1.60934;

            if (!origin || !destination) {
                alert('Please enter both starting location and destination');
                return;
            }

            try {
                // Request driving directions
                const request = {
                    origin: origin,
                    destination: destination,
                    travelMode: google.maps.TravelMode.DRIVING,
                    provideRouteAlternatives: false
                };

                directionsService.route(request, async function(result, status) {
                    if (status === 'OK') {
                        // Display the route
                        directionsRenderer.setDirections(result);
                        currentRoute = result;

                        // Extract route path
                        const route = result.routes[0];
                        const path = [];
                        
                        route.legs.forEach(leg => {
                            leg.steps.forEach(step => {
                                path.push({
                                    lat: step.start_location.lat(),
                                    lng: step.start_location.lng()
                                });
                            });
                        });
                        
                        // Add final point
                        const lastLeg = route.legs[route.legs.length - 1];
                        path.push({
                            lat: lastLeg.end_location.lat(),
                            lng: lastLeg.end_location.lng()
                        });

                        // Find sightings along route
                        displaySightingsAlongRoute(path, bufferKm);

                        // Load area statistics for route midpoint
                        const midpoint = Math.floor(path.length / 2);
                        await loadAreaStatistics(path[midpoint].lat, path[midpoint].lng, bufferMiles);

                        // Load hotspots and checklists if toggles are on
                        if (document.getElementById('showHotspots').checked) {
                            await loadHotspots(path[midpoint].lat, path[midpoint].lng, bufferMiles);
                        }
                        if (document.getElementById('showTopChecklists').checked) {
                            await loadTopChecklists(path[midpoint].lat, path[midpoint].lng, bufferMiles);
                        }

                        // Show route info
                        const duration = route.legs.reduce((sum, leg) => sum + leg.duration.value, 0);
                        const distance = route.legs.reduce((sum, leg) => sum + leg.distance.value, 0);
                        showNotification(`Route found: ${(distance / 1609.34).toFixed(1)} miles, ${Math.round(duration / 60)} minutes`);
                    } else {
                        alert('Could not calculate route: ' + status);
                    }
                });
            } catch (error) {
                console.error('Route search error:', error);
                alert('Error finding route. Please check your locations and try again.');
            }
        }

        function displaySightingsAlongRoute(routePath, bufferKm) {
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // Filter sightings near the route
            let nearbySightings = demoSightings.filter(sighting => {
                return isNearRoutePath(sighting, routePath, bufferKm);
            });

            // Apply list filters if authenticated
            if (ebirdAuthenticated) {
                const showOnList = document.getElementById('showOnMyList').checked;
                const showNotOnList = document.getElementById('showNotOnMyList').checked;

                if (showOnList) {
                    nearbySightings = nearbySightings.filter(s => userList.has(s.speciesCode));
                } else if (showNotOnList) {
                    nearbySightings = nearbySightings.filter(s => !userList.has(s.speciesCode));
                }
            }

            // Add markers for sightings
            nearbySightings.forEach(sighting => {
                const onMyList = userList.has(sighting.speciesCode);
                
                const marker = new google.maps.Marker({
                    position: { lat: sighting.lat, lng: sighting.lng },
                    map: map,
                    title: sighting.species,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: sighting.rarity === 'rare' ? '#ef4444' : 
                                   sighting.rarity === 'uncommon' ? '#fbbf24' : '#10b981',
                        fillOpacity: 0.8,
                        strokeColor: onMyList ? '#0d9488' : '#ffffff',
                        strokeWeight: onMyList ? 3 : 2
                    }
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px;">
                            <h3 style="margin: 0 0 10px 0; color: #2c5f2d;">${sighting.species}</h3>
                            <p style="margin: 5px 0;"><strong>Date:</strong> ${sighting.date}</p>
                            <p style="margin: 5px 0;"><strong>Rarity:</strong> ${sighting.rarity}</p>
                            ${ebirdAuthenticated ? `<p style="margin: 5px 0;"><strong>On my list:</strong> ${onMyList ? '‚úÖ Yes' : '‚ùå No'}</p>` : ''}
                            <p style="margin: 5px 0; font-size: 0.9em; color: #6c757d;">
                                ${sighting.lat.toFixed(4)}, ${sighting.lng.toFixed(4)}
                            </p>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            });

            document.getElementById('sightingCount').textContent = nearbySightings.length;
            checkAlerts(nearbySightings);
        }

        function isNearRoutePath(sighting, routePath, bufferKm) {
            // Check if sighting is within buffer distance of any segment in the route
            for (let i = 0; i < routePath.length - 1; i++) {
                const distance = distanceToSegment(
                    sighting.lat, sighting.lng,
                    routePath[i].lat, routePath[i].lng,
                    routePath[i + 1].lat, routePath[i + 1].lng
                );
                if (distance <= bufferKm) return true;
            }
            return false;
        }

        function clearRouteSearch() {
            // Clear the route from the map
            directionsRenderer.setDirections({routes: []});
            currentRoute = null;
            
            // Clear markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // Clear hotspot and checklist markers
            hotspotMarkers.forEach(marker => marker.setMap(null));
            hotspotMarkers = [];
            checklistMarkers.forEach(marker => marker.setMap(null));
            checklistMarkers = [];
            
            // Uncheck toggles
            document.getElementById('showHotspots').checked = false;
            document.getElementById('showTopChecklists').checked = false;
            
            document.getElementById('sightingCount').textContent = '0';
            showNotification('Route cleared');
        }

        async function searchLocation() {
            // Clear any existing route
            if (directionsRenderer) {
                directionsRenderer.setDirections({routes: []});
                currentRoute = null;
            }

            const city = document.getElementById('city').value.trim();
            const state = document.getElementById('state').value.trim();
            const country = document.getElementById('country').value.trim();
            const radiusMiles = parseFloat(document.getElementById('radius').value);
            const radiusKm = radiusMiles * 1.60934; // Convert miles to km

            if (!city) {
                alert('Please enter a city/town');
                return;
            }

            // Build address string
            const addressParts = [city];
            if (state) addressParts.push(state);
            if (country) addressParts.push(country);
            const address = addressParts.join(', ');

            try {
                // Geocode the address
                const results = await new Promise((resolve, reject) => {
                    geocoder.geocode({ address: address }, (results, status) => {
                        if (status === 'OK') {
                            resolve(results);
                        } else {
                            reject(status);
                        }
                    });
                });

                if (results && results[0]) {
                    const location = results[0].geometry.location;
                    currentLocation = { lat: location.lat(), lng: location.lng() };
                    map.setCenter(currentLocation);

                    // Extract region codes from geocoding result
                    extractRegionCodes(results[0]);

                    // Display sightings
                    displaySightings(currentLocation, radiusKm);
                    
                    // Load area statistics
                    await loadAreaStatistics(currentLocation.lat, currentLocation.lng, radiusMiles);
                    
                    // Load hotspots and checklists if toggles are on
                    if (document.getElementById('showHotspots').checked) {
                        await loadHotspots(currentLocation.lat, currentLocation.lng, radiusMiles);
                    }
                    if (document.getElementById('showTopChecklists').checked) {
                        await loadTopChecklists(currentLocation.lat, currentLocation.lng, radiusMiles);
                    }
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                alert('Could not find location. Please check your input and try again.');
            }
        }

        function extractRegionCodes(result) {
            // Try to extract region codes from geocoding result
            const components = result.address_components;
            
            for (let component of components) {
                if (component.types.includes('administrative_area_level_2')) {
                    // This might be county
                    // For US: format is typically US-STATE-COUNTY_CODE
                    // This is simplified - in production you'd need a lookup table
                }
                if (component.types.includes('administrative_area_level_1')) {
                    // State
                    const stateCode = component.short_name;
                    userLocation.state = `US-${stateCode}`;
                }
                if (component.types.includes('country')) {
                    userLocation.country = component.short_name;
                }
            }
        }

        function displaySightings(location, radiusKm) {
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // Filter sightings within radius
            let nearbySightings = demoSightings.filter(sighting => {
                const distance = getDistance(location.lat, location.lng, sighting.lat, sighting.lng);
                return distance <= radiusKm;
            });

            // Apply list filters if authenticated
            if (ebirdAuthenticated) {
                const showOnList = document.getElementById('showOnMyList').checked;
                const showNotOnList = document.getElementById('showNotOnMyList').checked;

                if (showOnList) {
                    nearbySightings = nearbySightings.filter(s => userList.has(s.speciesCode));
                } else if (showNotOnList) {
                    nearbySightings = nearbySightings.filter(s => !userList.has(s.speciesCode));
                }
            }

            // Add markers
            nearbySightings.forEach(sighting => {
                const onMyList = userList.has(sighting.speciesCode);
                
                const marker = new google.maps.Marker({
                    position: { lat: sighting.lat, lng: sighting.lng },
                    map: map,
                    title: sighting.species,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: sighting.rarity === 'rare' ? '#ef4444' : 
                                   sighting.rarity === 'uncommon' ? '#fbbf24' : '#10b981',
                        fillOpacity: 0.8,
                        strokeColor: onMyList ? '#0d9488' : '#ffffff',
                        strokeWeight: onMyList ? 3 : 2
                    }
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px;">
                            <h3 style="margin: 0 0 10px 0; color: #2c5f2d;">${sighting.species}</h3>
                            <p style="margin: 5px 0;"><strong>Date:</strong> ${sighting.date}</p>
                            <p style="margin: 5px 0;"><strong>Rarity:</strong> ${sighting.rarity}</p>
                            ${ebirdAuthenticated ? `<p style="margin: 5px 0;"><strong>On my list:</strong> ${onMyList ? '‚úÖ Yes' : '‚ùå No'}</p>` : ''}
                            <p style="margin: 5px 0; font-size: 0.9em; color: #6c757d;">
                                ${sighting.lat.toFixed(4)}, ${sighting.lng.toFixed(4)}
                            </p>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            });

            document.getElementById('sightingCount').textContent = nearbySightings.length;
            checkAlerts(nearbySightings);
        }

        async function loadSpeciesTaxonomy() {
            if (!ebirdAuthenticated) return;
            
            try {
                // Load eBird taxonomy (this is cached and only needs to be loaded once)
                const response = await fetch('https://api.ebird.org/v2/ref/taxonomy/ebird?fmt=json', {
                    headers: { 'X-eBirdApiToken': ebirdApiKey }
                });
                
                if (response.ok) {
                    allSpecies = await response.json();
                    console.log(`Loaded ${allSpecies.length} species from eBird taxonomy`);
                }
            } catch (error) {
                console.error('Error loading species taxonomy:', error);
            }
        }

        function searchSpecies() {
            const input = document.getElementById('speciesSearch').value.toLowerCase();
            const dropdown = document.getElementById('speciesDropdown');
            
            if (!input || input.length < 2) {
                dropdown.style.display = 'none';
                return;
            }

            // Filter species that match the search
            const matches = allSpecies
                .filter(sp => 
                    sp.comName.toLowerCase().includes(input) || 
                    sp.sciName.toLowerCase().includes(input)
                )
                .slice(0, 20); // Limit to 20 results

            if (matches.length === 0) {
                dropdown.innerHTML = '<div style="padding: 10px; color: #6c757d;">No species found</div>';
                dropdown.style.display = 'block';
                return;
            }

            // Build dropdown HTML
            dropdown.innerHTML = matches.map(sp => `
                <div 
                    style="padding: 10px; cursor: pointer; border-bottom: 1px solid #e9ecef;"
                    onmouseover="this.style.background='#f8f9fa'"
                    onmouseout="this.style.background='white'"
                    onclick="selectSpecies('${sp.speciesCode}', '${sp.comName.replace(/'/g, "\\'")}')"
                >
                    <strong style="color: #2c5f2d;">${sp.comName}</strong><br>
                    <small style="color: #6c757d; font-style: italic;">${sp.sciName}</small>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }

        function selectSpecies(speciesCode, commonName) {
            selectedSpecies = { code: speciesCode, name: commonName };
            document.getElementById('speciesSearch').value = commonName;
            document.getElementById('speciesDropdown').style.display = 'none';
        }

        function showSpeciesDropdown() {
            if (allSpecies.length === 0 && ebirdAuthenticated) {
                loadSpeciesTaxonomy();
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('speciesDropdown');
            const input = document.getElementById('speciesSearch');
            
            if (event.target !== dropdown && event.target !== input) {
                dropdown.style.display = 'none';
            }
        });

        function addAlert() {
            const alertType = document.getElementById('alertType').value;
            const alertRadius = parseFloat(document.getElementById('alertRadius').value);

            if (!selectedSpecies) {
                const manualInput = document.getElementById('speciesSearch').value.trim();
                if (!manualInput) {
                    alert('Please search and select a species');
                    return;
                }
                // Allow manual input if not selected from dropdown
                selectedSpecies = { name: manualInput, code: null };
            }

            const newAlert = {
                id: Date.now(),
                species: selectedSpecies.name,
                speciesCode: selectedSpecies.code,
                type: alertType,
                radius: alertRadius,
                created: new Date().toLocaleString()
            };

            alerts.push(newAlert);
            document.getElementById('speciesSearch').value = '';
            selectedSpecies = null;
            updateAlertsList();
            updateAlertCount();
        }

        function removeAlert(id) {
            alerts = alerts.filter(alert => alert.id !== id);
            updateAlertsList();
            updateAlertCount();
        }

        function updateAlertsList() {
            const alertsList = document.getElementById('alertsList');
            if (alerts.length === 0) {
                alertsList.innerHTML = '<p style="color: #6c757d; font-size: 0.9em;">No active alerts</p>';
                return;
            }

            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert-item">
                    <strong>${alert.species}</strong>
                    <small>Type: ${alert.type}</small><br>
                    <small>Radius: ${alert.radius} miles</small><br>
                    <small>Created: ${alert.created}</small>
                    <button class="remove-btn" onclick="removeAlert(${alert.id})">Remove</button>
                </div>
            `).join('');
        }

        function updateAlertCount() {
            document.getElementById('alertCount').textContent = alerts.length;
        }

        function checkAlerts(sightings) {
            alerts.forEach(alert => {
                const matching = sightings.filter(s => 
                    s.species.toLowerCase().includes(alert.species.toLowerCase())
                );

                if (matching.length > 0) {
                    const message = `üîî Alert: ${matching.length} sighting(s) of ${alert.species} found nearby!`;
                    showNotification(message);
                }
            });
        }

        function showNotification(message) {
            // Visual notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2c5f2d;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
                max-width: 300px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function addRoutePoint(latLng) {
            routePoints.push(latLng);

            // Add marker for waypoint
            const marker = new google.maps.Marker({
                position: latLng,
                map: map,
                label: String(routePoints.length),
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#667eea',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2
                }
            });

            // Draw route
            if (routePoints.length > 1) {
                if (routePath) {
                    routePath.setMap(null);
                }

                routePath = new google.maps.Polyline({
                    path: routePoints,
                    geodesic: true,
                    strokeColor: '#667eea',
                    strokeOpacity: 0.8,
                    strokeWeight: 4,
                    map: map
                });

                // Check for sightings along route
                checkRouteAlerts();
            }
        }

        function checkRouteAlerts() {
            if (routePoints.length < 2) return;

            const radiusMiles = parseFloat(document.getElementById('radius').value);
            const thresholdKm = radiusMiles * 1.60934;

            const nearbyToRoute = demoSightings.filter(sighting => {
                return isNearRoute(sighting, routePoints, thresholdKm);
            });

            alerts.forEach(alert => {
                if (alert.type === 'route' || alert.type === 'both') {
                    const matching = nearbyToRoute.filter(s => 
                        s.species.toLowerCase().includes(alert.species.toLowerCase())
                    );

                    if (matching.length > 0) {
                        showNotification(`üöó Alert: ${matching.length} ${alert.species} sighting(s) along your route!`);
                    }
                }
            });
        }

        function isNearRoute(sighting, route, thresholdKm) {
            for (let i = 0; i < route.length - 1; i++) {
                const distance = distanceToSegment(
                    sighting.lat, sighting.lng,
                    route[i].lat(), route[i].lng(),
                    route[i + 1].lat(), route[i + 1].lng()
                );
                if (distance <= thresholdKm) return true;
            }
            return false;
        }

        function distanceToSegment(px, py, x1, y1, x2, y2) {
            const A = px - x1;
            const B = py - y1;
            const C = x2 - x1;
            const D = y2 - y1;

            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;

            if (lenSq !== 0) param = dot / lenSq;

            let xx, yy;

            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }

            return getDistance(px, py, xx, yy);
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);

        // Initialize map - called by Google Maps API callback
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 42.3601, lng: -71.0589 }, // Boston
                zoom: 10,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            // Initialize geocoder for location searches
            geocoder = new google.maps.Geocoder();

            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: false,
                polylineOptions: {
                    strokeColor: '#0d9488',
                    strokeWeight: 4
                }
            });

            // Initialize after map is ready
            updateAlertsList();
            updateAuthUI();
        }

        // Make initMap available globally for Google Maps callback
        window.initMap = initMap;

        // Initialize other components when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            updateAlertsList();
            updateAuthUI();
        });

        // Toggle functions for collapsible sections
        function toggleInstructions() {
            const content = document.getElementById('instructionsContent');
            const toggle = document.getElementById('instructionsToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚àí';
            } else {
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }

        function toggleLegend() {
            const content = document.getElementById('legendContent');
            const toggle = document.getElementById('legendToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚àí';
            } else {
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }
    </script>
</body>
</html>
