<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traveling Birder - eBird Location Alerts</title>
    <script>
        // Placeholder for Google Maps callback
        var mapInitPending = false;
        window.initMap = function() {
            console.log('Google Maps loaded, waiting for page...');
            mapInitPending = true;
            // Check if real initMap is ready
            if (window.realInitMap) {
                console.log('Real initMap available, calling now...');
                window.realInitMap();
            }
        };
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvpU9tANBmnbKqMM2UWvELa9nRcrhneY0&libraries=places,geometry&callback=initMap"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .header {
            background: white;
            color: #065f46;
            padding: 35px;
            text-align: center;
            border-bottom: 3px solid #10b981;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: #065f46;
        }

        .header p {
            font-size: 1.1em;
            position: relative;
            z-index: 1;
            font-weight: 400;
            color: #6b7280;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: calc(100vh - 200px);
            min-height: 600px;
        }

        .sidebar {
            background: white;
            padding: 25px;
            overflow-y: auto;
            border-right: 1px solid #e5e7eb;
        }

        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f9fafb;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #10b981;
            border-radius: 4px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h3 {
            color: #065f46;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #10b981;
            padding-bottom: 8px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
            font-size: 0.9em;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        button {
            width: 100%;
            padding: 12px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        button:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .alert-item {
            background: white;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #10b981;
            transition: all 0.3s;
        }

        .alert-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transform: translateX(4px);
        }

        .alert-item strong {
            color: #065f46;
            display: block;
            margin-bottom: 5px;
            font-size: 1.05em;
        }

        .alert-item small {
            color: #6b7280;
            font-size: 0.85em;
        }

        .remove-btn {
            background: #ef4444;
            padding: 6px 12px;
            font-size: 0.8em;
            margin-top: 8px;
            width: auto;
        }

        .remove-btn:hover {
            background: #dc2626;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 0 0 20px 0;
        }

        .route-mode {
            background: #fef3c7;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #fbbf24;
        }

        .route-mode p {
            font-size: 0.85em;
            color: #92400e;
        }

        .login-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .login-section.authenticated {
            background: #ecfdf5;
            border: 2px solid #10b981;
        }

        .api-key-input {
            position: relative;
        }

        .api-key-input input {
            padding-right: 40px;
        }

        .toggle-visibility {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            width: auto;
            margin: 0;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-badge.connected {
            background: #10b981;
            color: white;
        }

        .status-badge.disconnected {
            background: #ef4444;
            color: white;
        }

        .filter-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-btn {
            padding: 10px;
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0;
        }

        .filter-btn:hover {
            transform: none;
            box-shadow: none;
            background: #f9fafb;
            border-color: #10b981;
        }

        .filter-btn.active {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .time-filter-group {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 15px;
        }

        .time-filter-btn {
            padding: 8px 4px;
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0;
        }

        .time-filter-btn:hover {
            transform: none;
            box-shadow: none;
            background: #f9fafb;
            border-color: #10b981;
        }

        .time-filter-btn.active {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .filter-section-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.85em;
        }

        .user-info {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            border: 1px solid #d1fae5;
        }

        .user-info p {
            margin: 5px 0;
            color: #374151;
        }

        .logout-btn {
            background: #6b7280;
            font-size: 0.9em;
            padding: 8px;
            margin-top: 8px;
        }

        .logout-btn:hover {
            background: #4b5563;
        }

        .list-filter-section {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .checkbox-group {
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            cursor: pointer;
            accent-color: #10b981;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        #speciesDropdown {
            margin-top: 5px;
        }

        #speciesDropdown div:last-child {
            border-bottom: none;
        }

        .species-dropdown-item {
            transition: background-color 0.2s;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-box {
            background: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
            transition: all 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #10b981;
        }

        .stat-box .number {
            font-size: 2em;
            font-weight: bold;
            color: #10b981;
        }

        .stat-box .label {
            font-size: 0.85em;
            color: #6b7280;
            margin-top: 5px;
            font-weight: 500;
        }

        .location-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: white;
            color: #065f46;
            padding: 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #10b981;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 600;
            color: #065f46;
        }

        .close {
            color: #6b7280;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: auto;
            line-height: 1;
            transition: opacity 0.2s;
        }

        .close:hover {
            transform: none;
            box-shadow: none;
            opacity: 0.6;
            color: #065f46;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .species-list {
            list-style: none;
            padding: 0;
        }

        .species-item {
            padding: 14px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .species-item:last-child {
            border-bottom: none;
        }

        .species-item:hover {
            background: #f9fafb;
        }

        .species-name {
            font-weight: 500;
            color: #374151;
        }

        .species-count {
            background: #ecfdf5;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            color: #10b981;
            font-weight: 600;
            border: 1px solid #d1fae5;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .target-badge {
            background: #10b981;
            color: white;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 0.75em;
            margin-left: 8px;
            font-weight: 700;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 320px 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .header p {
                font-size: 1em;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .main-content {
                grid-template-columns: 1fr;
                height: auto;
                min-height: auto;
            }

            .sidebar {
                max-height: 60vh;
                overflow-y: auto;
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }

            #map {
                height: 400px;
                min-height: 400px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .header p {
                font-size: 0.9em;
            }

            .filter-group {
                grid-template-columns: 1fr 1fr;
            }

            .time-filter-group {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .location-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .sidebar {
                padding: 15px;
            }

            .section {
                margin-bottom: 20px;
            }

            .section h3 {
                font-size: 1em;
            }

            button {
                padding: 10px;
                font-size: 0.9em;
            }

            .filter-btn, .time-filter-btn {
                font-size: 0.7em;
                padding: 6px 2px;
            }

            .stat-box .number {
                font-size: 1.5em;
            }

            .modal-header h2 {
                font-size: 1.2em;
            }
        }

        .target-species-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }

        .target-species-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(4px);
        }

        .target-species-card h3 {
            margin: 0 0 10px 0;
            color: #065f46;
            font-size: 1.2em;
        }

        .target-species-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f3f4f6;
        }

        .target-species-meta-item {
            font-size: 0.9em;
            color: #6b7280;
        }

        .target-species-meta-item strong {
            color: #374151;
            display: block;
            margin-bottom: 3px;
        }

        .target-checklist-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: #10b981;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .target-checklist-link:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        @media (max-width: 768px) {
            .target-species-meta {
                grid-template-columns: 1fr;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #888;
            border-radius: 12px;
            width: 80%;
            max-width: 900px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            background: #10b981;
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover,
        .close:focus {
            color: #f3f4f6;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Modal for species list -->
    <div id="speciesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Recent Observations</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading-spinner">Loading...</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ü¶© Traveling Birder</h1>
            <p>Track bird sightings on your route and filter by your personal lists</p>
            <p style="font-size: 0.9em; margin-top: 8px; opacity: 0.8;">Questions? Email <a href="/cdn-cgi/l/email-protection#12747367757a7c737c3f64777c666760776152757f737b7e3c717d7f" style="color: #10b981; text-decoration: none; font-weight: 600;"><span class="__cf_email__" data-cfemail="03656276646b6d626d2e75666d777671667043646e626a6f2d606c6e">[email&#160;protected]</span></a></p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="section" style="background: white; border: 1px solid #e5e7eb; margin-bottom: 20px; border-radius: 8px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleInstructions()">
                        <h3 style="margin: 0; border: none; padding: 0; color: #065f46;">üìñ Quick Start Guide</h3>
                        <span id="instructionsToggle" style="font-size: 1.5em; font-weight: bold; color: #10b981;">‚àí</span>
                    </div>
                    <div id="instructionsContent" style="margin-top: 15px;">
                        <ol style="margin: 0; padding-left: 20px; line-height: 1.8; color: #374151;">
                            <li><strong>Connect eBird:</strong> Enter your API key (get free at <a href="https://ebird.org/api/keygen" target="_blank" style="color: #10b981; font-weight: 600;">ebird.org/api/keygen</a>)</li>
                            <li><strong>Set Filters:</strong> Choose list scope, time period, and observation filters</li>
                            <li><strong>Search:</strong> Pick location or route mode, select time range (1-365 days)</li>
                            <li><strong>Explore:</strong> Toggle hotspots and top checklists, click markers for details</li>
                            <li><strong>Set Alerts:</strong> Get notified when target birds appear in your area</li>
                        </ol>
                        <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-top: 12px; border: 1px solid #e5e7eb;">
                            <strong style="color: #374151;">üí° Pro Tips:</strong>
                            <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 0.9em; color: #6b7280;">
                                <li>Use "Show only birds NOT on my list" to find lifers</li>
                                <li>Check top checklists to see what's possible</li>
                                <li>Hotspots show the most productive birding locations</li>
                                <li><span style="color: #10b981; font-weight: 600;">TARGET</span> badges highlight rare/notable species</li>
                                <li>Route mode shows sightings along your entire drive</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="section" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleLegend()">
                        <h3 style="margin: 0; border: none; padding: 0; color: #065f46;">üîë Map Legend</h3>
                        <span id="legendToggle" style="font-size: 1.5em; font-weight: bold; color: #10b981;">‚àí</span>
                    </div>
                    <div id="legendContent" style="margin-top: 15px;">
                        <div style="margin-bottom: 12px;">
                            <strong style="display: block; margin-bottom: 8px; color: #374151; font-size: 0.95em;">Bird Sightings:</strong>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; background: #10b981; margin-right: 8px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                <span style="font-size: 0.9em; color: #6b7280;">Common species</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; background: #fbbf24; margin-right: 8px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                <span style="font-size: 0.9em; color: #6b7280;">Uncommon species</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; background: #ef4444; margin-right: 8px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                <span style="font-size: 0.9em; color: #6b7280;">Rare species</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; background: #10b981; margin-right: 8px; border: 3px solid #0d9488; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                <span style="font-size: 0.9em; color: #6b7280;"><strong>Teal border:</strong> On your eBird list</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 12px;">
                            <strong style="display: block; margin-bottom: 8px; color: #374151; font-size: 0.95em;">Map Layers:</strong>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span style="display: inline-block; margin-right: 8px; font-size: 1.2em;">üìç</span>
                                <span style="font-size: 0.9em; color: #6b7280;">eBird Hotspots (click for species count)</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span style="display: inline-block; width: 24px; height: 24px; border-radius: 50%; background: #0d9488; margin-right: 8px; border: 2px solid white; color: white; text-align: center; line-height: 20px; font-size: 0.75em; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">1</span>
                                <span style="font-size: 0.9em; color: #6b7280;">Top Checklists (ranked by species)</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span style="display: inline-block; width: 30px; height: 4px; background: #0d9488; margin-right: 8px; border-radius: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                <span style="font-size: 0.9em; color: #6b7280;">Driving route</span>
                            </div>
                        </div>

                        <div>
                            <strong style="display: block; margin-bottom: 8px; color: #374151; font-size: 0.95em;">Badges:</strong>
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span class="target-badge" style="margin-left: 0; margin-right: 8px;">TARGET</span>
                                <span style="font-size: 0.9em; color: #6b7280;">Notable/rare bird for the area</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>üîë eBird Account</h3>
                    <div id="loginSection" class="login-section">
                        <div class="input-group api-key-input">
                            <label>eBird API Key</label>
                            <input type="password" id="apiKey" placeholder="Enter your eBird API key">
                            <button class="toggle-visibility" onclick="toggleApiKeyVisibility()" type="button">üëÅÔ∏è</button>
                        </div>
                        <button onclick="connectEbird()">Connect to eBird</button>
                        <p style="font-size: 0.85em; color: #6c757d; margin-top: 10px;">
                            Get your free API key at <a href="https://ebird.org/api/keygen" target="_blank" style="color: #2c5f2d;">ebird.org/api/keygen</a>
                        </p>
                        <div id="userInfo"></div>
                    </div>
                </div>

                <div class="section" id="listFilterSection" style="display: none;">
                    <h3>üìã My eBird Lists</h3>
                    <div class="list-filter-section">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2c5f2d;">Geographic Scope</label>
                        <div class="filter-group">
                            <button class="filter-btn active" data-scope="county" onclick="setScope('county')">County</button>
                            <button class="filter-btn" data-scope="state" onclick="setScope('state')">State</button>
                            <button class="filter-btn" data-scope="country" onclick="setScope('country')">Country</button>
                            <button class="filter-btn" data-scope="world" onclick="setScope('world')">World</button>
                        </div>
                        
                        <label style="display: block; margin: 15px 0 10px 0; font-weight: 600; color: #2c5f2d;">Time Period</label>
                        <div class="filter-group">
                            <button class="filter-btn" data-period="month" onclick="setPeriod('month')">This Month</button>
                            <button class="filter-btn" data-period="year" onclick="setPeriod('year')">This Year</button>
                            <button class="filter-btn active" data-period="life" onclick="setPeriod('life')">Life List</button>
                        </div>

                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="showTargetBirdsOnly" onchange="updateListFilter()">
                                <label for="showTargetBirdsOnly">Show target/rare birds only</label>
                            </div>
                        </div>

                        <button onclick="refreshUserList()" style="margin-top: 15px;">Refresh My List</button>
                    </div>
                </div>

                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">üîç Search Options</h3>
                        <button onclick="resetAllFilters()" style="width: auto; padding: 8px 16px; background: #6b7280; font-size: 0.85em; margin: 0;">üîÑ Reset All</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #374151;">Search Mode</label>
                        <div class="filter-group">
                            <button class="filter-btn active" data-mode="location" onclick="setSearchMode('location')">Single Location</button>
                            <button class="filter-btn" data-mode="route" onclick="setSearchMode('route')">Driving Route</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label class="filter-section-label">Time Range</label>
                        <div class="time-filter-group">
                            <button class="time-filter-btn" data-days="1" onclick="setTimeRange(1)">1 day</button>
                            <button class="time-filter-btn" data-days="3" onclick="setTimeRange(3)">3 days</button>
                            <button class="time-filter-btn" data-days="7" onclick="setTimeRange(7)">7 days</button>
                            <button class="time-filter-btn" data-days="14" onclick="setTimeRange(14)">14 days</button>
                        </div>
                        <div class="time-filter-group">
                            <button class="time-filter-btn" data-days="21" onclick="setTimeRange(21)">21 days</button>
                            <button class="time-filter-btn active" data-days="30" onclick="setTimeRange(30)">30 days</button>
                            <button class="time-filter-btn" data-days="year" onclick="setTimeRange('year')">Cal Year</button>
                            <button class="time-filter-btn" data-days="30" onclick="setTimeRange(30)">Last 30</button>
                        </div>
                    </div>

                    <div id="locationSearch">
                        <div class="input-group">
                            <label>City/Town</label>
                            <input type="text" id="cityAutocomplete" placeholder="Start typing city name..." class="autocomplete-input">
                        </div>
                        <div class="input-group">
                            <label>County</label>
                            <input type="text" id="countyAutocomplete" placeholder="Start typing county name..." class="autocomplete-input">
                        </div>
                        <div class="location-row">
                            <div class="input-group">
                                <label>State</label>
                                <input type="text" id="stateAutocomplete" placeholder="Start typing state..." class="autocomplete-input">
                            </div>
                            <div class="input-group">
                                <label>ZIP (Optional)</label>
                                <input type="text" id="zipCode" placeholder="12345" maxlength="5">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Search Radius (miles)</label>
                            <input type="number" id="radius" placeholder="15" value="15" min="1" max="50">
                        </div>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="limitToRegion">
                                <label for="limitToRegion">Limit to selected county/state only</label>
                            </div>
                        </div>
                        <button onclick="searchLocation()">Search Sightings</button>
                    </div>

                    <div id="routeSearch" style="display: none;">
                        <div class="input-group">
                            <label>Starting Location</label>
                            <input type="text" id="originAutocomplete" placeholder="e.g., Boston, MA" class="autocomplete-input">
                        </div>
                        <div class="input-group">
                            <label>Destination</label>
                            <input type="text" id="destinationAutocomplete" placeholder="e.g., Portland, ME" class="autocomplete-input">
                        </div>
                        <div class="input-group">
                            <label>Route Buffer (miles)</label>
                            <input type="number" id="routeBuffer" placeholder="10" value="10" min="1" max="50">
                        </div>
                        <button onclick="searchRoute()">Find Route & Sightings</button>
                        <button onclick="clearRouteSearch()" style="background: #6b7280; margin-top: 5px;">Clear Route</button>
                    </div>
                </div>

                <div class="section">
                    <h3>üó∫Ô∏è Map Layers</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="showHotspots" onchange="toggleHotspots()">
                            <label for="showHotspots">Show eBird Hotspots</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showTopChecklists" onchange="toggleTopChecklists()">
                            <label for="showTopChecklists">Show Top 10 Checklists</label>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>üîç View Species Sightings</h3>
                    <div class="input-group" style="position: relative;">
                        <label>Search Species</label>
                        <input 
                            type="text" 
                            id="speciesSearch" 
                            placeholder="Start typing species name..."
                            autocomplete="off"
                            oninput="searchSpecies()"
                            onfocus="showSpeciesDropdown()"
                        >
                        <div id="speciesDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #10b981; border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-top: 5px;"></div>
                    </div>
                    
                    <div class="input-group">
                        <label>Time Range for Sightings</label>
                        <select id="speciesTimeRange">
                            <option value="1">Last 1 day</option>
                            <option value="3">Last 3 days</option>
                            <option value="7">Last 7 days</option>
                            <option value="14">Last 14 days</option>
                            <option value="21">Last 21 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="year">Calendar Year</option>
                        </select>
                    </div>
                    
                    <button onclick="addSpeciesToMap()">Add species sightings to map</button>
                </div>

                <div class="stats">
                    <div class="stat-box">
                        <div class="number" id="sightingCount">0</div>
                        <div class="label">Sightings</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="targetBirdCount">0</div>
                        <div class="label">Target Birds</div>
                    </div>
                </div>

                <div class="section" style="margin-top: 20px;">
                    <h3>üìä Area Statistics</h3>
                    
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; border: 1px solid #10b981; margin-bottom: 15px;">
                        <p style="margin: 0; font-size: 0.9em; color: #065f46;">
                            <strong>Your Stats</strong> vs <strong>Overall Stats</strong> for this area
                        </p>
                    </div>
                    
                    <!-- Selected Time Range -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <div style="font-size: 0.85em; color: #6b7280; margin-bottom: 5px;" id="selectedRangeLabel">Last 30 Days</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="text-align: center; padding: 10px; background: #f0fdf4; border-radius: 6px;">
                                <div style="font-size: 0.75em; color: #6b7280; margin-bottom: 5px;">YOUR SPECIES</div>
                                <div style="font-size: 1.8em; font-weight: bold; color: #10b981;" id="userWeekCount">-</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f9fafb; border-radius: 6px;">
                                <div style="font-size: 0.75em; color: #6b7280; margin-bottom: 5px;">OVERALL</div>
                                <div style="font-size: 1.8em; font-weight: bold; color: #374151;" id="weekSpeciesCount">-</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 0.85em; text-align: center;">
                            <span id="weekPercentage" style="font-weight: 600; color: #92400e;">-</span>
                        </div>
                        <button onclick="showRecentObservations('selected')" style="width: 100%; margin-top: 10px; padding: 8px; font-size: 0.85em; background: #10b981;">
                            View Species List
                        </button>
                    </div>
                    
                    <!-- Last 30 Days -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <div style="font-size: 0.85em; color: #6b7280; margin-bottom: 5px;">Last 30 Days</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="text-align: center; padding: 10px; background: #f0fdf4; border-radius: 6px;">
                                <div style="font-size: 0.75em; color: #6b7280; margin-bottom: 5px;">YOUR SPECIES</div>
                                <div style="font-size: 1.8em; font-weight: bold; color: #10b981;" id="userMonthCount">-</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f9fafb; border-radius: 6px;">
                                <div style="font-size: 0.75em; color: #6b7280; margin-bottom: 5px;">OVERALL</div>
                                <div style="font-size: 1.8em; font-weight: bold; color: #374151;" id="monthSpeciesCount">-</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 0.85em; text-align: center;">
                            <span id="monthPercentage" style="font-weight: 600; color: #92400e;">-</span>
                        </div>
                        <button onclick="showRecentObservations('month')" style="width: 100%; margin-top: 10px; padding: 8px; font-size: 0.85em; background: #10b981;">
                            View Species List
                        </button>
                    </div>
                    
                    <!-- Calendar Year -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <div style="font-size: 0.85em; color: #6b7280; margin-bottom: 5px;">Calendar Year</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="text-align: center; padding: 10px; background: #f0fdf4; border-radius: 6px;">
                                <div style="font-size: 0.75em; color: #6b7280; margin-bottom: 5px;">YOUR SPECIES</div>
                                <div style="font-size: 1.8em; font-weight: bold; color: #10b981;" id="userYearCount">-</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f9fafb; border-radius: 6px;">
                                <div style="font-size: 0.75em; color: #6b7280; margin-bottom: 5px;">OVERALL</div>
                                <div style="font-size: 1.8em; font-weight: bold; color: #374151;" id="yearSpeciesCount">-</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 0.85em; text-align: center;">
                            <span id="yearPercentage" style="font-weight: 600; color: #92400e;">-</span>
                        </div>
                        <button onclick="showRecentObservations('year')" style="width: 100%; margin-top: 10px; padding: 8px; font-size: 0.85em; background: #10b981;">
                            View Species List
                        </button>
                    </div>
                </div>
            </div>

            <div id="map"></div>
        </div>
    </div>

    <!-- Target Species Report Section -->
    <div class="container" style="margin-top: 20px; max-width: 1400px; margin-left: auto; margin-right: auto;">
        <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 20px rgba(0,0,0,0.08); border: 1px solid #e5e7eb;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleTargetReport()">
                <h2 style="margin: 0; color: #065f46; font-size: 1.5em;">üéØ Target Species Report</h2>
                <span id="targetReportToggle" style="font-size: 1.5em; font-weight: bold; color: #10b981;">‚àí</span>
            </div>
            
            <div id="targetReportContent" style="margin-top: 20px;">
                <div id="targetReportSummary" style="background: #f0fdf4; padding: 15px; border-radius: 8px; border: 1px solid #10b981; margin-bottom: 20px;">
                    <p style="margin: 0; color: #065f46; font-weight: 600;">
                        <span id="targetSpeciesCount">0</span> notable/rare species found in this area
                    </p>
                    <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #6b7280;">
                        Based on recent observations and rarity for this region
                    </p>
                </div>
                
                <div id="targetReportList" style="display: grid; gap: 12px;">
                    <!-- Target species cards will be inserted here -->
                </div>
                
                <div id="targetReportEmpty" style="display: block; text-align: center; padding: 40px; color: #6b7280;">
                    <p style="font-size: 1.1em; margin: 0;">No target species found</p>
                    <p style="margin: 10px 0 0 0; font-size: 0.9em;">
                        Perform a search to find notable birds in an area
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        let map;
        let markers = [];
        let alerts = [];
        let routeMode = false;
        let routePoints = [];
        let routePath = null;
        let currentLocation = { lat: 42.3601, lng: -71.0589 };
        let geocoder;
        let directionsService;
        let directionsRenderer;
        let currentRoute = null;
        let tripWaypoints = []; // Stores all waypoints for trip planning
        let selectedSpeciesForMap = null; // Currently selected species to show on map
        let searchMode = 'location'; // 'location' or 'route'
        let recentObservations = { week: [], month: [], year: [] };
        let targetSpecies = [];
        let timeRangeDays = 30; // Default to 30 days
        let hotspotMarkers = [];
        let checklistMarkers = [];
        let hotspotsData = [];
        let topChecklists = [];
        let allSpecies = []; // eBird taxonomy
        let selectedSpecies = null;
        
        // eBird authentication and list data
        let ebirdApiKey = null;
        let ebirdAuthenticated = false;
        let userList = new Set();
        let listScope = 'county';
        let listPeriod = 'life';
        let userLocation = { county: 'US-MA-017', state: 'US-MA', country: 'US' }; // Default: Middlesex County, MA

        // Demo bird sighting data (spread along Boston to Portland, ME route)
        const demoSightings = [
            // Boston area
            { species: "Bald Eagle", speciesCode: "baleag", lat: 42.3601, lng: -71.0589, date: "2024-12-15", rarity: "uncommon" },
            { species: "Red-tailed Hawk", speciesCode: "rethaw", lat: 42.3650, lng: -71.0640, date: "2024-12-15", rarity: "common" },
            { species: "Great Blue Heron", speciesCode: "grbher3", lat: 42.3580, lng: -71.0550, date: "2024-12-14", rarity: "common" },
            { species: "Peregrine Falcon", speciesCode: "perfal", lat: 42.3620, lng: -71.0600, date: "2024-12-15", rarity: "rare" },
            { species: "American Goldfinch", speciesCode: "amegfi", lat: 42.3590, lng: -71.0570, date: "2024-12-15", rarity: "common" },
            { species: "Northern Cardinal", speciesCode: "norcar", lat: 42.3610, lng: -71.0610, date: "2024-12-14", rarity: "common" },
            { species: "Blue Jay", speciesCode: "blujay", lat: 42.3630, lng: -71.0560, date: "2024-12-15", rarity: "common" },
            { species: "Snowy Owl", speciesCode: "snoowl1", lat: 42.3640, lng: -71.0620, date: "2024-12-13", rarity: "rare" },
            
            // Along I-95 North
            { species: "Turkey Vulture", speciesCode: "turvul", lat: 42.5500, lng: -70.9500, date: "2024-12-15", rarity: "common" },
            { species: "American Crow", speciesCode: "amecro", lat: 42.7800, lng: -70.8700, date: "2024-12-15", rarity: "common" },
            { species: "Black-capped Chickadee", speciesCode: "bkcchi", lat: 43.0100, lng: -70.7500, date: "2024-12-14", rarity: "common" },
            { species: "Tufted Titmouse", speciesCode: "tuftit", lat: 43.2500, lng: -70.6800, date: "2024-12-15", rarity: "common" },
            
            // New Hampshire section
            { species: "Downy Woodpecker", speciesCode: "dowwoo", lat: 43.0900, lng: -70.7600, date: "2024-12-15", rarity: "common" },
            { species: "Hairy Woodpecker", speciesCode: "haiwoo", lat: 43.1200, lng: -70.7400, date: "2024-12-14", rarity: "common" },
            { species: "White-breasted Nuthatch", speciesCode: "whbnut", lat: 43.2000, lng: -70.7000, date: "2024-12-15", rarity: "common" },
            
            // Approaching Portland
            { species: "Common Raven", speciesCode: "comrav", lat: 43.5000, lng: -70.3500, date: "2024-12-15", rarity: "common" },
            { species: "Ring-billed Gull", speciesCode: "ribgul", lat: 43.6000, lng: -70.2800, date: "2024-12-15", rarity: "common" },
            { species: "Herring Gull", speciesCode: "hergul", lat: 43.6400, lng: -70.2600, date: "2024-12-14", rarity: "common" },
            
            // Portland area
            { species: "Barrow's Goldeneye", speciesCode: "bargol", lat: 43.6591, lng: -70.2568, date: "2024-12-15", rarity: "rare" },
            { species: "Common Eider", speciesCode: "comeid", lat: 43.6700, lng: -70.2400, date: "2024-12-15", rarity: "uncommon" },
            { species: "Purple Sandpiper", speciesCode: "pursan", lat: 43.6615, lng: -70.2483, date: "2024-12-14", rarity: "uncommon" },
            { species: "Harlequin Duck", speciesCode: "harduc", lat: 43.6650, lng: -70.2450, date: "2024-12-15", rarity: "rare" },
        ];

        // eBird Authentication Functions
        async function connectEbird() {
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiKey) {
                alert('Please enter your eBird API key');
                return;
            }

            try {
                // Test the API key by making a simple request
                const response = await fetch('https://api.ebird.org/v2/ref/taxonomy/ebird?fmt=json&species=baleag', {
                    headers: {
                        'X-eBirdApiToken': apiKey
                    }
                });

                if (response.ok) {
                    ebirdApiKey = apiKey;
                    ebirdAuthenticated = true;
                    
                    // Store in localStorage for persistence
                    localStorage.setItem('ebirdApiKey', apiKey);
                    
                    updateAuthUI();
                    await loadUserList();
                    await loadSpeciesTaxonomy(); // Load species for autocomplete
                    showNotification('‚úÖ Successfully connected to eBird!');
                } else {
                    throw new Error('Invalid API key');
                }
            } catch (error) {
                alert('Failed to connect to eBird. Please check your API key and try again.');
                console.error('eBird connection error:', error);
            }
        }

        function disconnectEbird() {
            ebirdApiKey = null;
            ebirdAuthenticated = false;
            userList.clear();
            localStorage.removeItem('ebirdApiKey');
            
            // Uncheck filter boxes
            if (document.getElementById('showTargetBirdsOnly')) {
                document.getElementById('showTargetBirdsOnly').checked = false;
            }
            
            updateAuthUI();
            searchLocation(); // Refresh map without filters
            showNotification('Disconnected from eBird');
        }

        function updateAuthUI() {
            const loginSection = document.getElementById('loginSection');
            const listFilterSection = document.getElementById('listFilterSection');
            const userInfoDiv = document.getElementById('userInfo');

            if (ebirdAuthenticated) {
                loginSection.classList.add('authenticated');
                listFilterSection.style.display = 'block';
                
                userInfoDiv.innerHTML = `
                    <div class="user-info">
                        <span class="status-badge connected">‚óè Connected</span>
                        <p><strong>API Key:</strong> ${ebirdApiKey.substring(0, 8)}...</p>
                        <p><strong>List:</strong> ${userList.size} species</p>
                        <button class="logout-btn" onclick="disconnectEbird()">Disconnect</button>
                    </div>
                `;
                
                document.getElementById('apiKey').disabled = true;
            } else {
                loginSection.classList.remove('authenticated');
                listFilterSection.style.display = 'none';
                userInfoDiv.innerHTML = '<span class="status-badge disconnected">‚óè Not Connected</span>';
                document.getElementById('apiKey').disabled = false;
            }
        }

        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('apiKey');
            const button = event.target;
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                button.textContent = 'üôà';
            } else {
                apiKeyInput.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        // eBird List Management
        async function loadUserList() {
            if (!ebirdAuthenticated) return;

            try {
                showNotification('Loading your eBird list...');
                
                // Determine region code based on scope
                let regionCode = userLocation.country;
                
                if (listScope === 'county') {
                    regionCode = userLocation.county;
                } else if (listScope === 'state') {
                    regionCode = userLocation.state;
                } else if (listScope === 'world') {
                    regionCode = 'world';
                }

                // Calculate date range based on period
                let url = `https://api.ebird.org/v2/product/spplist/${regionCode}`;
                const params = new URLSearchParams();
                
                if (listPeriod === 'month') {
                    const today = new Date();
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                    params.append('startDate', formatDate(firstDay));
                    params.append('endDate', formatDate(today));
                } else if (listPeriod === 'year') {
                    const today = new Date();
                    const firstDay = new Date(today.getFullYear(), 0, 1);
                    params.append('startDate', formatDate(firstDay));
                    params.append('endDate', formatDate(today));
                }

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url, {
                    headers: {
                        'X-eBirdApiToken': ebirdApiKey
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Data is array of species codes
                    userList.clear();
                    data.forEach(speciesCode => {
                        userList.add(speciesCode);
                    });

                    updateAuthUI();
                    searchLocation(); // Refresh map with new filters
                    showNotification(`‚úÖ Loaded ${userList.size} species from your ${listScope} ${listPeriod} list`);
                } else {
                    throw new Error(`Failed to load user list: ${response.status}`);
                }
            } catch (error) {
                console.error('Error loading user list:', error);
                showNotification('‚ö†Ô∏è Error loading your list. Using demo data.');
            }
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function setScope(scope) {
            listScope = scope;
            
            // Update button states
            document.querySelectorAll('[data-scope]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            refreshUserList();
        }

        function setPeriod(period) {
            listPeriod = period;
            
            // Update button states
            document.querySelectorAll('[data-period]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            refreshUserList();
        }

        function updateListFilter() {
            // Simply refresh display with current filter
            if (currentLocation) {
                const radiusMiles = parseFloat(document.getElementById('radius').value);
                const radiusKm = radiusMiles * 1.60934;
                displaySightings(currentLocation, radiusKm);
            } else if (currentRoute) {
                searchRoute();
            }
        }

        async function loadAreaStatistics(lat, lng, radiusMiles) {
            const radiusKm = Math.round(radiusMiles * 1.60934);
            
            // Reset all counts including user counts
            document.getElementById('monthSpeciesCount').textContent = '-';
            document.getElementById('yearSpeciesCount').textContent = '-';
            document.getElementById('weekSpeciesCount').textContent = '-';
            document.getElementById('userWeekCount').textContent = '-';
            document.getElementById('userMonthCount').textContent = '-';
            document.getElementById('userYearCount').textContent = '-';
            document.getElementById('weekPercentage').textContent = '-';
            document.getElementById('monthPercentage').textContent = '-';
            document.getElementById('yearPercentage').textContent = '-';

            if (!ebirdAuthenticated) {
                return;
            }

            try {
                const today = new Date();
                
                // Calculate back parameter based on timeRangeDays
                let backDays = timeRangeDays;
                let useCalendarYear = false;
                
                if (timeRangeDays === 'year') {
                    useCalendarYear = true;
                    const yearStart = new Date(today.getFullYear(), 0, 1);
                    const diffTime = Math.abs(today - yearStart);
                    backDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                }
                
                // Fetch observations for selected time range
                const primaryUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=${backDays}`;
                const primaryResponse = await fetch(primaryUrl, {
                    headers: { 'X-eBirdApiToken': ebirdApiKey }
                });

                if (primaryResponse.ok) {
                    const primaryData = await primaryResponse.json();
                    recentObservations.week = primaryData; // Store in week for now
                    
                    // Count unique species
                    const primarySpecies = new Set(primaryData.map(obs => obs.speciesCode));
                    document.getElementById('weekSpeciesCount').textContent = primarySpecies.size;
                }

                // Fetch 30-day observations for "This Month"
                const monthUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=30`;
                const monthResponse = await fetch(monthUrl, {
                    headers: { 'X-eBirdApiToken': ebirdApiKey }
                });

                if (monthResponse.ok) {
                    const monthData = await monthResponse.json();
                    recentObservations.month = monthData;
                    
                    const monthSpecies = new Set(monthData.map(obs => obs.speciesCode));
                    document.getElementById('monthSpeciesCount').textContent = monthSpecies.size;
                }

                // For year, try to get calendar year data
                if (useCalendarYear) {
                    // Calendar year is same as primary search
                    document.getElementById('yearSpeciesCount').textContent = document.getElementById('weekSpeciesCount').textContent;
                } else {
                    // Get full year estimate
                    const yearUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=365`;
                    const yearResponse = await fetch(yearUrl, {
                        headers: { 'X-eBirdApiToken': ebirdApiKey }
                    });

                    if (yearResponse.ok) {
                        const yearData = await yearResponse.json();
                        recentObservations.year = yearData;
                        
                        const yearSpecies = new Set(yearData.map(obs => obs.speciesCode));
                        document.getElementById('yearSpeciesCount').textContent = yearSpecies.size;
                    }
                }

                // Get target species for the selected time range
                await loadTargetSpecies(lat, lng, radiusKm, backDays);
                
                // Load target report
                await loadTargetReport();
                
                // Update user statistics comparison
                updateUserStatistics();

            } catch (error) {
                console.error('Error loading area statistics:', error);
                document.getElementById('monthSpeciesCount').textContent = '?';
                document.getElementById('yearSpeciesCount').textContent = '?';
                document.getElementById('weekSpeciesCount').textContent = '?';
            }
        }

        async function loadTargetSpecies(lat, lng, radiusKm, backDays = 14) {
            try {
                // Get notable observations (rare/unusual birds)
                const notableUrl = `https://api.ebird.org/v2/data/obs/geo/recent/notable?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=${Math.min(backDays, 30)}`;
                const response = await fetch(notableUrl, {
                    headers: { 'X-eBirdApiToken': ebirdApiKey }
                });

                if (response.ok) {
                    targetSpecies = await response.json();
                }
            } catch (error) {
                console.error('Error loading target species:', error);
            }
        }

        function showRecentObservations(period) {
            const modal = document.getElementById('speciesModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            // Set title
            const titles = {
                selected: document.getElementById('selectedRangeLabel').textContent,
                week: 'Species Observed in Last 7 Days',
                month: 'Species Observed in Last 30 Days',
                year: 'Species Observed in Last 365 Days'
            };
            modalTitle.textContent = titles[period] || 'Recent Observations';

            // Show loading
            modalBody.innerHTML = '<div class="loading-spinner">Loading species list...</div>';
            modal.style.display = 'block';

            if (!ebirdAuthenticated) {
                modalBody.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #6c757d;">
                        <p>Connect to eBird to see actual species data for this area.</p>
                        <p style="margin-top: 15px;">This feature requires an eBird API key to fetch real-time observation data.</p>
                    </div>
                `;
                return;
            }

            // Get the observations for the period
            let observations = [];
            if (period === 'selected') {
                observations = recentObservations.week || []; // Primary data is stored in 'week'
            } else {
                observations = recentObservations[period] || [];
            }
            
            if (observations.length === 0) {
                modalBody.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #6c757d;">
                        <p>No observations found for this period.</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">Try searching a different location or expanding your search radius.</p>
                    </div>
                `;
                return;
            }

            // Count observations by species
            const speciesCounts = {};
            const speciesNames = {};
            observations.forEach(obs => {
                if (!speciesCounts[obs.speciesCode]) {
                    speciesCounts[obs.speciesCode] = 0;
                    speciesNames[obs.speciesCode] = obs.comName;
                }
                speciesCounts[obs.speciesCode]++;
            });

            // Convert to array and sort by count
            const speciesArray = Object.keys(speciesCounts).map(code => ({
                code: code,
                name: speciesNames[code],
                count: speciesCounts[code],
                isTarget: targetSpecies.some(t => t.speciesCode === code)
            }));
            speciesArray.sort((a, b) => b.count - a.count);

            // Build species list HTML
            let html = '<ul class="species-list">';
            speciesArray.forEach(species => {
                html += `
                    <li class="species-item">
                        <span class="species-name">
                            ${species.name}
                            ${species.isTarget ? '<span class="target-badge">TARGET</span>' : ''}
                        </span>
                        <span class="species-count">${species.count} obs.</span>
                    </li>
                `;
            });
            html += '</ul>';

            if (targetSpecies.length > 0 && period === 'selected') {
                html = `
                    <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #fbbf24;">
                        <strong style="color: #856404;">üéØ ${targetSpecies.length} Target Species</strong>
                        <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #856404;">
                            These are notable/rare birds recently seen in this area
                        </p>
                    </div>
                ` + html;
            }

            modalBody.innerHTML = html;
        }

        function closeModal() {
            document.getElementById('speciesModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('speciesModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        /**
         * Calculate statistics for a hotspot including leader boards
         */
        function calculateHotspotStats(observations) {
            const observerMap = new Map();
            const speciesMap = new Map();

            observations.forEach(obs => {
                // Count observations by observer
                if (obs.userDisplayName) {
                    if (!observerMap.has(obs.userDisplayName)) {
                        observerMap.set(obs.userDisplayName, {
                            name: obs.userDisplayName,
                            checklists: new Set(),
                            species: new Set()
                        });
                    }
                    observerMap.get(obs.userDisplayName).checklists.add(obs.subId);
                    observerMap.get(obs.userDisplayName).species.add(obs.speciesCode);
                }

                // Count species observations
                if (!speciesMap.has(obs.speciesCode)) {
                    speciesMap.set(obs.speciesCode, {
                        code: obs.speciesCode,
                        name: obs.comName,
                        count: 0
                    });
                }
                speciesMap.get(obs.speciesCode).count++;
            });

            // Top observers by checklist count
            const topChecklistLeaders = Array.from(observerMap.values())
                .map(obs => ({
                    name: obs.name,
                    checklistCount: obs.checklists.size,
                    speciesCount: obs.species.size
                }))
                .sort((a, b) => b.checklistCount - a.checklistCount)
                .slice(0, 5);

            // Top observers by species count
            const topSpeciesLeaders = Array.from(observerMap.values())
                .map(obs => ({
                    name: obs.name,
                    speciesCount: obs.species.size,
                    checklistCount: obs.checklists.size
                }))
                .sort((a, b) => b.speciesCount - a.speciesCount)
                .slice(0, 5);

            // Most common species
            const mostCommonSpecies = Array.from(speciesMap.values())
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);

            return {
                topChecklistLeaders,
                topSpeciesLeaders,
                mostCommonSpecies
            };
        }

        async function loadHotspots(lat, lng, radiusMiles) {
            if (!ebirdAuthenticated) {
                showNotification('Please connect to eBird to view hotspots');
                document.getElementById('showHotspots').checked = false;
                return;
            }

            try {
                const radiusKm = Math.round(radiusMiles * 1.60934);
                const backDays = timeRangeDays === 'year' ? 30 : Math.min(timeRangeDays, 30);
                
                // Fetch hotspots in the area
                const hotspotsUrl = `https://api.ebird.org/v2/ref/hotspot/geo?lat=${lat}&lng=${lng}&dist=${radiusKm}&fmt=json`;
                const response = await fetch(hotspotsUrl, {
                    headers: { 'X-eBirdApiToken': ebirdApiKey }
                });

                if (response.ok) {
                    hotspotsData = await response.json();
                    
                    // Limit to first 25 hotspots for performance
                    const hotspotsToProcess = hotspotsData.slice(0, 25);
                    
                    // For each hotspot, get detailed statistics
                    const hotspotPromises = hotspotsToProcess.map(async (hotspot) => {
                        try {
                            // Get recent observations
                            const obsUrl = `https://api.ebird.org/v2/data/obs/${hotspot.locId}/recent?back=${backDays}`;
                            const obsResponse = await fetch(obsUrl, {
                                headers: { 'X-eBirdApiToken': ebirdApiKey }
                            });
                            
                            if (obsResponse.ok) {
                                const observations = await obsResponse.json();
                                
                                // Calculate species count
                                const speciesSet = new Set(observations.map(obs => obs.speciesCode));
                                hotspot.speciesCount = speciesSet.size;
                                
                                // Calculate leader board stats
                                hotspot.stats = calculateHotspotStats(observations);
                            } else {
                                hotspot.speciesCount = 0;
                                hotspot.stats = null;
                            }
                        } catch (error) {
                            hotspot.speciesCount = 0;
                            hotspot.stats = null;
                        }
                        return hotspot;
                    });

                    await Promise.all(hotspotPromises);
                    
                    if (document.getElementById('showHotspots').checked) {
                        displayHotspots();
                    }
                }
            } catch (error) {
                console.error('Error loading hotspots:', error);
                showNotification('Error loading hotspots');
            }
        }

        function displayHotspots() {
            // Clear existing hotspot markers
            hotspotMarkers.forEach(marker => marker.setMap(null));
            hotspotMarkers = [];

            hotspotsData.forEach(hotspot => {
                const marker = new google.maps.Marker({
                    position: { lat: hotspot.lat, lng: hotspot.lng },
                    map: map,
                    title: hotspot.locName,
                    icon: {
                        path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                        scale: 6,
                        fillColor: '#ea580c',
                        fillOpacity: 0.95,
                        strokeColor: '#ffffff',
                        strokeWeight: 2,
                        rotation: 180
                    },
                    zIndex: 100
                });

                // Create enhanced info window content
                let infoContent = `
                    <div style="padding: 15px; max-width: 350px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                        <h3 style="margin: 0 0 12px 0; color: #ea580c; font-size: 1.2em;">üìç ${hotspot.locName}</h3>
                        <p style="margin: 5px 0;"><strong>Species Count:</strong> ${hotspot.speciesCount || 'Loading...'}</p>
                        <p style="margin: 5px 0 15px 0; font-size: 0.9em; color: #6b7280;">
                            ${hotspot.lat.toFixed(4)}, ${hotspot.lng.toFixed(4)}
                        </p>
                `;

                // Add leader boards if available
                if (hotspot.stats) {
                    // Top Checklist Leaders
                    if (hotspot.stats.topChecklistLeaders && hotspot.stats.topChecklistLeaders.length > 0) {
                        infoContent += `
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <h4 style="margin: 0 0 10px 0; color: #374151; font-size: 0.95em;">üèÜ Top Checklist Leaders</h4>
                                <div style="font-size: 0.85em;">
                        `;
                        
                        hotspot.stats.topChecklistLeaders.forEach((leader, index) => {
                            infoContent += `
                                <div style="margin: 5px 0; padding: 5px; background: #f9fafb; border-radius: 4px;">
                                    <strong>${index + 1}. ${leader.name}</strong><br>
                                    <span style="color: #6b7280;">
                                        ${leader.checklistCount} checklist${leader.checklistCount !== 1 ? 's' : ''}, 
                                        ${leader.speciesCount} species
                                    </span>
                                </div>
                            `;
                        });
                        
                        infoContent += `
                                </div>
                            </div>
                        `;
                    }

                    // Top Species Leaders
                    if (hotspot.stats.topSpeciesLeaders && hotspot.stats.topSpeciesLeaders.length > 0) {
                        infoContent += `
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <h4 style="margin: 0 0 10px 0; color: #374151; font-size: 0.95em;">ü¶ú Top Species Finders</h4>
                                <div style="font-size: 0.85em;">
                        `;
                        
                        hotspot.stats.topSpeciesLeaders.forEach((leader, index) => {
                            infoContent += `
                                <div style="margin: 5px 0; padding: 5px; background: #f0fdf4; border-radius: 4px;">
                                    <strong>${index + 1}. ${leader.name}</strong><br>
                                    <span style="color: #6b7280;">
                                        ${leader.speciesCount} species found
                                    </span>
                                </div>
                            `;
                        });
                        
                        infoContent += `
                                </div>
                            </div>
                        `;
                    }

                    // Most Common Species
                    if (hotspot.stats.mostCommonSpecies && hotspot.stats.mostCommonSpecies.length > 0) {
                        infoContent += `
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <h4 style="margin: 0 0 10px 0; color: #374151; font-size: 0.95em;">üìä Most Reported</h4>
                                <div style="font-size: 0.85em;">
                        `;
                        
                        hotspot.stats.mostCommonSpecies.forEach((species, index) => {
                            infoContent += `
                                <div style="margin: 5px 0;">
                                    <strong>${index + 1}. ${species.name}</strong>
                                    <span style="color: #6b7280;"> - ${species.count} sighting${species.count !== 1 ? 's' : ''}</span>
                                </div>
                            `;
                        });
                        
                        infoContent += `
                                </div>
                            </div>
                        `;
                    }
                }

                infoContent += `
                        <p style="margin: 15px 0 0 0; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                            <a href="https://ebird.org/hotspot/${hotspot.locId}" 
                               target="_blank" 
                               rel="noopener noreferrer"
                               style="color: #10b981; font-weight: 600; text-decoration: none;">
                                View Full Hotspot on eBird ‚Üí
                            </a>
                        </p>
                    </div>
                `;

                const infoWindow = new google.maps.InfoWindow({
                    content: infoContent
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                hotspotMarkers.push(marker);
            });

            showNotification(`Loaded ${hotspotsData.length} hotspots with statistics`);
        }

        function toggleHotspots() {
            const show = document.getElementById('showHotspots').checked;
            
            if (show) {
                if (hotspotsData.length === 0) {
                    // Load hotspots if not already loaded
                    const radiusMiles = searchMode === 'location' 
                        ? parseFloat(document.getElementById('radius').value)
                        : parseFloat(document.getElementById('routeBuffer').value);
                    loadHotspots(currentLocation.lat, currentLocation.lng, radiusMiles);
                } else {
                    displayHotspots();
                }
            } else {
                // Hide hotspot markers
                hotspotMarkers.forEach(marker => marker.setMap(null));
            }
        }

        async function loadTopChecklists(lat, lng, radiusMiles) {
            if (!ebirdAuthenticated) {
                showNotification('Please connect to eBird to view top checklists');
                document.getElementById('showTopChecklists').checked = false;
                return;
            }

            try {
                const radiusKm = Math.round(radiusMiles * 1.60934);
                const backDays = timeRangeDays === 'year' ? 30 : Math.min(timeRangeDays, 30); // eBird API limits back parameter
                
                // Fetch recent observations
                const obsUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=${backDays}&maxResults=200`;
                const response = await fetch(obsUrl, {
                    headers: { 'X-eBirdApiToken': ebirdApiKey }
                });

                if (response.ok) {
                    const observations = await response.json();
                    
                    // Group by checklist (subId)
                    const checklistMap = {};
                    observations.forEach(obs => {
                        if (!checklistMap[obs.subId]) {
                            checklistMap[obs.subId] = {
                                subId: obs.subId,
                                locId: obs.locId,
                                locName: obs.locName,
                                lat: obs.lat,
                                lng: obs.lng,
                                obsDt: obs.obsDt,
                                species: new Set(),
                                obsCount: 0
                            };
                        }
                        checklistMap[obs.subId].species.add(obs.speciesCode);
                        checklistMap[obs.subId].obsCount++;
                    });

                    // Convert to array and sort by species count
                    topChecklists = Object.values(checklistMap)
                        .map(checklist => ({
                            ...checklist,
                            speciesCount: checklist.species.size
                        }))
                        .sort((a, b) => b.speciesCount - a.speciesCount)
                        .slice(0, 10);

                    if (document.getElementById('showTopChecklists').checked) {
                        displayTopChecklists();
                    }
                }
            } catch (error) {
                console.error('Error loading top checklists:', error);
                showNotification('Error loading top checklists');
            }
        }

        function displayTopChecklists() {
            // Clear existing checklist markers
            checklistMarkers.forEach(marker => marker.setMap(null));
            checklistMarkers = [];

            topChecklists.forEach((checklist, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: checklist.lat, lng: checklist.lng },
                    map: map,
                    label: {
                        text: String(index + 1),
                        color: 'white',
                        fontSize: '12px',
                        fontWeight: 'bold'
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 14,
                        fillColor: '#4285F4',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    },
                    zIndex: 200
                });

                const date = new Date(checklist.obsDt);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; max-width: 300px;">
                            <h3 style="margin: 0 0 10px 0; color: #4285F4;">#{${index + 1}} Top Checklist</h3>
                            <p style="margin: 5px 0;"><strong>Location:</strong> ${checklist.locName}</p>
                            <p style="margin: 5px 0;"><strong>Species:</strong> ${checklist.speciesCount}</p>
                            <p style="margin: 5px 0;"><strong>Date:</strong> ${formattedDate}</p>
                            <p style="margin: 10px 0 0 0;">
                                <a href="https://ebird.org/checklist/${checklist.subId}" target="_blank" style="color: #2c5f2d; font-weight: 600; text-decoration: none; padding: 8px 16px; background: #e7f5e8; border-radius: 6px; display: inline-block;">
                                    View Checklist on eBird ‚Üí
                                </a>
                            </p>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                checklistMarkers.push(marker);
            });

            showNotification(`Showing top ${topChecklists.length} checklists`);
        }

        function toggleTopChecklists() {
            const show = document.getElementById('showTopChecklists').checked;
            
            if (show) {
                if (topChecklists.length === 0) {
                    // Load top checklists if not already loaded
                    const radiusMiles = searchMode === 'location' 
                        ? parseFloat(document.getElementById('radius').value)
                        : parseFloat(document.getElementById('routeBuffer').value);
                    loadTopChecklists(currentLocation.lat, currentLocation.lng, radiusMiles);
                } else {
                    displayTopChecklists();
                }
            } else {
                // Hide checklist markers
                checklistMarkers.forEach(marker => marker.setMap(null));
            }
        }

        async function refreshUserList() {
            if (!ebirdAuthenticated) {
                alert('Please connect to eBird first');
                return;
            }
            
            await loadUserList();
        }

        // Location and Search Functions
        function setSearchMode(mode) {
            searchMode = mode;
            
            // Update button states
            document.querySelectorAll('[data-mode]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Toggle search sections
            if (mode === 'location') {
                document.getElementById('locationSearch').style.display = 'block';
                document.getElementById('routeSearch').style.display = 'none';
            } else {
                document.getElementById('locationSearch').style.display = 'none';
                document.getElementById('routeSearch').style.display = 'block';
            }
        }

        function setTimeRange(days) {
            timeRangeDays = days;
            
            // Update button states
            document.querySelectorAll('[data-days]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update the stat box label
            const labels = {
                1: 'Last 1 Day',
                3: 'Last 3 Days',
                7: 'Last 7 Days',
                14: 'Last 14 Days',
                21: 'Last 21 Days',
                30: 'Last 30 Days',
                365: 'Last 365 Days',
                'year': 'Calendar Year'
            };
            document.getElementById('selectedRangeLabel').textContent = labels[days] || `Last ${days} Days`;
            
            // Clear existing hotspots and checklists data
            hotspotsData = [];
            topChecklists = [];
            
            // Refresh current search with new time range
            if (searchMode === 'location' && currentLocation) {
                searchLocation();
            } else if (searchMode === 'route' && currentRoute) {
                // Re-run the last route search
                searchRoute();
            }
        }

        async function searchRoute() {
            const origin = document.getElementById('originAutocomplete').value.trim();
            const destination = document.getElementById('destinationAutocomplete').value.trim();
            const bufferMiles = parseFloat(document.getElementById('routeBuffer').value);
            const bufferKm = bufferMiles * 1.60934;

            if (!origin || !destination) {
                alert('Please enter both starting location and destination');
                return;
            }

            try {
                // Request driving directions
                const request = {
                    origin: origin,
                    destination: destination,
                    travelMode: google.maps.TravelMode.DRIVING,
                    provideRouteAlternatives: false
                };

                directionsService.route(request, async function(result, status) {
                    if (status === 'OK') {
                        // Display the route
                        directionsRenderer.setDirections(result);
                        currentRoute = result;

                        // Extract route path
                        const route = result.routes[0];
                        const path = [];
                        
                        route.legs.forEach(leg => {
                            leg.steps.forEach(step => {
                                path.push({
                                    lat: step.start_location.lat(),
                                    lng: step.start_location.lng()
                                });
                            });
                        });
                        
                        // Add final point
                        const lastLeg = route.legs[route.legs.length - 1];
                        path.push({
                            lat: lastLeg.end_location.lat(),
                            lng: lastLeg.end_location.lng()
                        });

                        // Find sightings along route
                        displaySightingsAlongRoute(path, bufferKm);

                        // Load area statistics for route midpoint
                        const midpoint = Math.floor(path.length / 2);
                        await loadAreaStatistics(path[midpoint].lat, path[midpoint].lng, bufferMiles);

                        // Load hotspots and checklists if toggles are on
                        if (document.getElementById('showHotspots').checked) {
                            await loadHotspots(path[midpoint].lat, path[midpoint].lng, bufferMiles);
                        }
                        if (document.getElementById('showTopChecklists').checked) {
                            await loadTopChecklists(path[midpoint].lat, path[midpoint].lng, bufferMiles);
                        }

                        // Show route info
                        const duration = route.legs.reduce((sum, leg) => sum + leg.duration.value, 0);
                        const distance = route.legs.reduce((sum, leg) => sum + leg.distance.value, 0);
                        showNotification(`Route found: ${(distance / 1609.34).toFixed(1)} miles, ${Math.round(duration / 60)} minutes`);
                    } else {
                        alert('Could not calculate route: ' + status);
                    }
                });
            } catch (error) {
                console.error('Route search error:', error);
                alert('Error finding route. Please check your locations and try again.');
            }
        }

        function displaySightingsAlongRoute(routePath, bufferKm) {
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // Filter sightings near the route
            let nearbySightings = demoSightings.filter(sighting => {
                return isNearRoutePath(sighting, routePath, bufferKm);
            });

            // Apply list filters if authenticated
            if (ebirdAuthenticated) {
                const showOnList = document.getElementById('showOnMyList').checked;
                const showNotOnList = document.getElementById('showNotOnMyList').checked;

                if (showOnList) {
                    nearbySightings = nearbySightings.filter(s => userList.has(s.speciesCode));
                } else if (showNotOnList) {
                    nearbySightings = nearbySightings.filter(s => !userList.has(s.speciesCode));
                }
            }

            // Add markers for sightings
            nearbySightings.forEach(sighting => {
                const onMyList = userList.has(sighting.speciesCode);
                
                const marker = new google.maps.Marker({
                    position: { lat: sighting.lat, lng: sighting.lng },
                    map: map,
                    title: sighting.species,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: sighting.rarity === 'rare' ? '#ef4444' : 
                                   sighting.rarity === 'uncommon' ? '#fbbf24' : '#10b981',
                        fillOpacity: 0.8,
                        strokeColor: onMyList ? '#0d9488' : '#ffffff',
                        strokeWeight: onMyList ? 3 : 2
                    }
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px;">
                            <h3 style="margin: 0 0 10px 0; color: #2c5f2d;">${sighting.species}</h3>
                            <p style="margin: 5px 0;"><strong>Date:</strong> ${sighting.date}</p>
                            <p style="margin: 5px 0;"><strong>Rarity:</strong> ${sighting.rarity}</p>
                            ${ebirdAuthenticated ? `<p style="margin: 5px 0;"><strong>On my list:</strong> ${onMyList ? '‚úÖ Yes' : '‚ùå No'}</p>` : ''}
                            <p style="margin: 5px 0; font-size: 0.9em; color: #6c757d;">
                                ${sighting.lat.toFixed(4)}, ${sighting.lng.toFixed(4)}
                            </p>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            });

            document.getElementById('sightingCount').textContent = nearbySightings.length;
        }

        function isNearRoutePath(sighting, routePath, bufferKm) {
            // Check if sighting is within buffer distance of any segment in the route
            for (let i = 0; i < routePath.length - 1; i++) {
                const distance = distanceToSegment(
                    sighting.lat, sighting.lng,
                    routePath[i].lat, routePath[i].lng,
                    routePath[i + 1].lat, routePath[i + 1].lng
                );
                if (distance <= bufferKm) return true;
            }
            return false;
        }

        function clearRouteSearch() {
            // Clear the route from the map
            directionsRenderer.setDirections({routes: []});
            currentRoute = null;
            
            // Clear markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // Clear hotspot and checklist markers
            hotspotMarkers.forEach(marker => marker.setMap(null));
            hotspotMarkers = [];
            checklistMarkers.forEach(marker => marker.setMap(null));
            checklistMarkers = [];
            
            // Uncheck toggles
            document.getElementById('showHotspots').checked = false;
            document.getElementById('showTopChecklists').checked = false;
            
            document.getElementById('sightingCount').textContent = '0';
            showNotification('Route cleared');
        }

        async function searchLocation() {
            // Clear any existing route
            if (directionsRenderer) {
                directionsRenderer.setDirections({routes: []});
                currentRoute = null;
            }

            const radiusMiles = parseFloat(document.getElementById('radius').value);
            const radiusKm = radiusMiles * 1.60934;
            const zipCode = document.getElementById('zipCode') ? document.getElementById('zipCode').value.trim() : '';
            const limitToRegion = document.getElementById('limitToRegion') ? document.getElementById('limitToRegion').checked : false;

            let searchLocation = null;

            // Priority: ZIP > County > City > State
            if (zipCode && /^\d{5}$/.test(zipCode)) {
                // Search by ZIP code
                try {
                    const results = await new Promise((resolve, reject) => {
                        geocoder.geocode({ address: zipCode + ', USA' }, (results, status) => {
                            if (status === 'OK') resolve(results);
                            else reject(status);
                        });
                    });
                    
                    if (results && results[0]) {
                        searchLocation = results[0].geometry.location;
                    }
                } catch (error) {
                    console.error('ZIP geocoding error:', error);
                }
            } else if (selectedRegion.county && selectedRegion.county.geometry) {
                // Use selected county
                searchLocation = selectedRegion.county.geometry.location;
            } else if (selectedRegion.city && selectedRegion.city.geometry) {
                // Use selected city
                searchLocation = selectedRegion.city.geometry.location;
            } else if (selectedRegion.state && selectedRegion.state.geometry) {
                // Use selected state
                searchLocation = selectedRegion.state.geometry.location;
            }

            if (!searchLocation) {
                alert('Please select a location using the autocomplete fields or enter a ZIP code');
                return;
            }

            try {
                currentLocation = { lat: searchLocation.lat(), lng: searchLocation.lng() };
                map.setCenter(currentLocation);

                // Display sightings
                displaySightings(currentLocation, radiusKm);
                
                // Load area statistics
                await loadAreaStatistics(currentLocation.lat, currentLocation.lng, radiusMiles);
                
                // Load hotspots and checklists if toggles are on
                if (document.getElementById('showHotspots').checked) {
                    await loadHotspots(currentLocation.lat, currentLocation.lng, radiusMiles);
                }
                if (document.getElementById('showTopChecklists').checked) {
                    await loadTopChecklists(currentLocation.lat, currentLocation.lng, radiusMiles);
                }
            } catch (error) {
                console.error('Search error:', error);
                alert('Error performing search. Please try again.');
            }
        }

        function extractRegionCodes(result) {
            // Try to extract region codes from geocoding result
            const components = result.address_components;
            
            for (let component of components) {
                if (component.types.includes('administrative_area_level_2')) {
                    // This might be county
                    // For US: format is typically US-STATE-COUNTY_CODE
                    // This is simplified - in production you'd need a lookup table
                }
                if (component.types.includes('administrative_area_level_1')) {
                    // State
                    const stateCode = component.short_name;
                    userLocation.state = `US-${stateCode}`;
                }
                if (component.types.includes('country')) {
                    userLocation.country = component.short_name;
                }
            }
        }

        function displaySightings(location, radiusKm) {
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // Filter sightings within radius
            let nearbySightings = demoSightings.filter(sighting => {
                const distance = getDistance(location.lat, location.lng, sighting.lat, sighting.lng);
                return distance <= radiusKm;
            });

            // Apply target birds filter if checked
            if (ebirdAuthenticated && document.getElementById('showTargetBirdsOnly')) {
                const showTargetOnly = document.getElementById('showTargetBirdsOnly').checked;

                if (showTargetOnly && targetSpecies) {
                    const targetCodes = new Set(targetSpecies.map(t => t.speciesCode));
                    nearbySightings = nearbySightings.filter(s => targetCodes.has(s.speciesCode));
                }
            }

            // Add markers
            nearbySightings.forEach(sighting => {
                const onMyList = userSpeciesList.has(sighting.speciesCode);
                const isTarget = targetSpecies && targetSpecies.some(t => t.speciesCode === sighting.speciesCode);
                
                const marker = new google.maps.Marker({
                    position: { lat: sighting.lat, lng: sighting.lng },
                    map: map,
                    title: sighting.species,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 9,
                        fillColor: sighting.rarity === 'rare' ? '#c026d3' : 
                                   sighting.rarity === 'uncommon' ? '#ea580c' : '#2563eb',
                        fillOpacity: 0.9,
                        strokeColor: onMyList ? '#fbbf24' : '#ffffff',
                        strokeWeight: onMyList ? 4 : 2
                    }
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px;">
                            <h3 style="margin: 0 0 10px 0; color: #10b981;">${sighting.species}</h3>
                            ${isTarget ? '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">TARGET</span><br>' : ''}
                            <p style="margin: 5px 0;"><strong>Date:</strong> ${sighting.date}</p>
                            <p style="margin: 5px 0;"><strong>Rarity:</strong> ${sighting.rarity}</p>
                            ${ebirdAuthenticated ? `<p style="margin: 5px 0;"><strong>On my list:</strong> ${onMyList ? '‚úÖ Yes' : '‚ùå No'}</p>` : ''}
                            <p style="margin: 5px 0; font-size: 0.9em; color: #6c757d;">
                                ${sighting.lat.toFixed(4)}, ${sighting.lng.toFixed(4)}
                            </p>
                            ${currentRoute ? '<button onclick="addWaypointToRoute(' + sighting.lat + ', ' + sighting.lng + ', \'' + sighting.species.replace(/'/g, "\\'") + '\')" style="margin-top: 10px; padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">Add to Route</button>' : ''}
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            });

            document.getElementById('sightingCount').textContent = nearbySightings.length;
        }

        async function loadSpeciesTaxonomy() {
            if (!ebirdAuthenticated) return;
            
            try {
                // Load eBird taxonomy (this is cached and only needs to be loaded once)
                const response = await fetch('https://api.ebird.org/v2/ref/taxonomy/ebird?fmt=json', {
                    headers: { 'X-eBirdApiToken': ebirdApiKey }
                });
                
                if (response.ok) {
                    allSpecies = await response.json();
                    console.log(`Loaded ${allSpecies.length} species from eBird taxonomy`);
                }
            } catch (error) {
                console.error('Error loading species taxonomy:', error);
            }
        }

        function searchSpecies() {
            const input = document.getElementById('speciesSearch').value.toLowerCase();
            const dropdown = document.getElementById('speciesDropdown');
            
            if (!input || input.length < 2) {
                dropdown.style.display = 'none';
                return;
            }

            // Filter species that match the search
            const matches = allSpecies
                .filter(sp => 
                    sp.comName.toLowerCase().includes(input) || 
                    sp.sciName.toLowerCase().includes(input)
                )
                .slice(0, 20); // Limit to 20 results

            if (matches.length === 0) {
                dropdown.innerHTML = '<div style="padding: 10px; color: #6c757d;">No species found</div>';
                dropdown.style.display = 'block';
                return;
            }

            // Build dropdown HTML
            dropdown.innerHTML = matches.map(sp => `
                <div 
                    style="padding: 10px; cursor: pointer; border-bottom: 1px solid #e9ecef;"
                    onmouseover="this.style.background='#f8f9fa'"
                    onmouseout="this.style.background='white'"
                    onclick="selectSpecies('${sp.speciesCode}', '${sp.comName.replace(/'/g, "\\'")}')"
                >
                    <strong style="color: #2c5f2d;">${sp.comName}</strong><br>
                    <small style="color: #6c757d; font-style: italic;">${sp.sciName}</small>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }

        function selectSpecies(speciesCode, commonName) {
            selectedSpecies = { code: speciesCode, name: commonName };
            document.getElementById('speciesSearch').value = commonName;
            document.getElementById('speciesDropdown').style.display = 'none';
        }

        function showSpeciesDropdown() {
            if (allSpecies.length === 0 && ebirdAuthenticated) {
                loadSpeciesTaxonomy();
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('speciesDropdown');
            const input = document.getElementById('speciesSearch');
            
            if (event.target !== dropdown && event.target !== input) {
                dropdown.style.display = 'none';
            }
        });

        /**
         * Add all sightings of selected species to the map
         */
        async function addSpeciesToMap() {
            if (!selectedSpecies) {
                alert('Please search and select a species first');
                return;
            }
            
            if (!ebirdAuthenticated) {
                alert('Please connect to eBird first');
                return;
            }
            
            if (!currentLocation && !currentRoute) {
                alert('Please perform a location or route search first');
                return;
            }
            
            const timeRange = document.getElementById('speciesTimeRange').value;
            let backDays = timeRange;
            if (timeRange === 'year') {
                const yearStart = new Date(new Date().getFullYear(), 0, 1);
                backDays = Math.ceil((new Date() - yearStart) / (1000 * 60 * 60 * 24));
            }
            backDays = Math.min(backDays, 30);
            
            const radiusMiles = parseFloat(document.getElementById('radius').value) || 15;
            const radiusKm = radiusMiles * 1.60934;
            
            const searchLat = currentLocation ? currentLocation.lat : currentRoute.routes[0].legs[0].start_location.lat();
            const searchLng = currentLocation ? currentLocation.lng : currentRoute.routes[0].legs[0].start_location.lng();
            
            try {
                const url = `https://api.ebird.org/v2/data/obs/geo/recent/${selectedSpecies.code}?lat=${searchLat}&lng=${searchLng}&dist=${radiusKm}&back=${backDays}`;
                
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': ebirdApiKey }
                });
                
                if (response.ok) {
                    const observations = await response.json();
                    
                    if (observations.length === 0) {
                        showNotification(`No recent sightings of ${selectedSpecies.name} found`);
                        return;
                    }
                    
                    markers.forEach(marker => marker.setMap(null));
                    markers = [];
                    
                    selectedSpeciesForMap = {
                        species: selectedSpecies,
                        observations: observations
                    };
                    
                    observations.forEach(obs => {
                        const onMyList = userSpeciesList.has(obs.speciesCode);
                        const isTarget = targetSpecies && targetSpecies.some(t => t.speciesCode === obs.speciesCode);
                        
                        const marker = new google.maps.Marker({
                            position: { lat: obs.lat, lng: obs.lng },
                            map: map,
                            title: obs.comName,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: isTarget ? '#c026d3' : '#2563eb',
                                fillOpacity: 1,
                                strokeColor: onMyList ? '#fbbf24' : '#ffffff',
                                strokeWeight: onMyList ? 4 : 2
                            }
                        });
                        
                        const date = new Date(obs.obsDt);
                        const infoWindow = new google.maps.InfoWindow({
                            content: `
                                <div style="padding: 10px;">
                                    <h3 style="margin: 0 0 10px 0; color: #10b981;">${obs.comName}</h3>
                                    ${isTarget ? '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">TARGET</span><br>' : ''}
                                    <p><strong>Location:</strong> ${obs.locName}</p>
                                    <p><strong>Date:</strong> ${date.toLocaleDateString()} ${date.toLocaleTimeString()}</p>
                                    <p><strong>Count:</strong> ${obs.howMany || 'X'}</p>
                                    ${onMyList ? '<p style="color: #fbbf24; font-weight: 600;">‚úì On your list</p>' : ''}
                                    <a href="https://ebird.org/checklist/${obs.subId}" target="_blank" rel="noopener noreferrer" style="color: #10b981; font-weight: 600;">View Checklist ‚Üí</a>
                                    ${currentRoute ? '<br><button onclick="addWaypointToRoute(' + obs.lat + ', ' + obs.lng + ', \'' + obs.locName.replace(/'/g, "\\'") + '\')" style="margin-top: 10px; padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">Add to Route</button>' : ''}
                                </div>
                            `
                        });
                        
                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });
                        
                        markers.push(marker);
                    });
                    
                    const bounds = new google.maps.LatLngBounds();
                    observations.forEach(obs => bounds.extend({ lat: obs.lat, lng: obs.lng }));
                    map.fitBounds(bounds);
                    
                    showNotification(`Found ${observations.length} sighting(s) of ${selectedSpecies.name}`);
                    
                } else {
                    alert('Error fetching species sightings');
                }
            } catch (error) {
                console.error('Error adding species to map:', error);
                alert('Error adding species sightings to map');
            }
        }

        /**
         * Add a waypoint to the current route
         */
        function addWaypointToRoute(lat, lng, locationName) {
            if (!currentRoute) {
                alert('Please create a route first');
                return;
            }
            
            tripWaypoints.push({
                location: { lat: lat, lng: lng },
                name: locationName
            });
            
            showNotification('Waypoint added! Recalculating route...');
            recalculateRouteWithWaypoints();
        }

        /**
         * Recalculate route including all waypoints
         */
        async function recalculateRouteWithWaypoints() {
            if (!directionsService || tripWaypoints.length === 0) {
                return;
            }
            
            const origin = document.getElementById('originAutocomplete').value;
            const destination = document.getElementById('destinationAutocomplete').value;
            
            if (!origin || !destination) {
                return;
            }
            
            try {
                const waypoints = tripWaypoints.map(wp => ({
                    location: new google.maps.LatLng(wp.location.lat, wp.location.lng),
                    stopover: true
                }));
                
                const request = {
                    origin: origin,
                    destination: destination,
                    waypoints: waypoints,
                    travelMode: google.maps.TravelMode.DRIVING,
                    optimizeWaypoints: false
                };
                
                directionsService.route(request, function(result, status) {
                    if (status === 'OK') {
                        directionsRenderer.setDirections(result);
                        currentRoute = result;
                        displayRouteInfo(result);
                        showNotification('Route updated with ' + tripWaypoints.length + ' waypoint(s)!');
                    } else {
                        console.error('Route error:', status);
                        alert('Could not calculate route with waypoints');
                    }
                });
            } catch (error) {
                console.error('Error recalculating route:', error);
            }
        }

        /**
         * Display detailed route information
         */
        function displayRouteInfo(route) {
            const legs = route.routes[0].legs;
            let totalDistance = 0;
            let totalDuration = 0;
            
            legs.forEach(leg => {
                totalDistance += leg.distance.value;
                totalDuration += leg.duration.value;
            });
            
            console.log('Route Info:', {
                legs: legs.length,
                totalDistance: (totalDistance / 1609.34).toFixed(1) + ' miles',
                totalDuration: Math.round(totalDuration / 60) + ' minutes'
            });
            
            document.getElementById('targetBirdCount').textContent = tripWaypoints.length;
        }

        /**
         * Clear all waypoints
         */
        function clearWaypoints() {
            tripWaypoints = [];
            searchRoute();
            showNotification('Waypoints cleared');
        }

        function showNotification(message, duration = 3000) {
            // Visual notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2c5f2d;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
                max-width: 300px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function addRoutePoint(latLng) {
            routePoints.push(latLng);

            // Add marker for waypoint
            const marker = new google.maps.Marker({
                position: latLng,
                map: map,
                label: String(routePoints.length),
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#667eea',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2
                }
            });

            // Draw route
            if (routePoints.length > 1) {
                if (routePath) {
                    routePath.setMap(null);
                }

                routePath = new google.maps.Polyline({
                    path: routePoints,
                    geodesic: true,
                    strokeColor: '#667eea',
                    strokeOpacity: 0.8,
                    strokeWeight: 4,
                    map: map
                });

                // Check for sightings along route
                checkRouteAlerts();
            }
        }

        function checkRouteAlerts() {
            if (routePoints.length < 2) return;

            const radiusMiles = parseFloat(document.getElementById('radius').value);
            const thresholdKm = radiusMiles * 1.60934;

            const nearbyToRoute = demoSightings.filter(sighting => {
                return isNearRoute(sighting, routePoints, thresholdKm);
            });

            alerts.forEach(alert => {
                if (alert.type === 'route' || alert.type === 'both') {
                    const matching = nearbyToRoute.filter(s => 
                        s.species.toLowerCase().includes(alert.species.toLowerCase())
                    );

                    if (matching.length > 0) {
                        showNotification(`üöó Alert: ${matching.length} ${alert.species} sighting(s) along your route!`);
                    }
                }
            });
        }

        function isNearRoute(sighting, route, thresholdKm) {
            for (let i = 0; i < route.length - 1; i++) {
                const distance = distanceToSegment(
                    sighting.lat, sighting.lng,
                    route[i].lat(), route[i].lng(),
                    route[i + 1].lat(), route[i + 1].lng()
                );
                if (distance <= thresholdKm) return true;
            }
            return false;
        }

        function distanceToSegment(px, py, x1, y1, x2, y2) {
            const A = px - x1;
            const B = py - y1;
            const C = x2 - x1;
            const D = y2 - y1;

            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;

            if (lenSq !== 0) param = dot / lenSq;

            let xx, yy;

            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }

            return getDistance(px, py, xx, yy);
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);

        // Global variables for autocomplete
        let cityAutocomplete, countyAutocomplete, stateAutocomplete, originAutocomplete, destinationAutocomplete;
        let selectedRegion = { city: null, county: null, state: null, zip: null };

        /**
         * Initialize all Google Places Autocomplete inputs
         */
        function initializeAutocomplete() {
            // City autocomplete
            if (document.getElementById('cityAutocomplete')) {
                cityAutocomplete = new google.maps.places.Autocomplete(
                    document.getElementById('cityAutocomplete'),
                    { types: ['(cities)'] }
                );
                cityAutocomplete.addListener('place_changed', function() {
                    selectedRegion.city = cityAutocomplete.getPlace();
                });
            }

            // County autocomplete
            if (document.getElementById('countyAutocomplete')) {
                countyAutocomplete = new google.maps.places.Autocomplete(
                    document.getElementById('countyAutocomplete'),
                    { types: ['administrative_area_level_2'] }
                );
                countyAutocomplete.addListener('place_changed', function() {
                    selectedRegion.county = countyAutocomplete.getPlace();
                });
            }

            // State autocomplete
            if (document.getElementById('stateAutocomplete')) {
                stateAutocomplete = new google.maps.places.Autocomplete(
                    document.getElementById('stateAutocomplete'),
                    { types: ['administrative_area_level_1'] }
                );
                stateAutocomplete.addListener('place_changed', function() {
                    selectedRegion.state = stateAutocomplete.getPlace();
                });
            }

            // Route autocomplete
            if (document.getElementById('originAutocomplete')) {
                originAutocomplete = new google.maps.places.Autocomplete(
                    document.getElementById('originAutocomplete')
                );
            }
            
            if (document.getElementById('destinationAutocomplete')) {
                destinationAutocomplete = new google.maps.places.Autocomplete(
                    document.getElementById('destinationAutocomplete')
                );
            }
        }

        /**
         * Reset all filters and clear the map
         */
        function resetAllFilters() {
            // Clear autocomplete inputs
            if (document.getElementById('cityAutocomplete')) document.getElementById('cityAutocomplete').value = '';
            if (document.getElementById('countyAutocomplete')) document.getElementById('countyAutocomplete').value = '';
            if (document.getElementById('stateAutocomplete')) document.getElementById('stateAutocomplete').value = '';
            if (document.getElementById('zipCode')) document.getElementById('zipCode').value = '';
            if (document.getElementById('radius')) document.getElementById('radius').value = '15';
            if (document.getElementById('originAutocomplete')) document.getElementById('originAutocomplete').value = '';
            if (document.getElementById('destinationAutocomplete')) document.getElementById('destinationAutocomplete').value = '';
            if (document.getElementById('routeBuffer')) document.getElementById('routeBuffer').value = '10';
            
            // Uncheck checkboxes
            if (document.getElementById('limitToRegion')) document.getElementById('limitToRegion').checked = false;
            
            // Reset time range
            document.querySelectorAll('.time-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-days') === '30') {
                    btn.classList.add('active');
                }
            });
            timeRangeDays = 30;
            document.getElementById('selectedRangeLabel').textContent = 'Last 30 Days';
            
            // Reset search mode
            document.querySelectorAll('[data-mode]').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-mode') === 'location') {
                    btn.classList.add('active');
                }
            });
            searchMode = 'location';
            document.getElementById('locationSearch').style.display = 'block';
            document.getElementById('routeSearch').style.display = 'none';
            
            // Clear map
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            hotspotMarkers.forEach(marker => marker.setMap(null));
            hotspotMarkers = [];
            checklistMarkers.forEach(marker => marker.setMap(null));
            checklistMarkers = [];
            directionsRenderer.setDirections({routes: []});
            
            // Reset map center
            map.setCenter({ lat: 42.3601, lng: -71.0589 });
            map.setZoom(10);
            
            // Clear selections
            selectedRegion = { city: null, county: null, state: null, zip: null };
            currentLocation = null;
            currentRoute = null;
            
            // Reset toggles
            if (document.getElementById('showHotspots')) document.getElementById('showHotspots').checked = false;
            if (document.getElementById('showTopChecklists')) document.getElementById('showTopChecklists').checked = false;
            
            showNotification('All filters reset');
        }

        /**
         * Calculate and update user vs overall statistics
         */
        function updateUserStatistics() {
            // Get overall counts
            const overallWeek = parseInt(document.getElementById('weekSpeciesCount').textContent) || 0;
            const overallMonth = parseInt(document.getElementById('monthSpeciesCount').textContent) || 0;
            const overallYearText = document.getElementById('yearSpeciesCount').textContent;
            const overallYear = parseInt(overallYearText.replace('~', '')) || 0;
            
            if (overallWeek === 0 && overallMonth === 0 && overallYear === 0) {
                return; // No data yet
            }
            
            // Get user's list size
            const userListSize = userSpeciesList.size;
            
            // Estimate user's observations in the area
            // This is an approximation since eBird API doesn't provide direct "user observations in area" endpoint
            // We calculate based on the proportion of user's list compared to typical regional diversity
            const estimatedRegionalSpecies = 500; // Rough estimate
            const userListPercentage = Math.min(userListSize / estimatedRegionalSpecies, 1);
            
            // Calculate user counts (conservative estimates)
            const userWeek = Math.round(overallWeek * userListPercentage * 0.6);
            const userMonth = Math.round(overallMonth * userListPercentage * 0.65);
            const userYear = Math.round(overallYear * userListPercentage * 0.7);
            
            // Update UI
            document.getElementById('userWeekCount').textContent = userWeek;
            document.getElementById('userMonthCount').textContent = userMonth;
            document.getElementById('userYearCount').textContent = userYear;
            
            // Calculate and display percentages
            if (overallWeek > 0) {
                const weekPct = Math.round((userWeek / overallWeek) * 100);
                document.getElementById('weekPercentage').textContent = 
                    `You've seen ${weekPct}% of species in this area`;
            }
            
            if (overallMonth > 0) {
                const monthPct = Math.round((userMonth / overallMonth) * 100);
                document.getElementById('monthPercentage').textContent = 
                    `You've seen ${monthPct}% of species in this area`;
            }
            
            if (overallYear > 0) {
                const yearPct = Math.round((userYear / overallYear) * 100);
                document.getElementById('yearPercentage').textContent = 
                    `You've seen ${yearPct}% of species in this area`;
            }
        }

        // Real map initialization function
        window.realInitMap = function() {
            console.log('Real initMap executing...');
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 42.3601, lng: -71.0589 }, // Boston
                zoom: 10,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            // Initialize geocoder for location searches
            geocoder = new google.maps.Geocoder();
            
            // Initialize directions service for route planning
            directionsService = new google.maps.DirectionsService();

            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: false,
                polylineOptions: {
                    strokeColor: '#0d9488',
                    strokeWeight: 4
                }
            });
            
            // Initialize autocomplete for search fields
            initializeAutocomplete();

            // Initialize after map is ready
            updateAuthUI();
            
            console.log('Map initialized successfully!');
        };
        
        // If Google Maps already loaded before this script, call init now
        if (window.mapInitPending) {
            console.log('Google Maps was waiting, initializing now...');
            window.realInitMap();
        }

        // Initialize other components when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            updateAuthUI();
        });

        // Toggle functions for collapsible sections
        function toggleInstructions() {
            const content = document.getElementById('instructionsContent');
            const toggle = document.getElementById('instructionsToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚àí';
            } else {
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }

        function toggleLegend() {
            const content = document.getElementById('legendContent');
            const toggle = document.getElementById('legendToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚àí';
            } else {
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }

        /**
         * Toggle target report visibility
         */
        function toggleTargetReport() {
            const content = document.getElementById('targetReportContent');
            const toggle = document.getElementById('targetReportToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚àí';
            } else {
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }

        /**
         * Helper function to get human-readable time ago
         */
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 60) {
                return diffMins === 1 ? '1 minute ago' : `${diffMins} minutes ago`;
            } else if (diffHours < 24) {
                return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
            } else if (diffDays < 7) {
                return diffDays === 1 ? '1 day ago' : `${diffDays} days ago`;
            } else {
                return date.toLocaleDateString() + ' at ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
        }

        /**
         * Show modal with target species details
         */
        function showTargetSpeciesModal() {
            if (!targetSpecies || targetSpecies.length === 0) {
                return;
            }
            
            const speciesMap = new Map();
            targetSpecies.forEach(obs => {
                if (!speciesMap.has(obs.speciesCode)) {
                    speciesMap.set(obs.speciesCode, {
                        code: obs.speciesCode,
                        name: obs.comName,
                        observations: []
                    });
                }
                speciesMap.get(obs.speciesCode).observations.push(obs);
            });
            
            const sortedSpecies = Array.from(speciesMap.values()).sort((a, b) => {
                const dateA = new Date(a.observations[0].obsDt);
                const dateB = new Date(b.observations[0].obsDt);
                return dateB - dateA;
            });
            
            let tableHTML = '<table style="width: 100%; border-collapse: collapse;">';
            tableHTML += '<thead><tr style="background: #f0fdf4; border-bottom: 2px solid #10b981;">';
            tableHTML += '<th style="padding: 12px; text-align: left; font-weight: 600;">Species</th>';
            tableHTML += '<th style="padding: 12px; text-align: left; font-weight: 600;">Last Seen</th>';
            tableHTML += '<th style="padding: 12px; text-align: left; font-weight: 600;">Location</th>';
            tableHTML += '</tr></thead><tbody>';
            
            sortedSpecies.forEach((species, index) => {
                const mostRecent = species.observations[0];
                const date = new Date(mostRecent.obsDt);
                const locationParts = mostRecent.locName.split(',');
                const location = locationParts.length >= 2 ? 
                    locationParts[locationParts.length - 2].trim() + ', ' + locationParts[locationParts.length - 1].trim() : 
                    mostRecent.locName;
                
                tableHTML += `<tr style="border-bottom: 1px solid #e5e7eb; ${index % 2 === 0 ? 'background: #f9fafb;' : ''}">`;
                tableHTML += `<td style="padding: 12px;"><strong>${species.name}</strong></td>`;
                tableHTML += `<td style="padding: 12px;">${date.toLocaleDateString()}</td>`;
                tableHTML += `<td style="padding: 12px;">${location}</td>`;
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            
            showModal('Target Species Details', tableHTML);
        }

        /**
         * Show a modal dialog
         */
        function showModal(title, content) {
            let modal = document.getElementById('customModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'customModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 id="modalTitle"></h2>
                            <span class="close" onclick="closeCustomModal()">&times;</span>
                        </div>
                        <div class="modal-body" id="modalBody"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            modal.style.display = 'block';
        }

        function closeCustomModal() {
            const modal = document.getElementById('customModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('customModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        /**
         * Load and display target species report
         */
        async function loadTargetReport() {
            if (!ebirdAuthenticated) {
                document.getElementById('targetReportEmpty').style.display = 'block';
                document.getElementById('targetReportList').innerHTML = '';
                document.getElementById('targetSpeciesCount').textContent = '0';
                return;
            }

            if (!currentLocation) {
                return;
            }

            const listElement = document.getElementById('targetReportList');
            const emptyElement = document.getElementById('targetReportEmpty');
            const countElement = document.getElementById('targetSpeciesCount');

            if (!targetSpecies || targetSpecies.length === 0) {
                emptyElement.style.display = 'block';
                listElement.innerHTML = '';
                countElement.textContent = '0';
                return;
            }

            emptyElement.style.display = 'none';
            
            // Get region name
            let regionName = 'this area';
            if (selectedRegion.county && selectedRegion.county.formatted_address) {
                regionName = selectedRegion.county.formatted_address;
            } else if (selectedRegion.city && selectedRegion.city.formatted_address) {
                regionName = selectedRegion.city.formatted_address;
            } else if (selectedRegion.state && selectedRegion.state.formatted_address) {
                regionName = selectedRegion.state.formatted_address;
            }
            
            // Make count clickable
            const targetCount = targetSpecies.length;
            countElement.innerHTML = `<a href="#" onclick="showTargetSpeciesModal(); return false;" style="color: #065f46; text-decoration: underline; cursor: pointer;">${targetCount}</a>`;
            
            // Update summary with region and clickable count
            const summaryElement = document.getElementById('targetReportSummary');
            if (summaryElement) {
                summaryElement.innerHTML = `
                    <p style="margin: 0; color: #065f46; font-weight: 600;">
                        <span id="targetSpeciesCount"><a href="#" onclick="showTargetSpeciesModal(); return false;" style="color: #065f46; text-decoration: underline; cursor: pointer;">${targetCount}</a></span> notable/rare species found in <strong>${regionName}</strong>
                    </p>
                    <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #6b7280;">
                        Based on recent observations and rarity for this region
                    </p>
                `;
            }

            // Group observations by species
            const speciesMap = new Map();
            targetSpecies.forEach(obs => {
                if (!speciesMap.has(obs.speciesCode)) {
                    speciesMap.set(obs.speciesCode, {
                        code: obs.speciesCode,
                        name: obs.comName,
                        sciName: obs.sciName || '',
                        observations: []
                    });
                }
                speciesMap.get(obs.speciesCode).observations.push(obs);
            });

            // Sort species by most recent observation
            const sortedSpecies = Array.from(speciesMap.values()).sort((a, b) => {
                const dateA = new Date(a.observations[0].obsDt);
                const dateB = new Date(b.observations[0].obsDt);
                return dateB - dateA;
            });

            // Build HTML for each species
            const cardsHTML = sortedSpecies.map(species => {
                const mostRecent = species.observations.sort((a, b) => {
                    return new Date(b.obsDt) - new Date(a.obsDt);
                })[0];

                const date = new Date(mostRecent.obsDt);
                const timeAgo = getTimeAgo(date);
                const onMyList = userSpeciesList.has(species.code);

                return `
                    <div class="target-species-card">
                        <h3>
                            ${species.name}
                            ${onMyList ? '<span style="background: #fbbf24; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.7em; margin-left: 8px;">ON YOUR LIST</span>' : ''}
                        </h3>
                        <p style="font-style: italic; color: #6b7280; margin: 5px 0;">${species.sciName}</p>
                        
                        <div class="target-species-meta">
                            <div class="target-species-meta-item">
                                <strong>üìç Location</strong>
                                ${mostRecent.locName}
                            </div>
                            <div class="target-species-meta-item">
                                <strong>üïê Observed</strong>
                                ${timeAgo}
                            </div>
                            <div class="target-species-meta-item">
                                <strong>üìä Count</strong>
                                ${mostRecent.howMany || 'Present'}
                            </div>
                            <div class="target-species-meta-item">
                                <strong>üëÅÔ∏è Total Sightings</strong>
                                ${species.observations.length} in search area
                            </div>
                        </div>
                        
                        <a href="https://ebird.org/checklist/${mostRecent.subId}" 
                           target="_blank" 
                           rel="noopener noreferrer" 
                           class="