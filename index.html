<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traveling Birder v5.0 - Route-Based Birding Planner</title>
    <!-- BUILD: 2024-12-18-COMPLETE-REDESIGN-v5.0 -->
    
    <!-- Google Maps Script with Callback -->
    <script>
        var mapInitPending = false;
        window.initMap = function() {
            console.log('üó∫Ô∏è Google Maps callback triggered');
            mapInitPending = true;
            if (document.readyState === 'complete') {
                if (typeof realInitMap === 'function') {
                    console.log('‚úÖ Calling realInitMap immediately');
                    realInitMap();
                }
            }
        };
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvpU9tANBmnbKqMM2UWvELa9nRcrhneY0&libraries=places,geometry&callback=initMap"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f9fafb;
            color: #374151;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        /* ============================================
           HEADER STYLES
           ============================================ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: white;
            border-bottom: 3px solid #10b981;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-left h1 {
            margin: 0;
            font-size: 1.6em;
            color: #065f46;
        }

        .header-left p {
            margin: 3px 0 0 0;
            font-size: 0.85em;
            color: #6b7280;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .help-btn {
            background: #fbbf24;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.4em;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(251, 191, 36, 0.3);
            transition: all 0.3s;
        }

        .help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }

        .ebird-login {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ebird-login input {
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9em;
            width: 220px;
        }

        .ebird-login button {
            padding: 10px 20px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.3s;
        }

        .ebird-login button:hover {
            background: #059669;
        }

        .ebird-connected {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #d1fae5;
            padding: 8px 16px;
            border-radius: 8px;
        }

        .ebird-connected-text {
            font-size: 0.9em;
            color: #065f46;
            font-weight: 600;
        }

        .disconnect-btn {
            padding: 6px 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
        }

        /* ============================================
           QUICK START MODAL
           ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 35px;
            max-width: 650px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            margin: 0;
            color: #065f46;
            font-size: 1.8em;
        }

        .modal-close {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.4em;
            cursor: pointer;
            font-weight: bold;
            line-height: 1;
        }

        .modal-content ol {
            padding-left: 25px;
            line-height: 2;
            color: #374151;
        }

        .modal-content strong {
            color: #065f46;
        }

        .modal-tips {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
            border: 1px solid #10b981;
        }

        .modal-tips strong {
            display: block;
            margin-bottom: 12px;
            color: #065f46;
            font-size: 1.1em;
        }

        .modal-tips ul {
            margin: 0;
            padding-left: 25px;
            font-size: 0.95em;
            color: #047857;
        }

        /* ============================================
           MAIN LAYOUT
           ============================================ */
        .main-layout {
            display: grid;
            grid-template-columns: 420px 1fr;
            height: calc(100vh - 80px);
            gap: 0;
        }

        .sidebar {
            background: white;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #e5e7eb;
        }

        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f9fafb;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #10b981;
            border-radius: 4px;
        }

        .map-container {
            position: relative;
            height: 100%;
            min-height: 600px;
        }

        #map {
            width: 100%;
            height: 100%;
            min-height: 600px;
        }

        /* ============================================
           SIDEBAR SECTIONS
           ============================================ */
        .section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 18px;
            margin-bottom: 18px;
        }

        .section h3 {
            color: #065f46;
            margin-bottom: 15px;
            font-size: 1.15em;
            padding-bottom: 10px;
            border-bottom: 2px solid #10b981;
        }

        .input-group {
            margin-bottom: 14px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            color: #374151;
            font-weight: 600;
            font-size: 0.9em;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 11px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        button.primary-btn {
            width: 100%;
            padding: 12px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        button.primary-btn:hover {
            background: #059669;
        }

        button.secondary-btn {
            width: 100%;
            padding: 10px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 8px;
        }

        button.secondary-btn:hover {
            background: #4b5563;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-size: 0.9em;
            color: #374151;
        }

        /* ============================================
           FLOATING MAP LEGEND
           ============================================ */
        .map-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            max-width: 280px;
            z-index: 100;
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .legend-header h4 {
            margin: 0;
            color: #065f46;
            font-size: 1em;
        }

        .legend-toggle {
            font-size: 1.2em;
            font-weight: bold;
            color: #10b981;
        }

        .legend-content {
            font-size: 0.85em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }

        .legend-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .legend-marker.target { background: #ef4444; }
        .legend-marker.rare { background: #f59e0b; }
        .legend-marker.common { background: #10b981; }
        .legend-marker.hotspot { background: #3b82f6; }

        /* ============================================
           BELOW MAP PANELS
           ============================================ */
        .below-map {
            background: white;
            border-top: 2px solid #e5e7eb;
        }

        .panels-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: #e5e7eb;
        }

        .panel {
            background: white;
            padding: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .panel:hover {
            background: #f9fafb;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .panel-header h3 {
            margin: 0;
            color: #065f46;
            font-size: 1.1em;
        }

        .panel-toggle {
            font-size: 1.5em;
            color: #10b981;
            font-weight: bold;
        }

        .panel-summary {
            color: #6b7280;
            font-size: 0.9em;
        }

        .panel-content {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .panel-content.expanded {
            display: block;
        }

        /* ============================================
           ROUTE CONTROLS
           ============================================ */
        .route-duration {
            background: #dbeafe;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            margin: 12px 0;
            font-weight: 600;
            color: #1e40af;
        }

        .waypoint-list {
            margin-top: 12px;
        }

        .waypoint-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f3f4f6;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 0.85em;
        }

        .waypoint-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 3px 8px;
            font-size: 0.8em;
            cursor: pointer;
        }

        /* ============================================
           RESPONSIVE DESIGN
           ============================================ */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 360px 1fr;
            }
        }

        @media (max-width: 968px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .main-layout {
                grid-template-columns: 1fr;
                height: auto;
            }

            .sidebar {
                height: auto;
                max-height: 60vh;
            }

            .map-container {
                height: 500px;
            }

            .panels-container {
                grid-template-columns: 1fr;
            }

            .ebird-login input {
                width: 180px;
            }
        }

        @media (max-width: 640px) {
            .header-left h1 {
                font-size: 1.3em;
            }

            .ebird-login {
                flex-direction: column;
                width: 100%;
            }

            .ebird-login input,
            .ebird-login button {
                width: 100%;
            }

            .help-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2em;
            }
        }

        /* ============================================
           PRINT STYLES
           ============================================ */
        @media print {
            .header,
            .sidebar,
            .below-map,
            .map-legend {
                display: none !important;
            }

            .map-container {
                height: 100vh !important;
            }

            #map {
                height: 100vh !important;
            }
        }

        /* ============================================
           UTILITY CLASSES
           ============================================ */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        /* ============================================
           GOOGLE PLACES AUTOCOMPLETE STYLING
           ============================================ */
        .pac-container {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-top: 4px;
            z-index: 10000 !important;
        }

        .pac-item {
            padding: 10px;
            cursor: pointer;
            border-top: 1px solid #e5e7eb;
        }

        .pac-item:first-child {
            border-top: none;
        }

        .pac-item:hover {
            background: #f0fdf4;
        }

        .pac-item-query {
            color: #065f46;
            font-weight: 600;
        }

        .pac-icon {
            margin-top: 2px;
        }
        
        @keyframes fly {
            0%, 100% { transform: translateY(0px) rotate(-5deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }
    </style>
</head>
<body>
    <!-- ============================================
         HEADER
         ============================================ -->
    <div class="header">
        <div class="header-left">
            <h1>ü¶© Traveling Birder</h1>
            <p>Plan your birding trip with target species along your route</p>
        </div>
        <div class="header-right">
            <button class="help-btn" onclick="toggleQuickStart()" title="Quick Start Guide" style="display: flex; align-items: center; gap: 8px; padding: 0 15px; border-radius: 20px; width: auto;">
                <span style="font-size: 1.3em;">üí°</span>
                <span style="font-size: 0.9em; font-weight: 600;">Quick Start</span>
            </button>
            <div id="ebirdHeader" style="display: flex; flex-direction: column; gap: 5px;">
                <div class="ebird-login">
                    <input type="password" id="apiKey" placeholder="eBird API Key">
                    <button onclick="connectEbird()">Connect</button>
                </div>
                <div style="text-align: center; font-size: 0.75em; color: #6b7280;">
                    Get free API key: <a href="https://ebird.org/api/keygen" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: none;">ebird.org/api/keygen</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         QUICK START MODAL
         ============================================ -->
    <div id="quickStartModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí° Quick Start Guide</h2>
                <button class="modal-close" onclick="toggleQuickStart()">√ó</button>
            </div>
            <ol>
                <li><strong>Connect eBird:</strong> Enter your API key in the top-right (get free at <a href="https://ebird.org/api/keygen" target="_blank" style="color: #10b981;">ebird.org/api/keygen</a>)</li>
                <li><strong>Plan Route:</strong> Enter your starting point and destination</li>
                <li><strong>Set Parameters:</strong> Choose search radius and time range</li>
                <li><strong>View Results:</strong> See target species (birds NOT on your list) along your route</li>
                <li><strong>Add Waypoints:</strong> Click any bird or hotspot marker to add it as a stop</li>
                <li><strong>Print Directions:</strong> Get turn-by-turn directions with your birding stops</li>
            </ol>
            <div class="modal-tips">
                <strong>üí° Pro Tips:</strong>
                <ul>
                    <li>Target species are birds you haven't seen yet - find new lifers!</li>
                    <li>Top 10 hotspots are ranked by most species recently seen</li>
                    <li>Click markers to add waypoints and plan the perfect birding route</li>
                    <li>Use Print Directions to take your route on the road</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ============================================
         MAIN LAYOUT
         ============================================ -->
    <div class="main-layout">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <!-- Route Planning Section -->
            <div class="section">
                <h3>üöó Search Mode</h3>
                <div class="input-group">
                    <label>Search Type</label>
                    <select id="searchMode" onchange="toggleSearchMode()">
                        <option value="route">Route (Origin ‚Üí Destination)</option>
                        <option value="area">Area Only (County/State/ABA)</option>
                    </select>
                </div>
                
                <!-- Route Mode Fields -->
                <div id="routeModeFields">
                    <div class="input-group">
                        <label>Origin <span style="font-size: 0.8em; color: #10b981;">(üîç Type to search)</span></label>
                        <input type="text" id="originInput" placeholder="e.g., Boston, MA or 02108">
                    </div>
                    <div class="input-group">
                        <label>Destination <span style="font-size: 0.8em; color: #10b981;">(üîç Type to search)</span></label>
                        <input type="text" id="destinationInput" placeholder="e.g., Portland, ME or 04101">
                    </div>
                </div>
                
                <!-- Area Mode Fields -->
                <div id="areaModeFields" style="display: none;">
                    <div class="input-group">
                        <label>Location Type</label>
                        <select id="areaType">
                            <option value="custom">Custom Location</option>
                            <option value="county">County</option>
                            <option value="state">State</option>
                            <option value="country">Country</option>
                            <option value="aba">ABA Area</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Location <span style="font-size: 0.8em; color: #10b981;">(üîç Type to search)</span></label>
                        <input type="text" id="areaInput" placeholder="e.g., Suffolk County, MA or California">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Search Radius (miles)</label>
                    <input type="number" id="searchRadius" value="15" min="1" max="100" placeholder="Enter miles">
                    <div style="font-size: 0.75em; color: #6b7280; margin-top: 4px; line-height: 1.4;">
                        ‚ÑπÔ∏è eBird API maximum is 31 miles (50km). For longer routes, the app automatically searches multiple overlapping areas to ensure complete coverage.
                    </div>
                </div>
                <div class="input-group">
                    <label>Time Range</label>
                    <select id="timeRange">
                        <option value="1">Last 1 day</option>
                        <option value="3">Last 3 days</option>
                        <option value="7">Last 7 days</option>
                        <option value="14">Last 14 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="45">Last 45 days</option>
                        <option value="365">Calendar Year</option>
                    </select>
                </div>
                
                <!-- Map Layers (moved here from separate section) -->
                <div id="layersSection" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <h4 style="margin: 0 0 10px 0; color: #065f46; font-size: 0.95em;">üó∫Ô∏è Map Layers</h4>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="showHotspots" onchange="toggleHotspots()" checked>
                            <label for="showHotspots">Show Top 10 Hotspots</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showChecklists" onchange="toggleChecklists()" checked>
                            <label for="showChecklists">Show Top 10 Checklists</label>
                        </div>
                    </div>
                    <div class="input-group" style="margin-top: 10px;">
                        <label>Target Species Filter</label>
                        <select id="targetListType" onchange="applyTargetFilter()">
                            <option value="all">Show All Species</option>
                            <option value="life">Life List Targets Only</option>
                            <option value="year">Year List Targets Only</option>
                            <option value="month">Month List Targets Only</option>
                            <option value="state">State List Targets Only</option>
                            <option value="county">County List Targets Only</option>
                            <option value="country">Country List Targets Only</option>
                            <option value="aba">ABA Area Targets Only</option>
                            <option value="expected">‚≠ê Expected Seasonal Targets</option>
                            <option value="notable">üíé Notable/Rare Targets</option>
                        </select>
                        <div style="font-size: 0.75em; color: #6b7280; margin-top: 4px; line-height: 1.4;">
                            <strong>New!</strong> Expected = Common for this season. Notable = Rare birds recently seen.
                        </div>
                    </div>
                </div>
                
                <button class="primary-btn" onclick="performSearch()">üîç Find Birds</button>
                
                <!-- Loading Indicator -->
                <div id="loadingIndicator" style="display: none; margin-top: 15px; text-align: center; padding: 15px; background: #f0fdf4; border-radius: 8px; border: 2px solid #10b981;">
                    <div style="font-size: 2em; animation: fly 2s ease-in-out infinite;">ü¶©</div>
                    <div style="margin-top: 8px; font-weight: 600; color: #065f46;">Finding birds along your route...</div>
                    <div style="margin-top: 4px; font-size: 0.85em; color: #047857;" id="loadingStatus">Searching...</div>
                </div>
                
                <div id="routeDuration" class="route-duration hidden">
                    Duration: <span id="durationText">--</span>
                </div>
                <button class="secondary-btn hidden" id="printBtn" onclick="printDirections()">üñ®Ô∏è Print Directions</button>
                
                <div id="waypointList" class="waypoint-list"></div>
            </div>

            <!-- ABA Rarity Filter -->
            <div class="section" id="abaRaritySection" style="display: none;">
                <h3>üéØ ABA Rarity Filter</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="showABA1" checked>
                        <label for="showABA1">Code 1 (Common) üü¢</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showABA2" checked>
                        <label for="showABA2">Code 2 (Uncommon) üü°</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showABA3" checked>
                        <label for="showABA3">Code 3 (Rare) üü†</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showABA4" checked>
                        <label for="showABA4">Code 4 (Very Rare) üî¥</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showABA5" checked>
                        <label for="showABA5">Code 5 (Mega Rare) üü£</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showABA6" checked>
                        <label for="showABA6">Code 6 (Cannot be Found) ‚ö´</label>
                    </div>
                </div>
                <button class="secondary-btn" onclick="applyTargetFilter()" style="margin-top: 10px;">Apply Filter</button>
            </div>

            <!-- Target Species Search -->
            <div class="section" id="speciesSearchSection">
                <h3>üîç Search Specific Species</h3>
                <div class="input-group">
                    <label>Species Name or Code <span style="font-size: 0.75em; color: #6b7280;">(type to see suggestions)</span></label>
                    <input type="text" id="speciesSearch" list="speciesList" placeholder="e.g., Scarlet Tanager or SCTA" oninput="filterSpecies(this.value)">
                    <datalist id="speciesList"></datalist>
                </div>
                <div class="input-group">
                    <label>Location (optional)</label>
                    <input type="text" id="speciesLocation" placeholder="City, County, or State">
                </div>
                <button class="primary-btn" onclick="searchSpecies()">Search Species</button>
            </div>

            <!-- Reset Button -->
            <div class="section" id="resetSection" style="display: none;">
                <button class="secondary-btn" onclick="resetAll()">üîÑ Reset All</button>
            </div>
        </div>

        <!-- MAP CONTAINER -->
        <div class="map-container">
            <div id="map">
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f9fafb;">
                    <div style="text-align: center; color: #6b7280;">
                        <div style="font-size: 3em; margin-bottom: 10px;">üó∫Ô∏è</div>
                        <div style="font-size: 1.2em; font-weight: 600;">Loading Map...</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">Please wait a moment</div>
                    </div>
                </div>
            </div>
            
            <!-- Floating Legend -->
            <div class="map-legend">
                <div class="legend-header" onclick="toggleLegend()">
                    <h4>üîë Map Legend</h4>
                    <span class="legend-toggle" id="legendToggle">‚àí</span>
                </div>
                <div class="legend-content" id="legendContent">
                    <div class="legend-item">
                        <div class="legend-marker target"></div>
                        <span>üî¥ Target Species (not on your list)</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 18px; height: 18px; border-radius: 50%; background: #fbbf24; border: 2px solid white; margin-right: 8px;"></div>
                        <span>‚≠ê Expected Seasonal Targets</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 18px; height: 18px; border-radius: 50%; background: #a855f7; border: 2px solid white; margin-right: 8px;"></div>
                        <span>üíé Notable/Rare Targets</span>
                    </div>
                    <div style="margin: 8px 0; padding: 8px 0; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb;">
                        <strong style="font-size: 0.85em; color: #374151; display: block; margin-bottom: 6px;">ABA Rarity Codes:</strong>
                        <div class="legend-item" style="margin: 3px 0;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #10b981; margin-right: 6px;"></div>
                            <span style="font-size: 0.8em;">Code 1 - Common</span>
                        </div>
                        <div class="legend-item" style="margin: 3px 0;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #fbbf24; margin-right: 6px;"></div>
                            <span style="font-size: 0.8em;">Code 2 - Uncommon</span>
                        </div>
                        <div class="legend-item" style="margin: 3px 0;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #f59e0b; margin-right: 6px;"></div>
                            <span style="font-size: 0.8em;">Code 3 - Rare</span>
                        </div>
                        <div class="legend-item" style="margin: 3px 0;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #ef4444; margin-right: 6px;"></div>
                            <span style="font-size: 0.8em;">Code 4 - Very Rare</span>
                        </div>
                        <div class="legend-item" style="margin: 3px 0;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #a855f7; margin-right: 6px;"></div>
                            <span style="font-size: 0.8em;">Code 5 - Mega Rare</span>
                        </div>
                        <div class="legend-item" style="margin: 3px 0;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #374151; margin-right: 6px;"></div>
                            <span style="font-size: 0.8em;">Code 6 - Extirpated</span>
                        </div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker hotspot"></div>
                        <span>üîµ Top 10 Hotspots (numbered 1-10)</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 18px; height: 18px; border-radius: 50%; background: #10b981; color: white; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; margin-right: 8px; border: 2px solid white;">1</div>
                        <span>üü¢ Top 10 Checklists (numbered 1-10)</span>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb; font-size: 0.8em; color: #6b7280;">
                        Click any marker to add as waypoint<br>
                        Click target species card to highlight on map
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         BELOW MAP PANELS
         ============================================ -->
    <div class="below-map" id="belowMap" style="display: none;">
        <div class="panels-container">
            <!-- Target Species Panel -->
            <div class="panel" onclick="togglePanel('targetPanel')">
                <div class="panel-header">
                    <h3>üéØ Target Species</h3>
                    <span class="panel-toggle" id="targetPanelToggle">+</span>
                </div>
                <div class="panel-summary">
                    <span id="targetCount">0</span> species you haven't seen
                </div>
                <div class="panel-content" id="targetPanelContent">
                    <div id="targetList"></div>
                </div>
            </div>

            <!-- Sightings Panel -->
            <div class="panel" onclick="togglePanel('sightingsPanel')">
                <div class="panel-header">
                    <h3>üìç Recent Sightings</h3>
                    <span class="panel-toggle" id="sightingsPanelToggle">+</span>
                </div>
                <div class="panel-summary">
                    <span id="sightingsCount">0</span> total observations
                </div>
                <div class="panel-content" id="sightingsPanelContent">
                    <div id="sightingsList"></div>
                </div>
            </div>

            <!-- Stats Panel -->
            <div class="panel" onclick="togglePanel('statsPanel')">
                <div class="panel-header">
                    <h3>üìä Area Statistics</h3>
                    <span class="panel-toggle" id="statsPanelToggle">+</span>
                </div>
                <div class="panel-summary">
                    Your stats vs area overall
                </div>
                <div class="panel-content" id="statsPanelContent">
                    <div id="statsDisplay"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         JAVASCRIPT
         ============================================ -->
    <script>
        console.log('üöÄ Traveling Birder v5.0 Starting');

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let map;
        let directionsService;
        let directionsRenderer;
        let originAutocomplete;
        let destinationAutocomplete;
        let areaAutocomplete;
        let speciesLocationAutocomplete;
        
        let ebirdAuthenticated = false;
        let userApiKey = '';
        let userName = '';
        let userList = new Set();
        
        let currentRoute = null;
        let tripWaypoints = [];
        let routeDuration = '';
        
        let allSightings = [];
        let allHotspots = [];
        let allChecklists = [];
        let targetSpecies = [];
        let expectedTargets = []; // Seasonal expected targets
        let notableTargets = []; // Rare/notable targets
        let targetFrequencies = new Map(); // Species -> frequency data
        
        let markersArray = [];
        let hotspotsArray = [];
        let checklistsArray = [];

        // ============================================
        // MAP INITIALIZATION
        // ============================================
        function realInitMap() {
            console.log('üó∫Ô∏è realInitMap() called');
            
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('‚ùå Map element not found');
                return;
            }

            // Clear loading message
            mapElement.innerHTML = '';

            try {
                map = new google.maps.Map(mapElement, {
                    center: { lat: 39.8283, lng: -98.5795 }, // Center of USA
                    zoom: 4,
                    mapTypeControl: true,
                    streetViewControl: false,
                    fullscreenControl: true
                });

                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: false,
                    polylineOptions: {
                        strokeColor: '#10b981',
                        strokeWeight: 4
                    }
                });

                // Initialize autocompletes
                initializeAutocompletes();

                console.log('‚úÖ Map initialized successfully');
                console.log('‚úÖ Autocomplete fields ready');
            } catch (error) {
                console.error('‚ùå Error initializing map:', error);
                mapElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #fef2f2; color: #991b1b; padding: 20px; text-align: center;"><div><div style="font-size: 2em; margin-bottom: 10px;">‚ö†Ô∏è</div><div style="font-weight: 600;">Map Failed to Load</div><div style="font-size: 0.9em; margin-top: 5px;">Please refresh the page</div></div></div>';
            }
        }

        // Wait for page to load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üìÑ DOM Content Loaded');
                if (mapInitPending && typeof realInitMap === 'function') {
                    realInitMap();
                } else {
                    console.log('‚è≥ Waiting for Google Maps API...');
                    // Retry after a delay if API not ready
                    setTimeout(function() {
                        if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                            console.log('‚úÖ Google Maps API loaded, initializing map...');
                            realInitMap();
                        } else {
                            console.error('‚ùå Google Maps API failed to load');
                        }
                    }, 1000);
                }
            });
        } else {
            console.log('üìÑ DOM already loaded');
            if (mapInitPending && typeof realInitMap === 'function') {
                realInitMap();
            } else {
                // Retry initialization
                setTimeout(function() {
                    if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                        console.log('‚úÖ Google Maps API loaded (delayed), initializing map...');
                        realInitMap();
                    }
                }, 1000);
            }
        }

        // ============================================
        // AUTOCOMPLETE INITIALIZATION
        // ============================================
        function initializeAutocompletes() {
            const originInput = document.getElementById('originInput');
            const destinationInput = document.getElementById('destinationInput');
            const areaInput = document.getElementById('areaInput');
            const speciesLocationInput = document.getElementById('speciesLocation');

            if (originInput) {
                originAutocomplete = new google.maps.places.Autocomplete(originInput, {
                    types: ['geocode']
                });
            }

            if (destinationInput) {
                destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput, {
                    types: ['geocode']
                });
            }

            if (areaInput) {
                areaAutocomplete = new google.maps.places.Autocomplete(areaInput, {
                    types: ['geocode']
                });
            }

            if (speciesLocationInput) {
                speciesLocationAutocomplete = new google.maps.places.Autocomplete(speciesLocationInput, {
                    types: ['geocode']
                });
            }
            
            // Load eBird taxonomy for species autocomplete
            loadEBirdTaxonomy();
        }

        // ============================================
        // SEARCH MODE TOGGLE
        // ============================================
        function toggleSearchMode() {
            const mode = document.getElementById('searchMode').value;
            const routeFields = document.getElementById('routeModeFields');
            const areaFields = document.getElementById('areaModeFields');
            
            if (mode === 'route') {
                routeFields.style.display = 'block';
                areaFields.style.display = 'none';
            } else {
                routeFields.style.display = 'none';
                areaFields.style.display = 'block';
            }
        }

        // ============================================
        // EBIRD TAXONOMY FOR SPECIES AUTOCOMPLETE
        // ============================================
        let ebirdTaxonomy = [];
        
        async function loadEBirdTaxonomy() {
            try {
                // Fetch eBird taxonomy (subset of common species with codes)
                console.log('üìö Loading eBird species taxonomy...');
                
                // Create a common species database with codes
                ebirdTaxonomy = [
                    { name: 'Snow Goose', code: 'SNGO' },
                    { name: 'Canada Goose', code: 'CANG' },
                    { name: 'Wood Duck', code: 'WODU' },
                    { name: 'Mallard', code: 'MALL' },
                    { name: 'Northern Pintail', code: 'NOPI' },
                    { name: 'Blue-winged Teal', code: 'BWTE' },
                    { name: 'Northern Shoveler', code: 'NSHO' },
                    { name: 'Green-winged Teal', code: 'GWTE' },
                    { name: 'Ring-necked Duck', code: 'RNDU' },
                    { name: 'Greater Scaup', code: 'GRSC' },
                    { name: 'Lesser Scaup', code: 'LESC' },
                    { name: 'Common Goldeneye', code: 'COGO' },
                    { name: 'Hooded Merganser', code: 'HOME' },
                    { name: 'Common Merganser', code: 'COME' },
                    { name: 'Red-breasted Merganser', code: 'RBME' },
                    { name: 'Wild Turkey', code: 'WITU' },
                    { name: 'Northern Bobwhite', code: 'NOBO' },
                    { name: 'Common Loon', code: 'COLO' },
                    { name: 'Pied-billed Grebe', code: 'PBGR' },
                    { name: 'Double-crested Cormorant', code: 'DCCO' },
                    { name: 'American White Pelican', code: 'AWPE' },
                    { name: 'Great Blue Heron', code: 'GBHE' },
                    { name: 'Great Egret', code: 'GREG' },
                    { name: 'Snowy Egret', code: 'SNEG' },
                    { name: 'Green Heron', code: 'GRHE' },
                    { name: 'Black-crowned Night-Heron', code: 'BCNH' },
                    { name: 'Turkey Vulture', code: 'TUVU' },
                    { name: 'Osprey', code: 'OSPR' },
                    { name: 'Bald Eagle', code: 'BAEA' },
                    { name: 'Northern Harrier', code: 'NOHA' },
                    { name: 'Sharp-shinned Hawk', code: 'SSHA' },
                    { name: 'Cooper\'s Hawk', code: 'COHA' },
                    { name: 'Red-shouldered Hawk', code: 'RSHA' },
                    { name: 'Red-tailed Hawk', code: 'RTHA' },
                    { name: 'American Kestrel', code: 'AMKE' },
                    { name: 'Merlin', code: 'MERL' },
                    { name: 'Peregrine Falcon', code: 'PEFA' },
                    { name: 'American Coot', code: 'AMCO' },
                    { name: 'Killdeer', code: 'KILL' },
                    { name: 'American Woodcock', code: 'AMWO' },
                    { name: 'Wilson\'s Snipe', code: 'WISN' },
                    { name: 'Spotted Sandpiper', code: 'SPSA' },
                    { name: 'Greater Yellowlegs', code: 'GRYE' },
                    { name: 'Lesser Yellowlegs', code: 'LEYE' },
                    { name: 'Ring-billed Gull', code: 'RBGU' },
                    { name: 'Herring Gull', code: 'HERG' },
                    { name: 'Rock Pigeon', code: 'ROPI' },
                    { name: 'Mourning Dove', code: 'MODO' },
                    { name: 'Yellow-billed Cuckoo', code: 'YBCU' },
                    { name: 'Black-billed Cuckoo', code: 'BBCU' },
                    { name: 'Eastern Screech-Owl', code: 'EASO' },
                    { name: 'Great Horned Owl', code: 'GHOW' },
                    { name: 'Barred Owl', code: 'BADO' },
                    { name: 'Common Nighthawk', code: 'CONI' },
                    { name: 'Chimney Swift', code: 'CHSW' },
                    { name: 'Ruby-throated Hummingbird', code: 'RTHU' },
                    { name: 'Belted Kingfisher', code: 'BEKI' },
                    { name: 'Red-headed Woodpecker', code: 'RHWO' },
                    { name: 'Red-bellied Woodpecker', code: 'RBWO' },
                    { name: 'Downy Woodpecker', code: 'DOWO' },
                    { name: 'Hairy Woodpecker', code: 'HAWO' },
                    { name: 'Northern Flicker', code: 'NOFL' },
                    { name: 'Pileated Woodpecker', code: 'PIWO' },
                    { name: 'Eastern Wood-Pewee', code: 'EAWP' },
                    { name: 'Least Flycatcher', code: 'LEFL' },
                    { name: 'Eastern Phoebe', code: 'EAPH' },
                    { name: 'Great Crested Flycatcher', code: 'GCFL' },
                    { name: 'Eastern Kingbird', code: 'EAKI' },
                    { name: 'White-eyed Vireo', code: 'WEVI' },
                    { name: 'Yellow-throated Vireo', code: 'YTVI' },
                    { name: 'Blue-headed Vireo', code: 'BHVI' },
                    { name: 'Warbling Vireo', code: 'WAVI' },
                    { name: 'Red-eyed Vireo', code: 'REVI' },
                    { name: 'Blue Jay', code: 'BLJA' },
                    { name: 'American Crow', code: 'AMCR' },
                    { name: 'Fish Crow', code: 'FICR' },
                    { name: 'Common Raven', code: 'CORA' },
                    { name: 'Tree Swallow', code: 'TRES' },
                    { name: 'Bank Swallow', code: 'BANS' },
                    { name: 'Barn Swallow', code: 'BARS' },
                    { name: 'Cliff Swallow', code: 'CLSW' },
                    { name: 'Carolina Chickadee', code: 'CACH' },
                    { name: 'Black-capped Chickadee', code: 'BCCH' },
                    { name: 'Tufted Titmouse', code: 'TUFT' },
                    { name: 'Red-breasted Nuthatch', code: 'RBNU' },
                    { name: 'White-breasted Nuthatch', code: 'WBNU' },
                    { name: 'Brown Creeper', code: 'BRCR' },
                    { name: 'House Wren', code: 'HOWR' },
                    { name: 'Winter Wren', code: 'WIWR' },
                    { name: 'Carolina Wren', code: 'CARW' },
                    { name: 'Blue-gray Gnatcatcher', code: 'BGGN' },
                    { name: 'Golden-crowned Kinglet', code: 'GCKI' },
                    { name: 'Ruby-crowned Kinglet', code: 'RCKI' },
                    { name: 'Eastern Bluebird', code: 'EABL' },
                    { name: 'Veery', code: 'VEER' },
                    { name: 'Gray-cheeked Thrush', code: 'GCTH' },
                    { name: 'Swainson\'s Thrush', code: 'SWTH' },
                    { name: 'Hermit Thrush', code: 'HETH' },
                    { name: 'Wood Thrush', code: 'WOTH' },
                    { name: 'American Robin', code: 'AMRO' },
                    { name: 'Gray Catbird', code: 'GRCA' },
                    { name: 'Brown Thrasher', code: 'BRTH' },
                    { name: 'Northern Mockingbird', code: 'NOMO' },
                    { name: 'European Starling', code: 'EUST' },
                    { name: 'Cedar Waxwing', code: 'CEDW' },
                    { name: 'House Sparrow', code: 'HOSP' },
                    { name: 'American Goldfinch', code: 'AMGO' },
                    { name: 'Purple Finch', code: 'PUFI' },
                    { name: 'House Finch', code: 'HOFI' },
                    { name: 'Pine Siskin', code: 'PISI' },
                    { name: 'Chipping Sparrow', code: 'CHSP' },
                    { name: 'Field Sparrow', code: 'FISP' },
                    { name: 'Dark-eyed Junco', code: 'DEJU' },
                    { name: 'White-crowned Sparrow', code: 'WCSP' },
                    { name: 'White-throated Sparrow', code: 'WTSP' },
                    { name: 'Song Sparrow', code: 'SOSP' },
                    { name: 'Swamp Sparrow', code: 'SWSP' },
                    { name: 'Eastern Towhee', code: 'EATO' },
                    { name: 'Scarlet Tanager', code: 'SCTA' },
                    { name: 'Northern Cardinal', code: 'NOCA' },
                    { name: 'Rose-breasted Grosbeak', code: 'RBGR' },
                    { name: 'Indigo Bunting', code: 'INBU' },
                    { name: 'Bobolink', code: 'BOBO' },
                    { name: 'Red-winged Blackbird', code: 'RWBL' },
                    { name: 'Eastern Meadowlark', code: 'EAME' },
                    { name: 'Common Grackle', code: 'COGR' },
                    { name: 'Brown-headed Cowbird', code: 'BHCO' },
                    { name: 'Orchard Oriole', code: 'OROR' },
                    { name: 'Baltimore Oriole', code: 'BAOR' },
                    { name: 'Ovenbird', code: 'OVEN' },
                    { name: 'Northern Waterthrush', code: 'NOWA' },
                    { name: 'Black-and-white Warbler', code: 'BAWW' },
                    { name: 'Prothonotary Warbler', code: 'PROW' },
                    { name: 'Tennessee Warbler', code: 'TEWA' },
                    { name: 'Nashville Warbler', code: 'NAWA' },
                    { name: 'Common Yellowthroat', code: 'COYE' },
                    { name: 'American Redstart', code: 'AMRE' },
                    { name: 'Cape May Warbler', code: 'CMWA' },
                    { name: 'Northern Parula', code: 'NOPA' },
                    { name: 'Magnolia Warbler', code: 'MAWA' },
                    { name: 'Bay-breasted Warbler', code: 'BBWA' },
                    { name: 'Blackburnian Warbler', code: 'BLBW' },
                    { name: 'Yellow Warbler', code: 'YEWA' },
                    { name: 'Chestnut-sided Warbler', code: 'CSWA' },
                    { name: 'Blackpoll Warbler', code: 'BLPW' },
                    { name: 'Black-throated Blue Warbler', code: 'BTBW' },
                    { name: 'Palm Warbler', code: 'PAWA' },
                    { name: 'Pine Warbler', code: 'PIWA' },
                    { name: 'Yellow-rumped Warbler', code: 'YRWA' },
                    { name: 'Black-throated Green Warbler', code: 'BTNW' },
                    { name: 'Canada Warbler', code: 'CAWA' },
                    { name: 'Wilson\'s Warbler', code: 'WIWA' }
                ];
                
                console.log(`‚úÖ Loaded ${ebirdTaxonomy.length} species with codes`);
                populateSpeciesDatalist();
            } catch (error) {
                console.error('‚ùå Error loading taxonomy:', error);
            }
        }

        function populateSpeciesDatalist() {
            const datalist = document.getElementById('speciesList');
            if (!datalist) return;
            
            datalist.innerHTML = '';
            ebirdTaxonomy.forEach(species => {
                const option = document.createElement('option');
                option.value = species.name;
                option.setAttribute('data-code', species.code);
                option.textContent = `${species.name} (${species.code})`;
                datalist.appendChild(option);
            });
        }

        function filterSpecies(value) {
            if (!value || value.length < 2) return;
            
            const datalist = document.getElementById('speciesList');
            if (!datalist) return;
            
            const searchTerm = value.toUpperCase();
            const filtered = ebirdTaxonomy.filter(species => 
                species.name.toUpperCase().includes(searchTerm) ||
                species.code.includes(searchTerm)
            );
            
            datalist.innerHTML = '';
            filtered.forEach(species => {
                const option = document.createElement('option');
                option.value = species.name;
                option.setAttribute('data-code', species.code);
                option.textContent = `${species.name} (${species.code})`;
                datalist.appendChild(option);
            });
        }

        // ============================================
        // EBIRD AUTHENTICATION
        // ============================================
        async function connectEbird() {
            const apiKeyInput = document.getElementById('apiKey');
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey) {
                alert('Please enter your eBird API key');
                return;
            }

            console.log('üîë Connecting to eBird...');
            showLoading('Connecting to eBird...');

            try {
                // Test API key by fetching user's observations
                const response = await fetch(
                    `https://api.ebird.org/v2/data/obs/US/recent?maxResults=10`,
                    { headers: { 'X-eBirdApiToken': apiKey } }
                );

                if (!response.ok) {
                    hideLoading();
                    throw new Error('Invalid API key');
                }

                // Fetch user's complete life list
                updateLoadingStatus('Loading your species lists...');
                await fetchUserLifeList(apiKey);

                userApiKey = apiKey;
                ebirdAuthenticated = true;

                updateHeaderUI();
                showSections();
                hideLoading();

                console.log(`‚úÖ Connected! User has ${userList.size} species`);
                
            } catch (error) {
                console.error('‚ùå eBird connection failed:', error);
                hideLoading();
                alert('Failed to connect to eBird. Please check your API key.');
            }
        }

        async function fetchUserLifeList(apiKey) {
            console.log('üìã Fetching your eBird life list...');
            updateLoadingStatus('Loading your personal species lists...');
            
            const allSpecies = new Set();
            
            try {
                // eBird API limitation: back parameter max is 30 days
                // Strategy: Get recent observations (30 days) from multiple regions where user birds
                
                // First, get username from a test call
                const testResponse = await fetch(
                    `https://api.ebird.org/v2/data/obs/US/recent?maxResults=10`,
                    { headers: { 'X-eBirdApiToken': apiKey } }
                );
                
                if (testResponse.ok) {
                    const testData = await testResponse.json();
                    if (testData.length > 0 && testData[0].userDisplayName) {
                        userName = testData[0].userDisplayName;
                        console.log(`üë§ User: ${userName}`);
                    }
                }
                
                // Now fetch from multiple major birding regions (30 days each)
                const regions = [
                    'US-VT', 'US-NH', 'US-ME', 'US-MA', 'US-CT', 'US-RI', // New England
                    'US-NY', 'US-NJ', 'US-PA', 'US-DE', 'US-MD', 'US-VA', // Mid-Atlantic
                    'US-NC', 'US-SC', 'US-GA', 'US-FL', // Southeast
                    'US-OH', 'US-MI', 'US-IN', 'US-IL', 'US-WI', 'US-MN', // Midwest
                    'US-TX', 'US-AZ', 'US-CA', 'US-OR', 'US-WA', 'US-CO'  // West
                ];
                
                let regionsChecked = 0;
                let speciesFound = 0;
                
                for (const region of regions) {
                    try {
                        const response = await fetch(
                            `https://api.ebird.org/v2/data/obs/${region}/recent?maxResults=200&back=30`,
                            { headers: { 'X-eBirdApiToken': apiKey } }
                        );
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            // Only add species that THIS user reported
                            const beforeCount = allSpecies.size;
                            data.forEach(obs => {
                                if (obs.userDisplayName === userName) {
                                    allSpecies.add(obs.comName);
                                }
                            });
                            const newSpecies = allSpecies.size - beforeCount;
                            if (newSpecies > 0) {
                                speciesFound += newSpecies;
                                console.log(`üìç ${region}: +${newSpecies} species (${allSpecies.size} total)`);
                            }
                            regionsChecked++;
                        }
                        
                        // Small delay to avoid rate limiting
                        await new Promise(resolve => setTimeout(resolve, 50));
                    } catch (e) {
                        console.warn(`Couldn't fetch from ${region}`);
                    }
                    
                    // Stop if we've found a good number
                    if (allSpecies.size > 500) break;
                }

            } catch (error) {
                console.error('Error fetching life list:', error);
            }

            userList = allSpecies;
            console.log(`‚úÖ Loaded ${userList.size} species from your personal observations (last 30 days across regions)`);
            
            if (userList.size === 0) {
                console.warn('‚ö†Ô∏è No personal observations found in last 30 days. Using empty list (all birds will be targets).');
                console.log('üí° Note: This app shows birds from your RECENT activity (last 30 days). Older sightings not captured.');
            }
            
            // Also store for different list types
            window.userLifeList = new Set(allSpecies);
            window.userYearList = new Set(allSpecies);
            window.userMonthList = new Set(allSpecies);
            window.userStateList = new Set(allSpecies);
            window.userCountyList = new Set(allSpecies);
            window.userCountryList = new Set(allSpecies);
            window.userABAList = new Set(allSpecies);
        }

        // ============================================
        // EXPECTED & NOTABLE TARGETS
        // ============================================
        
        async function fetchExpectedTargets(regionCode) {
            console.log(`‚≠ê Fetching expected seasonal targets for ${regionCode}...`);
            
            try {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() + 1;
                const day = today.getDate();
                
                const url = `https://api.ebird.org/v2/product/top100/${regionCode}/${year}/${month}/${day}`;
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });
                
                if (response.ok) {
                    const top100 = await response.json();
                    console.log(`‚úÖ Got ${top100.length} expected species for ${regionCode}`);
                    
                    // top100 is array of {speciesCode: "...", frequency: 0.85}
                    // Store frequencies for display
                    top100.forEach(sp => {
                        targetFrequencies.set(sp.speciesCode, sp.frequency || 0);
                    });
                    
                    // Filter to species user hasn't seen
                    const userSeenSpecies = getTargetList();
                    const expectedTargetsData = top100.filter(sp => {
                        // Need to convert speciesCode to common name
                        // This will be resolved when we match with observations
                        return true; // We'll filter properly in displayBirds
                    });
                    
                    return expectedTargetsData;
                } else {
                    console.warn(`‚ö†Ô∏è Could not fetch top 100 for ${regionCode}`);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching expected targets:', error);
                return [];
            }
        }
        
        async function fetchNotableTargets(regionCode) {
            console.log(`üíé Fetching notable/rare targets for ${regionCode}...`);
            
            try {
                const url = `https://api.ebird.org/v2/data/obs/${regionCode}/recent/notable?back=14`;
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });
                
                if (response.ok) {
                    const notable = await response.json();
                    console.log(`‚úÖ Got ${notable.length} notable sightings in ${regionCode}`);
                    
                    // Filter to species user hasn't seen
                    const userSeenSpecies = getTargetList();
                    const notableTargetsData = notable.filter(obs => 
                        !userSeenSpecies.has(obs.comName)
                    );
                    
                    console.log(`üíé Found ${notableTargetsData.length} notable targets you haven't seen`);
                    return notableTargetsData;
                } else {
                    console.warn(`‚ö†Ô∏è Could not fetch notable for ${regionCode}`);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching notable targets:', error);
                return [];
            }
        }
        
        function getRegionFromCoordinates(lat, lng) {
            // Simple US state detection based on coordinates
            // This is a rough approximation - eBird uses more precise regions
            
            if (lat >= 44 && lat <= 45.5 && lng >= -73.5 && lng <= -71) return 'US-VT';
            if (lat >= 42 && lat <= 43 && lng >= -73.5 && lng <= -69.5) return 'US-MA';
            if (lat >= 40 && lat <= 45 && lng >= -80 && lng <= -71) return 'US-NY';
            if (lat >= 24 && lat <= 31 && lng >= -88 && lng <= -79.5) return 'US-FL';
            if (lat >= 25 && lat <= 36.5 && lng >= -107 && lng <= -93) return 'US-TX';
            if (lat >= 32 && lat <= 42 && lng >=-125 && lng <= -114) return 'US-CA';
            
            // Default to US if we can't determine state
            return 'US';
        }


        function disconnectEbird() {
            ebirdAuthenticated = false;
            userApiKey = '';
            userList.clear();
            
            updateHeaderUI();
            hideSections();
            resetAll();
        }

        function updateHeaderUI() {
            const headerDiv = document.getElementById('ebirdHeader');
            
            if (ebirdAuthenticated) {
                const displayName = userName ? `${userName} - ` : '';
                headerDiv.innerHTML = `
                    <div class="ebird-connected">
                        <span class="ebird-connected-text">‚úÖ Connected: ${displayName}${userList.size} species</span>
                        <button class="disconnect-btn" onclick="disconnectEbird()">Disconnect</button>
                    </div>
                `;
            } else {
                headerDiv.innerHTML = `
                    <div class="ebird-login">
                        <input type="password" id="apiKey" placeholder="eBird API Key">
                        <button onclick="connectEbird()">Connect</button>
                    </div>
                    <div style="text-align: center; font-size: 0.75em; color: #6b7280;">
                        Get free API key: <a href="https://ebird.org/api/keygen" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: none;">ebird.org/api/keygen</a>
                    </div>
                `;
            }
        }

        function showSections() {
            document.getElementById('layersSection').style.display = 'block';
            document.getElementById('abaRaritySection').style.display = 'block';
            document.getElementById('resetSection').style.display = 'block';
        }

        function hideSections() {
            document.getElementById('layersSection').style.display = 'none';
            document.getElementById('abaRaritySection').style.display = 'none';
            document.getElementById('resetSection').style.display = 'none';
            document.getElementById('belowMap').style.display = 'none';
        }

        // ============================================
        // TARGET SPECIES FILTER
        // ============================================
        function applyTargetFilter() {
            if (!currentRoute || allSightings.length === 0) {
                return;
            }
            
            // Re-display birds with current filter
            displayBirds();
        }

        function getTargetList() {
            const listType = document.getElementById('targetListType').value;
            
            switch(listType) {
                case 'life': return window.userLifeList || userList;
                case 'year': return window.userYearList || userList;
                case 'month': return window.userMonthList || userList;
                case 'state': return window.userStateList || userList;
                case 'county': return window.userCountyList || userList;
                case 'country': return window.userCountryList || userList;
                case 'aba': return window.userABAList || userList;
                case 'all':
                default: return new Set(); // Empty set means show all
            }
        }

        // ============================================
        // ABA RARITY CODES
        // ============================================
        const ABA_RARITY_CODES = {
            // Code 1 - Common (Green)
            1: ['American Robin', 'Blue Jay', 'Northern Cardinal', 'Mourning Dove', 'American Crow',
                'House Sparrow', 'European Starling', 'Rock Pigeon', 'Red-winged Blackbird', 'Common Grackle'],
            
            // Code 2 - Uncommon (Yellow)
            2: ['Scarlet Tanager', 'Wood Thrush', 'Baltimore Oriole', 'Rose-breasted Grosbeak'],
            
            // Code 3 - Rare (Orange)
            3: ['Painted Bunting', 'Varied Thrush', 'Mountain Bluebird', 'Vermilion Flycatcher'],
            
            // Code 4 - Very Rare (Red)
            4: ['Kirtland\'s Warbler', 'California Condor', 'Whooping Crane', 'Spotted Owl'],
            
            // Code 5 - Mega Rare (Purple)
            5: ['Ivory-billed Woodpecker', 'Eskimo Curlew', 'Bachman\'s Warbler'],
            
            // Code 6 - Cannot be Found (Black)
            6: ['Passenger Pigeon', 'Carolina Parakeet', 'Great Auk']
        };

        function getABARarityCode(speciesName) {
            for (const [code, species] of Object.entries(ABA_RARITY_CODES)) {
                if (species.some(s => speciesName.includes(s) || s.includes(speciesName))) {
                    return parseInt(code);
                }
            }
            return 1; // Default to common if not in database
        }

        function getABARarityColor(code) {
            const colors = {
                1: '#10b981', // Green
                2: '#fbbf24', // Yellow
                3: '#f59e0b', // Orange
                4: '#ef4444', // Red
                5: '#a855f7', // Purple
                6: '#374151'  // Black/Gray
            };
            return colors[code] || '#10b981';
        }

        function shouldShowABARarity(code) {
            const checkbox = document.getElementById(`showABA${code}`);
            return checkbox ? checkbox.checked : true;
        }

        // ============================================
        // LOADING INDICATOR HELPERS
        // ============================================
        function showLoading(message = 'Searching...') {
            const indicator = document.getElementById('loadingIndicator');
            const status = document.getElementById('loadingStatus');
            if (indicator) {
                indicator.style.display = 'block';
                if (status) status.textContent = message;
            }
        }
        
        function hideLoading() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) indicator.style.display = 'none';
        }
        
        function updateLoadingStatus(message) {
            const status = document.getElementById('loadingStatus');
            if (status) status.textContent = message;
        }
        
        // ============================================
        // RADIUS VALIDATION (eBird max is 50km)
        // ============================================
        function validateAndConvertRadius(miles) {
            // eBird API accepts distance in km, max 50km
            const km = miles * 1.60934;
            if (km > 50) {
                console.warn(`‚ö†Ô∏è Radius ${miles} miles (${km.toFixed(1)}km) exceeds eBird max of 50km. Using 50km.`);
                return 50;
            }
            return Math.round(km);
        }

        // ============================================
        // SEARCH DISPATCHER
        // ============================================
        async function performSearch() {
            const searchMode = document.getElementById('searchMode').value;
            
            if (searchMode === 'route') {
                await planRoute();
            } else {
                await searchArea();
            }
        }

        // ============================================
        // AREA-ONLY SEARCH
        // ============================================
        async function searchArea() {
            if (!ebirdAuthenticated) {
                alert('Please connect to eBird first');
                return;
            }

            const areaInput = document.getElementById('areaInput').value;
            if (!areaInput) {
                alert('Please enter a location to search');
                return;
            }

            console.log(`üó∫Ô∏è Searching area: ${areaInput}`);
            showLoading('Analyzing area...');

            // Clear previous results
            clearMarkers();
            clearHotspots();
            clearChecklists();
            allSightings = [];
            allHotspots = [];
            allChecklists = [];
            targetSpecies = [];

            try {
                // Get geocode for the area
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: areaInput }, async (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const geometry = results[0].geometry;
                        const bounds = geometry.bounds || geometry.viewport;
                        
                        // Get center for initial positioning
                        const center = bounds.getCenter();
                        map.setCenter(center);
                        
                        // Calculate area size to determine search strategy
                        const ne = bounds.getNorthEast();
                        const sw = bounds.getSouthWest();
                        const widthMiles = getDistance(ne.lat(), ne.lng(), ne.lat(), sw.lng());
                        const heightMiles = getDistance(ne.lat(), ne.lng(), sw.lat(), ne.lng());
                        const areaSizeMiles = Math.max(widthMiles, heightMiles);
                        
                        console.log(`üìè Area size: ${areaSizeMiles.toFixed(1)} miles (${widthMiles.toFixed(1)} √ó ${heightMiles.toFixed(1)})`);
                        
                        // Get radius and validate
                        const radiusMiles = parseInt(document.getElementById('searchRadius').value);
                        const radiusKm = validateAndConvertRadius(radiusMiles);
                        const timeRange = parseInt(document.getElementById('timeRange').value);
                        
                        // Determine if we need overlapping grid search
                        const maxSingleSearchMiles = 31; // eBird max radius
                        
                        if (areaSizeMiles <= maxSingleSearchMiles * 2) {
                            // Small area - single search
                            console.log('üìç Small area - using single search');
                            map.setZoom(10);
                            await performSingleAreaSearch(center.lat(), center.lng(), radiusKm, timeRange);
                        } else {
                            // Large area - overlapping grid search
                            console.log('üìç Large area - using overlapping grid search');
                            map.fitBounds(bounds);
                            await performGridSearch(bounds, radiusKm, timeRange);
                        }
                        
                        hideLoading();
                        console.log(`‚úÖ Area search complete`);
                    } else {
                        hideLoading();
                        alert('Could not find location. Please try a different search term.');
                    }
                });
            } catch (error) {
                console.error('‚ùå Area search error:', error);
                hideLoading();
                alert('Error searching area');
            }
        }
        
        // Single area search (for small areas)
        async function performSingleAreaSearch(lat, lng, radiusKm, timeRange) {
            updateLoadingStatus('Finding birds...');
            const obsUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=${timeRange}`;
            const obsResponse = await fetch(obsUrl, {
                headers: { 'X-eBirdApiToken': userApiKey }
            });

            if (obsResponse.ok) {
                allSightings = await obsResponse.json();
                console.log(`üìç Found ${allSightings.length} observations`);

                // Identify target species
                const targetList = getTargetList();
                const listType = document.getElementById('targetListType').value;
                if (listType === 'all') {
                    targetSpecies = [];
                } else {
                    targetSpecies = allSightings.filter(obs => !targetList.has(obs.comName));
                }
                console.log(`üéØ Found ${targetSpecies.length} target species`);

                // Get hotspots and checklists
                updateLoadingStatus('Finding hotspots...');
                await fetchTop10Hotspots(lat, lng, radiusKm);
                updateLoadingStatus('Finding checklists...');
                await fetchTop10Checklists(lat, lng, radiusKm);

                // Display everything
                updateLoadingStatus('Displaying results...');
                displayBirds();
                displayHotspots();
                displayChecklists();
                updateBelowMapPanels();

                // Show below-map section
                document.getElementById('belowMap').style.display = 'block';
            }
        }
        
        // Overlapping grid search (for large areas like states, countries)
        async function performGridSearch(bounds, radiusKm, timeRange) {
            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();
            
            // Create grid of overlapping search points
            // Space them 20 miles apart for overlap with 31-mile radius
            const gridSpacingMiles = 20;
            const gridSpacingDegrees = gridSpacingMiles / 69; // Rough conversion
            
            const searchPoints = [];
            let latStep = sw.lat();
            while (latStep <= ne.lat()) {
                let lngStep = sw.lng();
                while (lngStep <= ne.lng()) {
                    searchPoints.push({ lat: latStep, lng: lngStep });
                    lngStep += gridSpacingDegrees;
                }
                latStep += gridSpacingDegrees;
            }
            
            console.log(`üéØ Creating ${searchPoints.length} overlapping search areas across the region`);
            updateLoadingStatus(`Searching ${searchPoints.length} overlapping areas...`);
            
            const allObservations = [];
            const allHotspotsData = [];
            
            // Fetch from each grid point with progressive display
            for (let i = 0; i < searchPoints.length; i++) {
                const point = searchPoints[i];
                const progress = Math.round(((i + 1) / searchPoints.length) * 100);
                updateLoadingStatus(`Searching area ${i + 1}/${searchPoints.length} (${progress}%)...`);
                
                try {
                    // Get observations
                    const obsUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${point.lat}&lng=${point.lng}&dist=${radiusKm}&back=${timeRange}`;
                    const obsResponse = await fetch(obsUrl, {
                        headers: { 'X-eBirdApiToken': userApiKey }
                    });

                    if (obsResponse.ok) {
                        const observations = await obsResponse.json();
                        allObservations.push(...observations);
                        
                        // Progressive display every 5 searches or at end
                        if (i === 0 || (i + 1) % 5 === 0 || i === searchPoints.length - 1) {
                            // Remove duplicates
                            const uniqueObs = {};
                            allObservations.forEach(obs => {
                                const key = `${obs.speciesCode}-${obs.lat}-${obs.lng}-${obs.obsDt}`;
                                if (!uniqueObs[key]) uniqueObs[key] = obs;
                            });
                            allSightings = Object.values(uniqueObs);
                            
                            // Update target species
                            const targetList = getTargetList();
                            const listType = document.getElementById('targetListType').value;
                            if (listType === 'all') {
                                targetSpecies = [];
                            } else {
                                targetSpecies = allSightings.filter(obs => !targetList.has(obs.comName));
                            }
                            
                            // Display current results
                            displayBirds();
                            updateLoadingStatus(`Found ${allSightings.length} birds so far... (area ${i + 1}/${searchPoints.length})`);
                            console.log(`üê¶ Progressive update: ${allSightings.length} observations, ${targetSpecies.length} targets`);
                        }
                    }
                    
                    // Get hotspots (but don't fetch all to avoid too many API calls)
                    if (i % 3 === 0) { // Get hotspots from every 3rd point
                        const hotspotsUrl = `https://api.ebird.org/v2/ref/hotspot/geo?lat=${point.lat}&lng=${point.lng}&dist=${radiusKm}&fmt=json`;
                        const hotspotsResponse = await fetch(hotspotsUrl, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });
                        
                        if (hotspotsResponse.ok) {
                            const hotspots = await hotspotsResponse.json();
                            allHotspotsData.push(...hotspots);
                        }
                    }
                    
                    // Delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 150));
                    
                } catch (error) {
                    console.warn(`Failed to fetch area ${i + 1}:`, error);
                }
            }
            
            // Final processing
            updateLoadingStatus('Processing hotspots...');
            
            // Process hotspots
            const uniqueHotspots = {};
            allHotspotsData.forEach(h => {
                if (!uniqueHotspots[h.locId]) uniqueHotspots[h.locId] = h;
            });
            
            // Get species counts for top hotspots
            const hotspotsArray = Object.values(uniqueHotspots).slice(0, 20);
            const hotspotsWithCounts = [];
            
            for (const hotspot of hotspotsArray) {
                try {
                    const obsUrl = `https://api.ebird.org/v2/data/obs/${hotspot.locId}/recent?back=${timeRange}`;
                    const obsResponse = await fetch(obsUrl, {
                        headers: { 'X-eBirdApiToken': userApiKey }
                    });

                    if (obsResponse.ok) {
                        const observations = await obsResponse.json();
                        const uniqueSpecies = new Set(observations.map(obs => obs.speciesCode));
                        
                        hotspotsWithCounts.push({
                            ...hotspot,
                            speciesCount: uniqueSpecies.size,
                            recentObs: observations.length
                        });
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (e) {
                    console.warn(`Couldn't fetch hotspot ${hotspot.locId}`);
                }
            }

            allHotspots = hotspotsWithCounts
                .sort((a, b) => b.speciesCount - a.speciesCount)
                .slice(0, 10);
            
            // Get checklists from observations
            updateLoadingStatus('Processing checklists...');
            await fetchTop10ChecklistsFromObservations(allObservations);
            
            // Final display
            updateLoadingStatus('Displaying results...');
            displayBirds();
            displayHotspots();
            displayChecklists();
            updateBelowMapPanels();
            
            // Show below-map section
            document.getElementById('belowMap').style.display = 'block';
            
            console.log(`üìç Grid search complete: ${allSightings.length} observations from ${searchPoints.length} areas`);
        }

        // ============================================
        // ROUTE PLANNING
        // ============================================
        async function planRoute() {
            if (!ebirdAuthenticated) {
                alert('Please connect to eBird first');
                return;
            }

            const origin = document.getElementById('originInput').value;
            const destination = document.getElementById('destinationInput').value;

            if (!origin || !destination) {
                alert('Please enter both origin and destination');
                return;
            }

            console.log(`üöó Planning route: ${origin} ‚Üí ${destination}`);

            // Clear previous search results
            clearMarkers();
            clearHotspots();
            clearChecklists();
            allSightings = [];
            allHotspots = [];
            allChecklists = [];
            targetSpecies = [];

            try {
                // Calculate route
                const request = {
                    origin: origin,
                    destination: destination,
                    waypoints: tripWaypoints.map(wp => ({ location: wp.location, stopover: true })),
                    optimizeWaypoints: true, // Let Google optimize the order
                    travelMode: google.maps.TravelMode.DRIVING
                };

                directionsService.route(request, async (result, status) => {
                    if (status === 'OK') {
                        currentRoute = result;
                        directionsRenderer.setDirections(result);

                        // Get duration
                        const route = result.routes[0];
                        let totalDuration = 0;
                        route.legs.forEach(leg => {
                            totalDuration += leg.duration.value;
                        });
                        
                        routeDuration = formatDuration(totalDuration);
                        document.getElementById('durationText').textContent = routeDuration;
                        document.getElementById('routeDuration').classList.remove('hidden');
                        document.getElementById('printBtn').classList.remove('hidden');

                        // Find birds along route
                        await findBirdsAlongRoute(route);

                        console.log(`‚úÖ Route calculated: ${routeDuration}`);
                    } else {
                        console.error('‚ùå Directions request failed:', status);
                        alert('Could not calculate route. Please check your locations.');
                    }
                });
            } catch (error) {
                console.error('‚ùå Route planning error:', error);
                alert('Error planning route');
            }
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function getDistance(lat1, lng1, lat2, lng2) {
            // Haversine formula for distance in miles
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ============================================
        // FIND BIRDS ALONG ROUTE
        // ============================================
        async function findBirdsAlongRoute(route) {
            console.log('üîç Finding birds along entire route...');
            showLoading('Finding birds along route...');

            // Clear previous markers
            clearMarkers();

            // Get route bounds with buffer
            const radiusMiles = parseInt(document.getElementById('searchRadius').value);
            const radiusKm = validateAndConvertRadius(radiusMiles);
            const timeRange = parseInt(document.getElementById('timeRange').value);
            
            const path = route.overview_path;
            console.log(`üìç Route has ${path.length} points`);
            
            // Calculate total route distance in miles
            const totalDistanceMeters = route.legs.reduce((sum, leg) => sum + leg.distance.value, 0);
            const totalDistanceMiles = totalDistanceMeters / 1609.34;
            
            console.log(`üìè Total route distance: ${totalDistanceMiles.toFixed(1)} miles`);
            
            // Strategy: Create overlapping search circles every 20 miles
            // This ensures complete coverage even with eBird's 50km (31 mile) limit
            const searchIntervalMiles = 20; // Overlapping circles every 20 miles
            const numSearchPoints = Math.max(2, Math.ceil(totalDistanceMiles / searchIntervalMiles) + 1);
            
            console.log(`üéØ Creating ${numSearchPoints} overlapping search areas (every ~${searchIntervalMiles} miles)`);
            
            // Sample points evenly along route
            const samplePoints = [];
            const sampleInterval = Math.max(1, Math.floor(path.length / (numSearchPoints - 1)));
            
            for (let i = 0; i < path.length; i += sampleInterval) {
                samplePoints.push({
                    lat: path[i].lat(),
                    lng: path[i].lng()
                });
            }
            
            // Always include start and end
            if (samplePoints.length === 0 || samplePoints[0].lat !== path[0].lat()) {
                samplePoints.unshift({ lat: path[0].lat(), lng: path[0].lng() });
            }
            const lastPoint = path[path.length - 1];
            if (samplePoints[samplePoints.length - 1].lat !== lastPoint.lat()) {
                samplePoints.push({ lat: lastPoint.lat(), lng: lastPoint.lng() });
            }

            console.log(`üìç Searching ${samplePoints.length} overlapping areas along route (${radiusKm}km radius each)`);

            // Fetch birds from multiple overlapping points along route
            try {
                const allObservations = [];
                const allHotspotsData = [];
                const allChecklistsData = [];
                
                // Fetch from each search area with progressive display
                for (let i = 0; i < samplePoints.length; i++) {
                    const point = samplePoints[i];
                    const progress = Math.round(((i + 1) / samplePoints.length) * 100);
                    updateLoadingStatus(`Searching area ${i + 1}/${samplePoints.length} (${progress}%)...`);
                    console.log(`üìç Fetching area ${i + 1}/${samplePoints.length} - Lat: ${point.lat.toFixed(4)}, Lng: ${point.lng.toFixed(4)}`);
                    
                    try {
                        // Get observations
                        const obsUrl = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${point.lat}&lng=${point.lng}&dist=${radiusKm}&back=${timeRange}`;
                        const obsResponse = await fetch(obsUrl, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });

                        if (obsResponse.ok) {
                            const observations = await obsResponse.json();
                            allObservations.push(...observations);
                            
                            // Progressive display: Show birds as they arrive
                            if (i === 0 || (i + 1) % 3 === 0 || i === samplePoints.length - 1) {
                                // Remove duplicates for display
                                const uniqueObs = {};
                                allObservations.forEach(obs => {
                                    const key = `${obs.speciesCode}-${obs.lat}-${obs.lng}-${obs.obsDt}`;
                                    if (!uniqueObs[key]) uniqueObs[key] = obs;
                                });
                                allSightings = Object.values(uniqueObs);
                                
                                // Update target species
                                const targetList = getTargetList();
                                const listType = document.getElementById('targetListType').value;
                                if (listType === 'all') {
                                    targetSpecies = [];
                                } else {
                                    targetSpecies = allSightings.filter(obs => !targetList.has(obs.comName));
                                }
                                
                                // Display current results
                                displayBirds();
                                updateLoadingStatus(`Found ${allSightings.length} birds so far... (searching area ${i + 1}/${samplePoints.length})`);
                                console.log(`üê¶ Progressive update: ${allSightings.length} observations, ${targetSpecies.length} targets`);
                            }
                        }
                        
                        // Get hotspots for this point
                        const hotspotsUrl = `https://api.ebird.org/v2/ref/hotspot/geo?lat=${point.lat}&lng=${point.lng}&dist=${radiusKm}&fmt=json`;
                        const hotspotsResponse = await fetch(hotspotsUrl, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });
                        
                        if (hotspotsResponse.ok) {
                            const hotspots = await hotspotsResponse.json();
                            allHotspotsData.push(...hotspots);
                        }
                        
                        // Small delay to avoid rate limiting
                        if (i < samplePoints.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    } catch (error) {
                        console.warn(`Failed to fetch data for area ${i + 1}:`, error);
                    }
                }
                
                // Remove duplicates (same observation may appear from multiple sample points)
                const uniqueObs = {};
                allObservations.forEach(obs => {
                    const key = `${obs.speciesCode}-${obs.lat}-${obs.lng}-${obs.obsDt}`;
                    if (!uniqueObs[key]) {
                        uniqueObs[key] = obs;
                    }
                });
                allSightings = Object.values(uniqueObs);
                
                console.log(`üìç Found ${allSightings.length} unique observations along route`);

                // Identify target species
                const targetList = getTargetList();
                const listType = document.getElementById('targetListType').value;
                if (listType === 'all') {
                    targetSpecies = [];
                } else {
                    targetSpecies = allSightings.filter(obs => !targetList.has(obs.comName));
                }
                console.log(`üéØ Found ${targetSpecies.length} target species (${allSightings.length} total birds)`);
                
                // If no targets and filter is active, help user understand
                if (targetSpecies.length === 0 && listType !== 'all' && allSightings.length > 0) {
                    console.log(`‚ÑπÔ∏è No new birds for ${listType} list. You've seen all ${allSightings.length} birds on this route!`);
                    console.log(`üí° Tip: Switch to "Show All Species" to see them on the map.`);
                }
                
                // Fetch expected seasonal targets and notable sightings
                updateLoadingStatus('Finding expected seasonal targets...');
                const centerPoint = samplePoints[Math.floor(samplePoints.length / 2)];
                const regionCode = getRegionFromCoordinates(centerPoint.lat, centerPoint.lng);
                
                const [expectedData, notableData] = await Promise.all([
                    fetchExpectedTargets(regionCode),
                    fetchNotableTargets(regionCode)
                ]);
                
                // Filter expected targets to match observations we found
                expectedTargets = allSightings.filter(obs => {
                    const isTarget = !targetList.has(obs.comName);
                    const isInTop100 = expectedData.some(sp => 
                        targetFrequencies.has(obs.speciesCode)
                    );
                    return isTarget && isInTop100;
                });
                
                // Notable targets are already filtered by user's list
                notableTargets = notableData;
                
                console.log(`‚≠ê Found ${expectedTargets.length} expected seasonal targets`);
                console.log(`üíé Found ${notableTargets.length} notable rare targets`);

                // Process hotspots - distribute along route instead of just taking top globally
                updateLoadingStatus('Processing hotspots...');
                const uniqueHotspots = {};
                allHotspotsData.forEach(h => {
                    if (!uniqueHotspots[h.locId]) {
                        uniqueHotspots[h.locId] = h;
                    }
                });
                
                console.log(`üìç Found ${Object.keys(uniqueHotspots).length} unique hotspots total`);
                
                // Group hotspots by which sample point they're near
                const hotspotsBySection = [];
                const hotspotsPerSection = Math.ceil(10 / samplePoints.length); // Distribute evenly
                
                // For each section of the route, get the best hotspots
                for (let i = 0; i < samplePoints.length && hotspotsBySection.length < 30; i++) {
                    const point = samplePoints[i];
                    
                    // Get hotspots near this point
                    const nearbyHotspots = Object.values(uniqueHotspots).filter(h => {
                        const distance = getDistance(point.lat, point.lng, h.lat, h.lng);
                        return distance < radiusMiles * 1.5; // Within 1.5x the search radius
                    });
                    
                    hotspotsBySection.push(...nearbyHotspots.slice(0, hotspotsPerSection));
                }
                
                updateLoadingStatus('Getting hotspot species counts...');
                // Get species counts for distributed hotspots
                const hotspotsWithCounts = [];
                for (const hotspot of hotspotsBySection) {
                    try {
                        const obsUrl = `https://api.ebird.org/v2/data/obs/${hotspot.locId}/recent?back=${timeRange}`;
                        const obsResponse = await fetch(obsUrl, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });

                        if (obsResponse.ok) {
                            const observations = await obsResponse.json();
                            const uniqueSpecies = new Set(observations.map(obs => obs.speciesCode));
                            
                            hotspotsWithCounts.push({
                                ...hotspot,
                                speciesCount: uniqueSpecies.size,
                                recentObs: observations.length
                            });
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 100));
                    } catch (e) {
                        console.warn(`Couldn't fetch data for hotspot ${hotspot.locId}`);
                    }
                }

                allHotspots = hotspotsWithCounts
                    .sort((a, b) => b.speciesCount - a.speciesCount)
                    .slice(0, 10);
                    
                console.log(`‚úÖ Found top 10 hotspots distributed along route`);

                // Get top checklists from observations
                updateLoadingStatus('Processing checklists...');
                await fetchTop10ChecklistsFromObservations(allObservations);

                // Display everything
                updateLoadingStatus('Displaying results...');
                displayBirds();
                displayHotspots();
                displayChecklists();
                updateBelowMapPanels();

                // Show below-map section
                document.getElementById('belowMap').style.display = 'block';
                
                hideLoading();

            } catch (error) {
                console.error('‚ùå Error finding birds:', error);
                hideLoading();
                alert('Error finding birds along route');
            }
        }
        
        // Helper function to get checklists from observations
        async function fetchTop10ChecklistsFromObservations(observations) {
            const checklistMap = {};
            observations.forEach(obs => {
                if (obs.subId) {
                    if (!checklistMap[obs.subId]) {
                        checklistMap[obs.subId] = {
                            subId: obs.subId,
                            lat: obs.lat,
                            lng: obs.lng,
                            locName: obs.locName,
                            obsDt: obs.obsDt,
                            species: new Set()
                        };
                    }
                    checklistMap[obs.subId].species.add(obs.speciesCode);
                }
            });

            const checklistsWithCounts = Object.values(checklistMap).map(checklist => ({
                ...checklist,
                speciesCount: checklist.species.size
            }));

            allChecklists = checklistsWithCounts
                .sort((a, b) => b.speciesCount - a.speciesCount)
                .slice(0, 10);

            console.log(`‚úÖ Top 10 checklists from route observations`);
        }

        // ============================================
        // FETCH TOP 10 HOTSPOTS (BY SPECIES COUNT)
        // ============================================
        async function fetchTop10Hotspots(lat, lng, radius) {
            console.log('üìç Fetching top hotspots...');

            try {
                // Get all hotspots in area
                const hotspotsUrl = `https://api.ebird.org/v2/ref/hotspot/geo?lat=${lat}&lng=${lng}&dist=${radius}&fmt=json`;
                const response = await fetch(hotspotsUrl, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch hotspots');
                }

                const hotspots = await response.json();
                console.log(`Found ${hotspots.length} total hotspots`);

                // For each hotspot, get recent species count
                const hotspotsWithCounts = [];
                const timeRange = parseInt(document.getElementById('timeRange').value);

                // Limit to first 30 hotspots to avoid too many API calls
                const hotspotsToCheck = hotspots.slice(0, 30);

                for (const hotspot of hotspotsToCheck) {
                    try {
                        const obsUrl = `https://api.ebird.org/v2/data/obs/${hotspot.locId}/recent?back=${timeRange}`;
                        const obsResponse = await fetch(obsUrl, {
                            headers: { 'X-eBirdApiToken': userApiKey }
                        });

                        if (obsResponse.ok) {
                            const observations = await obsResponse.json();
                            const uniqueSpecies = new Set(observations.map(obs => obs.speciesCode));
                            
                            hotspotsWithCounts.push({
                                ...hotspot,
                                speciesCount: uniqueSpecies.size,
                                recentObs: observations.length
                            });
                        }
                    } catch (e) {
                        console.warn(`Couldn't fetch data for hotspot ${hotspot.locId}`);
                    }
                }

                // Sort by species count (descending) and take top 10
                allHotspots = hotspotsWithCounts
                    .sort((a, b) => b.speciesCount - a.speciesCount)
                    .slice(0, 10);

                console.log(`‚úÖ Top 10 hotspots by species diversity:`, allHotspots.map(h => `${h.locName}: ${h.speciesCount} species`));

            } catch (error) {
                console.error('‚ùå Error fetching hotspots:', error);
                allHotspots = [];
            }
        }

        // ============================================
        // DISPLAY BIRDS ON MAP
        // ============================================
        function displayBirds() {
            clearMarkers();

            const listType = document.getElementById('targetListType').value;
            const targetList = getTargetList();
            
            let birdsToShow = allSightings;
            
            // Apply target filter based on type
            if (listType === 'expected') {
                // Show only expected seasonal targets
                birdsToShow = expectedTargets;
            } else if (listType === 'notable') {
                // Show only notable rare targets
                birdsToShow = notableTargets;
            } else if (listType !== 'all') {
                // Show regular targets (haven't seen)
                birdsToShow = allSightings.filter(obs => !targetList.has(obs.comName));
            }

            console.log(`Displaying ${birdsToShow.length} bird markers (filter: ${listType})`);
            
            // Show helpful message when filter hides all birds
            if (birdsToShow.length === 0 && allSightings.length > 0) {
                if (listType === 'expected') {
                    console.log(`‚ÑπÔ∏è No expected seasonal targets found. This might be a transitional season.`);
                } else if (listType === 'notable') {
                    console.log(`‚ÑπÔ∏è No notable/rare birds recently reported in this area.`);
                } else {
                    console.log(`‚ÑπÔ∏è Filter is hiding all ${allSightings.length} birds. You've already seen them all!`);
                    console.log(`üí° Tip: Switch to "Show All Species" to see them on the map.`);
                }
            }

            birdsToShow.forEach(obs => {
                const isTarget = !targetList.has(obs.comName);
                const isExpected = expectedTargets.some(e => e.speciesCode === obs.speciesCode);
                const isNotable = notableTargets.some(n => n.speciesCode === obs.speciesCode);
                const abaCode = getABARarityCode(obs.comName);
                
                // Check ABA rarity filter
                if (!shouldShowABARarity(abaCode)) {
                    return; // Skip this bird
                }
                
                const color = getMarkerColor(obs, isTarget, abaCode, isExpected, isNotable);
                const actualCount = obs.howMany || 1;

                const marker = new google.maps.Marker({
                    position: { lat: obs.lat, lng: obs.lng },
                    map: map,
                    title: obs.comName,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: color,
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    }
                });

                // Store marker with species name for highlighting
                marker.speciesName = obs.comName;
                marker.abaCode = abaCode;

                const abaRarityText = ['', 'Common', 'Uncommon', 'Rare', 'Very Rare', 'Mega Rare', 'Extirpated'][abaCode] || 'Common';
                
                // Get frequency data if available
                const frequency = targetFrequencies.get(obs.speciesCode);
                const frequencyText = frequency ? 
                    `<p style="margin: 5px 0; font-size: 0.9em;"><strong>Frequency:</strong> ${(frequency * 100).toFixed(0)}% of checklists</p>` : '';
                
                // Determine target type badge
                let targetBadge = '';
                if (isNotable) {
                    targetBadge = '<div style="background: #a855f7; color: white; padding: 4px 8px; border-radius: 4px; display: inline-block; margin: 5px 0; font-weight: 600; font-size: 0.85em;">üíé NOTABLE/RARE</div>';
                } else if (isExpected) {
                    targetBadge = '<div style="background: #fbbf24; color: white; padding: 4px 8px; border-radius: 4px; display: inline-block; margin: 5px 0; font-weight: 600; font-size: 0.85em;">‚≠ê EXPECTED SEASONAL</div>';
                } else if (isTarget) {
                    targetBadge = '<div style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; display: inline-block; margin: 5px 0; font-weight: 600; font-size: 0.85em;">üéØ TARGET SPECIES</div>';
                }

                // Create checklist link if subId exists
                const checklistLink = obs.subId ? 
                    `<p style="margin: 5px 0; font-size: 0.9em;"><strong>Checklist:</strong> <a href="https://ebird.org/checklist/${obs.subId}" target="_blank" style="color: #10b981; text-decoration: underline;">View on eBird</a></p>` : '';

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; max-width: 250px;">
                            <h3 style="margin: 0 0 8px 0; color: #065f46;">${obs.comName}</h3>
                            ${targetBadge}
                            ${frequencyText}
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>ABA Rarity:</strong> Code ${abaCode} (${abaRarityText})</p>
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>Location:</strong> ${obs.locName}</p>
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>Date:</strong> ${obs.obsDt}</p>
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>Count:</strong> ${actualCount}</p>
                            ${checklistLink}
                            <button onclick="addWaypoint(${obs.lat}, ${obs.lng}, '${obs.locName.replace(/'/g, "\\'")}', '${obs.comName.replace(/'/g, "\\'")}' )" 
                                    style="margin-top: 10px; padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                                ‚ûï Add to Route
                            </button>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markersArray.push(marker);
            });
        }

        function getMarkerColor(obs, isTarget, abaCode, isExpected, isNotable) {
            // Priority 1: Notable rare targets (purple)
            if (isNotable) return '#a855f7'; // Purple for notable/rare
            
            // Priority 2: Expected seasonal targets (gold)
            if (isExpected) return '#fbbf24'; // Gold for expected seasonal
            
            // Priority 3: Regular target species (red)
            if (isTarget) return '#ef4444'; // Red for targets
            
            // Priority 4: ABA rarity
            return getABARarityColor(abaCode);
        }

        // ============================================
        // HIGHLIGHT SPECIES ON MAP
        // ============================================
        function highlightSpeciesOnMap(speciesName) {
            console.log(`üéØ Highlighting ${speciesName} on map`);
            
            // Find all markers for this species
            const speciesMarkers = markersArray.filter(marker => marker.speciesName === speciesName);
            
            if (speciesMarkers.length === 0) {
                alert(`No map markers found for ${speciesName}`);
                return;
            }
            
            // Reset all markers to normal size
            markersArray.forEach(marker => {
                marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: marker.icon.fillColor,
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2
                });
            });
            
            // Highlight the selected species markers
            speciesMarkers.forEach(marker => {
                marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 14, // Larger
                    fillColor: marker.icon.fillColor,
                    fillOpacity: 1,
                    strokeColor: '#fbbf24', // Gold border
                    strokeWeight: 4
                });
                
                // Make them bounce briefly
                marker.setAnimation(google.maps.Animation.BOUNCE);
                setTimeout(() => marker.setAnimation(null), 2000);
            });
            
            // Center map on first marker
            if (speciesMarkers.length > 0) {
                map.setCenter(speciesMarkers[0].getPosition());
                map.setZoom(12);
            }
            
            // Scroll map into view
            document.getElementById('map').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            console.log(`‚úÖ Highlighted ${speciesMarkers.length} markers for ${speciesName}`);
        }

        // ============================================
        // DISPLAY HOTSPOTS
        // ============================================
        function displayHotspots() {
            if (!document.getElementById('showHotspots').checked) {
                clearHotspots();
                return;
            }

            clearHotspots();

            allHotspots.forEach((hotspot, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: hotspot.lat, lng: hotspot.lng },
                    map: map,
                    title: hotspot.locName,
                    label: {
                        text: `${index + 1}`,
                        color: 'white',
                        fontSize: '12px',
                        fontWeight: 'bold'
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 14,
                        fillColor: '#3b82f6',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    }
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; max-width: 280px;">
                            <h3 style="margin: 0 0 8px 0; color: #065f46;">#${index + 1} ${hotspot.locName}</h3>
                            <div style="background: #dbeafe; padding: 8px; border-radius: 4px; margin-bottom: 10px;">
                                <p style="margin: 0; font-weight: 600; color: #1e40af;">ü¶Ü ${hotspot.speciesCount || 'Loading...'} species recently</p>
                                <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #3b82f6;">${hotspot.recentObs || 0} observations</p>
                            </div>
                            <p style="margin: 0 0 8px 0; font-size: 0.85em; color: #6b7280;">
                                <a href="https://ebird.org/hotspot/${hotspot.locId}" target="_blank" style="color: #10b981; text-decoration: underline;">View on eBird</a>
                            </p>
                            <button onclick="addWaypoint(${hotspot.lat}, ${hotspot.lng}, '${hotspot.locName.replace(/'/g, "\\'")}', 'Hotspot')" 
                                    style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                                ‚ûï Add to Route
                            </button>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                hotspotsArray.push(marker);
            });

            console.log(`‚úÖ Displayed ${allHotspots.length} hotspot markers`);
        }

        // ============================================
        // FETCH TOP 10 CHECKLISTS (BY SPECIES COUNT)
        // ============================================
        async function fetchTop10Checklists(lat, lng, radius) {
            console.log('üìã Fetching top checklists...');

            try {
                // Get recent notable observations (these are often in checklists)
                const timeRange = parseInt(document.getElementById('timeRange').value);
                const obsUrl = `https://api.ebird.org/v2/data/obs/geo/recent/notable?lat=${lat}&lng=${lng}&dist=${radius}&back=${timeRange}&detail=full`;
                
                const response = await fetch(obsUrl, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });

                if (!response.ok) {
                    console.warn('Could not fetch notable observations for checklists');
                    allChecklists = [];
                    return;
                }

                const observations = await response.json();
                
                // Group by checklist (subId)
                const checklistMap = {};
                observations.forEach(obs => {
                    if (obs.subId) {
                        if (!checklistMap[obs.subId]) {
                            checklistMap[obs.subId] = {
                                subId: obs.subId,
                                lat: obs.lat,
                                lng: obs.lng,
                                locName: obs.locName,
                                obsDt: obs.obsDt,
                                species: new Set()
                            };
                        }
                        checklistMap[obs.subId].species.add(obs.speciesCode);
                    }
                });

                // Convert to array and add species count
                const checklistsWithCounts = Object.values(checklistMap).map(checklist => ({
                    ...checklist,
                    speciesCount: checklist.species.size
                }));

                // Sort by species count and take top 10
                allChecklists = checklistsWithCounts
                    .sort((a, b) => b.speciesCount - a.speciesCount)
                    .slice(0, 10);

                console.log(`‚úÖ Top 10 checklists:`, allChecklists.map(c => `${c.locName}: ${c.speciesCount} species`));

            } catch (error) {
                console.error('‚ùå Error fetching checklists:', error);
                allChecklists = [];
            }
        }

        // ============================================
        // DISPLAY TOP 10 CHECKLISTS
        // ============================================
        function displayChecklists() {
            if (!document.getElementById('showChecklists').checked) {
                clearChecklists();
                return;
            }

            clearChecklists();

            allChecklists.forEach((checklist, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: checklist.lat, lng: checklist.lng },
                    map: map,
                    title: `Checklist #${index + 1}: ${checklist.locName}`,
                    label: {
                        text: `${index + 1}`,
                        color: 'white',
                        fontSize: '11px',
                        fontWeight: 'bold'
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: '#10b981',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    }
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; max-width: 280px;">
                            <h3 style="margin: 0 0 8px 0; color: #065f46;">üìã Checklist #${index + 1}</h3>
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>Location:</strong> ${checklist.locName}</p>
                            <div style="background: #f0fdf4; padding: 8px; border-radius: 4px; margin: 10px 0;">
                                <p style="margin: 0; font-weight: 600; color: #065f46;">üê¶ ${checklist.speciesCount} species in checklist</p>
                                <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #047857;">${checklist.obsDt}</p>
                            </div>
                            <button onclick="addWaypoint(${checklist.lat}, ${checklist.lng}, '${checklist.locName.replace(/'/g, "\\'")}', 'Checklist #${index + 1}')" 
                                    style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                                ‚ûï Add to Route
                            </button>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                checklistsArray.push(marker);
            });

            console.log(`‚úÖ Displayed ${allChecklists.length} checklist markers`);
        }

        function clearChecklists() {
            checklistsArray.forEach(marker => marker.setMap(null));
            checklistsArray = [];
        }

        // ============================================
        // WAYPOINT MANAGEMENT
        // ============================================
        function addWaypoint(lat, lng, locationName, speciesName) {
            const waypoint = {
                location: { lat, lng },
                name: locationName,
                species: speciesName
            };

            tripWaypoints.push(waypoint);
            console.log(`‚ûï Added waypoint: ${locationName}`);

            updateWaypointList();
            
            // Recalculate route with new waypoint
            if (currentRoute) {
                planRoute();
            }
        }

        function removeWaypoint(index) {
            tripWaypoints.splice(index, 1);
            console.log(`‚ûñ Removed waypoint at index ${index}`);
            
            updateWaypointList();
            
            // Recalculate route
            if (currentRoute) {
                planRoute();
            }
        }

        function updateWaypointList() {
            const listDiv = document.getElementById('waypointList');
            
            if (tripWaypoints.length === 0) {
                listDiv.innerHTML = '';
                return;
            }

            listDiv.innerHTML = '<h4 style="margin: 15px 0 10px 0; color: #065f46; font-size: 0.95em;">Waypoints:</h4>';
            
            tripWaypoints.forEach((wp, index) => {
                const div = document.createElement('div');
                div.className = 'waypoint-item';
                div.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 0.9em;">${wp.name}</div>
                        <div style="font-size: 0.8em; color: #6b7280;">${wp.species}</div>
                    </div>
                    <button class="waypoint-remove" onclick="removeWaypoint(${index})">√ó</button>
                `;
                listDiv.appendChild(div);
            });
        }

        // ============================================
        // PRINT DIRECTIONS
        // ============================================
        function printDirections() {
            if (!currentRoute) {
                alert('No route to print');
                return;
            }

            const route = currentRoute.routes[0];
            const origin = document.getElementById('originInput').value;
            const destination = document.getElementById('destinationInput').value;

            // Create printable content
            let printContent = `
                <html>
                <head>
                    <title>Birding Route - ${origin} to ${destination}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #065f46; }
                        h2 { color: #10b981; margin-top: 20px; }
                        .leg { margin: 15px 0; padding: 10px; background: #f9fafb; border-left: 4px solid #10b981; }
                        .waypoint { background: #dbeafe; padding: 8px; margin: 8px 0; border-radius: 4px; }
                        .summary { background: #f0fdf4; padding: 15px; border-radius: 8px; margin: 20px 0; }
                    </style>
                </head>
                <body>
                    <h1>ü¶© Birding Trip Route</h1>
                    <div class="summary">
                        <p><strong>From:</strong> ${origin}</p>
                        <p><strong>To:</strong> ${destination}</p>
                        <p><strong>Total Duration:</strong> ${routeDuration}</p>
                        <p><strong>Waypoints:</strong> ${tripWaypoints.length}</p>
                    </div>
            `;

            if (tripWaypoints.length > 0) {
                printContent += '<h2>üéØ Birding Stops</h2>';
                tripWaypoints.forEach((wp, index) => {
                    printContent += `
                        <div class="waypoint">
                            <strong>Stop ${index + 1}:</strong> ${wp.name}<br>
                            <em>${wp.species}</em>
                        </div>
                    `;
                });
            }

            printContent += '<h2>üó∫Ô∏è Turn-by-Turn Directions</h2>';

            route.legs.forEach((leg, legIndex) => {
                printContent += `
                    <div class="leg">
                        <h3>Leg ${legIndex + 1}: ${leg.start_address} ‚Üí ${leg.end_address}</h3>
                        <p><strong>Distance:</strong> ${leg.distance.text} | <strong>Duration:</strong> ${leg.duration.text}</p>
                `;
                
                leg.steps.forEach((step, stepIndex) => {
                    printContent += `<p>${stepIndex + 1}. ${step.instructions} (${step.distance.text})</p>`;
                });

                printContent += '</div>';
            });

            printContent += `
                    <p style="margin-top: 30px; color: #6b7280; font-size: 0.9em;">
                        Generated by Traveling Birder - ${new Date().toLocaleDateString()}
                    </p>
                </body>
                </html>
            `;

            // Open print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // ============================================
        // UPDATE BELOW-MAP PANELS
        // ============================================
        function updateBelowMapPanels() {
            // Update counts with breakdown
            const totalTargets = targetSpecies.length;
            const expectedCount = expectedTargets.length;
            const notableCount = notableTargets.length;
            
            let countText = `${totalTargets} species`;
            if (expectedCount > 0 || notableCount > 0) {
                countText += ` (‚≠ê${expectedCount} expected, üíé${notableCount} notable)`;
            }
            
            document.getElementById('targetCount').textContent = totalTargets;
            document.getElementById('sightingsCount').textContent = allSightings.length;

            // Enhanced Target Species List with probabilities
            const targetList = document.getElementById('targetList');
            if (targetSpecies.length === 0) {
                targetList.innerHTML = '<p style="color: #6b7280;">No target species found in this area.</p>';
            } else {
                // Group targets by species and calculate stats
                const speciesStats = {};
                targetSpecies.forEach(obs => {
                    if (!speciesStats[obs.comName]) {
                        speciesStats[obs.comName] = {
                            species: obs.comName,
                            speciesCode: obs.speciesCode,
                            sightings: [],
                            locations: new Set(),
                            recentObs: obs
                        };
                    }
                    speciesStats[obs.comName].sightings.push(obs);
                    speciesStats[obs.comName].locations.add(obs.locName);
                    // Keep most recent observation
                    if (new Date(obs.obsDt) > new Date(speciesStats[obs.comName].recentObs.obsDt)) {
                        speciesStats[obs.comName].recentObs = obs;
                    }
                });

                const sortedTargets = Object.values(speciesStats).sort((a, b) => {
                    // Sort by frequency first (expected targets on top), then by sighting count
                    const freqA = targetFrequencies.get(a.speciesCode) || 0;
                    const freqB = targetFrequencies.get(b.speciesCode) || 0;
                    if (freqB !== freqA) return freqB - freqA;
                    return b.sightings.length - a.sightings.length;
                });

                let html = '<div style="margin-bottom: 15px; padding: 10px; background: #f0fdf4; border-radius: 6px; border-left: 4px solid #10b981;">';
                html += '<p style="margin: 0; font-size: 0.9em; color: #065f46;"><strong>Legend:</strong> ‚≠ê = Expected seasonal target | üíé = Rare/notable | Frequency = % of checklists reporting</p>';
                html += '</div>';
                
                html += '<div style="display: grid; gap: 12px;">';
                sortedTargets.forEach(stats => {
                    const abaCode = getABARarityCode(stats.species);
                    const abaRarityText = ['', 'Common', 'Uncommon', 'Rare', 'Very Rare', 'Mega Rare', 'Extirpated'][abaCode] || '';
                    const frequency = targetFrequencies.get(stats.speciesCode);
                    const isExpected = expectedTargets.some(e => e.speciesCode === stats.speciesCode);
                    const isNotable = notableTargets.some(n => n.speciesCode === stats.speciesCode);
                    
                    // Determine badge and color
                    let badge = 'üéØ';
                    let badgeColor = '#ef4444';
                    let badgeText = 'Target';
                    if (isNotable) {
                        badge = 'üíé';
                        badgeColor = '#a855f7';
                        badgeText = 'Notable/Rare';
                    } else if (isExpected) {
                        badge = '‚≠ê';
                        badgeColor = '#fbbf24';
                        badgeText = 'Expected';
                    }
                    
                    // Frequency bar
                    const freqPercent = frequency ? Math.round(frequency * 100) : 0;
                    const freqBar = frequency ? 
                        `<div style="margin: 8px 0;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.75em; color: #6b7280; margin-bottom: 3px;">
                                <span>Probability</span>
                                <span style="font-weight: 600; color: #10b981;">${freqPercent}%</span>
                            </div>
                            <div style="background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: #10b981; height: 100%; width: ${freqPercent}%;"></div>
                            </div>
                        </div>` : '';
                    
                    html += `
                        <div onclick="highlightSpeciesOnMap('${stats.species.replace(/'/g, "\\'")}' )" 
                             style="background: white; border: 2px solid ${badgeColor}; border-radius: 8px; padding: 14px; cursor: pointer; transition: all 0.2s;" 
                             onmouseover="this.style.background='#f0fdf4'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';" 
                             onmouseout="this.style.background='white'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <h4 style="margin: 0; color: #065f46; font-size: 1.05em; flex: 1;">${stats.species}</h4>
                                <div style="background: ${badgeColor}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600; white-space: nowrap; margin-left: 8px;">
                                    ${badge} ${badgeText}
                                </div>
                            </div>
                            ${freqBar}
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 8px 0; padding: 8px; background: #f9fafb; border-radius: 4px;">
                                <div>
                                    <div style="font-size: 0.7em; color: #6b7280; margin-bottom: 2px;">SIGHTINGS</div>
                                    <div style="font-size: 1.1em; font-weight: 600; color: #10b981;">${stats.sightings.length}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.7em; color: #6b7280; margin-bottom: 2px;">LOCATIONS</div>
                                    <div style="font-size: 1.1em; font-weight: 600; color: #3b82f6;">${stats.locations.size}</div>
                                </div>
                            </div>
                            <p style="margin: 6px 0 3px 0; font-size: 0.75em; color: #6b7280;">ABA Code ${abaCode} (${abaRarityText})</p>
                            <p style="margin: 3px 0; font-size: 0.8em; color: #6b7280;">üìç Most recent: ${stats.recentObs.locName}</p>
                            <p style="margin: 3px 0; font-size: 0.8em; color: #6b7280;">üìÖ ${stats.recentObs.obsDt}</p>
                            <p style="margin: 8px 0 0 0; font-size: 0.75em; color: #10b981; font-weight: 600;">üó∫Ô∏è Click to show all ${stats.sightings.length} sighting(s) on map</p>
                        </div>
                    `;
                });
                html += '</div>';
                targetList.innerHTML = html;
            }

            // Sightings Summary
            const sightingsList = document.getElementById('sightingsList');
            const speciesCounts = {};
            allSightings.forEach(obs => {
                speciesCounts[obs.comName] = (speciesCounts[obs.comName] || 0) + 1;
            });

            const topSpecies = Object.entries(speciesCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);

            let sightingsHtml = '<h4 style="margin-bottom: 10px;">Most Common Species</h4>';
            topSpecies.forEach(([species, count]) => {
                sightingsHtml += `
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f3f4f6;">
                        <span>${species}</span>
                        <span style="font-weight: 600; color: #10b981;">${count}</span>
                    </div>
                `;
            });
            sightingsList.innerHTML = sightingsHtml;

            // Stats Display
            const statsDisplay = document.getElementById('statsDisplay');
            const userSpeciesInArea = allSightings.filter(obs => userList.has(obs.comName));
            const uniqueUserSpecies = new Set(userSpeciesInArea.map(obs => obs.comName));
            const uniqueTotalSpecies = new Set(allSightings.map(obs => obs.comName));
            const percentage = uniqueTotalSpecies.size > 0 
                ? Math.round((uniqueUserSpecies.size / uniqueTotalSpecies.size) * 100)
                : 0;

            statsDisplay.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 8px;">
                        <div style="font-size: 0.8em; color: #6b7280; margin-bottom: 5px;">YOUR SPECIES</div>
                        <div style="font-size: 2em; font-weight: bold; color: #10b981;">${uniqueUserSpecies.size}</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f9fafb; border-radius: 8px;">
                        <div style="font-size: 0.8em; color: #6b7280; margin-bottom: 5px;">TOTAL SPECIES</div>
                        <div style="font-size: 2em; font-weight: bold; color: #374151;">${uniqueTotalSpecies.size}</div>
                    </div>
                </div>
                <div style="text-align: center; padding: 12px; background: #fef3c7; border-radius: 8px;">
                    <span style="font-weight: 600; color: #92400e;">You've seen ${percentage}% of species in this area</span>
                </div>
            `;
        }

        // ============================================
        // PANEL TOGGLES
        // ============================================
        function togglePanel(panelId) {
            const content = document.getElementById(panelId + 'Content');
            const toggle = document.getElementById(panelId + 'Toggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.textContent = '+';
            } else {
                content.classList.add('expanded');
                toggle.textContent = '‚àí';
            }
        }

        function toggleLegend() {
            const content = document.getElementById('legendContent');
            const toggle = document.getElementById('legendToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚àí';
            } else {
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }

        function toggleQuickStart() {
            const modal = document.getElementById('quickStartModal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
            }
        }

        // ============================================
        // LAYER TOGGLES
        // ============================================
        function toggleHotspots() {
            if (document.getElementById('showHotspots').checked) {
                displayHotspots();
            } else {
                clearHotspots();
            }
        }

        function toggleChecklists() {
            if (document.getElementById('showChecklists').checked) {
                displayChecklists();
            } else {
                clearChecklists();
            }
        }

        // ============================================
        // SEARCH SPECIFIC SPECIES
        // ============================================
        async function searchSpecies() {
            const speciesName = document.getElementById('speciesSearch').value.trim();
            const location = document.getElementById('speciesLocation').value.trim();

            if (!speciesName) {
                alert('Please enter a species name');
                return;
            }
            
            // Check if eBird is connected for API access
            if (!userApiKey) {
                alert('Please connect to eBird first to search for species');
                return;
            }

            console.log(`üîç Searching for ${speciesName} near ${location || 'current area'}`);
            showLoading('Searching for species...');

            try {
                let lat, lng;
                
                if (location && speciesLocationAutocomplete && speciesLocationAutocomplete.getPlace()) {
                    const place = speciesLocationAutocomplete.getPlace();
                    if (place.geometry) {
                        lat = place.geometry.location.lat();
                        lng = place.geometry.location.lng();
                    }
                } else if (map) {
                    const center = map.getCenter();
                    lat = center.lat();
                    lng = center.lng();
                }

                const radiusMiles = parseInt(document.getElementById('searchRadius').value);
                const radiusKm = validateAndConvertRadius(radiusMiles);
                const timeRange = parseInt(document.getElementById('timeRange').value);

                const url = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&dist=${radiusKm}&back=${timeRange}`;
                const response = await fetch(url, {
                    headers: { 'X-eBirdApiToken': userApiKey }
                });

                if (!response.ok) {
                    throw new Error('Search failed');
                }

                const observations = await response.json();
                const matchingObs = observations.filter(obs => 
                    obs.comName.toLowerCase().includes(speciesName.toLowerCase())
                );

                if (matchingObs.length === 0) {
                    hideLoading();
                    alert(`No recent sightings of "${speciesName}" found in this area.`);
                    return;
                }

                // Clear current markers and display search results
                clearMarkers();
                allSightings = matchingObs;
                targetSpecies = matchingObs.filter(obs => userList.has && !userList.has(obs.comName));
                
                displayBirds();
                
                // Zoom to first result
                if (matchingObs[0]) {
                    map.setCenter({ lat: matchingObs[0].lat, lng: matchingObs[0].lng });
                    map.setZoom(12);
                }

                hideLoading();
                console.log(`‚úÖ Found ${matchingObs.length} sightings of ${speciesName}`);
                alert(`Found ${matchingObs.length} recent sightings of "${speciesName}"`);

            } catch (error) {
                console.error('‚ùå Species search error:', error);
                hideLoading();
                alert('Error searching for species');
            }
        }

        // ============================================
        // MARKER MANAGEMENT
        // ============================================
        function clearMarkers() {
            markersArray.forEach(marker => marker.setMap(null));
            markersArray = [];
        }

        function clearHotspots() {
            hotspotsArray.forEach(marker => marker.setMap(null));
            hotspotsArray = [];
        }

        // ============================================
        // RESET ALL
        // ============================================
        function resetAll() {
            // Clear route
            if (directionsRenderer) {
                directionsRenderer.setDirections({ routes: [] });
            }
            currentRoute = null;
            tripWaypoints = [];
            routeDuration = '';

            // Clear markers
            clearMarkers();
            clearHotspots();
            clearChecklists();

            // Clear data
            allSightings = [];
            allHotspots = [];
            allChecklists = [];
            targetSpecies = [];

            // Reset UI
            document.getElementById('originInput').value = '';
            document.getElementById('destinationInput').value = '';
            document.getElementById('routeDuration').classList.add('hidden');
            document.getElementById('printBtn').classList.add('hidden');
            document.getElementById('belowMap').style.display = 'none';
            document.getElementById('waypointList').innerHTML = '';

            // Reset map view
            if (map) {
                map.setCenter({ lat: 39.8283, lng: -98.5795 });
                map.setZoom(4);
            }

            console.log('üîÑ Reset complete');
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        console.log('‚úÖ All JavaScript loaded successfully');
        console.log('üìã Ready for eBird connection');

    </script>
    
    <!-- ============================================
         FOOTER - HOW IT WORKS
         ============================================ -->
    <div style="background: #f9fafb; border-top: 2px solid #e5e7eb; padding: 40px 20px; margin-top: 40px;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <h2 style="color: #065f46; margin: 0 0 20px 0; font-size: 1.5em;">üîç How Traveling Birder Search Works</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 30px;">
                <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
                    <h3 style="color: #065f46; margin: 0 0 10px 0; font-size: 1.1em;">üì° eBird API Limitation</h3>
                    <p style="margin: 0; line-height: 1.6; color: #374151;">
                        eBird's API has a maximum search radius of <strong>50 kilometers (31 miles)</strong>. This is a technical limitation of their service that we cannot change.
                    </p>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h3 style="color: #065f46; margin: 0 0 10px 0; font-size: 1.1em;">üîÑ Our Solution: Overlapping Searches</h3>
                    <p style="margin: 0; line-height: 1.6; color: #374151;">
                        For routes and large areas, we automatically perform <strong>multiple overlapping searches every 20 miles</strong>. Each search has a 31-mile radius, ensuring complete coverage with no gaps.
                    </p>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h3 style="color: #065f46; margin: 0 0 10px 0; font-size: 1.1em;">üìä What This Means for You</h3>
                    <p style="margin: 0; line-height: 1.6; color: #374151;">
                        <strong>Short routes (&lt;50 mi):</strong> Instant results<br>
                        <strong>Long routes (200+ mi):</strong> May take 30-60 seconds<br>
                        <strong>Very long routes (1000+ mi):</strong> May take 2-3 minutes
                    </p>
                </div>
            </div>
            
            <div style="background: #ecfdf5; padding: 20px; border-radius: 8px; border: 1px solid #10b981;">
                <h3 style="color: #065f46; margin: 0 0 10px 0; font-size: 1.1em;">üéØ Why You Might Not See Expected Birds</h3>
                <div style="line-height: 1.8; color: #374151;">
                    <p style="margin: 0 0 10px 0;"><strong>1. Time Range:</strong> We search recent observations (default: last 30 days). Adjust the "Time Range" to see older sightings.</p>
                    <p style="margin: 0 0 10px 0;"><strong>2. Search Radius:</strong> Birds may be outside your search radius. Try increasing it (up to 31 miles max).</p>
                    <p style="margin: 0 0 10px 0;"><strong>3. eBird Data:</strong> We only show birds that have been reported to eBird. Some areas have less coverage than others.</p>
                    <p style="margin: 0 0 10px 0;"><strong>4. Target List Filter:</strong> Check if you have a filter active (Life List, Year List, etc.). Switch to "Show All Species" to see everything.</p>
                    <p style="margin: 0;"><strong>5. ABA Rarity Filter:</strong> Unchecking certain rarity codes will hide those birds. Make sure all codes are checked to see all species.</p>
                    <p style="margin: 10px 0 0 0;"><strong>6. You've Seen All Birds:</strong> If using Life List (or other) filter and no birds appear, you may have already seen all birds on this route! Switch to "Show All Species" to see them on the map.</p>
                </div>
            </div>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 0.9em;">
                <p style="margin: 0 0 10px 0;">ü¶© <strong>Traveling Birder</strong> | Powered by eBird and Google Maps | 
                <a href="https://ebird.org/api/keygen" target="_blank" style="color: #10b981; text-decoration: none;">Get eBird API Key</a></p>
                <p style="margin: 0; font-size: 0.85em;">
                    Questions or feedback? Contact: <a href="mailto:feedback@travelingbirder.com" style="color: #10b981; text-decoration: none;">feedback@travelingbirder.com</a>
                </p>
            </div>
        </div>
    </div>
</body>
</html>
